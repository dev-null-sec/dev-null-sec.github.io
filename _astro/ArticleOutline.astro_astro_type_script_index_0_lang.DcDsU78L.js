class m extends HTMLElement{observer;headingElements=new Map;outlineItems=null;activeIndicator=null;activeHeadingId=null;isUserScrolling=!0;constructor(){super(),this.observer=new IntersectionObserver(this.handleIntersection.bind(this),{rootMargin:"-80px 0px -80% 0px",threshold:[0,1]})}connectedCallback(){this.checkAndInit()}checkAndInit(){if(!window.location.pathname.includes("/posts/")){const i=this.querySelector(".outline-content");i&&(i.innerHTML="");return}const e=document.querySelector(".markdown-content");e?e.addEventListener("animationend",()=>{setTimeout(()=>{this.regenerateOutlineFromDOM(),this.init()},100)},{once:!0}):setTimeout(()=>{this.regenerateOutlineFromDOM(),this.init()},200)}regenerateOutlineFromDOM(){const e=document.querySelector(".markdown-content, .custom-md, .prose");if(!e)return;const i=e.querySelectorAll("h1, h2, h3, h4, h5, h6");if(i.length===0)return;const t=[];if(i.forEach(o=>{o.id&&t.push({depth:parseInt(o.tagName.substring(1)),slug:o.id,text:o.textContent||""})}),t.length===0)return;let n=10;for(const o of t)n=Math.min(n,o.depth);const c=3;let s=1;const r=o=>o.replace(/#+\s*$/,"").trim(),h=t.filter(o=>o.depth<n+c).map(o=>{const d=(o.depth-n)*1,l=o.depth===n,u=l?s++:null,g=r(o.text);return`
					<a 
						href="#${o.slug}"
						class="outline-item flex items-start gap-2 px-2 py-1.5 rounded hover:bg-[var(--btn-plain-bg-hover)] transition-colors"
						style="padding-left: ${d+.5}rem"
						data-heading-id="${o.slug}"
					>
						${l?`<span class="shrink-0 text-[var(--primary)] font-bold text-xs mt-0.5">${u}.</span>`:""}
						<span class="text-sm leading-relaxed flex-1 ${l?"text-black/90 dark:text-white/90 font-medium":"text-black/70 dark:text-white/70"}">
							${g}
						</span>
					</a>
				`}).join(""),a=this.querySelector(".outline-content");a&&(a.innerHTML=h)}cleanup(){this.headingElements.forEach(t=>{const n=t.parentElement;n&&this.observer.unobserve(n)}),this.outlineItems&&this.outlineItems.forEach(t=>{t.removeEventListener("click",this.handleClick.bind(this))}),this.headingElements.clear(),this.outlineItems=null,this.activeHeadingId=null,this.querySelectorAll(".outline-item").forEach(t=>t.classList.remove("active")),this.activeIndicator&&(this.activeIndicator.style.opacity="0");const i=this.querySelector(".outline-content");i&&(i.innerHTML="")}init(){this.outlineItems=this.querySelectorAll(".outline-item"),this.activeIndicator=this.querySelector("#outline-active-indicator"),!(!this.outlineItems||this.outlineItems.length===0)&&(this.outlineItems.forEach(e=>{const i=e.getAttribute("data-heading-id");if(i){const t=document.getElementById(i);if(t){this.headingElements.set(i,t);const n=t.parentElement;n&&this.observer.observe(n)}}}),this.outlineItems.forEach(e=>{e.addEventListener("click",this.handleClick.bind(this))}),this.updateActiveHeading())}handleIntersection(e){if(!this.isUserScrolling)return;const i=e.filter(t=>t.isIntersecting).sort((t,n)=>{const c=t.boundingClientRect.top,s=n.boundingClientRect.top;return Math.abs(c)-Math.abs(s)});if(i.length>0){const t=i[0].target.children[0]?.getAttribute("id");t&&this.setActiveHeading(t)}}setActiveHeading(e){this.activeHeadingId!==e&&(this.activeHeadingId=e,this.updateActiveHeading())}updateActiveHeading(){if(!(!this.outlineItems||!this.activeIndicator))if(this.outlineItems.forEach(e=>{e.classList.remove("active")}),this.activeHeadingId){const e=this.querySelector(`.outline-item[data-heading-id="${this.activeHeadingId}"]`);if(e){e.classList.add("active");const i=this.querySelector(".outline-content");if(i){const t=i.getBoundingClientRect(),n=e.getBoundingClientRect(),c=i.scrollTop,s=n.top-t.top+c,r=n.height;this.activeIndicator.style.top=`${s}px`,this.activeIndicator.style.height=`${r}px`,this.activeIndicator.style.opacity="1",this.scrollToActiveItem(e)}}}else this.activeIndicator.style.opacity="0"}scrollToActiveItem(e){const i=this.querySelector(".outline-content");if(!i)return;const t=i.getBoundingClientRect(),n=e.getBoundingClientRect();if(n.top<t.top||n.bottom>t.bottom){const s=i.scrollTop+(n.top-t.top)-t.height/3;i.scrollTo({top:s,behavior:"smooth"})}}handleClick(e){e.preventDefault();const t=e.currentTarget.getAttribute("data-heading-id");if(t){const n=document.getElementById(t);if(n){this.isUserScrolling=!1;const s=n.getBoundingClientRect().top+window.pageYOffset-80;window.scrollTo({top:s,behavior:"smooth"}),this.setActiveHeading(t),setTimeout(()=>{this.isUserScrolling=!0},1e3)}}}disconnectedCallback(){this.cleanup(),this.observer.disconnect()}}customElements.get("article-outline")||customElements.define("article-outline",m);
