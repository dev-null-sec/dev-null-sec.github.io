<?xml version="1.0" encoding="UTF-8"?><rss version="2.0" xmlns:content="http://purl.org/rss/1.0/modules/content/"><channel><title>DevNull</title><description>No description</description><link>https://dev-null-sec.github.io/</link><language>zh_CN</language><item><title>Goè¯­è¨€å­¦ä¹ ç¬”è®°(ä¸€)</title><link>https://dev-null-sec.github.io/posts/go%E8%AF%AD%E8%A8%80k8s%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/go%E8%AF%AD%E8%A8%80k8s%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</guid><description>Goè¯­è¨€åŸºç¡€è¯­æ³•å­¦ä¹ è®°å½•ï¼ŒåŒ…å«å˜é‡ç±»å‹ã€æµç¨‹æ§åˆ¶ã€å¾ªç¯ã€æ•°ç»„åˆ‡ç‰‡ã€æ˜ å°„ç­‰æ ¸å¿ƒæ¦‚å¿µ</description><pubDate>Tue, 29 Jul 2025 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;å­¦ä¹ ç›®æ ‡ï¼šæŒæ¡Goè¯­è¨€ï¼Œä¸ºK8säºŒæ¬¡å¼€å‘åšå‡†å¤‡&lt;/p&gt;
&lt;h2&gt;å­¦ä¹ è·¯çº¿&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;åŸºç¡€è¯­æ³•&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;[x] ç¯å¢ƒæ­å»º&lt;/li&gt;
&lt;li&gt;[x] è¾“å…¥è¾“å‡º&lt;/li&gt;
&lt;li&gt;[x] å˜é‡ç±»å‹&lt;/li&gt;
&lt;li&gt;[x] æµç¨‹æ§åˆ¶&lt;/li&gt;
&lt;li&gt;[x] å¾ªç¯&lt;/li&gt;
&lt;li&gt;[x] æ•°ç»„åˆ‡ç‰‡&lt;/li&gt;
&lt;li&gt;[x] æ˜ å°„map&lt;/li&gt;
&lt;li&gt;[ ] å‡½æ•°&lt;/li&gt;
&lt;li&gt;[ ] ç»“æ„ä½“&lt;/li&gt;
&lt;li&gt;[ ] æ¥å£&lt;/li&gt;
&lt;li&gt;[ ] é”™è¯¯å¤„ç†&lt;/li&gt;
&lt;li&gt;[ ] æŒ‡é’ˆ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;å®æˆ˜åº”ç”¨&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;[ ] JSON/YAMLå¤„ç†&lt;/li&gt;
&lt;li&gt;[ ] æ–‡ä»¶æ“ä½œ&lt;/li&gt;
&lt;li&gt;[ ] å¹¶å‘&lt;/li&gt;
&lt;li&gt;[ ] åŒ…ç®¡ç†&lt;/li&gt;
&lt;li&gt;[ ] K8sæ’ä»¶å¼€å‘&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;Goæ¦‚å¿µ -&amp;gt; K8såº”ç”¨å¯¹ç…§&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;fmt&lt;/code&gt; -&amp;gt; è°ƒè¯•è¾“å‡ºPodçŠ¶æ€&lt;/li&gt;
&lt;li&gt;&lt;code&gt;struct&lt;/code&gt; -&amp;gt; Pod/Serviceæ•°æ®ç»“æ„&lt;/li&gt;
&lt;li&gt;&lt;code&gt;slice&lt;/code&gt; -&amp;gt; Podåˆ—è¡¨ç®¡ç†&lt;/li&gt;
&lt;li&gt;&lt;code&gt;map&lt;/code&gt; -&amp;gt; Labels/Annotationså¤„ç†&lt;/li&gt;
&lt;li&gt;&lt;code&gt;goroutine&lt;/code&gt; -&amp;gt; å¹¶å‘å¤„ç†å¤šä¸ªPod&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;ç¯å¢ƒæ­å»º&lt;/h2&gt;
&lt;p&gt;Goç¯å¢ƒé…ç½®æ­¥éª¤ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®˜ç½‘ä¸‹è½½Go&lt;/li&gt;
&lt;li&gt;è®¾ç½®ç¯å¢ƒå˜é‡ &lt;code&gt;GOPROXY=https://goproxy.cn,direct&lt;/code&gt; (å›½å†…å¿…é¡»)&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ–é¡¹ç›® &lt;code&gt;go mod init project-name&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;è¿è¡Œ &lt;code&gt;go run main.go&lt;/code&gt; æˆ– &lt;code&gt;go build&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç¬¬ä¸€ä¸ªç¨‹åºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;package main
import &quot;fmt&quot;
func main() {
    fmt.Println(&quot;Hello K8s!&quot;)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¸¸ç”¨å‘½ä»¤ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;go mod init k8s-tools&lt;/code&gt; - åˆ›å»ºæ¨¡å—&lt;/li&gt;
&lt;li&gt;&lt;code&gt;go run main.go&lt;/code&gt; - ç›´æ¥è¿è¡Œ&lt;/li&gt;
&lt;li&gt;&lt;code&gt;go build&lt;/code&gt; - ç¼–è¯‘æˆå¯æ‰§è¡Œæ–‡ä»¶&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;è¾“å…¥è¾“å‡º&lt;/h2&gt;
&lt;p&gt;fmtåŒ…çš„ä¸‰ä¸ªä¸»è¦å‡½æ•°ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;fmt.Print()&lt;/code&gt; - è¾“å‡ºä¸æ¢è¡Œ&lt;/li&gt;
&lt;li&gt;&lt;code&gt;fmt.Println()&lt;/code&gt; - è¾“å‡ºå¹¶æ¢è¡Œ&lt;/li&gt;
&lt;li&gt;&lt;code&gt;fmt.Printf()&lt;/code&gt; - æ ¼å¼åŒ–è¾“å‡º(é‡ç‚¹)&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;package main
import &quot;fmt&quot;

func main() {
    // æ ¼å¼åŒ–è¾“å‡º
    podName := &quot;nginx-pod&quot;
    replicas := 3
    fmt.Printf(&quot;Podåç§°: %s, å‰¯æœ¬æ•°: %d\n&quot;, podName, replicas)
    
    // è¯»å–è¾“å…¥
    var name string
    var count int
    fmt.Print(&quot;è¯·è¾“å…¥Podåç§°: &quot;)
    fmt.Scan(&amp;amp;name)  // æ³¨æ„&amp;amp;ç¬¦å·
    fmt.Print(&quot;è¯·è¾“å…¥å‰¯æœ¬æ•°: &quot;)
    fmt.Scan(&amp;amp;count)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¸¸ç”¨æ ¼å¼åŒ–ç¬¦å·ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;%s&lt;/code&gt; - å­—ç¬¦ä¸²&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%d&lt;/code&gt; - æ•´æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%f&lt;/code&gt; - æµ®ç‚¹æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%.1f&lt;/code&gt; - ä¿ç•™1ä½å°æ•°&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%t&lt;/code&gt; - å¸ƒå°”å€¼&lt;/li&gt;
&lt;li&gt;&lt;code&gt;%v&lt;/code&gt; - ä»»æ„ç±»å‹&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç»ƒä¹ &lt;/strong&gt;ï¼šå†™ä¸ªç®€å•çš„K8så·¥å…·&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func main() {
    var podname string
    var replicas int
    
    fmt.Print(&quot;è¯·è¾“å…¥podåç§°ï¼š&quot;)
    fmt.Scan(&amp;amp;podname)
    fmt.Print(&quot;è¯·è¾“å…¥podå‰¯æœ¬æ•°ï¼š&quot;)
    fmt.Scan(&amp;amp;replicas)
    
    fmt.Printf(&quot;å‡†å¤‡åˆ›å»ºpodï¼š%sï¼Œå‰¯æœ¬æ•°ï¼š%d\n&quot;, podname, replicas)
    fmt.Println(&quot;æ­£åœ¨è¿æ¥åˆ° K8s é›†ç¾¤...&quot;)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h2&gt;å˜é‡å’Œç±»å‹&lt;/h2&gt;
&lt;p&gt;GoåŸºç¡€æ•°æ®ç±»å‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;string&lt;/code&gt; - å­—ç¬¦ä¸²ï¼Œå­˜å‚¨Podåç§°ã€å‘½åç©ºé—´ç­‰&lt;/li&gt;
&lt;li&gt;&lt;code&gt;int&lt;/code&gt; - æ•´æ•°ï¼Œå­˜å‚¨å‰¯æœ¬æ•°ã€ç«¯å£å·ç­‰&lt;/li&gt;
&lt;li&gt;&lt;code&gt;float64&lt;/code&gt; - æµ®ç‚¹æ•°ï¼Œå­˜å‚¨CPU/å†…å­˜é™åˆ¶&lt;/li&gt;
&lt;li&gt;&lt;code&gt;bool&lt;/code&gt; - å¸ƒå°”å€¼ï¼Œå­˜å‚¨Podå°±ç»ªçŠ¶æ€ç­‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å˜é‡å£°æ˜çš„ä¸‰ç§æ–¹å¼ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// 1. å®Œæ•´å£°æ˜
var podName string = &quot;nginx-pod&quot;

// 2. ç±»å‹æ¨æ–­ 
var serviceName = &quot;my-service&quot;

// 3. ç®€çŸ­å£°æ˜ (å‡½æ•°å†…)
deploymentName := &quot;web-deployment&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¸¸é‡å£°æ˜ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;const (
    DefaultNamespace = &quot;default&quot;
    MaxReplicas = 100
)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;K8s Deploymentç¤ºä¾‹&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func main() {
    deploymentName := &quot;web-server&quot;
    namespace := &quot;production&quot;
    replicas := 5
    cpuLimit := 1.5
    enabled := true
    
    fmt.Printf(`=== K8s Deployment ä¿¡æ¯ ===
éƒ¨ç½²åç§°: %s
å‘½åç©ºé—´: %s  
å‰¯æœ¬æ•°é‡: %d
CPUé™åˆ¶: %.1fæ ¸
çŠ¶æ€: %t`, deploymentName, namespace, replicas, cpuLimit, enabled)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ³¨æ„ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;:=&lt;/code&gt; åªèƒ½åœ¨å‡½æ•°å†…ä½¿ç”¨&lt;/li&gt;
&lt;li&gt;å£°æ˜çš„å˜é‡å¿…é¡»ä½¿ç”¨ï¼Œå¦åˆ™ç¼–è¯‘é”™è¯¯&lt;/li&gt;
&lt;li&gt;é‡æ–°èµ‹å€¼ç”¨ &lt;code&gt;=&lt;/code&gt;ï¼Œä¸æ˜¯ &lt;code&gt;:=&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;æµç¨‹æ§åˆ¶ if/else&lt;/h2&gt;
&lt;p&gt;ifè¯­å¥ç”¨æ¥æ ¹æ®æ¡ä»¶æ‰§è¡Œä¸åŒçš„ä»£ç åˆ†æ”¯ï¼ŒK8så¼€å‘ä¸­ç»å¸¸ç”¨åˆ°ã€‚&lt;/p&gt;
&lt;p&gt;åŸºæœ¬è¯­æ³•ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// åŸºç¡€if
if podStatus == &quot;Running&quot; {
    fmt.Println(&quot;âœ… Pod çŠ¶æ€æ­£å¸¸&quot;)
}

// if-else
if cpuUsage &amp;gt; 80.0 {
    fmt.Println(&quot;ğŸ”¥ éœ€è¦æ‰©å®¹&quot;)
} else {
    fmt.Println(&quot;âœ… CPUæ­£å¸¸&quot;)
}

// å¤šåˆ†æ”¯
if podStatus == &quot;Running&quot; {
    fmt.Println(&quot;âœ… è¿è¡Œæ­£å¸¸&quot;)
} else if podStatus == &quot;Pending&quot; {
    fmt.Println(&quot;âš ï¸ ç­‰å¾…è°ƒåº¦&quot;)
} else if podStatus == &quot;Failed&quot; {
    fmt.Println(&quot;âŒ å¯åŠ¨å¤±è´¥&quot;)
} else {
    fmt.Println(&quot;â“ æœªçŸ¥çŠ¶æ€&quot;)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ¯”è¾ƒè¿ç®—ç¬¦ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;==&lt;/code&gt; ç­‰äº&lt;/li&gt;
&lt;li&gt;&lt;code&gt;!=&lt;/code&gt; ä¸ç­‰äº&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;gt;&lt;/code&gt; &lt;code&gt;&amp;gt;=&lt;/code&gt; å¤§äº(ç­‰äº)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;&amp;lt;&lt;/code&gt; &lt;code&gt;&amp;lt;=&lt;/code&gt; å°äº(ç­‰äº)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;é€»è¾‘è¿ç®—ç¬¦ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;&amp;amp;&amp;amp;&lt;/code&gt; é€»è¾‘ä¸ (éƒ½ä¸ºtrue)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;||&lt;/code&gt; é€»è¾‘æˆ– (è‡³å°‘ä¸€ä¸ªtrue)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;!&lt;/code&gt; é€»è¾‘é (å–å)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Podç›‘æ§ç¤ºä¾‹&lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func main() {
    podName := &quot;web-server-pod&quot;
    status := &quot;Running&quot;
    cpuUsage := 75.5
    memUsage := 60.2
    
    fmt.Println(&quot;=== Podç›‘æ§æŠ¥å‘Š ===&quot;)
    
    if status == &quot;Running&quot; {
        fmt.Println(&quot;âœ… Podè¿è¡Œæ­£å¸¸&quot;)
    } else {
        fmt.Println(&quot;âš ï¸ PodçŠ¶æ€å¼‚å¸¸&quot;)
    }
    
    if cpuUsage &amp;gt; 80 &amp;amp;&amp;amp; memUsage &amp;gt; 85 {
        fmt.Println(&quot;âš ï¸ èµ„æºä½¿ç”¨ç‡è¿‡é«˜ï¼Œå»ºè®®æ‰©å®¹&quot;)
    } else {
        fmt.Println(&quot;âœ… èµ„æºä½¿ç”¨æ­£å¸¸&quot;)
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ³¨æ„ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¡ä»¶è¡¨è¾¾å¼ç»“æœå¿…é¡»æ˜¯boolç±»å‹&lt;/li&gt;
&lt;li&gt;å¤§æ‹¬å·&lt;code&gt;{}&lt;/code&gt;å¿…é¡»æœ‰ï¼Œå·¦å¤§æ‹¬å·å¿…é¡»åœ¨åŒä¸€è¡Œ&lt;/li&gt;
&lt;li&gt;å¤šåˆ†æ”¯ä»ä¸Šåˆ°ä¸‹æ£€æŸ¥ï¼Œé‡åˆ°trueå°±æ‰§è¡Œå¹¶è·³å‡º&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h2&gt;å¾ªç¯&lt;/h2&gt;
&lt;p&gt;å¾ªç¯ç”¨æ¥é‡å¤æ‰§è¡Œä»£ç ï¼ŒK8så¼€å‘ä¸­å¤„ç†æ‰¹é‡Podã€å®¹å™¨ç­‰æ•°æ®æ—¶å¿…ä¸å¯å°‘ã€‚&lt;/p&gt;
&lt;h3&gt;1. ä¼ ç»Ÿforå¾ªç¯&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// åŸºæœ¬è¯­æ³•: for åˆå§‹åŒ–; æ¡ä»¶; æ›´æ–° { }
for i := 0; i &amp;lt; 3; i++ {
    fmt.Printf(&quot;ç¬¬ %d æ¬¡é‡è¯•è¿æ¥...\n&quot;, i+1)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;2. for rangeå¾ªç¯ (æœ€å¸¸ç”¨)&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// éå†Podåˆ—è¡¨
pods := []string{&quot;nginx-pod&quot;, &quot;redis-pod&quot;, &quot;mysql-pod&quot;}

// åªè¦å€¼
for _, podName := range pods {
    fmt.Println(podName)
}

// è¦ç´¢å¼•å’Œå€¼
for i, podName := range pods {
    fmt.Printf(&quot;[%d] %s\n&quot;, i+1, podName)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;3. æ— é™å¾ªç¯&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;for {
    // ç›‘æ§PodçŠ¶æ€
    if podReady {
        break  // é€€å‡ºæ¡ä»¶
    }
    time.Sleep(1 * time.Second)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;4. å¾ªç¯æ§åˆ¶&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// break - è·³å‡ºå¾ªç¯
for _, pod := range pods {
    if pod == &quot;target-pod&quot; {
        fmt.Println(&quot;æ‰¾åˆ°ç›®æ ‡Pod&quot;)
        break
    }
}

// continue - è·³è¿‡å½“å‰å¾ªç¯
for _, pod := range pods {
    if pod == &quot;skip-pod&quot; {
        continue  // è·³è¿‡è¿™ä¸ªpod
    }
    fmt.Println(&quot;å¤„ç†:&quot;, pod)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é›†ç¾¤å¥åº·æ£€æŸ¥ç»ƒä¹ &lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func main() {
    services := []string{&quot;web-service&quot;, &quot;api-service&quot;, &quot;db-service&quot;}
    pods := [][]string{
        {&quot;web-1&quot;, &quot;web-2&quot;, &quot;web-3&quot;},
        {&quot;api-1&quot;, &quot;api-2&quot;},
        {&quot;mysql-1&quot;, &quot;mysql-2&quot;},
    }
    statuses := [][]string{
        {&quot;Running&quot;, &quot;Running&quot;, &quot;Failed&quot;},
        {&quot;Running&quot;, &quot;Pending&quot;},
        {&quot;Running&quot;, &quot;Running&quot;},
    }
    
    // åµŒå¥—å¾ªç¯éå†
    for i, serviceName := range services {
        fmt.Printf(&quot;ğŸ” æ£€æŸ¥æœåŠ¡: %s\n&quot;, serviceName)
        servicePods := pods[i]
        serviceStatuses := statuses[i]
        
        for j, podName := range servicePods {
            status := serviceStatuses[j]
            if status == &quot;Running&quot; {
                fmt.Printf(&quot;  âœ… %s: %s\n&quot;, podName, status)
            } else {
                fmt.Printf(&quot;  âŒ %s: %s\n&quot;, podName, status)
            }
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h2&gt;æ•°ç»„å’Œåˆ‡ç‰‡&lt;/h2&gt;
&lt;p&gt;åˆ‡ç‰‡æ˜¯åŠ¨æ€æ•°ç»„ï¼ŒK8så¼€å‘ä¸­ç®¡ç†Podåˆ—è¡¨ã€å®¹å™¨åˆ—è¡¨å¿…å¤‡ã€‚&lt;/p&gt;
&lt;h3&gt;æ•°ç»„ vs åˆ‡ç‰‡&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ•°ç»„&lt;/strong&gt;: å›ºå®šé•¿åº¦ &lt;code&gt;[3]int{1,2,3}&lt;/code&gt;ï¼Œå¾ˆå°‘ç”¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;åˆ‡ç‰‡&lt;/strong&gt;: åŠ¨æ€é•¿åº¦ &lt;code&gt;[]int{1,2,3}&lt;/code&gt;ï¼Œå¸¸ç”¨&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;åˆ‡ç‰‡æ“ä½œ&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// åˆ›å»ºåˆ‡ç‰‡
pods := []string{&quot;nginx-pod&quot;, &quot;redis-pod&quot;}  
pods = append(pods, &quot;mysql-pod&quot;)  // æ·»åŠ å…ƒç´ 

// è®¿é—®å…ƒç´  
fmt.Println(pods[0])    // ç¬¬ä¸€ä¸ªå…ƒç´ 
fmt.Println(len(pods))  // é•¿åº¦

// åˆ‡ç‰‡æˆªå–
fmt.Println(pods[:2])   // å‰2ä¸ª: [nginx-pod redis-pod]
fmt.Println(pods[1:])   // ä»ç¬¬2ä¸ªå¼€å§‹: [redis-pod mysql-pod]

// éå†
for i, pod := range pods {
    fmt.Printf(&quot;[%d] %s\n&quot;, i, pod)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;äºŒç»´åˆ‡ç‰‡&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// K8så¤šæœåŠ¡Podç®¡ç†
services := []string{&quot;web-service&quot;, &quot;api-service&quot;}
pods := [][]string{
    {&quot;web-1&quot;, &quot;web-2&quot;, &quot;web-3&quot;},  // web-serviceçš„Pod
    {&quot;api-1&quot;, &quot;api-2&quot;},           // api-serviceçš„Pod  
}

// è®¿é—®: pods[æœåŠ¡ç´¢å¼•][Podç´¢å¼•]
fmt.Println(pods[0])     // web-serviceçš„æ‰€æœ‰Pod
fmt.Println(pods[0][1])  // web-serviceçš„ç¬¬2ä¸ªPod: web-2

// éå†äºŒç»´åˆ‡ç‰‡
for i, serviceName := range services {
    fmt.Printf(&quot;æœåŠ¡: %s\n&quot;, serviceName)
    servicePods := pods[i]
    for j, podName := range servicePods {
        fmt.Printf(&quot;  [%d] %s\n&quot;, j+1, podName)
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Podç®¡ç†ç»ƒä¹ &lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func main() {
    pods := []string{&quot;web-pod-1&quot;, &quot;db-pod-1&quot;}
    pods = append(pods, &quot;cache-pod-1&quot;, &quot;api-pod-1&quot;, &quot;worker-pod-1&quot;)
    
    fmt.Println(&quot;=== K8s é›†ç¾¤çŠ¶æ€ ===&quot;)
    fmt.Println(&quot;Pod æ€»æ•°:&quot;, len(pods))
    fmt.Println(&quot;Pod åˆ—è¡¨:&quot;)
    
    for i, podName := range pods {
        fmt.Printf(&quot;  [%d] %s\n&quot;, i+1, podName)
    }
    
    fmt.Println(&quot;å‰3ä¸ªPod:&quot;, pods[:3])
    fmt.Println(&quot;æœ€å2ä¸ªPod:&quot;, pods[len(pods)-2:])
}
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h2&gt;æ˜ å°„(map)&lt;/h2&gt;
&lt;p&gt;æ˜ å°„æ˜¯é”®å€¼å¯¹é›†åˆï¼Œç”¨æ¥å¤„ç†K8sçš„Labelsã€Annotationsã€ConfigMapç­‰ã€‚&lt;/p&gt;
&lt;h3&gt;åŸºæœ¬è¯­æ³•&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// åˆ›å»ºæ˜ å°„
labels := map[string]string{
    &quot;app&quot;:     &quot;nginx&quot;,
    &quot;version&quot;: &quot;v1.0&quot;, 
    &quot;env&quot;:     &quot;production&quot;,
}

// è®¿é—®å€¼
appName := labels[&quot;app&quot;]

// æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
version, exists := labels[&quot;version&quot;]
if exists {
    fmt.Println(&quot;ç‰ˆæœ¬:&quot;, version)
}

// æ·»åŠ /ä¿®æ”¹
labels[&quot;tier&quot;] = &quot;frontend&quot;

// åˆ é™¤
delete(labels, &quot;version&quot;)

// è·å–é•¿åº¦
fmt.Println(&quot;æ ‡ç­¾æ•°é‡:&quot;, len(labels))
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;éå†æ˜ å°„&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// éå†é”®å€¼å¯¹
for key, value := range labels {
    fmt.Printf(&quot;%s = %s\n&quot;, key, value)
}

// åªè¦é”®
for key := range labels {
    fmt.Println(&quot;é”®:&quot;, key)
}

// åªè¦å€¼
for _, value := range labels {
    fmt.Println(&quot;å€¼:&quot;, value)
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;åµŒå¥—æ˜ å°„&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;// Podæ ‡ç­¾ç®¡ç†: namespace -&amp;gt; podName -&amp;gt; labels
podLabels := map[string]map[string]string{
    &quot;default&quot;: {
        &quot;web-pod&quot;:   &quot;app=nginx,version=v1.0&quot;,
        &quot;cache-pod&quot;: &quot;app=redis,version=v6.0&quot;,
    },
    &quot;production&quot;: {
        &quot;api-pod&quot;: &quot;app=api,version=v2.1&quot;,
        &quot;db-pod&quot;:  &quot;app=mysql,version=v8.0&quot;,
    },
}

// å®‰å…¨è®¿é—®åµŒå¥—æ˜ å°„
if prodPods, exists := podLabels[&quot;production&quot;]; exists {
    if apiLabels, exists := prodPods[&quot;api-pod&quot;]; exists {
        fmt.Println(&quot;API Podæ ‡ç­¾:&quot;, apiLabels)
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Labelsç®¡ç†ç»ƒä¹ &lt;/strong&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;func main() {
    podLabels := map[string]map[string]string{
        &quot;web-pod-1&quot;: {&quot;app&quot;: &quot;nginx&quot;, &quot;version&quot;: &quot;v1.0&quot;, &quot;env&quot;: &quot;prod&quot;},
        &quot;web-pod-2&quot;: {&quot;app&quot;: &quot;nginx&quot;, &quot;version&quot;: &quot;v1.1&quot;, &quot;env&quot;: &quot;prod&quot;}, 
        &quot;api-pod&quot;:   {&quot;app&quot;: &quot;api&quot;, &quot;version&quot;: &quot;v2.0&quot;, &quot;env&quot;: &quot;staging&quot;},
        &quot;db-pod&quot;:    {&quot;app&quot;: &quot;mysql&quot;, &quot;version&quot;: &quot;v8.0&quot;, &quot;env&quot;: &quot;prod&quot;},
    }
    
    // ç»Ÿè®¡ç¯å¢ƒåˆ†å¸ƒ
    envCount := map[string]int{&quot;prod&quot;: 0, &quot;staging&quot;: 0}
    appCount := map[string]int{}
    
    for podName, labels := range podLabels {
        fmt.Printf(&quot;ğŸ“‹ Pod: %s\n&quot;, podName)
        
        for key, value := range labels {
            fmt.Printf(&quot;  %s = %s\n&quot;, key, value)
            
            if key == &quot;env&quot; {
                envCount[value]++
            }
            if key == &quot;app&quot; {
                appCount[value]++
            }
        }
    }
    
    fmt.Println(&quot;ğŸ“Š ç»Ÿè®¡:&quot;)
    fmt.Printf(&quot;- ç”Ÿäº§ç¯å¢ƒPod: %d\n&quot;, envCount[&quot;prod&quot;])
    fmt.Printf(&quot;- åº”ç”¨åˆ†å¸ƒ: %v\n&quot;, appCount)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ³¨æ„ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ˜ å°„éå†é¡ºåºæ˜¯éšæœºçš„&lt;/li&gt;
&lt;li&gt;è®¿é—®ä¸å­˜åœ¨çš„é”®ä¼šè¿”å›é›¶å€¼&lt;/li&gt;
&lt;li&gt;å¿…é¡»å…ˆåˆå§‹åŒ–æ‰èƒ½ä½¿ç”¨: &lt;code&gt;make(map[string]string)&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;em&gt;å­¦ä¹ è¿›åº¦&lt;/em&gt;: å®ŒæˆåŸºç¡€è¯­æ³•éƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥å­¦ä¹ å‡½æ•°ã€ç»“æ„ä½“ã€é”™è¯¯å¤„ç†ç­‰é«˜çº§ç‰¹æ€§ï¼Œæœ€ç»ˆå®ç°K8säºŒæ¬¡å¼€å‘ç›®æ ‡ã€‚&lt;/p&gt;
</content:encoded></item><item><title>CI/CD è¿›é˜¶å®æˆ˜ä¸è¸©å‘è®°å½•</title><link>https://dev-null-sec.github.io/posts/ci-cd%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98%E4%B8%8E%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/ci-cd%E8%BF%9B%E9%98%B6%E5%AE%9E%E6%88%98%E4%B8%8E%E8%B8%A9%E5%9D%91%E8%AE%B0%E5%BD%95/</guid><description>æ·±å…¥å®è·µ CI/CD è¿›é˜¶åŠŸèƒ½ï¼ŒåŒ…æ‹¬ SonarQube ä»£ç æ‰«æã€Prometheus+Grafana+Loki å…¨é“¾è·¯ç›‘æ§ã€Argo Rollouts ç°åº¦å‘å¸ƒï¼Œä»¥åŠèµ„æºä¼˜åŒ–å’Œè¸©å‘ç»éªŒ</description><pubDate>Fri, 20 Jun 2025 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;å‰é¢æŠŠåŸºç¡€çš„ CI/CD æµæ°´çº¿è·‘é€šåï¼Œæˆ‘åˆèŠ±äº†å‡ å¤©æ—¶é—´æŠ˜è…¾äº†ä¸€äº›è¿›é˜¶åŠŸèƒ½ã€‚è¿™ç¯‡è®°å½•ä¸€ä¸‹ä»£ç æ‰«æã€å…¨é“¾è·¯ç›‘æ§ã€ç°åº¦å‘å¸ƒè¿™äº›ä¸œè¥¿ï¼Œä»¥åŠä¸­é€”é‡åˆ°çš„ä¸€äº›å‘ã€‚&lt;/p&gt;
&lt;h2&gt;ä»ä¸€ä¸ª Go é¡¹ç›®å¼€å§‹&lt;/h2&gt;
&lt;p&gt;ä¹‹å‰ç”¨çš„éƒ½æ˜¯ç°æˆçš„ Nginx é•œåƒï¼Œè¿™æ¬¡æƒ³æç‚¹çœŸå®çš„åº”ç”¨ï¼Œå°±å†™äº†ä¸ªç®€å•çš„ Go Web æœåŠ¡ã€‚&lt;/p&gt;
&lt;h3&gt;åˆ›å»ºé¡¹ç›®&lt;/h3&gt;
&lt;p&gt;æˆ‘æœ¬åœ°çš„ Go ç¯å¢ƒæ˜¯ 1.25ï¼Œç›´æ¥å¼€å¹²ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir go-demo-app
cd go-demo-app
go mod init go-demo-app

go get github.com/prometheus/client_golang/prometheus/promhttp
go mod tidy
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å†™ä»£ç &lt;/h3&gt;
&lt;p&gt;&lt;code&gt;main.go&lt;/code&gt; å¾ˆç®€å•ï¼Œå°±ä¸‰ä¸ªæ¥å£ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;package main

import (
	&quot;fmt&quot;
	&quot;net/http&quot;
	&quot;os&quot;

	&quot;github.com/prometheus/client_golang/prometheus/promhttp&quot;
)

var version = &quot;v1.0.0&quot;

func main() {
	// ä¸»é¡µé¢
	http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) {
		hostname, _ := os.Hostname()
		fmt.Printf(&quot;Received request from %s\n&quot;, r.RemoteAddr)
		fmt.Fprintf(w, &quot;&amp;lt;h1&amp;gt;Go Demo App&amp;lt;/h1&amp;gt;&quot;)
		fmt.Fprintf(w, &quot;&amp;lt;div&amp;gt;Version: &amp;lt;strong&amp;gt;%s&amp;lt;/strong&amp;gt;&amp;lt;/div&amp;gt;&quot;, version)
		fmt.Fprintf(w, &quot;&amp;lt;div&amp;gt;Hostname: %s&amp;lt;/div&amp;gt;&quot;, hostname)
	})

	// å¥åº·æ£€æŸ¥
	http.HandleFunc(&quot;/health&quot;, func(w http.ResponseWriter, r *http.Request) {
		w.WriteHeader(200)
		w.Write([]byte(&quot;ok&quot;))
	})

	// Prometheus ç›‘æ§æŒ‡æ ‡
	http.Handle(&quot;/metrics&quot;, promhttp.Handler())

	fmt.Printf(&quot;Starting server on port 8080, version: %s\n&quot;, version)
	if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil {
		fmt.Printf(&quot;Error starting server: %s\n&quot;, err)
	}
}
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;Dockerfile&lt;/h3&gt;
&lt;p&gt;ç”¨çš„æ˜¯å¤šé˜¶æ®µæ„å»ºï¼Œæœ€ç»ˆé•œåƒåªæœ‰åå‡  MBï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ„å»ºé˜¶æ®µ
FROM reg.westos.org/library/golang:1.25-alpine AS builder

WORKDIR /app

# Go ä»£ç†åŠ é€Ÿ
ENV GOPROXY=https://goproxy.cn,direct

COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o go-demo-app .

# è¿è¡Œé˜¶æ®µ
FROM reg.westos.org/library/alpine:latest

WORKDIR /root/

COPY --from=builder /app/go-demo-app .

EXPOSE 8080

CMD [&quot;./go-demo-app&quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å› ä¸º Kaniko è®¿é—®ä¸äº† DockerHubï¼Œæˆ‘æå‰æŠŠåŸºç¡€é•œåƒæ¨åˆ°äº† Harborï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull golang:1.25-alpine
docker pull alpine:latest

docker login reg.westos.org -u admin -p 12345

docker tag golang:1.25-alpine reg.westos.org/library/golang:1.25-alpine
docker tag alpine:latest reg.westos.org/library/alpine:latest

docker push reg.westos.org/library/golang:1.25-alpine
docker push reg.westos.org/library/alpine:latest
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;æ¨é€åˆ° Gitea&lt;/h3&gt;
&lt;p&gt;åœ¨ Gitea åˆ›å»º &lt;code&gt;go-demo-app&lt;/code&gt; ä»“åº“ï¼Œç„¶åæ¨ä¸Šå»ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;git init
git add .
git commit -m &quot;Initial commit: Go app with metrics&quot;
git branch -M main
git remote add origin http://192.168.100.10:30030/admin/go-demo-app.git
git push -u origin main
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;é…ç½® Jenkins Pipeline&lt;/h2&gt;
&lt;p&gt;åœ¨ä»“åº“æ ¹ç›®å½•æ–°å»º &lt;code&gt;Jenkinsfile&lt;/code&gt;ï¼Œç”¨æ¥è‡ªåŠ¨æ„å»ºé•œåƒï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;pipeline {
  agent {
    kubernetes {
      yaml &apos;&apos;&apos;
      apiVersion: v1
      kind: Pod
      spec:
        hostAliases:
        - ip: &quot;192.168.100.14&quot;
          hostnames:
          - &quot;reg.westos.org&quot;
        containers:
        - name: kaniko
          image: gcr.io/kaniko-project/executor:debug
          command:
          - sleep
          - infinity
          volumeMounts:
          - name: registry-creds
            mountPath: /kaniko/.docker/
        volumes:
        - name: registry-creds
          secret:
            secretName: harbor-auth
            items:
              - key: .dockerconfigjson
                path: config.json
      &apos;&apos;&apos;
    }
  }

  environment {
    IMAGE_REPO = &quot;reg.westos.org/library/go-demo-app&quot;
    IMAGE_TAG = &quot;v1.0.${BUILD_NUMBER}&quot;
  }

  stages {
    stage(&apos;Checkout&apos;) {
      steps {
        checkout scm
      }
    }

    stage(&apos;Build &amp;amp; Push&apos;) {
      steps {
        container(&apos;kaniko&apos;) {
          sh &quot;&quot;&quot;
            /kaniko/executor \
            --context `pwd` \
            --dockerfile `pwd`/Dockerfile \
            --destination ${IMAGE_REPO}:${IMAGE_TAG} \
            --destination ${IMAGE_REPO}:latest \
            --skip-tls-verify \
            --insecure
          &quot;&quot;&quot;
        }
      }
    }
    
    stage(&apos;Update Manifest&apos;) {
        steps {
            echo &quot;TODO: Update ArgoCD manifest with new tag ${IMAGE_TAG}&quot;
        }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨ Jenkins æ–°å»ºä¸€ä¸ª Pipeline ä»»åŠ¡ï¼Œé€‰æ‹© &quot;Pipeline from SCM&quot;ï¼ŒæŒ‡å‘ Gitea çš„ &lt;code&gt;go-demo-app&lt;/code&gt; ä»“åº“ï¼Œåˆ†æ”¯é€‰ &lt;code&gt;main&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;è·‘ä¸€æ¬¡æ„å»ºï¼Œå» Harbor çœ‹çœ‹é•œåƒæœ‰æ²¡æœ‰ç”Ÿæˆã€‚&lt;/p&gt;
&lt;h2&gt;å‡†å¤‡ K8s éƒ¨ç½²æ–‡ä»¶&lt;/h2&gt;
&lt;p&gt;åœ¨ &lt;code&gt;go-demo-app&lt;/code&gt; ä»“åº“é‡Œæ–°å»º &lt;code&gt;deploy/deployment.yaml&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: go-demo-app
  namespace: default
  labels:
    app: go-demo-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: go-demo-app
  template:
    metadata:
      labels:
        app: go-demo-app
      annotations:
        prometheus.io/scrape: &quot;true&quot;
        prometheus.io/port: &quot;8080&quot;
        prometheus.io/path: &quot;/metrics&quot;
    spec:
      hostAliases:
      - ip: &quot;192.168.100.14&quot;
        hostnames:
        - &quot;reg.westos.org&quot;
      containers:
      - name: go-demo-app
        image: reg.westos.org/library/go-demo-app:latest 
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: &quot;500m&quot;
            memory: &quot;128Mi&quot;
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
      imagePullSecrets:
      - name: harbor-auth

---
apiVersion: v1
kind: Service
metadata:
  name: go-demo-app-svc
  namespace: default
  labels:
    app: go-demo-app
spec:
  type: NodePort
  selector:
    app: go-demo-app
  ports:
  - name: http
    port: 8080
    targetPort: 8080
    nodePort: 30095
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ¨é€åˆ° Giteaï¼Œç„¶ååœ¨ ArgoCD åˆ›å»ºæ–°åº”ç”¨ &lt;code&gt;go-demo-app&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Repository URL: &lt;code&gt;http://192.168.100.10:30030/admin/go-demo-app.git&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Path: &lt;code&gt;deploy&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Sync Policy: Automaticï¼Œå‹¾é€‰ Prune å’Œ Self Heal&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åŒæ­¥åè®¿é—® &lt;code&gt;http://192.168.100.10:30095&lt;/code&gt;ï¼Œèƒ½çœ‹åˆ°é¡µé¢å°±ç®—æˆåŠŸäº†ã€‚&lt;/p&gt;
&lt;h2&gt;å®ç° CI é—­ç¯&lt;/h2&gt;
&lt;p&gt;ç°åœ¨ Jenkins æ¯æ¬¡æ„å»ºå‡ºæ–°é•œåƒï¼Œè¿˜éœ€è¦æ‰‹åŠ¨æ”¹ &lt;code&gt;deployment.yaml&lt;/code&gt; é‡Œçš„ç‰ˆæœ¬å·ï¼Œè¿™å¤ªè ¢äº†ã€‚æˆ‘ä»¬è®© Jenkins è‡ªå·±å»æ”¹ã€‚&lt;/p&gt;
&lt;h3&gt;ä¿®æ”¹ Jenkinsfile&lt;/h3&gt;
&lt;p&gt;ä¸»è¦æ”¹åŠ¨æ˜¯åŠ ä¸€ä¸ª &lt;code&gt;git-tools&lt;/code&gt; å®¹å™¨ï¼Œç”¨æ¥æäº¤ä»£ç ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;pipeline {
  agent {
    kubernetes {
      yaml &apos;&apos;&apos;
      apiVersion: v1
      kind: Pod
      spec:
        hostAliases:
        - ip: &quot;192.168.100.14&quot;
          hostnames:
          - &quot;reg.westos.org&quot;
        containers:
        - name: kaniko
          image: gcr.io/kaniko-project/executor:debug
          command:
          - sleep
          - infinity
          volumeMounts:
          - name: registry-creds
            mountPath: /kaniko/.docker/
        - name: git-tools
          image: bitnami/git:latest
          command:
          - sleep
          - infinity
        volumes:
        - name: registry-creds
          secret:
            secretName: harbor-auth
            items:
              - key: .dockerconfigjson
                path: config.json
      &apos;&apos;&apos;
    }
  }

  environment {
    IMAGE_REPO = &quot;reg.westos.org/library/go-demo-app&quot;
    IMAGE_TAG = &quot;v1.0.${BUILD_NUMBER}&quot;
    GITEA_REPO = &quot;192.168.100.10:30030/admin/go-demo-app.git&quot;
  }

  stages {
    stage(&apos;Checkout&apos;) {
      steps {
        checkout scm
      }
    }

    stage(&apos;Build &amp;amp; Push&apos;) {
      steps {
        container(&apos;kaniko&apos;) {
          sh &quot;&quot;&quot;
            /kaniko/executor \
            --context `pwd` \
            --dockerfile `pwd`/Dockerfile \
            --destination ${IMAGE_REPO}:${IMAGE_TAG} \
            --destination ${IMAGE_REPO}:latest \
            --skip-tls-verify \
            --insecure
          &quot;&quot;&quot;
        }
      }
    }
    
    stage(&apos;Update Manifest&apos;) {
      steps {
        container(&apos;git-tools&apos;) {
          withCredentials([usernamePassword(credentialsId: &apos;gitea-auth&apos;, usernameVariable: &apos;GIT_USER&apos;, passwordVariable: &apos;GIT_PASS&apos;)]) {
            sh &quot;&quot;&quot;
              git config --global user.email &quot;jenkins@westos.org&quot;
              git config --global user.name &quot;Jenkins CI&quot;
              git config --global --add safe.directory &apos;*&apos;
              
              git checkout main
              git pull origin main

              sed -i &quot;s|image: ${IMAGE_REPO}:.*|image: ${IMAGE_REPO}:${IMAGE_TAG}|&quot; deploy/deployment.yaml
              
              echo &quot;Updated deployment.yaml:&quot;
              grep &quot;image:&quot; deploy/deployment.yaml

              if git status --porcelain | grep deploy/deployment.yaml; then
                  git add deploy/deployment.yaml
                  git commit -m &quot;Deploy: update image tag to ${IMAGE_TAG} [skip ci]&quot;
                  git push http://${GIT_USER}:${GIT_PASS}@${GITEA_REPO} main
              else
                  echo &quot;No changes to commit&quot;
              fi
            &quot;&quot;&quot;
          }
        }
      }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ¨é€æ›´æ–°åè·‘ä¸€æ¬¡æ„å»ºï¼Œå» Gitea çœ‹çœ‹ &lt;code&gt;deployment.yaml&lt;/code&gt; æœ‰æ²¡æœ‰è‡ªåŠ¨æ›´æ–°ç‰ˆæœ¬å·ã€‚å¦‚æœæœ‰ï¼Œå» ArgoCD çœ‹ Pod æœ‰æ²¡æœ‰é‡å¯ã€‚è¿™æ · CI é—­ç¯å°±é€šäº†ã€‚&lt;/p&gt;
&lt;h2&gt;æ¥å…¥ä»£ç æ‰«æ (SonarQube)&lt;/h2&gt;
&lt;p&gt;ä¸ºäº†æ˜¾å¾—ä¸“ä¸šä¸€ç‚¹ï¼ŒåŠ ä¸ªä»£ç æ‰«æã€‚&lt;/p&gt;
&lt;h3&gt;å®‰è£… SonarQube&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm repo add sonarqube https://SonarSource.github.io/helm-chart-sonarqube
helm repo update

kubectl create namespace sonarqube

cat &amp;lt;&amp;lt;EOF &amp;gt; sonar-values.yaml
community:
  enabled: true

service:
  type: NodePort
  nodePort: 30099

persistence:
  enabled: true
  storageClass: &quot;nfs-client&quot;
  size: 5Gi

elasticsearch:
  configureNode: false

monitoringPasscode: &quot;westos_monitor_123&quot;
EOF

helm install sonarqube sonarqube/sonarqube -n sonarqube -f sonar-values.yaml

kubectl get pods -n sonarqube -w
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;SonarQube å¯åŠ¨æ¯”è¾ƒæ…¢ï¼Œç­‰ä¸ª 2-3 åˆ†é’Ÿã€‚&lt;/p&gt;
&lt;h3&gt;é…ç½® SonarQube&lt;/h3&gt;
&lt;p&gt;è®¿é—® &lt;code&gt;http://192.168.100.10:30099&lt;/code&gt;ï¼Œé»˜è®¤è´¦å· &lt;code&gt;admin/admin&lt;/code&gt;ï¼Œé¦–æ¬¡ç™»å½•è¦æ”¹å¯†ç ï¼Œæˆ‘æ”¹æˆäº† &lt;code&gt;Admin123456789!&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åˆ›å»ºé¡¹ç›®ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Create a local project&lt;/li&gt;
&lt;li&gt;Project display name: &lt;code&gt;go-demo-app&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Project Key: &lt;code&gt;go-demo-app&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Main branch name: &lt;code&gt;main&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é€‰ &quot;Follows the instance&apos;s default&quot;ï¼Œç‚¹ Create&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;ç„¶åç”Ÿæˆ Tokenï¼Œé€‰ &quot;Locally&quot;ï¼Œç‚¹ Generateï¼Œå¤åˆ¶è¿™ä¸ª Tokenï¼ˆé•¿è¿™æ ·ï¼š&lt;code&gt;sqp_xxxx...&lt;/code&gt;ï¼‰ã€‚&lt;/p&gt;
&lt;h3&gt;é…ç½® Jenkins&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;å®‰è£…æ’ä»¶ï¼š&lt;strong&gt;SonarQube Scanner&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;æ·»åŠ å‡­è¯ï¼š
&lt;ul&gt;
&lt;li&gt;Kind: Secret text&lt;/li&gt;
&lt;li&gt;Secret: ç²˜è´´åˆšæ‰çš„ Token&lt;/li&gt;
&lt;li&gt;ID: &lt;code&gt;sonar-token&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;é…ç½®ç³»ç»Ÿï¼š
&lt;ul&gt;
&lt;li&gt;Manage Jenkins â†’ System â†’ SonarQube servers&lt;/li&gt;
&lt;li&gt;å‹¾é€‰ &quot;Environment variables&quot;&lt;/li&gt;
&lt;li&gt;Name: &lt;code&gt;sonar-server&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Server URL: &lt;code&gt;http://sonarqube-sonarqube.sonarqube.svc.cluster.local:9000&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;Token: é€‰ &lt;code&gt;sonar-token&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;ä¿®æ”¹ Jenkinsfile&lt;/h3&gt;
&lt;p&gt;åœ¨ Pod Template é‡ŒåŠ ä¸€ä¸ª &lt;code&gt;sonar-cli&lt;/code&gt; å®¹å™¨ï¼Œç„¶ååœ¨ Build ä¹‹å‰åŠ ä¸€ä¸ª Code Analysis é˜¶æ®µï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;// Pod Template é‡ŒåŠ è¿™ä¸ªå®¹å™¨
- name: sonar-cli
  image: sonarsource/sonar-scanner-cli:latest
  command:
  - sleep
  - infinity

// stages é‡ŒåŠ è¿™ä¸ªé˜¶æ®µ
stage(&apos;Code Analysis&apos;) {
    steps {
        container(&apos;sonar-cli&apos;) {
            withSonarQubeEnv(&apos;sonar-server&apos;) {
                sh &quot;&quot;&quot;
                    sonar-scanner \
                      -Dsonar.projectKey=go-demo-app \
                      -Dsonar.sources=. \
                      -Dsonar.host.url=http://sonarqube-sonarqube.sonarqube.svc.cluster.local:9000 \
                      -Dsonar.login=$SONAR_AUTH_TOKEN
                &quot;&quot;&quot;
            }
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è·‘ä¸€æ¬¡æ„å»ºï¼ŒæˆåŠŸåå» SonarQube ç½‘é¡µçœ‹çœ‹æœ‰æ²¡æœ‰æ‰«ææŠ¥å‘Šã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://dev-null-sec.github.io/images/posts/bc89b42fa4665e8f773dd677f5bedc8b.png&quot; alt=&quot;bc89b42fa4665e8f773dd677f5bedc8b&quot; /&gt;&lt;/p&gt;
&lt;h2&gt;èµ„æºä¼˜åŒ–&lt;/h2&gt;
&lt;p&gt;è¿™æ—¶å€™æˆ‘å‘ç°é›†ç¾¤æœ‰ç‚¹æ’‘ä¸ä½äº†ï¼Œçœ‹äº†ä¸‹èŠ‚ç‚¹èµ„æºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

kubectl patch deployment metrics-server -n kube-system --type=&apos;json&apos; -p=&apos;[{&quot;op&quot;: &quot;add&quot;, &quot;path&quot;: &quot;/spec/template/spec/containers/0/args/-&quot;, &quot;value&quot;: &quot;--kubelet-insecure-tls&quot;}]&apos;

kubectl top nodes
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç»“æœï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME         CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)
k8s-master   134m         6%       1227Mi          74%
k8s-node1    133m         6%       5524Mi          73%
k8s-node2    59m          2%       856Mi           11%
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;node1 å¿«ç´¯æ­»äº†ï¼Œnode2 åœ¨å·æ‡’ã€‚å†çœ‹çœ‹ Podï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl top pods -A --sort-by=memory
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;NAMESPACE     NAME                      CPU(cores)   MEMORY(bytes)
sonarqube     sonarqube-sonarqube-0     19m          2186Mi
jenkins       jenkins-0                 2m           1495Mi
kube-system   kube-apiserver-k8s-master 31m          494Mi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;é—®é¢˜å¾ˆæ˜æ˜¾ï¼šèµ„æºåˆ†é…ä¸å‡ï¼Œè€Œä¸” SonarQube å’Œ Jenkins å¤ªåƒå†…å­˜äº†ã€‚&lt;/p&gt;
&lt;h3&gt;è°ƒæ•´èµ„æºåˆ†é…&lt;/h3&gt;
&lt;p&gt;å…ˆæŠŠ node1 ç¦æ­¢è°ƒåº¦ï¼Œå¼ºåˆ¶ SonarQube å’Œ Jenkins é‡å»ºåˆ° node2ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl cordon k8s-node1

kubectl delete pod sonarqube-sonarqube-0 -n sonarqube
kubectl delete pod -n jenkins -l app.kubernetes.io/name=jenkins

# ç¡®è®¤è·‘åˆ° node2 äº†
kubectl -n sonarqube get pod -o wide
kubectl -n jenkins get pod -o wide

# è§£å°
kubectl uncordon k8s-node1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å†çœ‹èŠ‚ç‚¹æŒ‡æ ‡ï¼Œå¹³è¡¡å¤šäº†ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME         CPU(cores)   CPU(%)   MEMORY(bytes)   MEMORY(%)
k8s-master   130m         6%       1277Mi          77%
k8s-node1    68m          3%       1440Mi          19%
k8s-node2    145m         7%       883Mi           11%
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é™åˆ¶å†…å­˜å ç”¨&lt;/h3&gt;
&lt;p&gt;ä¿®æ”¹ &lt;code&gt;sonar-values.yaml&lt;/code&gt;ï¼ŒåŠ ä¸Šèµ„æºé™åˆ¶ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;resources:
  requests:
    cpu: &quot;200m&quot;
    memory: &quot;1Gi&quot;
  limits:
    cpu: &quot;1000m&quot;
    memory: &quot;1800Mi&quot;

jvmCeOpts: &quot;-Xmx1024m -Xms512m&quot;
jvmOpts: &quot;-Xmx1024m -Xms512m&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ›´æ–°ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;helm upgrade sonarqube sonarqube/sonarqube -n sonarqube -f sonar-values.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¿®æ”¹ &lt;code&gt;jenkins-manual.yaml&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;controller:
  javaOpts: &quot;-Xms512m -Xmx800m -Djenkins.install.runSetupWizard=false&quot;
  
  resources:
    requests:
      cpu: &quot;200m&quot;
      memory: &quot;512Mi&quot;
    limits:
      cpu: &quot;1000m&quot;
      memory: &quot;1280Mi&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ›´æ–°ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;helm upgrade jenkins jenkins/jenkins -n jenkins -f jenkins-manual.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å†çœ‹å†…å­˜å ç”¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAMESPACE     NAME                      CPU(cores)   MEMORY(bytes)
sonarqube     sonarqube-sonarqube-0     913m         767Mi
kube-system   kube-apiserver-k8s-master 53m          530Mi
jenkins       jenkins-0                 945m         328Mi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¼˜åŒ–æ•ˆæœå¾ˆæ˜æ˜¾ï¼Œè™½ç„¶è¿˜æ˜¯æœ‰ç‚¹å¡ï¼Œä½†è‡³å°‘ä¸ä¼šæ•´ä¸ªèŠ‚ç‚¹å´©æºƒäº†ã€‚&lt;/p&gt;
&lt;h2&gt;å…¨é“¾è·¯ç›‘æ§&lt;/h2&gt;
&lt;p&gt;æ¥ä¸‹æ¥æç›‘æ§ï¼Œç”¨ Prometheus + Grafana + Lokiã€‚&lt;/p&gt;
&lt;h3&gt;éƒ¨ç½² kube-prometheus-stack&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; monitor-values.yaml
grafana:
  service:
    type: NodePort
    nodePort: 30000

prometheus:
  prometheusSpec:
    retention: 5d
    resources:
      requests:
        memory: 512Mi
        cpu: 200m
      limits:
        memory: 1Gi
        cpu: 1000m
    serviceMonitorSelectorNilUsesHelmValues: false
    serviceMonitorSelector: {}
    serviceMonitorNamespaceSelector: {}

alertmanager:
  alertmanagerSpec:
    replicas: 1

kubeStateMetrics:
  enabled: true
nodeExporter:
  enabled: true
EOF

helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

kubectl create ns monitoring

helm install prometheus prometheus-community/kube-prometheus-stack \
  -n monitoring \
  -f monitor-values.yaml

kubectl get pods -n monitoring -w
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;ç›‘æ§ Jenkins&lt;/h3&gt;
&lt;p&gt;åœ¨ Jenkins å®‰è£…æ’ä»¶ &lt;strong&gt;Prometheus metrics&lt;/strong&gt;ï¼Œé‡å¯åè®¿é—® &lt;code&gt;http://192.168.100.10:30080/prometheus/&lt;/code&gt; èƒ½çœ‹åˆ°æŒ‡æ ‡å°±è¡Œã€‚&lt;/p&gt;
&lt;p&gt;åˆ›å»º &lt;code&gt;jenkins-monitor.yaml&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: jenkins
  namespace: monitoring
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      app.kubernetes.io/instance: jenkins
  namespaceSelector:
    matchNames:
      - jenkins
  endpoints:
  - port: http
    path: /prometheus/
    interval: 15s
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åº”ç”¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f jenkins-monitor.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;è®¿é—® Grafana&lt;/h3&gt;
&lt;p&gt;è®¿é—® &lt;code&gt;http://192.168.100.10:30000&lt;/code&gt;ï¼Œè´¦å· &lt;code&gt;admin&lt;/code&gt;ï¼Œå¯†ç ç”¨å‘½ä»¤æŸ¥ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n monitoring get secret prometheus-grafana \
  -o jsonpath=&quot;{.data.admin-password}&quot; | base64 -d ; echo
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æˆ‘çš„å¯†ç æ˜¯ï¼š&lt;code&gt;sgbrApYRHjBKbJzdv7YbS1LgGZGqPAToqZ4x1NDj&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;è¿›å…¥ Grafanaï¼Œå·¦ä¾§èœå• Dashboards â†’ New â†’ Importï¼Œè¾“å…¥ Dashboard ID &lt;code&gt;24357&lt;/code&gt;ï¼Œæ•°æ®æºé€‰ Prometheusï¼Œç‚¹ Importã€‚&lt;/p&gt;
&lt;p&gt;å°±èƒ½çœ‹åˆ° Jenkins çš„ç›‘æ§å¤§ç›˜äº†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://dev-null-sec.github.io/images/posts/41296523d2e7871e17230893838f035e.png&quot; alt=&quot;41296523d2e7871e17230893838f035e&quot; /&gt;&lt;/p&gt;
&lt;p&gt;ä¹Ÿå¯ä»¥å¯¼å…¥ &lt;code&gt;16098&lt;/code&gt; å’Œ &lt;code&gt;13105&lt;/code&gt; çœ‹ä¸»æœºå’Œ K8s é›†ç¾¤çš„ä¿¡æ¯ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://dev-null-sec.github.io/images/posts/632560302e3e4f84aeb5652c240c72e8.png&quot; alt=&quot;632560302e3e4f84aeb5652c240c72e8&quot; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://dev-null-sec.github.io/images/posts/f37460f220035f8709ae67dd8e91c373.png&quot; alt=&quot;f37460f220035f8709ae67dd8e91c373&quot; /&gt;&lt;/p&gt;
&lt;h3&gt;ç›‘æ§ Go åº”ç”¨&lt;/h3&gt;
&lt;p&gt;åˆ›å»º &lt;code&gt;app-monitor.yaml&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: go-demo-app
  namespace: monitoring
  labels:
    release: prometheus
spec:
  selector:
    matchLabels:
      app: go-demo-app
  namespaceSelector:
    matchNames:
      - default
  endpoints:
  - port: http
    path: /metrics
    interval: 5s
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åº”ç”¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f app-monitor.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨ Grafana çš„ Explore é‡Œæœç´¢ &lt;code&gt;go_goroutines&lt;/code&gt; æˆ– &lt;code&gt;process_cpu_seconds_total&lt;/code&gt;ï¼Œèƒ½çœ‹åˆ°å›¾è¡¨å°±è¯´æ˜æˆåŠŸäº†ã€‚&lt;/p&gt;
&lt;h2&gt;æ—¥å¿—èšåˆ (Loki)&lt;/h2&gt;
&lt;p&gt;Grafana å·²ç»è£…äº†ï¼Œåªéœ€è¦è£… Loki å’Œ Promtailã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

kubectl create ns logging

cat &amp;lt;&amp;lt;EOF &amp;gt; loki-values.yaml
loki:
  enabled: true

  image:
    repository: grafana/loki
    tag: &quot;2.9.3&quot;  # é»˜è®¤çš„ 2.6 ç‰ˆæœ¬ Grafana è¿ä¸ä¸Š
    pullPolicy: IfNotPresent

  config:
    auth_enabled: false

  commonConfig:
    replication_factor: 1

  storage:
    type: filesystem

  singleBinary:
    replicas: 1

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

promtail:
  enabled: true
  config:
    clients:
      - url: http://loki:3100/loki/api/v1/push
EOF

helm install loki grafana/loki-stack -n logging -f loki-values.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½® Grafana æ•°æ®æº&lt;/h3&gt;
&lt;p&gt;è¿›å…¥ Grafana â†’ Connections â†’ Data Sources â†’ Add data source â†’ é€‰æ‹© Lokiã€‚&lt;/p&gt;
&lt;p&gt;URL å¡«ï¼š&lt;code&gt;http://loki.logging.svc.cluster.local:3100&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;ç‚¹ Save &amp;amp; Testã€‚&lt;/p&gt;
&lt;h3&gt;éªŒè¯æ—¥å¿—&lt;/h3&gt;
&lt;p&gt;è¿›å…¥ Grafana â†’ Explore â†’ æ•°æ®æºé€‰ Lokiã€‚&lt;/p&gt;
&lt;p&gt;Label filters é€‰ &lt;code&gt;namespace = jenkins&lt;/code&gt; æˆ– &lt;code&gt;default&lt;/code&gt;ï¼Œç‚¹ Run queryã€‚&lt;/p&gt;
&lt;p&gt;ç°åœ¨ä¸ä»…èƒ½çœ‹åˆ° CPU æ›²çº¿ï¼Œè¿˜èƒ½åœ¨åŒä¸€ä¸ªé¡µé¢çœ‹åˆ° Pod çš„æ—¥å¿—ï¼Œå…¨é“¾è·¯å¯è§†åŒ–å°±å®ç°äº†ã€‚&lt;/p&gt;
&lt;h2&gt;Argo Rollouts ç°åº¦å‘å¸ƒ&lt;/h2&gt;
&lt;p&gt;æœ€åæä¸ªç°åº¦å‘å¸ƒï¼Œå®ç°æ— äººå€¼å®ˆè‡ªåŠ¨ä¸Šçº¿ã€‚&lt;/p&gt;
&lt;h3&gt;å®‰è£… Argo Rollouts&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl create namespace argo-rollouts

kubectl apply -n argo-rollouts -f https://github.com/argoproj/argo-rollouts/releases/latest/download/install.yaml

# å®‰è£… kubectl æ’ä»¶
curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
chmod +x ./kubectl-argo-rollouts-linux-amd64
mv ./kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

kubectl get pods -n argo-rollouts
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;åˆ›å»º AnalysisTemplate&lt;/h3&gt;
&lt;p&gt;åœ¨ &lt;code&gt;go-demo-app&lt;/code&gt; ä»“åº“çš„ &lt;code&gt;deploy&lt;/code&gt; ç›®å½•ä¸‹ï¼Œæ–°å»º &lt;code&gt;analysis.yaml&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: argoproj.io/v1alpha1
kind: AnalysisTemplate
metadata:
  name: success-rate-check
  namespace: default
spec:
  args:
  - name: service-name
  metrics:
  - name: success-rate
    successCondition: result[0] == 1
    provider:
      prometheus:
        address: http://prometheus-kube-prometheus-prometheus.monitoring:9090
        query: |
          # æ¼”ç¤ºç”¨çš„æŸ¥è¯¢ï¼Œæ°¸è¿œè¿”å› 1
          # ç”Ÿäº§ç¯å¢ƒåº”è¯¥æ”¹æˆçœŸå®çš„æˆåŠŸç‡æŸ¥è¯¢
          vector(1)
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å°† Deployment å‡çº§ä¸º Rollout&lt;/h3&gt;
&lt;p&gt;ä¿®æ”¹ &lt;code&gt;deploy/deployment.yaml&lt;/code&gt;ï¼Œä¸»è¦æ”¹åŠ¨ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;apiVersion&lt;/code&gt; æ”¹ä¸º &lt;code&gt;argoproj.io/v1alpha1&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;kind&lt;/code&gt; æ”¹ä¸º &lt;code&gt;Rollout&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;replicas&lt;/code&gt; æ”¹ä¸º &lt;code&gt;5&lt;/code&gt;ï¼ˆæ–¹ä¾¿çœ‹ç°åº¦æ•ˆæœï¼‰&lt;/li&gt;
&lt;li&gt;åŠ ä¸Š &lt;code&gt;strategy.canary&lt;/code&gt; é…ç½®&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: go-demo-app
  namespace: default
  labels:
    app: go-demo-app
spec:
  replicas: 5
  selector:
    matchLabels:
      app: go-demo-app
  strategy:
    canary:
      steps:
      - setWeight: 20  # å…ˆåˆ‡ 20% æµé‡
      - analysis:
          templates:
          - templateName: success-rate-check
          args:
          - name: service-name
            value: go-demo-app
      - pause: {duration: 30s}  # äººå·¥è§‚å¯Ÿ 30 ç§’
      - setWeight: 50  # å†åˆ‡ 50% æµé‡
      - pause: {duration: 10s}
      - setWeight: 100  # æœ€åå…¨é‡ä¸Šçº¿
  template:
    metadata:
      labels:
        app: go-demo-app
      annotations:
        prometheus.io/scrape: &quot;true&quot;
        prometheus.io/port: &quot;8080&quot;
        prometheus.io/path: &quot;/metrics&quot;
    spec:
      hostAliases:
      - ip: &quot;192.168.100.14&quot;
        hostnames:
        - &quot;reg.westos.org&quot;
      containers:
      - name: go-demo-app
        image: reg.westos.org/library/go-demo-app:latest 
        imagePullPolicy: Always
        ports:
        - containerPort: 8080
        resources:
          limits:
            cpu: &quot;200m&quot;
            memory: &quot;128Mi&quot;
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 10
      imagePullSecrets:
      - name: harbor-auth
---
apiVersion: v1
kind: Service
metadata:
  name: go-demo-app-svc
  namespace: default
  labels:
    app: go-demo-app
spec:
  type: NodePort
  selector:
    app: go-demo-app
  ports:
  - name: http
    port: 8080
    targetPort: 8080
    nodePort: 30095
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åˆ é™¤æ—§çš„ Deploymentï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete deployment go-demo-app
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ¨é€åˆ° Giteaï¼Œå» ArgoCD ç‚¹ Syncã€‚&lt;/p&gt;
&lt;h3&gt;æ¨¡æ‹Ÿç°åº¦å‘å¸ƒ&lt;/h3&gt;
&lt;p&gt;å¼€ä¸€ä¸ªç»ˆç«¯çª—å£ï¼Œå®æ—¶ç›‘æ§ Rollout çŠ¶æ€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl argo rollouts get rollout go-demo-app -n default -w
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç„¶åå» Jenkins è·‘ä¸€æ¬¡æ„å»ºã€‚&lt;/p&gt;
&lt;p&gt;è§‚å¯Ÿè¿‡ç¨‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Step 1&lt;/strong&gt;: çŠ¶æ€å˜ä¸º Pausedï¼Œæ–°ç‰ˆæœ¬ Pod å¯åŠ¨ 1 ä¸ªï¼ˆ20%ï¼‰ï¼Œæ—§ç‰ˆæœ¬ 4 ä¸ª&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Analysis&lt;/strong&gt;: åå°è·‘ AnalysisRunï¼Œè¿ Prometheus æŸ¥è¯¢ &lt;code&gt;vector(1)&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Pass&lt;/strong&gt;: å¦‚æœ Prometheus è¿æ¥æ­£å¸¸ï¼ŒAnalysis æ˜¾ç¤º Successful&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Step 2&lt;/strong&gt;: æƒé‡è‡ªåŠ¨å¢åŠ åˆ° 50%&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Complete&lt;/strong&gt;: æœ€ç»ˆæƒé‡å˜æˆ 100%ï¼Œæ—§ç‰ˆæœ¬ Pod å…¨éƒ¨æ¶ˆå¤±&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;https://dev-null-sec.github.io/images/posts/163492a4e552faed921a6f7c10858de8-1766296444543-9.png&quot; alt=&quot;163492a4e552faed921a6f7c10858de8&quot; /&gt;&lt;/p&gt;
&lt;p&gt;å…¨éƒ¨åˆ‡ä¸ºæ–°ç‰ˆæœ¬&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://dev-null-sec.github.io/images/posts/82815ed2de155af98b23e71eff469d7a.png&quot; alt=&quot;82815ed2de155af98b23e71eff469d7a&quot; /&gt;&lt;/p&gt;
&lt;p&gt;æ•´ä¸ªè¿‡ç¨‹å®Œå…¨è‡ªåŠ¨åŒ–ï¼Œæ— éœ€äººå·¥ä»‹å…¥ã€‚è¿™å°±æ˜¯ GitOps + ç°åº¦å‘å¸ƒçš„é­…åŠ›ã€‚&lt;/p&gt;
&lt;h2&gt;å°ç»“&lt;/h2&gt;
&lt;p&gt;æŠ˜è…¾äº†è¿™ä¹ˆå¤šå¤©ï¼Œä»åŸºç¡€çš„ CI/CD åˆ°ä»£ç æ‰«æã€å…¨é“¾è·¯ç›‘æ§ã€ç°åº¦å‘å¸ƒï¼Œæ•´ä¸ªäº‘åŸç”Ÿå·¥å…·é“¾ç®—æ˜¯ä½“éªŒäº†ä¸€éã€‚è™½ç„¶ä¸­é€”é‡åˆ°ä¸å°‘èµ„æºä¸è¶³ã€é…ç½®é”™è¯¯çš„é—®é¢˜ï¼Œä½†æ¯æ¬¡è§£å†³é—®é¢˜éƒ½èƒ½å­¦åˆ°æ–°ä¸œè¥¿ã€‚&lt;/p&gt;
&lt;p&gt;æœ€å¤§çš„æ„Ÿå—å°±æ˜¯ï¼š&lt;strong&gt;äº‘åŸç”Ÿä¸æ˜¯é“¶å¼¹ï¼Œä½†ç¡®å®èƒ½è§£å†³å¾ˆå¤šä¼ ç»Ÿéƒ¨ç½²æ–¹å¼è§£å†³ä¸äº†çš„é—®é¢˜&lt;/strong&gt;ã€‚æ¯”å¦‚ç°åº¦å‘å¸ƒï¼Œä»¥å‰è¦å†™ä¸€å †è„šæœ¬ï¼Œç°åœ¨ä¸€ä¸ª YAML å°±æå®šäº†ã€‚&lt;/p&gt;
</content:encoded></item><item><title>K8s é›†ç¾¤æ•…éšœæ¢å¤å®å½•</title><link>https://dev-null-sec.github.io/posts/k8s%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E5%AE%9E%E5%BD%95/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/k8s%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E5%AE%9E%E5%BD%95/</guid><description>è®°å½•ä¸€æ¬¡ K8s é›†ç¾¤å¿«ç…§æ¢å¤å¯¼è‡´çš„æ•…éšœåŠå®Œæ•´æ¢å¤è¿‡ç¨‹ï¼ŒåŒ…æ‹¬æ—¶é—´åŒæ­¥ã€NFS æŒ‚è½½ã€Pod é‡å»ºç­‰å…³é”®æ­¥éª¤</description><pubDate>Thu, 15 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;äº‹æ•…ç°åœº&lt;/h2&gt;
&lt;p&gt;èµ·å› æ˜¯æˆ‘åœ¨åš K8s éƒ¨ç½² CI/CD å®éªŒæ—¶ï¼Œåªå¤‡ä»½äº† Master èŠ‚ç‚¹çš„å¿«ç…§ã€‚å½“æ—¶çš„æƒ³æ³•æ˜¯ï¼šetcd æ•°æ®ä¸»è¦åœ¨ Master ä¸Šï¼Œåªè¦ Master èƒ½æ¢å¤ï¼Œé›†ç¾¤å°±èƒ½æ¢å¤åˆ°å¯ç”¨çŠ¶æ€ï¼›å·¥ä½œèŠ‚ç‚¹å’Œå…¶ä»–ç»„ä»¶å³ä½¿æœ‰é—®é¢˜ä¹Ÿå¯ä»¥é‡æ–°æ‹‰èµ·æ¥ã€‚ä¹‹åè¿›è¡Œå…¶ä»–å®éªŒæ—¶ï¼Œä¸ºäº†å¿«é€Ÿå›åˆ°â€œå¹²å‡€ç¯å¢ƒâ€ï¼Œæˆ‘åœ¨å®éªŒç»“æŸåç›´æ¥å›æ»šäº† Master çš„å¿«ç…§ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é—®é¢˜æ¥äº†&lt;/strong&gt;ï¼šæˆ‘åªæ¢å¤äº† Masterï¼ŒNode1 å’Œ Node2 åªæ¢å¤äº†åˆšæ­å»ºk8sé›†ç¾¤æ—¶çš„å¿«ç…§ï¼&lt;/p&gt;
&lt;p&gt;é›†ç¾¤èµ·æ¥åç›´æ¥æ‡µäº†ï¼Œæ‰€æœ‰ Pod éƒ½æ˜¯ &lt;code&gt;Unknown&lt;/code&gt; çŠ¶æ€ï¼Œå®Œå…¨ä¸å·¥ä½œã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get pods -A
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;NAMESPACE     NAME                    READY   STATUS    RESTARTS   AGE
jenkins       jenkins-0               0/1     Unknown   0          3d
gitea         gitea-0                 0/1     Unknown   0          3d
argocd        argocd-server-xxx       0/1     Unknown   0          3d
...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¿™ä¸‹éº»çƒ¦äº†ï¼Œæ•´ä¸ªé›†ç¾¤æŒ‚äº†ã€‚&lt;/p&gt;
&lt;h2&gt;æ’æŸ¥æ€è·¯&lt;/h2&gt;
&lt;p&gt;å†·é™åˆ†æäº†ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Master æ¢å¤åˆ°äº†å‡ å¤©å‰çš„çŠ¶æ€&lt;/li&gt;
&lt;li&gt;Node1 å’Œ Node2 è¿˜æ˜¯&quot;æœ€åˆå§‹&quot;çš„çŠ¶æ€&lt;/li&gt;
&lt;li&gt;æ—¶é—´ä¸åŒæ­¥ï¼ŒèŠ‚ç‚¹è¯ä¹¦å¯èƒ½è¿‡æœŸ&lt;/li&gt;
&lt;li&gt;Kubelet å’Œ containerd çŠ¶æ€ä¸å¯¹&lt;/li&gt;
&lt;li&gt;ä¸€å † Pod å¡åœ¨ Unknownï¼Œéœ€è¦å¼ºåˆ¶é‡å»º&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;å¼€å§‹æŠ¢æ•‘&lt;/h2&gt;
&lt;h3&gt;ç¬¬ä¸€æ­¥ï¼šæ—¶é—´åŒæ­¥&lt;/h3&gt;
&lt;p&gt;æ—¶é—´ä¸åŒæ­¥ä¼šå¯¼è‡´å„ç§å¥‡æ€ªçš„é—®é¢˜ï¼Œå…ˆæŠŠä¸‰ä¸ªèŠ‚ç‚¹çš„æ—¶é—´å¯¹é½ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;systemctl start chronyd
chronyc makestep
hwclock -w
date  # ç¡®è®¤æ—¶é—´å·²ç»æ˜¯å½“å‰æ—¶é—´
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;ç¬¬äºŒæ­¥ï¼šå®‰è£… NFS å®¢æˆ·ç«¯&lt;/h3&gt;
&lt;p&gt;å› ä¸º Node æ¢å¤åæ²¡æœ‰ NFS å·¥å…·ï¼Œä½†é›†ç¾¤é‡Œçš„ PV éƒ½æ˜¯ NFS çš„ï¼Œä¼šå¯¼è‡´æŒ‚è½½å¤±è´¥ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ Node1 å’Œ Node2 ä¸Šæ‰§è¡Œï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;yum install -y nfs-utils
systemctl enable --now rpcbind
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;ç¬¬ä¸‰æ­¥ï¼šé‡å¯å®¹å™¨è¿è¡Œæ—¶&lt;/h3&gt;
&lt;p&gt;å¾ˆå¤š Pod çš„çŠ¶æ€æ˜¯æ—§çš„ï¼Œéœ€è¦é‡å¯ containerd å’Œ kubelet æ¸…ç†æ‰åƒµå°¸è¿›ç¨‹ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ Node1 å’Œ Node2 ä¸Šæ‰§è¡Œï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœæ­¢æ—§çš„å®¹å™¨è¿›ç¨‹ï¼ˆé˜²æ­¢åƒµå°¸è¿›ç¨‹å ç”¨ç«¯å£ï¼‰
systemctl restart containerd

# é‡å¯ kubelet
systemctl restart kubelet
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç­‰äº†å‡ åˆ†é’Ÿï¼Œçœ‹äº†ä¸‹èŠ‚ç‚¹çŠ¶æ€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get nodes
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;NAME         STATUS   ROLES           AGE   VERSION
k8s-master   Ready    control-plane   10d   v1.28.0
k8s-node1    Ready    &amp;lt;none&amp;gt;          10d   v1.28.0
k8s-node2    Ready    &amp;lt;none&amp;gt;          10d   v1.28.0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¥½ï¼ŒèŠ‚ç‚¹æ¢å¤ Ready äº†ã€‚ä½† Pod è¿˜æ˜¯ Unknownã€‚&lt;/p&gt;
&lt;h3&gt;ç¬¬å››æ­¥ï¼šå¼ºåˆ¶åˆ é™¤ Pod&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;Unknown&lt;/code&gt; çŠ¶æ€çš„ Pod å·²ç»æ²¡æ•‘äº†ï¼Œåªèƒ½å¼ºåˆ¶åˆ æ‰è®©å®ƒä»¬é‡å»ºã€‚&lt;/p&gt;
&lt;h4&gt;æ¢å¤ Jenkins&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n jenkins delete pod jenkins-0 --force --grace-period=0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç­‰äº†ä¸€ä¼šï¼Œæ–°çš„ Pod èµ·æ¥äº†ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n jenkins get pods
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;NAME        READY   STATUS    RESTARTS   AGE
jenkins-0   1/1     Running   0          2m
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;æ¢å¤ Gitea&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n gitea get pods
kubectl -n gitea delete pod --all --force --grace-period=0
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;æ¢å¤ ArgoCD&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n argocd delete pod --all --force --grace-period=0
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;æ¢å¤ NFS Provisioner&lt;/h4&gt;
&lt;p&gt;è¿™ä¸ªå¾ˆå…³é”®ï¼Œæ²¡æœ‰å®ƒ PVC å°±æ²¡æ³•è‡ªåŠ¨åˆ›å»ºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n kube-system get pods | grep nfs
kubectl -n kube-system delete pod -l app=nfs-subdir-external-provisioner --force --grace-period=0
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;ç¬¬äº”æ­¥ï¼šéªŒè¯&lt;/h3&gt;
&lt;p&gt;ç­‰æ‰€æœ‰ Pod éƒ½é‡å»ºå®Œæˆåï¼Œæ£€æŸ¥ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get pods -A
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;NAMESPACE     NAME                              READY   STATUS    RESTARTS   AGE
jenkins       jenkins-0                         1/1     Running   0          5m
gitea         gitea-0                           1/1     Running   0          4m
argocd        argocd-server-xxx                 1/1     Running   0          3m
argocd        argocd-application-controller-xxx 1/1     Running   0          3m
...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å…¨éƒ¨ Runningï¼&lt;/p&gt;
&lt;p&gt;è®¿é—®ä¸€ä¸‹æœåŠ¡ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Jenkins: &lt;code&gt;http://192.168.100.10:30080&lt;/code&gt; âœ…&lt;/li&gt;
&lt;li&gt;Gitea: &lt;code&gt;http://192.168.100.10:30030&lt;/code&gt; âœ…&lt;/li&gt;
&lt;li&gt;ArgoCD: &lt;code&gt;https://192.168.100.10:30090&lt;/code&gt; âœ…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;æ•°æ®ä¹Ÿéƒ½åœ¨ï¼Œå› ä¸ºç”¨çš„æ˜¯ NFS å­˜å‚¨ï¼Œæ²¡ä¸¢ã€‚&lt;/p&gt;
&lt;h2&gt;æ•™è®­&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;å¤‡ä»½è¦å…¨&lt;/strong&gt;ï¼šæ—¢ç„¶è¦å­˜å¿«ç…§ï¼ŒMaster å’Œ Node éƒ½å¾—å­˜ï¼Œä¸èƒ½åªå­˜ä¸€åŠ&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ—¶é—´åŒæ­¥å¾ˆé‡è¦&lt;/strong&gt;ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿå¯¹æ—¶é—´æ•æ„Ÿï¼Œä¸åŒæ­¥ä¼šå‡ºå„ç§å¥‡æ€ªé—®é¢˜&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;PV æ•°æ®è¿˜åœ¨å°±å¥½åŠ&lt;/strong&gt;ï¼šåªè¦æŒä¹…åŒ–å­˜å‚¨æ²¡ä¸¢ï¼ŒPod é‡å»ºå°±èƒ½æ¢å¤&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æŠ˜è…¾äº†ä¸€ä¸ªå¤šå°æ—¶ï¼Œæ€»ç®—æŠŠé›†ç¾¤æ•‘å›æ¥äº†ã€‚ä»¥ååšå®éªŒè¿˜æ˜¯å¾—å°å¿ƒç‚¹ï¼Œå¤šå¤‡ä»½ã€‚&lt;/p&gt;
</content:encoded></item><item><title>ä»é›¶æ­å»º K8s CI/CD æµæ°´çº¿å®æˆ˜è®°å½•</title><link>https://dev-null-sec.github.io/posts/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA-k8s-cicd-%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%AE%9E%E6%88%98%E8%AE%B0%E5%BD%95/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/%E4%BB%8E%E9%9B%B6%E6%90%AD%E5%BB%BA-k8s-cicd-%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%AE%9E%E6%88%98%E8%AE%B0%E5%BD%95/</guid><description>åŸºäº Kubernetes æ­å»ºå®Œæ•´ CI/CD æµæ°´çº¿å®æˆ˜ï¼Œæ¶µç›– Jenkinsã€Giteaã€ArgoCDã€Harbor çš„éƒ¨ç½²ä¸é›†æˆï¼Œå®ç° GitOps è‡ªåŠ¨åŒ–å‘å¸ƒ</description><pubDate>Wed, 14 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;æœ€è¿‘åœ¨å­¦äº‘åŸç”Ÿï¼Œæƒ³ç€å…‰çœ‹æ–‡æ¡£ä¸è¡Œï¼Œå¾—åŠ¨æ‰‹æ­ä¸ªçœŸå®çš„ CI/CD æµæ°´çº¿æ‰ç®—å…¥é—¨ã€‚æŠ˜è…¾äº†å·®ä¸å¤šä¸€å‘¨ï¼Œç»ˆäºæŠŠæ•´å¥—æµç¨‹è·‘é€šäº†ã€‚&lt;/p&gt;
&lt;h2&gt;æˆ‘çš„å®éªŒç¯å¢ƒ&lt;/h2&gt;
&lt;p&gt;æ‰‹ä¸Šæœ‰ 4 å°è™šæ‹Ÿæœºï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ä¸»æœºå&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;k8s-master&lt;/td&gt;
&lt;td&gt;192.168.100.10&lt;/td&gt;
&lt;td&gt;K8s ä¸»èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node1&lt;/td&gt;
&lt;td&gt;192.168.100.11&lt;/td&gt;
&lt;td&gt;Work èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node2&lt;/td&gt;
&lt;td&gt;192.168.100.12&lt;/td&gt;
&lt;td&gt;Work èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;harbor&lt;/td&gt;
&lt;td&gt;192.168.100.14&lt;/td&gt;
&lt;td&gt;ç§æœ‰é•œåƒä»“åº“&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;K8s é›†ç¾¤ä¹‹å‰å°±æ­å¥½äº†ï¼Œè¿™æ¬¡ä¸»è¦è®°å½•æ€ä¹ˆåœ¨ä¸Šé¢è·‘ Jenkinsã€Giteaã€ArgoCD è¿™äº›ä¸œè¥¿ã€‚&lt;/p&gt;
&lt;h2&gt;å…ˆè§£å†³å­˜å‚¨é—®é¢˜&lt;/h2&gt;
&lt;p&gt;ä¸€å¼€å§‹æˆ‘ç›´æ¥è£… Jenkinsï¼Œç»“æœé‡å¯ Pod åæ‰€æœ‰é…ç½®éƒ½æ²¡äº†ã€‚æ‰æ„è¯†åˆ°å¾—å…ˆæä¸ªæŒä¹…åŒ–å­˜å‚¨ï¼Œä¸ç„¶æ•°æ®å…¨åœ¨å†…å­˜é‡Œï¼Œé‡å¯å°±å®Œè›‹ã€‚&lt;/p&gt;
&lt;h3&gt;åœ¨ Harbor èŠ‚ç‚¹ä¸Šå®‰è£… NFS æœåŠ¡ç«¯&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;yum install -y nfs-utils rpcbind
systemctl enable rpcbind nfs-server
systemctl start rpcbind nfs-server

mkdir -p /data/nfs-share
chmod 777 /data/nfs-share  # ç®€å•ç²—æš´ç»™æƒé™ï¼Œé˜²æ­¢ K8s æŒ‚è½½æ—¶ Permission Denied

cat &amp;lt;&amp;lt;EOF &amp;gt;&amp;gt; /etc/exports
/data/nfs-share 192.168.100.0/24(rw,sync,no_root_squash,no_all_squash)
EOF

exportfs -r
showmount -e localhost  # æ£€æŸ¥æ˜¯å¦ç”Ÿæ•ˆ
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;åœ¨ K8s èŠ‚ç‚¹ä¸Šè£…å®¢æˆ·ç«¯&lt;/h3&gt;
&lt;p&gt;æ¯ä¸ª Node éƒ½å¾—è£… NFS å®¢æˆ·ç«¯ï¼Œä¸ç„¶æŒ‚è½½ä¸ä¸Šï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;yum install -y nfs-utils

# æµ‹è¯•ä¸€ä¸‹èƒ½ä¸èƒ½æ­£å¸¸æŒ‚è½½
mkdir -p /tmp/test-mount
mount -t nfs 192.168.100.14:/data/nfs-share /tmp/test-mount
touch /tmp/test-mount/hello.txt
umount /tmp/test-mount
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;èƒ½åˆ›å»ºæ–‡ä»¶å°±è¯´æ˜é€šäº†ã€‚&lt;/p&gt;
&lt;h3&gt;è®© K8s è‡ªåŠ¨åˆ›å»º PV&lt;/h3&gt;
&lt;p&gt;æ‰‹åŠ¨åˆ›å»º PV å¤ªéº»çƒ¦äº†ï¼Œè£…ä¸ª NFS Provisioner è®©å®ƒè‡ªåŠ¨æï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å…ˆè£… Helm
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# æ·»åŠ ä»“åº“
helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/

# å®‰è£… NFS Provisioner
helm install nfs-client nfs-subdir-external-provisioner/nfs-subdir-external-provisioner \
  --set nfs.server=192.168.100.14 \
  --set nfs.path=/data/nfs-share \
  --set storageClass.name=nfs-client \
  --set storageClass.defaultClass=true \
  --namespace kube-system
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è£…å¥½åçœ‹çœ‹æœ‰æ²¡æœ‰ StorageClassï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get sc
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æœ‰ &lt;code&gt;nfs-client (default)&lt;/code&gt; å°±å¯¹äº†ã€‚&lt;/p&gt;
&lt;p&gt;è¯•è¯•èƒ½ä¸èƒ½è‡ªåŠ¨åˆ†é…å­˜å‚¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; test-pvc.yaml
kind: PersistentVolumeClaim
apiVersion: v1
metadata:
  name: test-claim
spec:
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: 1Mi
EOF

kubectl apply -f test-pvc.yaml
kubectl get pvc
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;STATUS å˜æˆ &lt;code&gt;Bound&lt;/code&gt; å°±è¯´æ˜èƒ½ç”¨äº†ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete -f test-pvc.yaml  # æµ‹è¯•å®Œåˆ æ‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;å¼€å§‹è£… Jenkins&lt;/h2&gt;
&lt;p&gt;Jenkins æ˜¯æµæ°´çº¿çš„å¤§è„‘ï¼Œè¿™ä¸œè¥¿é…ç½®é¡¹ç‰¹åˆ«å¤šï¼Œç”¨ Helm è£…çœäº‹ã€‚&lt;/p&gt;
&lt;h3&gt;å†™é…ç½®æ–‡ä»¶&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; jenkins-manual.yaml
controller:
  image:
    repository: &quot;jenkins/jenkins&quot;
    tag: &quot;lts-jdk17&quot;
    pullPolicy: &quot;IfNotPresent&quot;
  
  # èµ„æºç»™è¶³ä¸€ç‚¹ï¼Œä¸ç„¶è·‘èµ·æ¥ä¼šå¡
  resources:
    requests:
      cpu: &quot;500m&quot;
      memory: &quot;1024Mi&quot;
    limits:
      cpu: &quot;1500m&quot;
      memory: &quot;2560Mi&quot;

  # ç®¡ç†å‘˜è´¦å·
  admin:
    createSecret: true
    username: &quot;admin&quot;
    password: &quot;admin123&quot;

  # NodePort æš´éœ²æœåŠ¡
  serviceType: NodePort
  servicePort: 8080
  nodePort: 30080

  # æŒä¹…åŒ–å­˜å‚¨
  persistence:
    enabled: true
    size: 8Gi
    storageClass: &quot;nfs-client&quot; 
    accessMode: ReadWriteOnce

  # å…ˆä¸è£…æ’ä»¶ï¼Œå¯åŠ¨åå†æ‰‹åŠ¨è£…
  installPlugins: []

  # è·³è¿‡åˆå§‹å‘å¯¼
  javaOpts: &quot;-Xms1024m -Xmx2048m -Djenkins.install.runSetupWizard=false&quot;

serviceAccount:
  create: true
  name: jenkins
rbac:
  create: true
  readSecrets: true
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å¼€å§‹è£…&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl create namespace jenkins

helm repo add jenkins https://charts.jenkins.io
helm repo update

helm install jenkins jenkins/jenkins -n jenkins -f jenkins-manual.yaml

# ç­‰ Pod Running
kubectl get pods -n jenkins -w
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;ç¬¬ä¸€ä¸ªå‘ï¼šService é…ç½®&lt;/h3&gt;
&lt;p&gt;ä¸€å¼€å§‹æˆ‘å‚è€ƒç½‘ä¸Šæ‰¾çš„é…ç½®æ–‡ä»¶ï¼ŒService éƒ¨åˆ†æ˜¯è¿™ä¹ˆå†™çš„ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;service:
  type: NodePort
  nodePort: 30080
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç»“æœè£…å®Œå‘ç° Service æ˜¯ ClusterIPï¼Œæ ¹æœ¬æ²¡æš´éœ²ç«¯å£ï¼Œå¤–é¢è®¿é—®ä¸äº†ã€‚&lt;/p&gt;
&lt;p&gt;ç¿»äº†ä¸‹å®˜æ–¹æ–‡æ¡£æ‰çŸ¥é“ï¼Œæ–°ç‰ˆæœ¬æ”¹äº†é…ç½®ç»“æ„ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;serviceType: NodePort
servicePort: 8080
nodePort: 30080
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ”¹å®Œé…ç½®é‡æ–°éƒ¨ç½²ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;helm upgrade jenkins jenkins/jenkins -n jenkins -f jenkins-manual.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç„¶åæµè§ˆå™¨è®¿é—® &lt;code&gt;http://192.168.100.10:30080&lt;/code&gt;ï¼Œè´¦å· &lt;code&gt;admin/admin123&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3&gt;è£…æ’ä»¶&lt;/h3&gt;
&lt;p&gt;è¿›å»åç¬¬ä¸€ä»¶äº‹å°±æ˜¯è£…æ’ä»¶ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Kubernetes&lt;/strong&gt; - è®© Jenkins èƒ½åœ¨ K8s é‡ŒåŠ¨æ€ç”Ÿæˆ Agent&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Pipeline&lt;/strong&gt; - æ„å»ºæµæ°´çº¿å¿…é¡»çš„&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Git&lt;/strong&gt; - æ‹‰å–ä»£ç &lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Blue Ocean&lt;/strong&gt; - å¥½çœ‹çš„æµæ°´çº¿ UIï¼ˆå¯é€‰ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Localization: Chinese (Simplified)&lt;/strong&gt; - ç®€ä½“ä¸­æ–‡åŒ…ï¼ˆå¯é€‰ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;å°å‘&lt;/strong&gt;ï¼šå®˜æ–¹æºä¸‹è½½å·¨æ…¢ï¼Œå¥½å‡ ä¸ªæ’ä»¶æŠ¥é”™è£…ä¸ä¸Šã€‚åæ¥æ¢äº†æ¸…åæºæ‰æå®šï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ¢å®Œæºé‡å¯ Jenkins å°±å¥½äº†ã€‚&lt;/p&gt;
&lt;h3&gt;è®© Jenkins è·‘åœ¨ K8s ä¸Š&lt;/h3&gt;
&lt;p&gt;è¿™æ˜¯å…³é”®é…ç½®ï¼Œè®© Jenkins èƒ½åœ¨ K8s é‡ŒåŠ¨æ€èµ· Pod æ¥æ„å»ºï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;è¿›å…¥ &lt;strong&gt;Manage Jenkins&lt;/strong&gt; â†’ &lt;strong&gt;Clouds&lt;/strong&gt; â†’ &lt;strong&gt;New Cloud&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;é€‰æ‹© &lt;strong&gt;Kubernetes&lt;/strong&gt;ï¼Œè¾“å…¥åç§° &lt;code&gt;kubernetes&lt;/code&gt;ï¼Œç‚¹å‡» Create&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;å¡«å…¥ä»¥ä¸‹é…ç½®ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Kubernetes URL&lt;/strong&gt;: &lt;code&gt;https://kubernetes.default&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Kubernetes Namespace&lt;/strong&gt;: &lt;code&gt;jenkins&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Credentials&lt;/strong&gt;: é€‰æ‹© Noneï¼ˆå› ä¸ºæˆ‘ä»¬å¼€å¯äº† RBACï¼Œä¼šè‡ªåŠ¨ç”¨ ServiceAccount è®¤è¯ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Jenkins URL&lt;/strong&gt;: &lt;code&gt;http://jenkins.jenkins.svc.cluster.local:8080&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Jenkins tunnel&lt;/strong&gt;: &lt;code&gt;jenkins.jenkins.svc.cluster.local:50000&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;ç‚¹ &lt;strong&gt;Test Connection&lt;/strong&gt;ï¼Œçœ‹åˆ° &lt;code&gt;Connected to Kubernetes v1.xx&lt;/code&gt; å°±æˆäº†&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;æµ‹è¯•ä¸€ä¸‹&lt;/h3&gt;
&lt;p&gt;å†™ä¸ªç®€å•çš„ Pipeline è¯•è¯•èƒ½ä¸èƒ½åœ¨ K8s é‡Œè·‘ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;pipeline {
  agent {
    kubernetes {
      yaml &apos;&apos;&apos;
      apiVersion: v1
      kind: Pod
      spec:
        containers:
        - name: shell
          image: busybox
          command: [&apos;sleep&apos;, &apos;infinity&apos;]
      &apos;&apos;&apos;
    }
  }
  stages {
    stage(&apos;Test&apos;) {
      steps {
        container(&apos;shell&apos;) {
          sh &apos;echo &quot;Success!&quot;&apos;
        }
      }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è·‘é€šäº†å°±è¯´æ˜ Jenkins èƒ½åœ¨ K8s é‡ŒåŠ¨æ€åˆ›å»º Pod äº†ã€‚&lt;/p&gt;
&lt;h2&gt;è£…ä¸ª Git ä»“åº“&lt;/h2&gt;
&lt;p&gt;Gitea æ¯” GitLab è½»é‡å¤šäº†ï¼Œæˆ‘è¿™å°é›†ç¾¤è·‘ GitLab ä¼°è®¡ç›´æ¥æŒ‚ã€‚&lt;/p&gt;
&lt;h3&gt;é…ç½®æ–‡ä»¶&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; gitea-lite.yaml
global:
  storageClass: &quot;nfs-client&quot;

# ç¦ç”¨å„ç§å¤æ‚çš„å¤–éƒ¨ä¾èµ–
redis:
  enabled: false
redis-cluster:
  enabled: false
valkey:
  enabled: false
valkey-cluster:
  enabled: false
postgresql:
  enabled: false
postgresql-ha:
  enabled: false

# Gitea æ ¸å¿ƒé…ç½®
gitea:
  # ä½¿ç”¨å†…ç½® SQLite3 æ•°æ®åº“
  config:
    database:
      DB_TYPE: sqlite3
    server:
      DOMAIN: &quot;gitea.local&quot; 
      ROOT_URL: &quot;http://192.168.100.10:30030/&quot;
      SSH_DOMAIN: &quot;192.168.100.10&quot;
      SSH_PORT: &quot;30022&quot;
      
  # ç®¡ç†å‘˜è´¦å·
  admin:
    username: &quot;admin&quot;
    password: &quot;admin123&quot;
    email: &quot;admin@example.com&quot;

# ç½‘ç»œæš´éœ²
service:
  http:
    type: NodePort
    port: 3000
    nodePort: 30030
  ssh:
    type: NodePort
    port: 22
    nodePort: 30022

# æŒä¹…åŒ–å­˜å‚¨
persistence:
  enabled: true
  size: 5Gi
  accessModes:
    - ReadWriteOnce
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;ç¬¬äºŒä¸ªå¤§å‘&lt;/h3&gt;
&lt;p&gt;ä¸€å¼€å§‹æˆ‘æ²¡æ³¨æ„é…ç½®æ–‡ä»¶ï¼Œç›´æ¥ &lt;code&gt;helm install&lt;/code&gt;ï¼Œç»“æœå®ƒç»™æˆ‘æ‹‰äº†ä¸€å † Redis Clusterã€PostgreSQL HA ä»€ä¹ˆçš„ï¼Œåå‡ ä¸ª Pod ç¬é—´æŠŠé›†ç¾¤æ’‘çˆ†äº†ã€‚&lt;/p&gt;
&lt;p&gt;èµ¶ç´§æŠŠé‚£äº›ç¼“å­˜å’Œé«˜å¯ç”¨ç»„ä»¶å…¨ç¦ç”¨æ‰ï¼Œåªç•™ä¸€ä¸ª Gitea Podï¼Œä¸–ç•Œæ¸…å‡€äº†ã€‚&lt;/p&gt;
&lt;h3&gt;å¼€å§‹è£…&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;helm repo add gitea-charts https://dl.gitea.com/charts/
helm repo update

kubectl create ns gitea
helm install gitea gitea-charts/gitea -n gitea -f gitea-lite.yaml

kubectl get pods -n gitea -w
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è®¿é—® &lt;code&gt;http://192.168.100.10:30030&lt;/code&gt;ï¼Œç¬¬ä¸€æ¬¡è¦ç‚¹&quot;å®‰è£…&quot;ï¼Œæ•°æ®åº“é€‰ SQLite3ï¼ˆæœ€ç®€å•ï¼‰ï¼Œå…¶ä»–ä¸ç”¨æ”¹ï¼Œç›´æ¥è£…ã€‚&lt;/p&gt;
&lt;p&gt;è£…å®Œç”¨ &lt;code&gt;admin/admin123&lt;/code&gt; ç™»å½•ï¼Œå»ºä¸ªæµ‹è¯•ä»“åº“ &lt;code&gt;demo-app&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h2&gt;Harbor å‡†å¤‡å·¥ä½œ&lt;/h2&gt;
&lt;p&gt;Harbor æˆ‘ä¹‹å‰å°±æ­å¥½äº†ï¼Œåœ¨ &lt;code&gt;192.168.100.14&lt;/code&gt; ä¸Šï¼ŒåŸŸå &lt;code&gt;reg.westos.org&lt;/code&gt;ï¼Œè´¦å· &lt;code&gt;admin/12345&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;h3&gt;è®© Jenkins èƒ½æ¨é•œåƒ&lt;/h3&gt;
&lt;p&gt;Jenkins è¦å¾€ Harbor æ¨é•œåƒï¼Œå¾—å…ˆç»™å®ƒä¸ªå‡­è¯ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl create secret docker-registry harbor-auth \
  --docker-server=reg.westos.org \
  --docker-username=admin \
  --docker-password=12345 \
  --docker-email=admin@westos.org \
  -n jenkins
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;æå‰æ¨ä¸ªåŸºç¡€é•œåƒ&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;docker pull nginx:latest
docker login reg.westos.org -u admin -p 12345
docker tag nginx:latest reg.westos.org/library/nginx:v1
docker push reg.westos.org/library/nginx:v1
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å†™ä¸ªç®€å•çš„ Dockerfile&lt;/h3&gt;
&lt;p&gt;åœ¨ &lt;code&gt;demo-app&lt;/code&gt; ä»“åº“æ ¹ç›®å½•å»ºä¸ª Dockerfileï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM reg.westos.org/library/nginx:v1
RUN echo &quot;Hello from Westos Harbor - v1&quot; &amp;gt; /usr/share/nginx/html/index.html
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åˆè¸©å‘äº†&lt;/strong&gt;ï¼šæœ€å¼€å§‹æˆ‘ç”¨ Alpine + &lt;code&gt;cat&lt;/code&gt; è¾“å‡ºå†…å®¹ï¼Œç»“æœå®¹å™¨ä¸€è·‘å°± CrashLoopBackOffã€‚åæ¥æ‰æƒ³æ˜ç™½ï¼Œ&lt;code&gt;cat&lt;/code&gt; æ‰§è¡Œå®Œè¿›ç¨‹å°±é€€äº†ï¼Œå®¹å™¨å½“ç„¶æŒ‚ã€‚æ¢æˆ Nginx æ‰æ­£å¸¸ã€‚&lt;/p&gt;
&lt;h3&gt;è®© Jenkins èƒ½æ‹‰ä»£ç &lt;/h3&gt;
&lt;p&gt;Gitea ä»“åº“æ˜¯ç§æœ‰çš„ï¼Œå¾—ç»™ Jenkins é…ä¸ªå‡­è¯ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;è¿›å…¥ &lt;strong&gt;Manage Jenkins&lt;/strong&gt; â†’ &lt;strong&gt;Credentials&lt;/strong&gt; â†’ &lt;strong&gt;System&lt;/strong&gt; â†’ &lt;strong&gt;Global credentials&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;ç‚¹å‡» &lt;strong&gt;Add Credentials&lt;/strong&gt;ï¼š
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Kind&lt;/strong&gt;: Username with password&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Username&lt;/strong&gt;: &lt;code&gt;admin&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Password&lt;/strong&gt;: &lt;code&gt;admin123&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ID&lt;/strong&gt;: &lt;code&gt;gitea-auth&lt;/code&gt;ï¼ˆè®°ä½è¿™ä¸ª IDï¼Œæµæ°´çº¿è¦ç”¨ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Description&lt;/strong&gt;: Gitea Admin&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;å†™ç¬¬ä¸€æ¡æµæ°´çº¿&lt;/h2&gt;
&lt;p&gt;ç»ˆäºåˆ°å…³é”®ç¯èŠ‚äº†ï¼Œå†™ä¸ª Pipeline è®© Jenkins è‡ªåŠ¨æ„å»ºé•œåƒã€‚&lt;/p&gt;
&lt;p&gt;åœ¨ Jenkins åˆ›å»ºä¸€ä¸ªæ–°çš„æµæ°´çº¿ä»»åŠ¡ï¼Œç²˜è´´ä»¥ä¸‹ä»£ç ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;pipeline {
  agent {
    kubernetes {
      yaml &apos;&apos;&apos;
      apiVersion: v1
      kind: Pod
      spec:
        # è®© Pod çŸ¥é“åŸŸåçš„ IP
        hostAliases:
        - ip: &quot;192.168.100.14&quot;
          hostnames:
          - &quot;reg.westos.org&quot;
        
        containers:
        - name: kaniko
          # ä½¿ç”¨ debug ç‰ˆæœ¬ï¼ŒåŒ…å« shell æ–¹ä¾¿è°ƒè¯•
          image: gcr.io/kaniko-project/executor:debug
          command:
          - sleep
          - infinity
          volumeMounts:
          - name: registry-creds
            mountPath: /kaniko/.docker/
        
        volumes:
        - name: registry-creds
          secret:
            secretName: harbor-auth
            items:
              - key: .dockerconfigjson
                path: config.json
      &apos;&apos;&apos;
    }
  }

  stages {
    stage(&apos;Checkout Code&apos;) {
      steps {
        git credentialsId: &apos;gitea-auth&apos;, 
            url: &apos;http://192.168.100.10:30030/admin/demo-app.git&apos;,
            branch: &apos;main&apos;
      }
    }

    stage(&apos;Build &amp;amp; Push&apos;) {
      steps {
        container(&apos;kaniko&apos;) {
          sh &apos;&apos;&apos;
            /kaniko/executor \
            --context `pwd` \
            --dockerfile `pwd`/Dockerfile \
            --destination reg.westos.org/library/demo-app:v1 \
            --skip-tls-verify \
            --insecure
          &apos;&apos;&apos;
        }
      }
    }
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç‚¹&quot;ç«‹å³æ„å»º&quot;ï¼Œç„¶åå°±çœ‹ç€ Jenkins è‡ªå·±è·‘ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;åœ¨ K8s é‡Œèµ·ä¸ª Kaniko Pod&lt;/li&gt;
&lt;li&gt;ä» Gitea æ‹‰ä»£ç &lt;/li&gt;
&lt;li&gt;æ„å»ºé•œåƒ&lt;/li&gt;
&lt;li&gt;æ¨åˆ° Harbor&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;æˆåŠŸåå» Harbor çœ‹çœ‹ï¼Œ&lt;code&gt;library/demo-app:v1&lt;/code&gt; åº”è¯¥å°±åœ¨é‚£äº†ã€‚&lt;/p&gt;
&lt;h2&gt;è£… ArgoCD å®ç° GitOps&lt;/h2&gt;
&lt;p&gt;ArgoCD æ˜¯ GitOps çš„çµé­‚ï¼Œå®ƒä¼šç›¯ç€ Git ä»“åº“ï¼Œä¸€æœ‰å˜åŒ–å°±è‡ªåŠ¨åŒæ­¥åˆ° K8sã€‚&lt;/p&gt;
&lt;h3&gt;è£…ä¸Šå»&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl create namespace argocd
kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml

# æš´éœ²æœåŠ¡
kubectl patch svc argocd-server -n argocd -p &apos;{&quot;spec&quot;: {&quot;type&quot;: &quot;NodePort&quot;, &quot;ports&quot;: [{&quot;port&quot;: 443, &quot;targetPort&quot;: 8080, &quot;nodePort&quot;: 30090}]}}&apos;

# è·å–åˆå§‹å¯†ç 
kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath=&quot;{.data.password}&quot; | base64 -d; echo
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æµè§ˆå™¨è®¿é—® &lt;code&gt;https://192.168.100.10:30090&lt;/code&gt;ï¼ˆä¼šæŠ¥ä¸å®‰å…¨ï¼Œæ— è§†å®ƒç»§ç»­å°±è¡Œï¼‰ï¼Œç”¨ &lt;code&gt;admin&lt;/code&gt; å’Œåˆšæ‰çš„å¯†ç ç™»å½•ã€‚&lt;/p&gt;
&lt;h3&gt;å‡†å¤‡éƒ¨ç½²é…ç½®&lt;/h3&gt;
&lt;p&gt;åœ¨ Gitea çš„ &lt;code&gt;demo-app&lt;/code&gt; ä»“åº“é‡Œå»ºä¸ª &lt;code&gt;deploy&lt;/code&gt; æ–‡ä»¶å¤¹ï¼Œå†™ä¸ª &lt;code&gt;deployment.yaml&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: demo-app
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: demo-app
  template:
    metadata:
      labels:
        app: demo-app
    spec:
      # è®© K8s èŠ‚ç‚¹çŸ¥é“æ€ä¹ˆè§£æ reg.westos.org
      hostAliases:
      - ip: &quot;192.168.100.14&quot;
        hostnames:
        - &quot;reg.westos.org&quot;
        
      containers:
      - name: demo-app
        image: reg.westos.org/library/demo-app:v1
        imagePullPolicy: Always
        ports:
        - containerPort: 80
      
      # æ‹‰å–ç§æœ‰é•œåƒçš„å‡­è¯
      imagePullSecrets:
      - name: harbor-auth
---
apiVersion: v1
kind: Service
metadata:
  name: demo-app-svc
  namespace: default
spec:
  type: NodePort
  selector:
    app: demo-app
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30088
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ³¨æ„&lt;/strong&gt;ï¼šè¦éƒ¨ç½²åˆ° &lt;code&gt;default&lt;/code&gt; å‘½åç©ºé—´ï¼Œé‚£é‡Œä¹Ÿå¾—æœ‰ Harbor å‡­è¯ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl create secret docker-registry harbor-auth \
  --docker-server=reg.westos.org \
  --docker-username=admin \
  --docker-password=12345 \
  --docker-email=admin@westos.org \
  -n default
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æˆ‘å°±æ˜¯å¿˜äº†è¿™èŒ¬ï¼ŒPod ä¸€ç›´ &lt;code&gt;ImagePullBackOff&lt;/code&gt;ï¼ŒæŸ¥äº†åŠå¤©æ‰ååº”è¿‡æ¥ã€‚&lt;/p&gt;
&lt;h3&gt;åœ¨ ArgoCD é‡Œé…ç½®åº”ç”¨&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;ç™»å½• ArgoCD UI&lt;/li&gt;
&lt;li&gt;ç‚¹å‡»å·¦ä¸Šè§’ &lt;strong&gt;+ NEW APP&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;å¡«å…¥ä»¥ä¸‹é…ç½®ï¼š
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Application Name&lt;/strong&gt;: &lt;code&gt;demo-app&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Project Name&lt;/strong&gt;: &lt;code&gt;default&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Sync Policy&lt;/strong&gt;: &lt;code&gt;Automatic&lt;/code&gt;ï¼ˆè‡ªåŠ¨åŒæ­¥ï¼‰
&lt;ul&gt;
&lt;li&gt;å‹¾é€‰ &lt;strong&gt;Prune Resources&lt;/strong&gt;ï¼ˆGit åˆ äº†æ–‡ä»¶ï¼ŒK8s ä¹Ÿè·Ÿç€åˆ ï¼‰&lt;/li&gt;
&lt;li&gt;å‹¾é€‰ &lt;strong&gt;Self Heal&lt;/strong&gt;ï¼ˆæ‰‹åŠ¨æ”¹ K8s ä¼šè¢«è‡ªåŠ¨è¿˜åŸï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Repository URL&lt;/strong&gt;: &lt;code&gt;http://192.168.100.10:30030/admin/demo-app.git&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Revision&lt;/strong&gt;: &lt;code&gt;main&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Path&lt;/strong&gt;: &lt;code&gt;deploy&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Cluster URL&lt;/strong&gt;: &lt;code&gt;https://kubernetes.default.svc&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Namespace&lt;/strong&gt;: &lt;code&gt;default&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;ç‚¹å‡» &lt;strong&gt;CREATE&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;åˆ›å»ºåï¼ŒArgoCD è‡ªå·±ä¼šä» Gitea æ‹‰ YAML æ–‡ä»¶éƒ¨ç½²åˆ° K8sã€‚ç­‰ä¸€ä¼šçŠ¶æ€å˜æˆ &lt;code&gt;Healthy&lt;/code&gt; å’Œ &lt;code&gt;Synced&lt;/code&gt; å°±å¥½äº†ã€‚&lt;/p&gt;
&lt;h2&gt;å®Œæ•´è·‘ä¸€é&lt;/h2&gt;
&lt;p&gt;ç°åœ¨ CI/CD å·²ç»é€šäº†ï¼Œæµ‹è¯•ä¸‹å®Œæ•´æµç¨‹ã€‚&lt;/p&gt;
&lt;h3&gt;CI éƒ¨åˆ†&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;ä¿®æ”¹ Gitea ä¸­çš„ &lt;code&gt;Dockerfile&lt;/code&gt;ï¼ŒæŠŠ &lt;code&gt;v1&lt;/code&gt; æ”¹æˆ &lt;code&gt;v2&lt;/code&gt;ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;FROM reg.westos.org/library/nginx:v1
RUN echo &quot;Hello from Westos Harbor - v2&quot; &amp;gt; /usr/share/nginx/html/index.html
&lt;/code&gt;&lt;/pre&gt;
&lt;ol&gt;
&lt;li&gt;åœ¨ Jenkins æ‰‹åŠ¨è§¦å‘æ„å»ºï¼ˆæˆ–è€…é…ç½® Webhook è‡ªåŠ¨è§¦å‘ï¼‰&lt;/li&gt;
&lt;li&gt;ä¿®æ”¹ Pipeline ä¸­çš„é•œåƒ tagï¼ŒæŠŠ &lt;code&gt;destination&lt;/code&gt; æ”¹æˆ &lt;code&gt;demo-app:v2&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;æ„å»ºæˆåŠŸåï¼ŒHarbor é‡Œä¼šå‡ºç° &lt;code&gt;v2&lt;/code&gt; æ ‡ç­¾çš„é•œåƒ&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;CD éƒ¨åˆ†&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;åœ¨ Gitea ä¸­è¿›å…¥ &lt;code&gt;deploy&lt;/code&gt; ç›®å½•ï¼Œç¼–è¾‘ &lt;code&gt;deployment.yaml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;æŠŠé•œåƒ tag ä» &lt;code&gt;v1&lt;/code&gt; æ”¹æˆ &lt;code&gt;v2&lt;/code&gt;ï¼š&lt;/li&gt;
&lt;/ol&gt;
&lt;pre&gt;&lt;code&gt;image: reg.westos.org/library/demo-app:v2
&lt;/code&gt;&lt;/pre&gt;
&lt;ol&gt;
&lt;li&gt;æäº¤æ›´æ”¹&lt;/li&gt;
&lt;li&gt;å» ArgoCD ç•Œé¢ï¼Œç‚¹å‡» &lt;code&gt;demo-app&lt;/code&gt; åº”ç”¨çš„ &lt;strong&gt;Refresh&lt;/strong&gt; æŒ‰é’®ï¼ˆå¦‚æœé…ç½®äº†è‡ªåŠ¨åŒæ­¥ï¼Œç­‰å‡ åç§’å®ƒè‡ªå·±ä¼šæ£€æµ‹åˆ°å˜åŒ–ï¼‰&lt;/li&gt;
&lt;li&gt;ArgoCD ä¼šå‘ç°æ–°ç‰ˆæœ¬é•œåƒï¼Œè§¦å‘æ»šåŠ¨æ›´æ–°&lt;/li&gt;
&lt;li&gt;æ—§çš„ Pod ä¼šè¢« Terminatingï¼Œæ–°çš„ Pod ä¼šå¯åŠ¨&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;img src=&quot;https://dev-null-sec.github.io/images/posts/29295ce94ad216d1f32b362fc79edb74.png&quot; alt=&quot;29295ce94ad216d1f32b362fc79edb74&quot; /&gt;&lt;/p&gt;
&lt;h3&gt;éªŒè¯&lt;/h3&gt;
&lt;p&gt;æµè§ˆå™¨æ‰“å¼€ &lt;code&gt;http://192.168.100.10:30088&lt;/code&gt;ï¼Œçœ‹åˆ° &quot;Hello from Westos Harbor - v2&quot; å°±è¯´æ˜æ•´æ¡é“¾è·¯é€šäº†ï¼&lt;/p&gt;
&lt;h2&gt;æŠ˜è…¾å®Œçš„ä¸€äº›æ„Ÿå—&lt;/h2&gt;
&lt;p&gt;æäº†è¿™ä¹ˆä¹…ï¼Œæ€»ç®—æŠŠ CI/CD è¿™å¥—ä¸œè¥¿è·‘é€šäº†ã€‚å‡ ä¸ªä½“ä¼šï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;å­˜å‚¨åˆ«çœ&lt;/strong&gt; - ä¸€å¼€å§‹å«Œ NFS éº»çƒ¦ï¼Œåæ¥å‘ç°ä¸ææŒä¹…åŒ–æ ¹æœ¬æ²¡æ³•ç©&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;èµ„æºç»™è¶³&lt;/strong&gt; - Jenkins æŒºåƒèµ„æºçš„ï¼Œé…å°‘äº†ä¼šå¡æ­»&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;GitOps ç¡®å®çˆ½&lt;/strong&gt; - æ”¹ä¸ª YAML æ¨ä¸Šå»ï¼Œè‡ªåŠ¨å°±éƒ¨ç½²äº†ï¼Œå†ä¹Ÿä¸ç”¨ SSH ä¸Šå»æ‰‹åŠ¨é‡å¯å®¹å™¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è¸©å‘æ˜¯å¸¸æ€&lt;/strong&gt; - Service é…ç½®ã€å‡­è¯å‘½åç©ºé—´ã€å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œæ¯ä¸ªéƒ½è¸©äº†ä¸€é&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦‚æœä½ ä¹Ÿåœ¨æŠ˜è…¾è¿™äº›ä¸œè¥¿ï¼Œæœ‰é—®é¢˜æ¬¢è¿äº¤æµã€‚åæ­£æˆ‘è¿™ä¸€è·¯è¸©çš„å‘å¤Ÿå¤šäº†ï¼Œè¯´ä¸å®šèƒ½å¸®ä¸Šå¿™ã€‚&lt;/p&gt;
</content:encoded></item><item><title>Kubernetes é›†ç¾¤å‡çº§ä¸é«˜å¯ç”¨éƒ¨ç½²</title><link>https://dev-null-sec.github.io/posts/k8s%E9%9B%86%E7%BE%A4%E5%8D%87%E7%BA%A7%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/k8s%E9%9B%86%E7%BE%A4%E5%8D%87%E7%BA%A7%E4%B8%8E%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/</guid><description>è®°å½• k8s é›†ç¾¤å‡çº§æµç¨‹å’Œé«˜å¯ç”¨é›†ç¾¤æ­å»ºè¿‡ç¨‹ï¼Œä½¿ç”¨ kube-vip å®ç° VIP é«˜å¯ç”¨</description><pubDate>Mon, 12 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;è®°å½• k8s é›†ç¾¤çš„ç‰ˆæœ¬å‡çº§å’Œé«˜å¯ç”¨éƒ¨ç½²è¿‡ç¨‹ã€‚å…ˆå¯¹å• master é›†ç¾¤è¿›è¡Œå‡çº§ï¼Œç„¶åæ­å»ºä¸€ä¸ªä¸‰ master çš„é«˜å¯ç”¨é›†ç¾¤ï¼Œä½¿ç”¨ kube-vip å®ç° VIP æ¼‚ç§»ã€‚&lt;/p&gt;
&lt;h2&gt;ç¬¬ä¸€éƒ¨åˆ†ï¼šé›†ç¾¤å‡çº§&lt;/h2&gt;
&lt;h3&gt;ç¯å¢ƒè¯´æ˜&lt;/h3&gt;
&lt;p&gt;ç°æœ‰é›†ç¾¤ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;k8s-master: 192.168.100.20&lt;/li&gt;
&lt;li&gt;k8s-node1: 192.168.100.21&lt;/li&gt;
&lt;li&gt;k8s-node2: 192.168.100.22&lt;/li&gt;
&lt;li&gt;å½“å‰ç‰ˆæœ¬ï¼šv1.33.5&lt;/li&gt;
&lt;li&gt;ç›®æ ‡ç‰ˆæœ¬ï¼šv1.34.1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/&quot;&gt;å‡çº§æŒ‡å—&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/releases/version-skew-policy/&quot;&gt;ç‰ˆæœ¬åå·®ç­–ç•¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;å‡çº§ Master èŠ‚ç‚¹&lt;/h3&gt;
&lt;h4&gt;1. ä¿®æ”¹ yum æº&lt;/h4&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹ä¿®æ”¹æºç‰ˆæœ¬ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.34/rpm/
enabled=1
gpgcheck=0
EOF

yum makecache fast
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2. å‡†å¤‡é•œåƒ&lt;/h4&gt;
&lt;p&gt;åœ¨ harbor èŠ‚ç‚¹ä¸Šæ‹‰å–é•œåƒå¹¶æ¨é€åˆ°ç§æœ‰ä»“åº“ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ‹‰å–é˜¿é‡Œäº‘é•œåƒ
docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.34.1
docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.34.1
docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.34.1
docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.34.1
docker pull registry.aliyuncs.com/google_containers/coredns:v1.12.1
docker pull registry.aliyuncs.com/google_containers/pause:3.10.1
docker pull registry.aliyuncs.com/google_containers/etcd:3.6.4-0

# æ‰“æ ‡ç­¾å¹¶æ¨é€åˆ° Harbor
docker images |grep google_containers | awk &apos;{print $1&quot;:&quot;$2}&apos; | awk -F/ &apos;{system(&quot;docker tag &quot;$0&quot; reg.westos.org/k8s/&quot;$3&quot;&quot;)}&apos;
docker images |grep reg.westos.org/k8s | awk &apos;{system(&quot;docker push &quot;$1&quot;:&quot;$2&quot;&quot;)}&apos;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3. ä¿®æ”¹ containerd é…ç½®&lt;/h4&gt;
&lt;p&gt;åœ¨æ‰€æœ‰èŠ‚ç‚¹æ›´æ–° pause é•œåƒç‰ˆæœ¬ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sed -i &apos;s#sandbox_image = &quot;.*&quot;#sandbox_image = &quot;reg.westos.org/k8s/pause:3.10.1&quot;#g&apos; /etc/containerd/config.toml
systemctl restart containerd
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4. å‡çº§ kubeadm&lt;/h4&gt;
&lt;p&gt;åœ¨ master èŠ‚ç‚¹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;yum install -y kubeadm-1.34.1

# éªŒè¯ç‰ˆæœ¬
kubeadm version
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubeadm version: &amp;amp;version.Info{Major:&quot;1&quot;, Minor:&quot;34&quot;, GitVersion:&quot;v1.34.1&quot;, ...}
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;5. éªŒè¯å‡çº§è®¡åˆ’&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;kubeadm upgrade plan
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¼šåˆ—å‡ºå¯å‡çº§çš„ç‰ˆæœ¬å’Œç»„ä»¶å˜åŒ–ã€‚&lt;/p&gt;
&lt;h4&gt;6. æ‰§è¡Œå‡çº§&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;kubeadm upgrade apply v1.34.1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç­‰å¾…å‡çº§å®Œæˆï¼Œä¼šçœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[upgrade/successful] SUCCESS! Your cluster was upgraded to &quot;v1.34.1&quot;. Enjoy!
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;7. å‡çº§ kubelet å’Œ kubectl&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# è…¾ç©ºèŠ‚ç‚¹ï¼ˆé©±é€ Podï¼‰
kubectl drain k8s-master --ignore-daemonsets

# å‡çº§ç»„ä»¶
yum install -y kubelet-1.34.1 kubectl-1.34.1

# é‡å¯ kubelet
systemctl daemon-reload
systemctl restart kubelet

# è§£é™¤ä¿æŠ¤
kubectl uncordon k8s-master

# éªŒè¯
kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å‡çº§ Worker èŠ‚ç‚¹&lt;/h3&gt;
&lt;p&gt;åœ¨æ¯ä¸ª worker èŠ‚ç‚¹ä¸Šä¾æ¬¡æ‰§è¡Œï¼š&lt;/p&gt;
&lt;h4&gt;1. å‡çº§ kubeadm&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;yum install -y kubeadm-1.34.1
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2. å‡çº§èŠ‚ç‚¹&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;kubeadm upgrade node
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3. å‡çº§ kubelet&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨ master ä¸Šè…¾ç©ºèŠ‚ç‚¹
kubectl drain k8s-node1 --ignore-daemonsets

# åœ¨ node1 ä¸Šå‡çº§
yum install -y kubelet-1.34.1
systemctl daemon-reload
systemctl restart kubelet

# åœ¨ master ä¸Šè§£é™¤ä¿æŠ¤
kubectl uncordon k8s-node1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¯¹ node2 é‡å¤ç›¸åŒæ­¥éª¤ã€‚&lt;/p&gt;
&lt;h3&gt;éªŒè¯å‡çº§ç»“æœ&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME         STATUS   ROLES           AGE   VERSION
k8s-master   Ready    control-plane   10d   v1.34.1
k8s-node1    Ready    &amp;lt;none&amp;gt;          10d   v1.34.1
k8s-node2    Ready    &amp;lt;none&amp;gt;          10d   v1.34.1
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h2&gt;ç¬¬äºŒéƒ¨åˆ†ï¼šé«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²&lt;/h2&gt;
&lt;h3&gt;ç¯å¢ƒè§„åˆ’&lt;/h3&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ä¸»æœº&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;k8s-master01&lt;/td&gt;
&lt;td&gt;192.168.100.20&lt;/td&gt;
&lt;td&gt;æ§åˆ¶å¹³é¢èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-master02&lt;/td&gt;
&lt;td&gt;192.168.100.21&lt;/td&gt;
&lt;td&gt;æ§åˆ¶å¹³é¢èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-master03&lt;/td&gt;
&lt;td&gt;192.168.100.22&lt;/td&gt;
&lt;td&gt;æ§åˆ¶å¹³é¢èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-worker01&lt;/td&gt;
&lt;td&gt;192.168.100.23&lt;/td&gt;
&lt;td&gt;å·¥ä½œèŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;harbor&lt;/td&gt;
&lt;td&gt;192.168.100.14&lt;/td&gt;
&lt;td&gt;ç§æœ‰é•œåƒä»“åº“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;VIP&lt;/td&gt;
&lt;td&gt;192.168.100.200&lt;/td&gt;
&lt;td&gt;è™šæ‹Ÿ IPï¼ˆæ¼‚ç§»ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;è½¯ä»¶ç‰ˆæœ¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;k8s: v1.34.1&lt;/li&gt;
&lt;li&gt;kube-vip: v1.0.1&lt;/li&gt;
&lt;li&gt;Calico: v3.31.0&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Harbor ä»“åº“åœ°å€ï¼š&lt;code&gt;reg.westos.org&lt;/code&gt;&lt;/p&gt;
&lt;h3&gt;ç³»ç»Ÿåˆå§‹åŒ–&lt;/h3&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼ˆå‚è€ƒæ­å»ºk8sé›†ç¾¤æ–‡ç« çš„å®Œæ•´æµç¨‹ï¼‰ã€‚&lt;/p&gt;
&lt;h4&gt;å…³é—­ swap&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;swapoff -a
sed -i &apos;/swap/s/^/#/&apos; /etc/fstab
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;è°ƒæ•´å†…æ ¸å‚æ•°&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

sysctl --system
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;é…ç½®ä¸»æœºåå’Œè§£æ&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨å„èŠ‚ç‚¹è®¾ç½®ä¸»æœºå
hostnamectl set-hostname k8s-master01  # master01 ä¸Š
hostnamectl set-hostname k8s-master02  # master02 ä¸Š
hostnamectl set-hostname k8s-master03  # master03 ä¸Š
hostnamectl set-hostname k8s-worker01  # worker01 ä¸Š

# æ‰€æœ‰èŠ‚ç‚¹æ·»åŠ  hosts
cat &amp;gt;&amp;gt; /etc/hosts &amp;lt;&amp;lt;EOF
192.168.100.20  k8s-master01
192.168.100.21  k8s-master02
192.168.100.22  k8s-master03
192.168.100.23  k8s-worker01
192.168.100.14  reg.westos.org
192.168.100.200 k8s-apiserver
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;é…ç½® yum æº&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.34/rpm/
enabled=1
gpgcheck=0
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;é…ç½® IPVS&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; /etc/modules-load.d/ipvs.conf &amp;lt;&amp;lt;EOF
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
overlay
br_netfilter
EOF

modprobe ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack overlay br_netfilter
dnf install -y ipvsadm ipset
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å®‰è£… containerd&lt;/h3&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹å®‰è£…ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;yum install -y containerd.io cri-tools
containerd config default &amp;gt; /etc/containerd/config.toml

# å¯ç”¨ systemd cgroup
sed -i &apos;s#SystemdCgroup = false#SystemdCgroup = true#g&apos; /etc/containerd/config.toml

systemctl enable --now containerd

# é…ç½® crictl
cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;é…ç½® Harbor è¯ä¹¦&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºç›®å½•
mkdir -p /etc/containerd/certs.d/reg.westos.org

# ä» harbor å¤åˆ¶è¯ä¹¦ï¼ˆåœ¨å„èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼‰
scp root@192.168.100.14:/etc/docker/certs.d/reg.westos.org/ca.crt /etc/containerd/certs.d/reg.westos.org/

# ä¿®æ”¹ containerd é…ç½®
sed -i &quot;s#config_path = &apos;&apos;#config_path = &apos;/etc/containerd/certs.d&apos;#g&quot; /etc/containerd/config.toml
sed -i &quot;s#registry.k8s.io/pause.*#reg.westos.org/k8s/pause:3.10.1&apos;#g&quot; /etc/containerd/config.toml

systemctl restart containerd
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å®‰è£… k8s ç»„ä»¶&lt;/h3&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹å®‰è£…ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;yum install -y kubelet kubeadm kubectl
systemctl enable --now kubelet
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;éƒ¨ç½² kube-vipï¼ˆç¬¬ä¸€ä¸ª masterï¼‰&lt;/h3&gt;
&lt;p&gt;kube-vip ç”¨äºå®ç°æ§åˆ¶å¹³é¢çš„é«˜å¯ç”¨ï¼Œé€šè¿‡ VIP æ¼‚ç§»ç¡®ä¿ apiserver çš„è®¿é—®å…¥å£å§‹ç»ˆå¯ç”¨ã€‚&lt;/p&gt;
&lt;h4&gt;å‡†å¤‡ kube-vip é•œåƒ&lt;/h4&gt;
&lt;p&gt;åœ¨ harbor èŠ‚ç‚¹ä¸Šï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull ghcr.io/kube-vip/kube-vip:v1.0.1

# æ‰“æ ‡ç­¾å¹¶æ¨é€
docker tag ghcr.io/kube-vip/kube-vip:v1.0.1 reg.westos.org/kube-vip/kube-vip:v1.0.1
docker push reg.westos.org/kube-vip/kube-vip:v1.0.1
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;åˆ›å»º kube-vip é™æ€ Pod&lt;/h4&gt;
&lt;p&gt;åœ¨ master01 ä¸Šåˆ›å»º kube-vip é…ç½®ï¼ˆæ³¨æ„ï¼šè¦åœ¨åˆå§‹åŒ–é›†ç¾¤&lt;strong&gt;ä¹‹å‰&lt;/strong&gt;åˆ›å»ºï¼‰ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å…ˆåˆ›å»º manifests ç›®å½•
mkdir -p /etc/kubernetes/manifests

# åˆ›å»º kube-vip é…ç½®
cat &amp;gt; /etc/kubernetes/manifests/kube-vip.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: kube-vip
  namespace: kube-system
spec:
  containers:
  - args:
    - manager
    env:
    - name: vip_arp
      value: &quot;true&quot;
    - name: port
      value: &quot;6443&quot;
    - name: vip_nodename
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: vip_interface
      value: ens160
    - name: vip_subnet
      value: &quot;32&quot;
    - name: dns_mode
      value: first
    - name: cp_enable
      value: &quot;true&quot;
    - name: cp_namespace
      value: kube-system
    - name: svc_enable
      value: &quot;true&quot;
    - name: svc_leasename
      value: plndr-svcs-lock
    - name: vip_leaderelection
      value: &quot;true&quot;
    - name: vip_leasename
      value: plndr-cp-lock
    - name: vip_leaseduration
      value: &quot;5&quot;
    - name: vip_renewdeadline
      value: &quot;3&quot;
    - name: vip_retryperiod
      value: &quot;1&quot;
    - name: address
      value: 192.168.100.200
    - name: prometheus_server
      value: :2112
    image: reg.westos.org/kube-vip/kube-vip:v1.0.1
    imagePullPolicy: IfNotPresent
    name: kube-vip
    resources: {}
    securityContext:
      capabilities:
        add:
        - NET_ADMIN
        - NET_RAW
        drop:
        - ALL
    volumeMounts:
    - mountPath: /etc/kubernetes/admin.conf
      name: kubeconfig
  hostAliases:
  - hostnames:
    - kubernetes
    ip: 127.0.0.1
  hostNetwork: true
  volumes:
  - hostPath:
      path: /etc/kubernetes/super-admin.conf
    name: kubeconfig
status: {}
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å‡†å¤‡é›†ç¾¤åˆå§‹åŒ–é…ç½®&lt;/h3&gt;
&lt;p&gt;åœ¨ master01 ä¸Šåˆ›å»ºé…ç½®æ–‡ä»¶ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; kubeadm-config.yaml &amp;lt;&amp;lt;EOF
apiVersion: kubeadm.k8s.io/v1beta4
kind: InitConfiguration
bootstrapTokens:
- groups:
  - system:bootstrappers:kubeadm:default-node-token
  token: abcdef.0123456789abcdef
  ttl: 24h0m0s
  usages:
  - signing
  - authentication
localAPIEndpoint:
  advertiseAddress: 192.168.100.20    # master01 æœ¬æœº IP
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///var/run/containerd/containerd.sock
  imagePullPolicy: IfNotPresent
  name: k8s-master01                   # master01 ä¸»æœºå
  taints: null
---
apiVersion: kubeadm.k8s.io/v1beta4
kind: ClusterConfiguration
kubernetesVersion: v1.34.1
clusterName: kubernetes
controlPlaneEndpoint: &quot;192.168.100.200:6443&quot;  # VIP åœ°å€
imageRepository: reg.westos.org/k8s
certificatesDir: /etc/kubernetes/pki
apiServer:
  certSANs:
  - 192.168.100.200                    # VIP åŠ å…¥è¯ä¹¦
  - 192.168.100.20
  - 192.168.100.21
  - 192.168.100.22
etcd:
  local:
    dataDir: /var/lib/etcd
networking:
  serviceSubnet: 10.96.0.0/12
  podSubnet: 10.244.0.0/16
  dnsDomain: cluster.local
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
mode: ipvs
ipvs:
  scheduler: rr
  strictARP: true                      # é«˜å¯ç”¨å¿…é¡»å¼€å¯ï¼Œé¿å… ARP å†²çª
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;åˆå§‹åŒ–ç¬¬ä¸€ä¸ª Master&lt;/h3&gt;
&lt;p&gt;åœ¨ master01 ä¸Šæ‰§è¡Œï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubeadm init --config=kubeadm-config.yaml --upload-certs
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åˆå§‹åŒ–æˆåŠŸåä¼šè¾“å‡ºä¸¤æ¡ join å‘½ä»¤ï¼Œä¸€æ¡ç»™ master ç”¨ï¼Œä¸€æ¡ç»™ worker ç”¨ï¼Œè®°å½•ä¸‹æ¥ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Master èŠ‚ç‚¹åŠ å…¥å‘½ä»¤ï¼ˆå¸¦ --control-planeï¼‰
kubeadm join 192.168.100.200:6443 --token abcdef.0123456789abcdef \
  --discovery-token-ca-cert-hash sha256:xxx... \
  --control-plane --certificate-key yyy...

# Worker èŠ‚ç‚¹åŠ å…¥å‘½ä»¤
kubeadm join 192.168.100.200:6443 --token abcdef.0123456789abcdef \
  --discovery-token-ca-cert-hash sha256:xxx...
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½® kubectl&lt;/h3&gt;
&lt;p&gt;åœ¨ master01 ä¸Šï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# å‘½ä»¤è¡¥å…¨
yum install -y bash-completion
echo &quot;source &amp;lt;(kubectl completion bash)&quot; &amp;gt;&amp;gt; ~/.bashrc
source ~/.bashrc
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME           STATUS     ROLES           AGE   VERSION
k8s-master01   NotReady   control-plane   2m    v1.34.1
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;å®‰è£… Calico ç½‘ç»œæ’ä»¶&lt;/h3&gt;
&lt;p&gt;åœ¨ harbor èŠ‚ç‚¹å‡†å¤‡é•œåƒï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull quay.io/calico/cni:v3.31.0
docker pull quay.io/calico/node:v3.31.0
docker pull quay.io/calico/kube-controllers:v3.31.0

# æ‰“æ ‡ç­¾å¹¶æ¨é€
docker images |grep calico | awk &apos;{print $1&quot;:&quot;$2}&apos; | awk -F/ &apos;{system(&quot;docker tag &quot;$0&quot; reg.westos.org/calico/&quot;$3&quot;&quot;)}&apos;
docker images |grep reg.westos.org/calico | awk &apos;{system(&quot;docker push &quot;$1&quot;:&quot;$2&quot;&quot;)}&apos;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨ master01 ä¸Šéƒ¨ç½²ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;wget https://raw.githubusercontent.com/projectcalico/calico/v3.31.0/manifests/calico.yaml
sed -i &apos;s#quay.io/#reg.westos.org/#g&apos; calico.yaml
kubectl apply -f calico.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç­‰å¾… Calico å¯åŠ¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get pod -A |grep calico
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;èŠ‚ç‚¹å˜ä¸º Readyï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME           STATUS   ROLES           AGE   VERSION
k8s-master01   Ready    control-plane   5m    v1.34.1
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;éªŒè¯ kube-vip&lt;/h3&gt;
&lt;p&gt;æ£€æŸ¥ VIP æ˜¯å¦ç”Ÿæ•ˆï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ip a s eth0 |grep 192.168.100.200
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åº”è¯¥èƒ½çœ‹åˆ°ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;inet 192.168.100.200/32 scope global eth0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æŸ¥çœ‹ kube-vip Podï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;crictl ps |grep kube-vip
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;åŠ å…¥å…¶ä»– Master èŠ‚ç‚¹&lt;/h3&gt;
&lt;p&gt;åœ¨ master02 å’Œ master03 ä¸Šï¼Œå…ˆåˆ›å»º kube-vip é…ç½®ï¼ˆä½¿ç”¨å‘½ä»¤ç”Ÿæˆï¼‰ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸‹è½½ kube-vip äºŒè¿›åˆ¶ï¼ˆæˆ–ç”¨ docker run æ–¹å¼ç”Ÿæˆï¼‰
mkdir -p /etc/kubernetes/manifests

# ç”Ÿæˆé…ç½®
 kube-vip manifest pod --interface eth0 --address 192.168.100.200 --controlplane --services  --arp --leaderElection --image reg.westos.org/kube-vip/kube-vip:v1.0.1 &amp;gt; /etc/kubernetes/manifests/kube-vip.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç„¶åæ‰§è¡Œ join å‘½ä»¤ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä½¿ç”¨ä¹‹å‰è®°å½•çš„ master join å‘½ä»¤
kubeadm join 192.168.100.200:6443 --token abcdef.0123456789abcdef \
  --discovery-token-ca-cert-hash sha256:xxx... \
  --control-plane --certificate-key yyy...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨ master01 ä¸ŠæŸ¥çœ‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME           STATUS   ROLES           AGE   VERSION
k8s-master01   Ready    control-plane   20m   v1.34.1
k8s-master02   Ready    control-plane   5m    v1.34.1
k8s-master03   Ready    control-plane   3m    v1.34.1
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;åŠ å…¥ Worker èŠ‚ç‚¹&lt;/h3&gt;
&lt;p&gt;åœ¨ worker01 ä¸Šæ‰§è¡Œï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä½¿ç”¨ä¹‹å‰è®°å½•çš„ worker join å‘½ä»¤
kubeadm join 192.168.100.200:6443 --token abcdef.0123456789abcdef \
  --discovery-token-ca-cert-hash sha256:xxx...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ·»åŠ èŠ‚ç‚¹æ ‡ç­¾ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl label nodes k8s-worker01 node-role.kubernetes.io/worker=
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æŸ¥çœ‹é›†ç¾¤çŠ¶æ€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME           STATUS   ROLES           AGE   VERSION
k8s-master01   Ready    control-plane   30m   v1.34.1
k8s-master02   Ready    control-plane   15m   v1.34.1
k8s-master03   Ready    control-plane   13m   v1.34.1
k8s-worker01   Ready    worker          2m    v1.34.1
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;éªŒè¯ etcd é›†ç¾¤&lt;/h3&gt;
&lt;p&gt;æŸ¥çœ‹ etcd é›†ç¾¤çŠ¶æ€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# è·å– etcd Pod åç§°
ETCD_POD=$(kubectl get pod -n kube-system -l component=etcd -o jsonpath=&apos;{.items[0].metadata.name}&apos;)

# æŸ¥çœ‹ etcd æˆå‘˜
kubectl -n kube-system exec ${ETCD_POD} -- sh -c \
  &quot;ETCDCTL_API=3 etcdctl \
  --endpoints=https://127.0.0.1:2379 \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  member list -w table&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åº”è¯¥èƒ½çœ‹åˆ° 3 ä¸ª etcd æˆå‘˜ã€‚&lt;/p&gt;
&lt;p&gt;æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl -n kube-system exec ${ETCD_POD} -- sh -c \
  &quot;ETCDCTL_API=3 etcdctl \
  --endpoints=https://127.0.0.1:2379 \
  --cert=/etc/kubernetes/pki/etcd/server.crt \
  --key=/etc/kubernetes/pki/etcd/server.key \
  --cacert=/etc/kubernetes/pki/etcd/ca.crt \
  endpoint status --cluster -w table&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;æµ‹è¯•é«˜å¯ç”¨&lt;/h3&gt;
&lt;p&gt;æµ‹è¯• VIP æ¼‚ç§»ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å…³é—­å½“å‰æŒæœ‰ VIP çš„ master èŠ‚ç‚¹
# åœ¨å¦ä¸€å° master ä¸Šè§‚å¯Ÿ VIP æ˜¯å¦æ¼‚ç§»è¿‡æ¥
ip a s eth0 |grep 192.168.100.200
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æµ‹è¯• apiserver è®¿é—®ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# é€šè¿‡ VIP è®¿é—® apiserver
kubectl --server=https://192.168.100.200:6443 get node
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;å¸¸è§é—®é¢˜&lt;/h2&gt;
&lt;p&gt;é‡åˆ°è¿‡å‡ ä¸ªé—®é¢˜ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;kube-vip æ²¡å¯åŠ¨&lt;/strong&gt;ï¼šæ£€æŸ¥ &lt;code&gt;/etc/kubernetes/super-admin.conf&lt;/code&gt; æ˜¯å¦å­˜åœ¨ï¼Œkubelet åˆå§‹åŒ–åæ‰ä¼šç”Ÿæˆè¿™ä¸ªæ–‡ä»¶&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;VIP å†²çª&lt;/strong&gt;ï¼šç¡®ä¿ &lt;code&gt;strictARP: true&lt;/code&gt;ï¼Œé¿å…å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å“åº” ARP&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;token è¿‡æœŸ&lt;/strong&gt;ï¼šé‡æ–°ç”Ÿæˆ join å‘½ä»¤ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubeadm token create --print-join-command
# è·å– certificate-key
kubeadm init phase upload-certs --upload-certs
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;etcd ä¸å¥åº·&lt;/strong&gt;ï¼šæ£€æŸ¥é˜²ç«å¢™ï¼Œetcd éœ€è¦ 2379ã€2380 ç«¯å£äº’é€š&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h2&gt;å‚è€ƒèµ„æ–™&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/&quot;&gt;kubeadm å‡çº§æ–‡æ¡£&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kube-vip.io/docs/installation/static/&quot;&gt;kube-vip å®˜æ–¹æ–‡æ¡£&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://kubernetes.io/zh-cn/releases/version-skew-policy/&quot;&gt;ç‰ˆæœ¬åå·®ç­–ç•¥&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content:encoded></item><item><title>06.Kubernetes å­¦ä¹ ç¬”è®°ï¼šå­˜å‚¨ç®¡ç†ä¸æ•°æ®æŒä¹…åŒ–</title><link>https://dev-null-sec.github.io/posts/06-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/06-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96/</guid><description>æ·±å…¥ç†è§£ K8s å­˜å‚¨ä½“ç³»ï¼ŒæŒæ¡ Volumeã€PVã€PVC å’Œ StorageClass æ•°æ®æŒä¹…åŒ–æ–¹æ¡ˆ</description><pubDate>Sat, 10 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;ä¹ã€å­˜å‚¨ç®¡ç†ï¼šæ•°æ®æŒä¹…åŒ–çš„è‰ºæœ¯&lt;/h2&gt;
&lt;h3&gt;1. ä¸ºä»€ä¹ˆKuberneteséœ€è¦å­˜å‚¨ç®¡ç†&lt;/h3&gt;
&lt;h4&gt;1.1 å®¹å™¨æ•°æ®çš„&quot;çŸ­å‘½&quot;é—®é¢˜&lt;/h4&gt;
&lt;p&gt;å®¹å™¨çš„æœ¬è´¨ç‰¹æ€§æ˜¯ä¸´æ—¶çš„ï¼Œåˆ é™¤åæ•°æ®å…¨éƒ¨ä¸¢å¤±ã€‚è¿™å¯¹äºæœ‰çŠ¶æ€åº”ç”¨ï¼ˆå¦‚æ•°æ®åº“ï¼‰æ˜¯è‡´å‘½çš„ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¼”ç¤ºé—®é¢˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å¯åŠ¨MySQLï¼Œå†™å…¥æ•°æ®
kubectl run mysql --image=mysql:8.0 --env=&quot;MYSQL_ROOT_PASSWORD=pass&quot;
kubectl exec mysql -- mysql -uroot -ppass -e &quot;CREATE DATABASE testdb;&quot;

# åˆ é™¤Pod
kubectl delete pod mysql

# é‡æ–°åˆ›å»ºï¼Œæ•°æ®æ¶ˆå¤±
kubectl run mysql --image=mysql:8.0 --env=&quot;MYSQL_ROOT_PASSWORD=pass&quot;
kubectl exec mysql -- mysql -uroot -ppass -e &quot;USE testdb;&quot;
# æŠ¥é”™ï¼šDatabase doesn&apos;t exist
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Kubernetesçš„å­˜å‚¨æŒ‘æˆ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Podæ¼‚ç§»&lt;/strong&gt;ï¼šPodå¯èƒ½åœ¨ä¸åŒèŠ‚ç‚¹é‡å¯&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¤šå‰¯æœ¬å…±äº«&lt;/strong&gt;ï¼šå¤šä¸ªPodéœ€è®¿é—®åŒä¸€æ•°æ®&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç”Ÿå‘½å‘¨æœŸç®¡ç†&lt;/strong&gt;ï¼šå­˜å‚¨ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºPod&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;1.2 å­˜å‚¨æ¶æ„æ€»è§ˆ&lt;/h4&gt;
&lt;p&gt;Kubernetesé€šè¿‡å››å±‚æ¶æ„è§£å†³å­˜å‚¨é—®é¢˜ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;graph TB
    subgraph &quot;ç”¨æˆ·å±‚&quot;
        Pod[&quot;Pod&amp;lt;br/&amp;gt;ä½¿ç”¨å­˜å‚¨&quot;]
    end
    
    subgraph &quot;ç”³è¯·å±‚&quot;
        PVC[&quot;PVC&amp;lt;br/&amp;gt;å­˜å‚¨ç”³è¯·&quot;]
    end
    
    subgraph &quot;èµ„æºå±‚&quot;
        PV[&quot;PV&amp;lt;br/&amp;gt;å­˜å‚¨èµ„æº&quot;]
        SC[&quot;StorageClass&amp;lt;br/&amp;gt;è‡ªåŠ¨åˆ›å»ºPV&quot;]
    end
    
    subgraph &quot;å®ç°å±‚&quot;
        Backend[&quot;åç«¯å­˜å‚¨&amp;lt;br/&amp;gt;NFS/Ceph/äº‘ç›˜&quot;]
    end
    
    Pod --&amp;gt;|volumes| PVC
    PVC -.ç»‘å®š.-&amp;gt; PV
    SC -.åŠ¨æ€åˆ›å»º.-&amp;gt; PV
    PV --&amp;gt;|æŒ‚è½½| Backend
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å››å¤§ç»„ä»¶ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç»„ä»¶&lt;/th&gt;
&lt;th&gt;è§’è‰²&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Volume&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æœ€åŸºç¡€&lt;/td&gt;
&lt;td&gt;Podå†…å®šä¹‰ï¼Œç”Ÿå‘½å‘¨æœŸç»‘å®šPod&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;PV&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å­˜å‚¨èµ„æº&lt;/td&gt;
&lt;td&gt;é›†ç¾¤çº§ï¼Œä»£è¡¨çœŸå®å­˜å‚¨ç©ºé—´&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;PVC&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å­˜å‚¨ç”³è¯·&lt;/td&gt;
&lt;td&gt;ç”¨æˆ·ç”³è¯·ï¼Œè‡ªåŠ¨åŒ¹é…PV&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;StorageClass&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨åŒ–&lt;/td&gt;
&lt;td&gt;åŠ¨æ€åˆ›å»ºPVï¼Œå­˜å‚¨åˆ†ç±»&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;é™æ€ vs åŠ¨æ€ä¾›ç»™ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;é™æ€ä¾›ç»™ï¼š
ç®¡ç†å‘˜æ‰‹åŠ¨åˆ›å»ºPV â†’ ç”¨æˆ·åˆ›å»ºPVC â†’ è‡ªåŠ¨ç»‘å®š

åŠ¨æ€ä¾›ç»™ï¼š
ç”¨æˆ·åˆ›å»ºPVCï¼ˆæŒ‡å®šStorageClassï¼‰â†’ è‡ªåŠ¨åˆ›å»ºPV â†’ è‡ªåŠ¨ç»‘å®š
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;2. Volumeï¼šæœ€åŸºç¡€çš„å­˜å‚¨&lt;/h3&gt;
&lt;h4&gt;2.1 emptyDirï¼šä¸´æ—¶å…±äº«å­˜å‚¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;emptyDir&lt;/strong&gt; æ˜¯æœ€ç®€å•çš„Volumeï¼ŒPodåˆ›å»ºæ—¶è‡ªåŠ¨åˆ›å»ºï¼ŒPodåˆ é™¤æ—¶æ•°æ®ä¸¢å¤±ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®¹å™¨é—´æ•°æ®å…±äº«&lt;/li&gt;
&lt;li&gt;ä¸´æ—¶ç¼“å­˜&lt;/li&gt;
&lt;li&gt;è®¡ç®—ä¸­é—´ç»“æœ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: emptydir-demo
spec:
  containers:
  - name: writer
    image: busybox
    command: [&apos;sh&apos;, &apos;-c&apos;, &apos;echo &quot;Hello&quot; &amp;gt; /data/msg.txt; sleep 3600&apos;]
    volumeMounts:
    - name: shared-data
      mountPath: /data
  
  - name: reader
    image: busybox
    command: [&apos;sh&apos;, &apos;-c&apos;, &apos;while true; do cat /data/msg.txt 2&amp;gt;/dev/null; sleep 5; done&apos;]
    volumeMounts:
    - name: shared-data
      mountPath: /data
  
  volumes:
  - name: shared-data
    emptyDir: {}      # ä½¿ç”¨ç£ç›˜
    # emptyDir:
    #   medium: Memory  # ä½¿ç”¨å†…å­˜ï¼ˆæ›´å¿«ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2.2 hostPathï¼šæŒ‚è½½å®¿ä¸»æœºç›®å½•&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;hostPath&lt;/strong&gt; å°†å®¿ä¸»æœºç›®å½•æŒ‚è½½åˆ°Podã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;âš ï¸ æ³¨æ„ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸åŒèŠ‚ç‚¹è·¯å¾„å¯èƒ½ä¸åŒ&lt;/li&gt;
&lt;li&gt;æœ‰å®‰å…¨é£é™©&lt;/li&gt;
&lt;li&gt;ä¸æ¨èç”Ÿäº§ç¯å¢ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: hostpath-demo
spec:
  containers:
  - name: nginx
    image: nginx:1.20
    volumeMounts:
    - name: host-data
      mountPath: /usr/share/nginx/html
  
  volumes:
  - name: host-data
    hostPath:
      path: /data/nginx
      type: DirectoryOrCreate
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;hostPathç±»å‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;type&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DirectoryOrCreate&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç›®å½•ä¸å­˜åœ¨åˆ™åˆ›å»º&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Directory&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¿…é¡»å­˜åœ¨çš„ç›®å½•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;File&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¿…é¡»å­˜åœ¨çš„æ–‡ä»¶&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
&lt;h3&gt;3. PersistentVolumeï¼ˆPVï¼‰ï¼šæŒä¹…åŒ–å­˜å‚¨èµ„æº&lt;/h3&gt;
&lt;h4&gt;3.1 PVæ ¸å¿ƒæ¦‚å¿µ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;PV&lt;/strong&gt; æ˜¯é›†ç¾¤çº§åˆ«çš„å­˜å‚¨èµ„æºï¼Œç”±ç®¡ç†å‘˜åˆ›å»ºæˆ–StorageClassåŠ¨æ€åˆ›å»ºã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç‹¬ç«‹äºPodç”Ÿå‘½å‘¨æœŸ&lt;/li&gt;
&lt;li&gt;é›†ç¾¤çº§èµ„æºï¼ˆæ— namespaceï¼‰&lt;/li&gt;
&lt;li&gt;ä»£è¡¨çœŸå®å­˜å‚¨ç©ºé—´&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;PVç”Ÿå‘½å‘¨æœŸï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Availableï¼ˆå¯ç”¨ï¼‰â†’ Boundï¼ˆå·²ç»‘å®šï¼‰â†’ Releasedï¼ˆå·²é‡Šæ”¾ï¼‰â†’ Failedï¼ˆå¤±è´¥ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.2 PVé…ç½®è¯¦è§£&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-001
spec:
  capacity:
    storage: 10Gi
  
  accessModes:
  - ReadWriteOnce
  
  persistentVolumeReclaimPolicy: Retain
  
  storageClassName: nfs-storage
  
  nfs:
    server: 192.168.100.14
    path: /data/nfs/pv-001
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.3 è®¿é—®æ¨¡å¼ï¼ˆAccessModesï¼‰&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ¨¡å¼&lt;/th&gt;
&lt;th&gt;ç¼©å†™&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;é€‚ç”¨åœºæ™¯&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ReadWriteOnce&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;RWO&lt;/td&gt;
&lt;td&gt;å•èŠ‚ç‚¹è¯»å†™&lt;/td&gt;
&lt;td&gt;æ•°æ®åº“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ReadOnlyMany&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ROX&lt;/td&gt;
&lt;td&gt;å¤šèŠ‚ç‚¹åªè¯»&lt;/td&gt;
&lt;td&gt;é™æ€èµ„æº&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ReadWriteMany&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;RWX&lt;/td&gt;
&lt;td&gt;å¤šèŠ‚ç‚¹è¯»å†™&lt;/td&gt;
&lt;td&gt;å…±äº«æ–‡ä»¶ç³»ç»Ÿ&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;ä¸åŒå­˜å‚¨æ”¯æŒçš„æ¨¡å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­˜å‚¨ç±»å‹&lt;/th&gt;
&lt;th&gt;RWO&lt;/th&gt;
&lt;th&gt;ROX&lt;/th&gt;
&lt;th&gt;RWX&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;hostPath&lt;/td&gt;
&lt;td&gt;âœ…&lt;/td&gt;
&lt;td&gt;âŒ&lt;/td&gt;
&lt;td&gt;âŒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;NFS&lt;/td&gt;
&lt;td&gt;âœ…&lt;/td&gt;
&lt;td&gt;âœ…&lt;/td&gt;
&lt;td&gt;âœ…&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Ceph RBD&lt;/td&gt;
&lt;td&gt;âœ…&lt;/td&gt;
&lt;td&gt;âœ…&lt;/td&gt;
&lt;td&gt;âŒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;äº‘ç›˜&lt;/td&gt;
&lt;td&gt;âœ…&lt;/td&gt;
&lt;td&gt;âŒ&lt;/td&gt;
&lt;td&gt;âŒ&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;3.4 å›æ”¶ç­–ç•¥ï¼ˆReclaimPolicyï¼‰&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç­–ç•¥&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;é€‚ç”¨åœºæ™¯&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Retain&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¿ç•™æ•°æ®ï¼Œéœ€æ‰‹åŠ¨æ¸…ç†&lt;/td&gt;
&lt;td&gt;ç”Ÿäº§ç¯å¢ƒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Delete&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨åˆ é™¤PVå’Œæ•°æ®&lt;/td&gt;
&lt;td&gt;åŠ¨æ€ä¾›ç»™&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Recycle&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åˆ é™¤æ•°æ®ï¼ˆå·²åºŸå¼ƒï¼‰&lt;/td&gt;
&lt;td&gt;ä¸æ¨è&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
&lt;h3&gt;4. PersistentVolumeClaimï¼ˆPVCï¼‰ï¼šå­˜å‚¨ç”³è¯·&lt;/h3&gt;
&lt;h4&gt;4.1 PVCæ ¸å¿ƒæ¦‚å¿µ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;PVC&lt;/strong&gt; æ˜¯ç”¨æˆ·å¯¹å­˜å‚¨çš„ç”³è¯·ï¼Œç±»ä¼¼äºPodå¯¹CPUçš„ç”³è¯·ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å‘½åç©ºé—´çº§èµ„æº&lt;/li&gt;
&lt;li&gt;ç”¨æˆ·æ— éœ€çŸ¥é“åº•å±‚å­˜å‚¨ç»†èŠ‚&lt;/li&gt;
&lt;li&gt;K8sè‡ªåŠ¨åŒ¹é…PV&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;4.2 PVCé…ç½®&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: default
spec:
  accessModes:
  - ReadWriteOnce
  
  resources:
    requests:
      storage: 10Gi
  
  storageClassName: nfs-storage
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.3 PVCç»‘å®šè§„åˆ™&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;K8så¦‚ä½•é€‰æ‹©PVï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åŒ¹é…æ¡ä»¶ï¼ˆå…¨éƒ¨æ»¡è¶³ï¼‰ï¼š
1. accessModes åŒ¹é…
2. storageå¤§å°æ»¡è¶³ï¼ˆPV &amp;gt;= PVCï¼‰
3. storageClassName åŒ¹é…

ä¼˜å…ˆçº§ï¼š
1. å¤§å°ç²¾ç¡®åŒ¹é…
2. æœ€å°æ»¡è¶³ï¼ˆPVç•¥å¤§äºPVCï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.4 Podä½¿ç”¨PVC&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
spec:
  containers:
  - name: mysql
    image: mysql:8.0
    volumeMounts:
    - name: mysql-data
      mountPath: /var/lib/mysql
  
  volumes:
  - name: mysql-data
    persistentVolumeClaim:
      claimName: mysql-pvc
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;5. StorageClassï¼šè‡ªåŠ¨åŒ–å­˜å‚¨ä¾›åº”&lt;/h3&gt;
&lt;h4&gt;5.1 StorageClassæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;StorageClass&lt;/strong&gt; æ˜¯å­˜å‚¨çš„&quot;è‡ªåŠ¨å”®è´§æœº&quot;ï¼Œç”¨æˆ·ç”³è¯·å­˜å‚¨æ—¶è‡ªåŠ¨åˆ›å»ºPVã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®šä¹‰å­˜å‚¨ç±»å‹å’Œå‚æ•°&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨åˆ›å»ºPVï¼ˆåŠ¨æ€ä¾›ç»™ï¼‰&lt;/li&gt;
&lt;li&gt;ä¸åŒæ€§èƒ½ç­‰çº§ï¼ˆSSD/HDDï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;5.2 StorageClassé…ç½®&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
provisioner: nfs-provisioner
parameters:
  archiveOnDelete: &quot;false&quot;
reclaimPolicy: Delete
volumeBindingMode: Immediate
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®å­—æ®µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;provisioner&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å­˜å‚¨ä¾›åº”å™¨ï¼ˆå¦‚nfs-provisionerï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;parameters&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¾›åº”å™¨ç‰¹å®šå‚æ•°&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;reclaimPolicy&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;PVå›æ”¶ç­–ç•¥&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;volumeBindingMode&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç»‘å®šæ¨¡å¼ï¼ˆImmediate/WaitForFirstConsumerï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;5.3 è®¾ç½®é»˜è®¤StorageClass&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
  annotations:
    storageclass.kubernetes.io/is-default-class: &quot;true&quot;
provisioner: nfs-provisioner
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹é»˜è®¤StorageClass
kubectl get storageclass
# NAME                    PROVISIONER         AGE
# nfs-storage (default)   nfs-provisioner     1d
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;6. ä¸»æµåç«¯å­˜å‚¨å¯¹æ¯”&lt;/h3&gt;
&lt;p&gt;åç«¯å­˜å‚¨æ˜¯PVçœŸæ­£å­˜å‚¨æ•°æ®çš„åœ°æ–¹ï¼Œé€‰æ‹©åˆé€‚çš„å­˜å‚¨æ–¹æ¡ˆè‡³å…³é‡è¦ã€‚&lt;/p&gt;
&lt;h4&gt;6.1 å­˜å‚¨æ–¹æ¡ˆå¯¹æ¯”&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­˜å‚¨ç±»å‹&lt;/th&gt;
&lt;th&gt;æ€§èƒ½&lt;/th&gt;
&lt;th&gt;å¯é æ€§&lt;/th&gt;
&lt;th&gt;å¤æ‚åº¦&lt;/th&gt;
&lt;th&gt;æˆæœ¬&lt;/th&gt;
&lt;th&gt;è®¿é—®æ¨¡å¼&lt;/th&gt;
&lt;th&gt;é€‚ç”¨åœºæ™¯&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;hostPath&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;td&gt;â­&lt;/td&gt;
&lt;td&gt;â­&lt;/td&gt;
&lt;td&gt;å…è´¹&lt;/td&gt;
&lt;td&gt;RWO&lt;/td&gt;
&lt;td&gt;å¼€å‘æµ‹è¯•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;NFS&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;â­â­&lt;/td&gt;
&lt;td&gt;â­â­&lt;/td&gt;
&lt;td&gt;â­â­&lt;/td&gt;
&lt;td&gt;ä½&lt;/td&gt;
&lt;td&gt;RWO/ROX/RWX&lt;/td&gt;
&lt;td&gt;å¼€å‘ç¯å¢ƒã€å°è§„æ¨¡ç”Ÿäº§&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Ceph/Rook&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;td&gt;ä¸­&lt;/td&gt;
&lt;td&gt;RWO/ROX/RWX&lt;/td&gt;
&lt;td&gt;ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;äº‘ç›˜ï¼ˆEBSï¼‰&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;td&gt;â­&lt;/td&gt;
&lt;td&gt;é«˜&lt;/td&gt;
&lt;td&gt;RWO&lt;/td&gt;
&lt;td&gt;äº‘ç¯å¢ƒç”Ÿäº§&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å¯¹è±¡å­˜å‚¨ï¼ˆS3ï¼‰&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;â­â­&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;td&gt;â­&lt;/td&gt;
&lt;td&gt;ä¸­&lt;/td&gt;
&lt;td&gt;ROX&lt;/td&gt;
&lt;td&gt;é™æ€èµ„æºã€å¤‡ä»½&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;6.2 è¯¦ç»†åˆ†æ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;1. hostPathï¼ˆå®¿ä¸»æœºç›®å½•ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
âœ… ç®€å•ç›´æ¥ï¼Œæ— éœ€é¢å¤–é…ç½®
âœ… æ€§èƒ½æœ€å¥½ï¼ˆæœ¬åœ°ç£ç›˜ï¼‰
âœ… é›¶æˆæœ¬

ç¼ºç‚¹ï¼š
âŒ æ•°æ®ç»‘å®šèŠ‚ç‚¹ï¼ŒPodæ¼‚ç§»ä¼šä¸¢å¤±æ•°æ®
âŒ æ— æ³•å¤šèŠ‚ç‚¹å…±äº«
âŒ å®‰å…¨é£é™©é«˜

é€‚ç”¨åœºæ™¯ï¼š
- å¼€å‘æµ‹è¯•
- å•èŠ‚ç‚¹é›†ç¾¤
- DaemonSetæ—¥å¿—æ”¶é›†
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;2. NFSï¼ˆç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
âœ… æ”¯æŒRWXå¤šèŠ‚ç‚¹è¯»å†™
âœ… é…ç½®ç®€å•
âœ… æˆæœ¬ä½

ç¼ºç‚¹ï¼š
âŒ æ€§èƒ½ä¸€èˆ¬ï¼ˆç½‘ç»œIOï¼‰
âŒ å•ç‚¹æ•…éšœé£é™©ï¼ˆNFS ServeræŒ‚äº†å…¨æŒ‚ï¼‰
âŒ ä¸é€‚åˆé«˜å¹¶å‘

é€‚ç”¨åœºæ™¯ï¼š
- å¼€å‘ç¯å¢ƒ
- å°è§„æ¨¡ç”Ÿäº§ï¼ˆéæ ¸å¿ƒä¸šåŠ¡ï¼‰
- å…±äº«é…ç½®æ–‡ä»¶
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;3. Ceph/Rookï¼ˆåˆ†å¸ƒå¼å­˜å‚¨ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
âœ… é«˜å¯ç”¨ï¼ˆæ•°æ®å¤šå‰¯æœ¬ï¼‰
âœ… å¯æ‰©å±•ï¼ˆæ¨ªå‘æ‰©å±•ï¼‰
âœ… æ€§èƒ½å¥½
âœ… æ”¯æŒRWX

ç¼ºç‚¹ï¼š
âŒ éƒ¨ç½²å¤æ‚
âŒ éœ€è¦ä¸“ä¸šè¿ç»´
âŒ èµ„æºæ¶ˆè€—å¤§ï¼ˆè‡³å°‘3èŠ‚ç‚¹ï¼‰

é€‚ç”¨åœºæ™¯ï¼š
- ä¼ä¸šçº§ç”Ÿäº§ç¯å¢ƒ
- å¤§è§„æ¨¡é›†ç¾¤
- å¯¹æ•°æ®å¯é æ€§è¦æ±‚é«˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;4. äº‘ç›˜ï¼ˆEBS/GCE Diskï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
âœ… é«˜å¯ç”¨ï¼ˆäº‘å‚å•†ä¿éšœï¼‰
âœ… æ˜“ç”¨ï¼ˆäº‘å¹³å°é›†æˆï¼‰
âœ… æ€§èƒ½å¯é€‰ï¼ˆSSD/HDDï¼‰
âœ… å¿«ç…§å¤‡ä»½æ–¹ä¾¿

ç¼ºç‚¹ï¼š
âŒ åªæ”¯æŒRWO
âŒ æˆæœ¬è¾ƒé«˜
âŒ ç»‘å®šäº‘å‚å•†

é€‚ç”¨åœºæ™¯ï¼š
- äº‘ç¯å¢ƒç”Ÿäº§
- æ•°æ®åº“å­˜å‚¨
- å•å®ä¾‹åº”ç”¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;5. å¯¹è±¡å­˜å‚¨ï¼ˆS3/OSSï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
âœ… æ— é™å®¹é‡
âœ… é«˜å¯ç”¨
âœ… æˆæœ¬ä½ï¼ˆæŒ‰é‡ä»˜è´¹ï¼‰

ç¼ºç‚¹ï¼š
âŒ ä¸æ”¯æŒPOSIXæ–‡ä»¶ç³»ç»Ÿ
âŒ åªé€‚åˆè¯»å¤šå†™å°‘åœºæ™¯

é€‚ç”¨åœºæ™¯ï¼š
- é™æ€èµ„æºï¼ˆå›¾ç‰‡ã€è§†é¢‘ï¼‰
- å¤‡ä»½å½’æ¡£
- å¤§æ•°æ®å­˜å‚¨
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;6.3 é€‰æ‹©å»ºè®®&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;graph TD
    Start[é€‰æ‹©å­˜å‚¨æ–¹æ¡ˆ] --&amp;gt; Q1{ç”Ÿäº§ç¯å¢ƒ?}
    
    Q1 --&amp;gt;|å¦| Dev[å¼€å‘æµ‹è¯•ç¯å¢ƒ]
    Q1 --&amp;gt;|æ˜¯| Q2{äº‘ç¯å¢ƒ?}
    
    Dev --&amp;gt; hostPath[hostPath&amp;lt;br/&amp;gt;å¿«é€Ÿç®€å•]
    Dev --&amp;gt; NFS1[NFS&amp;lt;br/&amp;gt;å…±äº«æ–‡ä»¶]
    
    Q2 --&amp;gt;|æ˜¯| Cloud[äº‘ç›˜&amp;lt;br/&amp;gt;EBS/GCE Disk]
    Q2 --&amp;gt;|å¦| Q3{éœ€è¦RWX?}
    
    Q3 --&amp;gt;|æ˜¯| Q4{è§„æ¨¡å¤§?}
    Q3 --&amp;gt;|å¦| Local[æœ¬åœ°ç›˜&amp;lt;br/&amp;gt;æˆ–äº‘ç›˜RWO]
    
    Q4 --&amp;gt;|æ˜¯| Ceph[Ceph/Rook&amp;lt;br/&amp;gt;ä¼ä¸šçº§]
    Q4 --&amp;gt;|å¦| NFS2[NFS&amp;lt;br/&amp;gt;å°è§„æ¨¡]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;âš ï¸ ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. èƒ½ç”¨äº‘å­˜å‚¨å°±ç”¨äº‘å­˜å‚¨ï¼ˆçœå¿ƒï¼‰
2. è‡ªå»ºå­˜å‚¨éœ€è¦ä¸“ä¸šè¿ç»´å›¢é˜Ÿ
3. æ•°æ®åº“ç­‰æ ¸å¿ƒåº”ç”¨ä½¿ç”¨é«˜å¯ç”¨å­˜å‚¨
4. å®šæœŸå¤‡ä»½ï¼Œå¤‡ä»½ï¼Œå¤‡ä»½ï¼
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;7. å®æˆ˜1ï¼šä½¿ç”¨hostPathå®ç°æŒä¹…åŒ–&lt;/h3&gt;
&lt;h4&gt;7.1 å®æˆ˜ç›®æ ‡&lt;/h4&gt;
&lt;p&gt;ä½¿ç”¨hostPathéªŒè¯æ•°æ®æŒä¹…åŒ–ï¼Œç†è§£å­˜å‚¨çš„åŸºæœ¬åŸç†ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼š&lt;/strong&gt; åˆ›å»ºNginx Podï¼Œä½¿ç”¨hostPathå­˜å‚¨ç½‘é¡µï¼ŒéªŒè¯Podåˆ é™¤åæ•°æ®æ˜¯å¦ä¿ç•™ã€‚&lt;/p&gt;
&lt;h4&gt;7.2 å‡†å¤‡å·¥ä½œ&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨node1èŠ‚ç‚¹åˆ›å»ºç›®å½•
ssh root@192.168.100.21
mkdir -p /data/nginx-html
echo &quot;&amp;lt;h1&amp;gt;Hello from hostPath - v1&amp;lt;/h1&amp;gt;&quot; &amp;gt; /data/nginx-html/index.html
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;7.3 åˆ›å»ºä½¿ç”¨hostPathçš„Pod&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;hostpath-nginx.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-hostpath
  labels:
    app: nginx
spec:
  # æŒ‡å®šè°ƒåº¦åˆ°node1ï¼ˆhostPathç»‘å®šèŠ‚ç‚¹ï¼‰
  nodeSelector:
    kubernetes.io/hostname: k8s-node1
  
  containers:
  - name: nginx
    image: nginx:1.20
    ports:
    - containerPort: 80
    volumeMounts:
    - name: html-data
      mountPath: /usr/share/nginx/html
  
  volumes:
  - name: html-data
    hostPath:
      path: /data/nginx-html
      type: Directory
---
apiVersion: v1
kind: Service
metadata:
  name: nginx-hostpath
spec:
  selector:
    app: nginx
  ports:
  - port: 80
    nodePort: 30090
  type: NodePort
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f hostpath-nginx.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;7.4 æµ‹è¯•æ•°æ®æŒä¹…åŒ–&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# 1. è®¿é—®Nginx
curl http://192.168.100.21:30090
# è¾“å‡ºï¼š&amp;lt;h1&amp;gt;Hello from hostPath - v1&amp;lt;/h1&amp;gt;

# 2. åœ¨å®¹å™¨å†…ä¿®æ”¹æ–‡ä»¶
kubectl exec nginx-hostpath -- sh -c &apos;echo &quot;&amp;lt;h1&amp;gt;Modified in container - v2&amp;lt;/h1&amp;gt;&quot; &amp;gt; /usr/share/nginx/html/index.html&apos;

# 3. å†æ¬¡è®¿é—®ï¼Œçœ‹åˆ°æ›´æ–°
curl http://192.168.100.21:30090
# è¾“å‡ºï¼š&amp;lt;h1&amp;gt;Modified in container - v2&amp;lt;/h1&amp;gt;

# 4. åˆ é™¤Pod
kubectl delete pod nginx-hostpath

# 5. é‡æ–°åˆ›å»ºPod
kubectl apply -f hostpath-nginx.yaml

# 6. æ•°æ®è¿˜åœ¨ï¼
curl http://192.168.100.21:30090
# è¾“å‡ºï¼š&amp;lt;h1&amp;gt;Modified in container - v2&amp;lt;/h1&amp;gt;

# 7. åœ¨å®¿ä¸»æœºä¸ŠéªŒè¯
ssh root@192.168.100.21 &quot;cat /data/nginx-html/index.html&quot;
# è¾“å‡ºï¼š&amp;lt;h1&amp;gt;Modified in container - v2&amp;lt;/h1&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;âš ï¸ æµ‹è¯•Podæ¼‚ç§»é—®é¢˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤nodeSelectorï¼Œè®©Podå¯ä»¥è°ƒåº¦åˆ°ä»»æ„èŠ‚ç‚¹
kubectl delete -f hostpath-nginx.yaml

# ä¿®æ”¹YAMLï¼Œå»æ‰nodeSelector
# é‡æ–°åˆ›å»º

# å¦‚æœPodè°ƒåº¦åˆ°node2ï¼Œä¼šå‘ç°è®¿é—®å¤±è´¥
# å› ä¸ºnode2çš„/data/nginx-htmlç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç»“è®ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ… æ•°æ®æŒä¹…åŒ–æˆåŠŸ&lt;/li&gt;
&lt;li&gt;âŒ ä½†æ•°æ®ç»‘å®šèŠ‚ç‚¹ï¼Œä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;8. å®æˆ˜2ï¼šä½¿ç”¨NFSå®ç°åŠ¨æ€ä¾›ç»™&lt;/h3&gt;
&lt;h4&gt;8.1 å®æˆ˜ç›®æ ‡&lt;/h4&gt;
&lt;p&gt;éƒ¨ç½²NFSæœåŠ¡å™¨å’ŒNFS Provisionerï¼Œå®ç°PVCè‡ªåŠ¨åˆ›å»ºPVçš„åŠ¨æ€ä¾›ç»™ã€‚&lt;/p&gt;
&lt;h4&gt;8.2 éƒ¨ç½²NFSæœåŠ¡å™¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœ¨harboræœºå™¨ï¼ˆ192.168.100.14ï¼‰ä¸Šå®‰è£…NFSï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å®‰è£…NFSæœåŠ¡
yum install -y nfs-utils rpcbind

# åˆ›å»ºå…±äº«ç›®å½•
mkdir -p /data/nfs-storage
chmod 777 /data/nfs-storage

# é…ç½®NFSå…±äº«
cat &amp;gt;&amp;gt; /etc/exports &amp;lt;&amp;lt; EOF
/data/nfs-storage *(rw,sync,no_root_squash,no_all_squash)
EOF

# å¯åŠ¨NFSæœåŠ¡
systemctl start rpcbind
systemctl start nfs-server
systemctl enable rpcbind
systemctl enable nfs-server

# åˆ·æ–°NFSé…ç½®
exportfs -r

# æŸ¥çœ‹å…±äº«ç›®å½•
showmount -e localhost
# è¾“å‡ºï¼š/data/nfs-storage *
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœ¨æ‰€æœ‰K8sèŠ‚ç‚¹å®‰è£…NFSå®¢æˆ·ç«¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨masterã€node1ã€node2ä¸Šæ‰§è¡Œ
yum install -y nfs-utils

# æµ‹è¯•æŒ‚è½½
mount -t nfs 192.168.100.14:/data/nfs-storage /mnt
ls /mnt
umount /mnt
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;8.3 éƒ¨ç½²NFS Provisioner&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºnfs-provisioner.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# RBACæƒé™
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-provisioner
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nfs-provisioner
rules:
- apiGroups: [&quot;&quot;]
  resources: [&quot;persistentvolumes&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]
- apiGroups: [&quot;&quot;]
  resources: [&quot;persistentvolumeclaims&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]
- apiGroups: [&quot;storage.k8s.io&quot;]
  resources: [&quot;storageclasses&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
- apiGroups: [&quot;&quot;]
  resources: [&quot;events&quot;]
  verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: nfs-provisioner
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: nfs-provisioner
subjects:
- kind: ServiceAccount
  name: nfs-provisioner
  namespace: kube-system
---
# Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-provisioner
  namespace: kube-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nfs-provisioner
  template:
    metadata:
      labels:
        app: nfs-provisioner
    spec:
      serviceAccountName: nfs-provisioner
      containers:
      - name: nfs-provisioner
        image: registry.cn-hangzhou.aliyuncs.com/open-ali/nfs-client-provisioner:latest
        volumeMounts:
        - name: nfs-client-root
          mountPath: /persistentvolumes
        env:
        - name: PROVISIONER_NAME
          value: nfs-provisioner        # Provisioneråç§°
        - name: NFS_SERVER
          value: 192.168.100.14         # NFSæœåŠ¡å™¨åœ°å€
        - name: NFS_PATH
          value: /data/nfs-storage      # NFSå…±äº«è·¯å¾„
      volumes:
      - name: nfs-client-root
        nfs:
          server: 192.168.100.14
          path: /data/nfs-storage
---
# StorageClass
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: nfs-storage
  annotations:
    storageclass.kubernetes.io/is-default-class: &quot;true&quot;  # è®¾ä¸ºé»˜è®¤
provisioner: nfs-provisioner
parameters:
  archiveOnDelete: &quot;false&quot;    # åˆ é™¤PVCæ—¶ä¸å½’æ¡£æ•°æ®
reclaimPolicy: Delete
volumeBindingMode: Immediate
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f nfs-provisioner.yaml

# æŸ¥çœ‹ProvisionerçŠ¶æ€
kubectl get pods -n kube-system -l app=nfs-provisioner

# æŸ¥çœ‹StorageClass
kubectl get storageclass
# NAME                     PROVISIONER         RECLAIMPOLICY   
# nfs-storage (default)    nfs-provisioner     Delete          
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;8.4 æµ‹è¯•åŠ¨æ€ä¾›ç»™&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºtest-pvc.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: test-pvc
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: nfs-storage
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f test-pvc.yaml

# æŸ¥çœ‹PVCï¼ˆè‡ªåŠ¨ç»‘å®šï¼‰
kubectl get pvc test-pvc
# NAME       STATUS   VOLUME                                     CAPACITY   
# test-pvc   Bound    pvc-abc123-...                             1Gi        

# æŸ¥çœ‹è‡ªåŠ¨åˆ›å»ºçš„PV
kubectl get pv
# NAME                                       CAPACITY   ACCESS MODES   STATUS   
# pvc-abc123-...                             1Gi        RWX            Bound    

# åœ¨NFSæœåŠ¡å™¨ä¸ŠæŸ¥çœ‹è‡ªåŠ¨åˆ›å»ºçš„ç›®å½•
ssh root@192.168.100.14 &quot;ls -l /data/nfs-storage/&quot;
# drwxrwxrwx 2 root root 6 Jan 15 10:30 default-test-pvc-pvc-abc123...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºPodä½¿ç”¨PVCï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: test-nfs-pod
spec:
  containers:
  - name: app
    image: nginx:1.20
    volumeMounts:
    - name: data
      mountPath: /usr/share/nginx/html
  volumes:
  - name: data
    persistentVolumeClaim:
      claimName: test-pvc
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f test-nfs-pod.yaml

# å†™å…¥æµ‹è¯•æ•°æ®
kubectl exec test-nfs-pod -- sh -c &apos;echo &quot;&amp;lt;h1&amp;gt;NFS Dynamic Provisioning Works!&amp;lt;/h1&amp;gt;&quot; &amp;gt; /usr/share/nginx/html/index.html&apos;

# åœ¨NFSæœåŠ¡å™¨éªŒè¯
ssh root@192.168.100.14 &quot;cat /data/nfs-storage/default-test-pvc-*/index.html&quot;
# è¾“å‡ºï¼š&amp;lt;h1&amp;gt;NFS Dynamic Provisioning Works!&amp;lt;/h1&amp;gt;

# åˆ é™¤Podï¼Œæ•°æ®ä¿ç•™
kubectl delete pod test-nfs-pod

# é‡æ–°åˆ›å»ºï¼Œæ•°æ®è¿˜åœ¨
kubectl apply -f test-nfs-pod.yaml
kubectl exec test-nfs-pod -- cat /usr/share/nginx/html/index.html
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;8.5 æµ‹è¯•å›æ”¶ç­–ç•¥&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤PVC
kubectl delete pvc test-pvc

# PVè‡ªåŠ¨åˆ é™¤ï¼ˆreclaimPolicy: Deleteï¼‰
kubectl get pv
# æ— è¾“å‡ºï¼ˆPVå·²åˆ é™¤ï¼‰

# NFSæœåŠ¡å™¨ä¸Šçš„æ•°æ®ä¹Ÿè¢«åˆ é™¤
ssh root@192.168.100.14 &quot;ls /data/nfs-storage/&quot;
# ç©ºç›®å½•ï¼ˆæ•°æ®å·²åˆ é™¤ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;9. å®æˆ˜3ï¼šStatefulSetæŒä¹…åŒ–MySQL&lt;/h3&gt;
&lt;h4&gt;9.1 å®æˆ˜ç›®æ ‡&lt;/h4&gt;
&lt;p&gt;ä½¿ç”¨StatefulSetéƒ¨ç½²MySQLé›†ç¾¤ï¼Œæ¯ä¸ªå®ä¾‹æ‹¥æœ‰ç‹¬ç«‹çš„PVCï¼ŒéªŒè¯æ‰©ç¼©å®¹æ—¶æ•°æ®ç‹¬ç«‹æ€§ã€‚&lt;/p&gt;
&lt;h4&gt;9.2 åˆ›å»ºStatefulSet MySQL&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;mysql-statefulset.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: mysql-headless
spec:
  clusterIP: None  # Headless Service
  selector:
    app: mysql
  ports:
  - port: 3306
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: mysql-headless
  replicas: 3
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        ports:
        - containerPort: 3306
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: &quot;MyPass123&quot;
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
  
  # VolumeClaimTemplateï¼ˆæ¯ä¸ªPodç‹¬ç«‹PVCï¼‰
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [&quot;ReadWriteOnce&quot;]
      storageClassName: nfs-storage
      resources:
        requests:
          storage: 5Gi
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f mysql-statefulset.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;9.3 éªŒè¯ç‹¬ç«‹å­˜å‚¨&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Pod
kubectl get pods -l app=mysql
# NAME      READY   STATUS    RESTARTS   AGE
# mysql-0   1/1     Running   0          1m
# mysql-1   1/1     Running   0          50s
# mysql-2   1/1     Running   0          40s

# æŸ¥çœ‹PVCï¼ˆæ¯ä¸ªPodç‹¬ç«‹PVCï¼‰
kubectl get pvc
# NAME           STATUS   VOLUME                  CAPACITY
# data-mysql-0   Bound    pvc-abc...              5Gi
# data-mysql-1   Bound    pvc-def...              5Gi
# data-mysql-2   Bound    pvc-ghi...              5Gi

# åœ¨mysql-0ä¸­åˆ›å»ºæ•°æ®åº“
kubectl exec mysql-0 -- mysql -uroot -pMyPass123 -e &quot;CREATE DATABASE db0;&quot;

# åœ¨mysql-1ä¸­åˆ›å»ºä¸åŒçš„æ•°æ®åº“
kubectl exec mysql-1 -- mysql -uroot -pMyPass123 -e &quot;CREATE DATABASE db1;&quot;

# éªŒè¯æ•°æ®ç‹¬ç«‹
kubectl exec mysql-0 -- mysql -uroot -pMyPass123 -e &quot;SHOW DATABASES;&quot; | grep db
# db0

kubectl exec mysql-1 -- mysql -uroot -pMyPass123 -e &quot;SHOW DATABASES;&quot; | grep db
# db1

# æ•°æ®å®Œå…¨ç‹¬ç«‹ï¼
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;9.4 æµ‹è¯•æ‰©ç¼©å®¹&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# ç¼©å®¹åˆ°1ä¸ªå‰¯æœ¬
kubectl scale statefulset mysql --replicas=1

# æŸ¥çœ‹Podï¼ˆmysql-1å’Œmysql-2è¢«åˆ é™¤ï¼‰
kubectl get pods -l app=mysql
# NAME      READY   STATUS    RESTARTS   AGE
# mysql-0   1/1     Running   0          5m

# PVCä¸ä¼šè¢«åˆ é™¤ï¼ˆæ•°æ®ä¿æŠ¤ï¼‰
kubectl get pvc
# NAME           STATUS   VOLUME                  CAPACITY
# data-mysql-0   Bound    pvc-abc...              5Gi
# data-mysql-1   Bound    pvc-def...              5Gi    &amp;lt;- ä¿ç•™
# data-mysql-2   Bound    pvc-ghi...              5Gi    &amp;lt;- ä¿ç•™

# æ‰©å®¹å›3ä¸ªå‰¯æœ¬
kubectl scale statefulset mysql --replicas=3

# æ–°Podè‡ªåŠ¨ç»‘å®šåŸæ¥çš„PVCï¼Œæ•°æ®æ¢å¤ï¼
kubectl exec mysql-1 -- mysql -uroot -pMyPass123 -e &quot;SHOW DATABASES;&quot; | grep db
# db1    &amp;lt;- æ•°æ®è¿˜åœ¨ï¼
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;æ€»ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;æœ¬ç« å­¦ä¹ äº†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å­˜å‚¨æ¶æ„&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Volume/PV/PVC/StorageClasså…³ç³»&lt;/li&gt;
&lt;li&gt;é™æ€ä¾›ç»™ vs åŠ¨æ€ä¾›ç»™&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å­˜å‚¨ç±»å‹&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Volumeï¼šemptyDirã€hostPath&lt;/li&gt;
&lt;li&gt;PVï¼šè®¿é—®æ¨¡å¼ã€å›æ”¶ç­–ç•¥&lt;/li&gt;
&lt;li&gt;PVCï¼šç»‘å®šè§„åˆ™&lt;/li&gt;
&lt;li&gt;StorageClassï¼šè‡ªåŠ¨åŒ–ä¾›ç»™&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åç«¯å­˜å‚¨é€‰æ‹©&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;hostPathï¼šå¼€å‘æµ‹è¯•&lt;/li&gt;
&lt;li&gt;NFSï¼šå°è§„æ¨¡ç”Ÿäº§&lt;/li&gt;
&lt;li&gt;Cephï¼šä¼ä¸šçº§&lt;/li&gt;
&lt;li&gt;äº‘ç›˜ï¼šäº‘ç¯å¢ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å®æˆ˜ç»éªŒ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;hostPathæŒä¹…åŒ–ï¼ˆå•èŠ‚ç‚¹ï¼‰&lt;/li&gt;
&lt;li&gt;NFSåŠ¨æ€ä¾›ç»™ï¼ˆå¤šèŠ‚ç‚¹å…±äº«ï¼‰&lt;/li&gt;
&lt;li&gt;StatefulSetç‹¬ç«‹å­˜å‚¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§å»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;âš ï¸ &lt;strong&gt;å­˜å‚¨æ˜¯æœ‰çŠ¶æ€åº”ç”¨çš„ç”Ÿå‘½çº¿&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. èƒ½ç”¨äº‘å­˜å‚¨å°±ç”¨äº‘å­˜å‚¨ï¼ˆçœå¿ƒï¼‰
2. è‡ªå»ºå­˜å‚¨éœ€è¦ä¸“ä¸šå›¢é˜Ÿè¿ç»´
3. ç”Ÿäº§ç¯å¢ƒå¿…é¡»ï¼š
   - å®šæœŸå¤‡ä»½
   - æµ‹è¯•æ¢å¤æµç¨‹
   - ç›‘æ§å­˜å‚¨å®¹é‡å’Œæ€§èƒ½
4. æ ¸å¿ƒæ•°æ®ä½¿ç”¨é«˜å¯ç”¨å­˜å‚¨ï¼ˆCeph/äº‘ç›˜ï¼‰
5. éæ ¸å¿ƒæ•°æ®å¯ç”¨NFS
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é£é™©æç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;âš ï¸ è‡ªå»ºå­˜å‚¨æ„å‘³ç€å¯¹æ•°æ®è´Ÿå…¨è´£
âš ï¸ å­˜å‚¨æ•…éšœ = æ•°æ®ä¸¢å¤± = ä¸šåŠ¡ç¾éš¾
âš ï¸ ä¼˜å…ˆè€ƒè™‘äº‘å­˜å‚¨æˆ–æ‰˜ç®¡å­˜å‚¨æœåŠ¡
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h2&gt;åã€K8sè°ƒåº¦ï¼šè®©Podå»è¯¥å»çš„åœ°æ–¹&lt;/h2&gt;
&lt;h3&gt;1. è°ƒåº¦åŸºç¡€æ¦‚å¿µ&lt;/h3&gt;
&lt;h4&gt;1.1 ä»€ä¹ˆæ˜¯K8sè°ƒåº¦&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;è°ƒåº¦ï¼ˆSchedulingï¼‰&lt;/strong&gt; æ˜¯Kubernetesçš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå†³å®šPodåº”è¯¥è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Šã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»æ¥ç†è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æƒ³è±¡ä¸€ä¸ªç‰©æµè°ƒåº¦ä¸­å¿ƒï¼š

Pod = è´§ç‰©ï¼ˆéœ€è¦è¿é€åˆ°æŸä¸ªä»“åº“ï¼‰
Node = ä»“åº“ï¼ˆå­˜æ”¾è´§ç‰©çš„åœ°æ–¹ï¼‰
Scheduler = è°ƒåº¦å‘˜ï¼ˆå†³å®šè´§ç‰©æ”¾åˆ°å“ªä¸ªä»“åº“ï¼‰

è°ƒåº¦å‘˜éœ€è¦è€ƒè™‘ï¼š
- ä»“åº“å‰©ä½™ç©ºé—´ï¼ˆèŠ‚ç‚¹èµ„æºï¼‰
- è´§ç‰©ç‰¹æ®Šè¦æ±‚ï¼ˆéœ€è¦å†·è—ï¼Ÿæ˜“ç¢ï¼Ÿï¼‰
- è·ç¦»å’Œæ•ˆç‡ï¼ˆç½‘ç»œå»¶è¿Ÿã€äº²å’Œæ€§ï¼‰
- ä»“åº“é™åˆ¶ï¼ˆæŸäº›ä»“åº“ä¸æ”¶å±é™©å“ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è°ƒåº¦çš„é‡è¦æ€§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¸ºä»€ä¹ˆè°ƒåº¦å¦‚æ­¤é‡è¦ï¼Ÿ

1. èµ„æºåˆ©ç”¨ç‡
   - åˆç†åˆ†é…Podï¼Œé¿å…æŸäº›èŠ‚ç‚¹è¿‡è½½
   - æé«˜é›†ç¾¤æ•´ä½“èµ„æºä½¿ç”¨æ•ˆç‡

2. é«˜å¯ç”¨æ€§
   - å°†Podåˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹/æœºæˆ¿
   - é¿å…å•ç‚¹æ•…éšœ

3. æ€§èƒ½ä¼˜åŒ–
   - å°†ç›¸å…³Podè°ƒåº¦åˆ°ä¸€èµ·ï¼ˆå‡å°‘ç½‘ç»œå»¶è¿Ÿï¼‰
   - å°†Podè°ƒåº¦åˆ°åˆé€‚çš„ç¡¬ä»¶ï¼ˆGPUã€SSDï¼‰

4. åˆè§„è¦æ±‚
   - æŸäº›æ•°æ®å¿…é¡»å­˜å‚¨åœ¨ç‰¹å®šåŒºåŸŸ
   - æ•æ„ŸæœåŠ¡åªèƒ½è¿è¡Œåœ¨ç‰¹å®šèŠ‚ç‚¹
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;1.2 è°ƒåº¦å™¨å·¥ä½œåŸç†&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Schedulerçš„è°ƒåº¦æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;flowchart TD
    A[&quot;ç›‘å¬æœªè°ƒåº¦çš„ Podï¼ˆWatch API Serverï¼‰&quot;] --&amp;gt; B[&quot;è¯»å– Pod éœ€æ±‚ï¼ˆrequests / affinity / tolerationsï¼‰&quot;]
    B --&amp;gt; C[&quot;é¢„é€‰ Filteringï¼šå‰”é™¤ä¸æ»¡è¶³æ¡ä»¶çš„èŠ‚ç‚¹&quot;]
    C --&amp;gt; D[&quot;ä¼˜é€‰ Scoringï¼šå¯¹å€™é€‰èŠ‚ç‚¹æ‰“åˆ†æ’åº&quot;]
    D --&amp;gt; E[&quot;ç»‘å®š Bindingï¼šé€‰æ‹©æœ€é«˜åˆ†èŠ‚ç‚¹å¹¶ç»‘å®š Pod&quot;]
    E --&amp;gt; F[&quot;Kubelet åˆ›å»ºå®¹å™¨ï¼šåœ¨ç›®æ ‡èŠ‚ç‚¹æ‹‰é•œåƒå¹¶å¯åŠ¨å®¹å™¨&quot;]

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è¯¦ç»†æµç¨‹è§£æï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·åˆ›å»ºPodï¼škubectl apply -f pod.yaml                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Serveræ¥æ”¶è¯·æ±‚                                          â”‚
â”‚  - PodçŠ¶æ€ï¼šPending                                         â”‚
â”‚  - nodeNameï¼šç©ºï¼ˆæœªåˆ†é…èŠ‚ç‚¹ï¼‰                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Schedulerç›‘å¬åˆ°æ–°Pod                                        â”‚
â”‚  å¼€å§‹è°ƒåº¦æµç¨‹                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é¢„é€‰é˜¶æ®µï¼ˆFilteringï¼‰                                       â”‚
â”‚                                                             â”‚
â”‚  æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦æ»¡è¶³Podçš„ç¡¬æ€§è¦æ±‚ï¼š                          â”‚
â”‚  âœ“ èµ„æºå……è¶³ï¼Ÿï¼ˆCPUã€å†…å­˜ï¼‰                                   â”‚
â”‚  âœ“ ç«¯å£å¯ç”¨ï¼Ÿ                                               â”‚
â”‚  âœ“ èŠ‚ç‚¹é€‰æ‹©å™¨åŒ¹é…ï¼Ÿï¼ˆnodeSelectorï¼‰                          â”‚
â”‚  âœ“ èŠ‚ç‚¹äº²å’Œæ€§æ»¡è¶³ï¼Ÿï¼ˆnodeAffinity requiredï¼‰                 â”‚
â”‚  âœ“ æ±¡ç‚¹èƒ½å®¹å¿ï¼Ÿï¼ˆTolerationsï¼‰                              â”‚
â”‚  âœ“ å…¶ä»–çº¦æŸæ»¡è¶³ï¼Ÿ                                           â”‚
â”‚                                                             â”‚
â”‚  ç»“æœï¼šä»10ä¸ªèŠ‚ç‚¹ä¸­ç­›é€‰å‡º5ä¸ªå€™é€‰èŠ‚ç‚¹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¼˜é€‰é˜¶æ®µï¼ˆScoringï¼‰                                         â”‚
â”‚                                                             â”‚
â”‚  å¯¹å€™é€‰èŠ‚ç‚¹æ‰“åˆ†ï¼ˆ0-100åˆ†ï¼‰ï¼š                                  â”‚
â”‚  - èµ„æºå‡è¡¡åº¦ï¼ˆLeastRequestedPriorityï¼‰                      â”‚
â”‚  - èŠ‚ç‚¹äº²å’Œæ€§åå¥½ï¼ˆNodeAffinityPriorityï¼‰                    â”‚
â”‚  - Podäº²å’Œæ€§åå¥½ï¼ˆInterPodAffinityPriorityï¼‰                 â”‚
â”‚  - é•œåƒå·²å­˜åœ¨ï¼ˆImageLocalityPriorityï¼‰                       â”‚
â”‚  - ...                                                      â”‚
â”‚                                                             â”‚
â”‚  Node1: 85åˆ† | Node2: 92åˆ† | Node3: 78åˆ† | ...               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é€‰æ‹©æœ€é«˜åˆ†èŠ‚ç‚¹ï¼šNode2ï¼ˆ92åˆ†ï¼‰                                â”‚
â”‚  ç»‘å®šPodåˆ°Node2                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Node2ä¸Šçš„Kubelet                                           â”‚
â”‚  - ç›‘å¬åˆ°åˆ†é…ç»™è‡ªå·±çš„Pod                                     â”‚
â”‚  - æ‹‰å–é•œåƒ                                                 â”‚
â”‚  - åˆ›å»ºå®¹å™¨                                                 â”‚
â”‚  - PodçŠ¶æ€ï¼šRunning                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;1.3 è°ƒåº¦ç­–ç•¥å…¨æ™¯å›¾&lt;/h4&gt;
&lt;p&gt;K8sæä¾›äº†å¤šç§è°ƒåº¦ç­–ç•¥ï¼ŒæŒ‰ç…§&lt;strong&gt;çº¦æŸå¼ºåº¦&lt;/strong&gt;å¯ä»¥åˆ†ä¸ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    K8sè°ƒåº¦ç­–ç•¥å…¨æ™¯å›¾                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ã€ç¡¬æ€§çº¦æŸã€‘å¿…é¡»æ»¡è¶³ï¼Œå¦åˆ™Podæ— æ³•è°ƒåº¦                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ nodeSelector          - èŠ‚ç‚¹æ ‡ç­¾é€‰æ‹©å™¨              â”‚   â”‚
â”‚  â”‚ â€¢ nodeName              - æŒ‡å®šèŠ‚ç‚¹åç§°                â”‚   â”‚
â”‚  â”‚ â€¢ nodeAffinity.required - èŠ‚ç‚¹äº²å’Œæ€§ï¼ˆç¡¬æ€§ï¼‰          â”‚   â”‚
â”‚  â”‚ â€¢ podAffinity.required  - Podäº²å’Œæ€§ï¼ˆç¡¬æ€§ï¼‰           â”‚   â”‚
â”‚  â”‚ â€¢ Taints &amp;amp; Tolerations  - æ±¡ç‚¹ä¸å®¹å¿                  â”‚   â”‚
â”‚  â”‚ â€¢ èµ„æºè¯·æ±‚              - CPU/å†…å­˜å¿…é¡»æ»¡è¶³            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ã€è½¯æ€§åå¥½ã€‘å°½é‡æ»¡è¶³ï¼Œä¸æ»¡è¶³ä¹Ÿèƒ½è°ƒåº¦                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ nodeAffinity.preferred  - èŠ‚ç‚¹äº²å’Œæ€§ï¼ˆè½¯æ€§ï¼‰        â”‚   â”‚
â”‚  â”‚ â€¢ podAffinity.preferred   - Podäº²å’Œæ€§ï¼ˆè½¯æ€§ï¼‰         â”‚   â”‚
â”‚  â”‚ â€¢ podAntiAffinity         - Podåäº²å’Œæ€§               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ã€ä¼˜å…ˆçº§è°ƒåº¦ã€‘èµ„æºä¸è¶³æ—¶çš„æŠ¢å æœºåˆ¶                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â€¢ PriorityClass          - Podä¼˜å…ˆçº§                  â”‚   â”‚
â”‚  â”‚ â€¢ Preemption             - æŠ¢å ä½ä¼˜å…ˆçº§Pod            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç­–ç•¥ä¼˜å…ˆçº§å…³ç³»ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;è°ƒåº¦å†³ç­–é¡ºåºï¼ˆä»é«˜åˆ°ä½ï¼‰ï¼š

1. nodeNameï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   â†“ ç›´æ¥æŒ‡å®šèŠ‚ç‚¹ï¼Œç»•è¿‡Scheduler
2. Taints &amp;amp; Tolerations
   â†“ èŠ‚ç‚¹æ’æ–¥æœºåˆ¶
3. nodeSelector / nodeAffinity.required
   â†“ ç¡¬æ€§èŠ‚ç‚¹é€‰æ‹©
4. podAffinity/podAntiAffinity.required
   â†“ ç¡¬æ€§Podäº²å’Œ/åäº²å’Œ
5. nodeAffinity.preferred
   â†“ è½¯æ€§èŠ‚ç‚¹åå¥½
6. podAffinity/podAntiAffinity.preferred
   â†“ è½¯æ€§Podäº²å’Œ/åäº²å’Œ
7. èµ„æºå‡è¡¡ã€é•œåƒæœ¬åœ°åŒ–ç­‰å…¶ä»–å› ç´ 
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;2. èŠ‚ç‚¹é€‰æ‹©æœºåˆ¶&lt;/h3&gt;
&lt;h4&gt;2.1 nodeSelectorï¼šæœ€ç®€å•çš„èŠ‚ç‚¹é€‰æ‹©&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;nodeSelector&lt;/strong&gt; æ˜¯æœ€ç®€å•çš„èŠ‚ç‚¹é€‰æ‹©æ–¹å¼ï¼Œé€šè¿‡æ ‡ç­¾åŒ¹é…å°†Podè°ƒåº¦åˆ°ç‰¹å®šèŠ‚ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯1ï¼šå°†Podè°ƒåº¦åˆ°SSDèŠ‚ç‚¹
  èŠ‚ç‚¹æ ‡ç­¾ï¼šdisk-type=ssd
  Podé…ç½®ï¼šnodeSelector: disk-type: ssd

åœºæ™¯2ï¼šå°†Podè°ƒåº¦åˆ°GPUèŠ‚ç‚¹
  èŠ‚ç‚¹æ ‡ç­¾ï¼šgpu=nvidia
  Podé…ç½®ï¼šnodeSelector: gpu: nvidia

åœºæ™¯3ï¼šå°†Podè°ƒåº¦åˆ°ç‰¹å®šæœºæˆ¿
  èŠ‚ç‚¹æ ‡ç­¾ï¼šzone=beijing
  Podé…ç½®ï¼šnodeSelector: zone: beijing
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-ssd
spec:
  nodeSelector:           # èŠ‚ç‚¹é€‰æ‹©å™¨
    disk-type: ssd        # åªè°ƒåº¦åˆ°æ ‡ç­¾ä¸ºdisk-type=ssdçš„èŠ‚ç‚¹
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;èŠ‚ç‚¹æ ‡ç­¾ç®¡ç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹èŠ‚ç‚¹æ ‡ç­¾
kubectl get nodes --show-labels

# ä¸ºèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾
kubectl label nodes k8s-node1 disk-type=ssd

# ä¿®æ”¹èŠ‚ç‚¹æ ‡ç­¾
kubectl label nodes k8s-node1 disk-type=hdd --overwrite

# åˆ é™¤èŠ‚ç‚¹æ ‡ç­¾
kubectl label nodes k8s-node1 disk-type-

# æ ¹æ®æ ‡ç­¾ç­›é€‰èŠ‚ç‚¹
kubectl get nodes -l disk-type=ssd
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;nodeSelectorçš„å±€é™æ€§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;âœ— åªæ”¯æŒç²¾ç¡®åŒ¹é…ï¼ˆkey=valueï¼‰
âœ— ä¸æ”¯æŒ&quot;æˆ–&quot;é€»è¾‘ï¼ˆdisk-type=ssd æˆ– disk-type=nvmeï¼‰
âœ— ä¸æ”¯æŒ&quot;é&quot;é€»è¾‘ï¼ˆä¸è¦disk-type=hddï¼‰
âœ— ä¸æ”¯æŒè½¯æ€§åå¥½ï¼ˆå°½é‡é€‰æ‹©ï¼Œä½†ä¸å¼ºåˆ¶ï¼‰

è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨nodeAffinityï¼ˆèŠ‚ç‚¹äº²å’Œæ€§ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2.2 nodeAffinityï¼šé«˜çº§èŠ‚ç‚¹äº²å’Œæ€§&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;nodeAffinity&lt;/strong&gt; æ˜¯nodeSelectorçš„å¢å¼ºç‰ˆï¼Œæä¾›æ›´çµæ´»çš„èŠ‚ç‚¹é€‰æ‹©èƒ½åŠ›ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸¤ç§äº²å’Œæ€§ç±»å‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;æ•ˆæœ&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;requiredDuringSchedulingIgnoredDuringExecution&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç¡¬æ€§è¦æ±‚&lt;/td&gt;
&lt;td&gt;å¿…é¡»æ»¡è¶³ï¼Œå¦åˆ™ä¸è°ƒåº¦&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;preferredDuringSchedulingIgnoredDuringExecution&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è½¯æ€§åå¥½&lt;/td&gt;
&lt;td&gt;å°½é‡æ»¡è¶³ï¼Œä¸æ»¡è¶³ä¹Ÿå¯è°ƒåº¦&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;åç§°è§£æï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;requiredDuringScheduling  = è°ƒåº¦æ—¶å¿…é¡»æ»¡è¶³
preferred DuringScheduling = è°ƒåº¦æ—¶å°½é‡æ»¡è¶³
IgnoredDuringExecution   = è¿è¡Œæ—¶å¿½ç•¥ï¼ˆPodå·²è¿è¡Œåï¼Œå³ä½¿æ¡ä»¶ä¸æ»¡è¶³ä¹Ÿä¸é©±é€ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ”¯æŒçš„æ“ä½œç¬¦ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ“ä½œç¬¦&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;In&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å€¼åœ¨åˆ—è¡¨ä¸­&lt;/td&gt;
&lt;td&gt;key In [v1, v2]&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;NotIn&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å€¼ä¸åœ¨åˆ—è¡¨ä¸­&lt;/td&gt;
&lt;td&gt;key NotIn [v1, v2]&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Exists&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾å­˜åœ¨&lt;/td&gt;
&lt;td&gt;key Exists&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DoesNotExist&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾ä¸å­˜åœ¨&lt;/td&gt;
&lt;td&gt;key DoesNotExist&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Gt&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¤§äºï¼ˆæ•°å€¼ï¼‰&lt;/td&gt;
&lt;td&gt;key Gt 5&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Lt&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å°äºï¼ˆæ•°å€¼ï¼‰&lt;/td&gt;
&lt;td&gt;key Lt 10&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹1ï¼šç¡¬æ€§è¦æ±‚&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-affinity-required
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:  # ç¡¬æ€§è¦æ±‚
        nodeSelectorTerms:
        - matchExpressions:
          - key: disk-type
            operator: In
            values:
            - ssd
            - nvme          # disk-type=ssd æˆ– disk-type=nvme
          - key: zone
            operator: In
            values:
            - beijing       # åŒæ—¶ zone=beijing
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹2ï¼šè½¯æ€§åå¥½&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-affinity-preferred
spec:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:  # è½¯æ€§åå¥½
      - weight: 80          # æƒé‡1-100ï¼Œè¶Šé«˜è¶Šä¼˜å…ˆ
        preference:
          matchExpressions:
          - key: disk-type
            operator: In
            values:
            - ssd
      - weight: 20          # æƒé‡è¾ƒä½
        preference:
          matchExpressions:
          - key: zone
            operator: In
            values:
            - beijing
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹3ï¼šç¡¬æ€§+è½¯æ€§ç»„åˆ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-affinity-combo
spec:
  affinity:
    nodeAffinity:
      # ç¡¬æ€§è¦æ±‚ï¼šå¿…é¡»åœ¨beijingæˆ–shanghai
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: zone
            operator: In
            values:
            - beijing
            - shanghai
      # è½¯æ€§åå¥½ï¼šå°½é‡é€‰æ‹©SSDèŠ‚ç‚¹
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        preference:
          matchExpressions:
          - key: disk-type
            operator: In
            values:
            - ssd
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2.3 nodeNameï¼šç›´æ¥æŒ‡å®šèŠ‚ç‚¹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;nodeName&lt;/strong&gt; ç›´æ¥æŒ‡å®šPodè¿è¡Œçš„èŠ‚ç‚¹åç§°ï¼Œç»•è¿‡Schedulerã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-specific-node
spec:
  nodeName: k8s-node1      # ç›´æ¥æŒ‡å®šèŠ‚ç‚¹åç§°
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;âš ï¸ ä½¿ç”¨nodeNameçš„é£é™©ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;âœ— ç»•è¿‡Schedulerï¼Œä¸æ£€æŸ¥èµ„æºæ˜¯å¦å……è¶³
âœ— ç»•è¿‡Taintsæ£€æŸ¥ï¼Œå¯èƒ½è°ƒåº¦åˆ°ä¸åº”è¯¥å»çš„èŠ‚ç‚¹
âœ— èŠ‚ç‚¹ä¸å­˜åœ¨æˆ–ä¸å¯ç”¨æ—¶ï¼ŒPodä¸€ç›´Pending
âœ— ä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨

é€‚ç”¨åœºæ™¯ï¼š
âœ“ è°ƒè¯•å’Œæµ‹è¯•
âœ“ DaemonSetï¼ˆæ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªPodï¼‰
âœ“ é™æ€Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;3. æ±¡ç‚¹ä¸å®¹å¿ï¼ˆTaints &amp;amp; Tolerationsï¼‰&lt;/h3&gt;
&lt;h4&gt;3.1 ä»€ä¹ˆæ˜¯æ±¡ç‚¹å’Œå®¹å¿&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ±¡ç‚¹ï¼ˆTaintï¼‰&lt;/strong&gt; æ˜¯èŠ‚ç‚¹çš„å±æ€§ï¼Œç”¨äºæ’æ–¥Podã€‚
&lt;strong&gt;å®¹å¿ï¼ˆTolerationï¼‰&lt;/strong&gt; æ˜¯Podçš„å±æ€§ï¼Œç”¨äºå®¹å¿èŠ‚ç‚¹çš„æ±¡ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿæ´»åŒ–æ¯”å–»ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æƒ³è±¡ä¸€ä¸ªå…¬å¯“æ¥¼çš„ç§Ÿæˆ¿åœºæ™¯ï¼š

èŠ‚ç‚¹ï¼ˆNodeï¼‰ = å…¬å¯“æˆ¿é—´
æ±¡ç‚¹ï¼ˆTaintï¼‰ = æˆ¿é—´çš„&quot;ç¼ºç‚¹æ ‡ç­¾&quot;ï¼ˆå¦‚ï¼šé é©¬è·¯åµã€æ²¡æœ‰ç”µæ¢¯ã€åªç§Ÿç»™ç¨‹åºå‘˜ï¼‰
Pod          = ç§Ÿå®¢
å®¹å¿ï¼ˆTolerationï¼‰ = ç§Ÿå®¢èƒ½æ¥å—çš„&quot;ç¼ºç‚¹&quot;

åœºæ™¯1ï¼šæˆ¿é—´æ ‡ç­¾&quot;é é©¬è·¯=åµ:NoSchedule&quot;
  â†’ æ™®é€šç§Ÿå®¢ä¸æ„¿æ„ä½ï¼ˆPodä¸ä¼šè°ƒåº¦ï¼‰
  â†’ èƒ½å¿å—å™ªéŸ³çš„ç§Ÿå®¢å¯ä»¥ä½ï¼ˆPodé…ç½®äº†å¯¹åº”Tolerationï¼‰

åœºæ™¯2ï¼šMasterèŠ‚ç‚¹çš„æ±¡ç‚¹&quot;node-role.kubernetes.io/control-plane:NoSchedule&quot;
  â†’ æ™®é€šPodä¸ä¼šè°ƒåº¦åˆ°Master
  â†’ ç³»ç»Ÿç»„ä»¶ï¼ˆå¦‚CoreDNSï¼‰é…ç½®äº†å®¹å¿ï¼Œå¯ä»¥è¿è¡Œåœ¨Masterä¸Š
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œåŸç†å›¾ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èŠ‚ç‚¹æœ‰æ±¡ç‚¹ + Podæ²¡æœ‰å¯¹åº”å®¹å¿ = Podä¸ä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹           â”‚
â”‚  èŠ‚ç‚¹æœ‰æ±¡ç‚¹ + Podæœ‰å¯¹åº”å®¹å¿   = Podå¯ä»¥è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹           â”‚
â”‚  èŠ‚ç‚¹æ²¡æœ‰æ±¡ç‚¹               = Podå¯ä»¥è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node1     â”‚                    â”‚   Node2     â”‚
â”‚  æ— æ±¡ç‚¹     â”‚                    â”‚ Taint: gpu  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                                  â†‘
      â”‚ âœ“ å¯ä»¥è°ƒåº¦                        â”‚ âœ— ä¸èƒ½è°ƒåº¦
      â”‚                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pod A     â”‚                    â”‚   Pod A     â”‚
â”‚  æ— å®¹å¿     â”‚                    â”‚  æ— å®¹å¿     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Node1     â”‚                    â”‚   Node2     â”‚
â”‚  æ— æ±¡ç‚¹     â”‚                    â”‚ Taint: gpu  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                                  â†‘
      â”‚ âœ“ å¯ä»¥è°ƒåº¦                        â”‚ âœ“ å¯ä»¥è°ƒåº¦
      â”‚                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Pod B     â”‚                    â”‚   Pod B     â”‚
â”‚ Toleration: â”‚                    â”‚ Toleration: â”‚
â”‚   gpu       â”‚                    â”‚   gpu       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.2 æ±¡ç‚¹çš„ç±»å‹ä¸æ•ˆæœ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ±¡ç‚¹æ ¼å¼ï¼š&lt;/strong&gt; &lt;code&gt;key=value:effect&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸‰ç§Effectï¼ˆæ•ˆæœï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Effect&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;å·²è¿è¡Œçš„Pod&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;NoSchedule&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¸è°ƒåº¦æ–°Pod&lt;/td&gt;
&lt;td&gt;ä¸å½±å“ï¼ˆç»§ç»­è¿è¡Œï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;PreferNoSchedule&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å°½é‡ä¸è°ƒåº¦æ–°Podï¼ˆè½¯æ€§ï¼‰&lt;/td&gt;
&lt;td&gt;ä¸å½±å“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;NoExecute&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¸è°ƒåº¦æ–°Pod + é©±é€å·²è¿è¡Œçš„Pod&lt;/td&gt;
&lt;td&gt;é©±é€ï¼&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;è¯¦ç»†å¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NoScheduleï¼ˆä¸è°ƒåº¦ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•ˆæœï¼šæ–°Podä¸ä¼šè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹                    â”‚
â”‚ å·²æœ‰Podï¼šä¸å—å½±å“ï¼Œç»§ç»­è¿è¡Œ                    â”‚
â”‚                                              â”‚
â”‚ ä½¿ç”¨åœºæ™¯ï¼š                                    â”‚
â”‚ - MasterèŠ‚ç‚¹ï¼ˆä¸è¿è¡Œä¸šåŠ¡Podï¼‰                 â”‚
â”‚ - ä¸“ç”¨èŠ‚ç‚¹ï¼ˆGPUèŠ‚ç‚¹åªç»™ç‰¹å®šåº”ç”¨ï¼‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PreferNoScheduleï¼ˆå°½é‡ä¸è°ƒåº¦ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•ˆæœï¼šå°½é‡ä¸è°ƒåº¦ï¼Œä½†å¦‚æœæ²¡æœ‰å…¶ä»–èŠ‚ç‚¹å¯ä»¥è°ƒåº¦    â”‚
â”‚ å·²æœ‰Podï¼šä¸å—å½±å“ï¼Œç»§ç»­è¿è¡Œ                    â”‚
â”‚                                              â”‚
â”‚ ä½¿ç”¨åœºæ™¯ï¼š                                    â”‚
â”‚ - èµ„æºç´§å¼ çš„èŠ‚ç‚¹ï¼ˆå¸Œæœ›æ–°Podå»å…¶ä»–èŠ‚ç‚¹ï¼‰        â”‚
â”‚ - ç»´æŠ¤é¢„å¤‡èŠ‚ç‚¹ï¼ˆå‡†å¤‡ä¸‹çº¿ï¼Œä½†ä¸ç´§æ€¥ï¼‰           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

NoExecuteï¼ˆä¸è°ƒåº¦+é©±é€ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ•ˆæœï¼šæ–°Podä¸è°ƒåº¦ + é©±é€å·²æœ‰Pod                â”‚
â”‚ å·²æœ‰Podï¼šè¢«é©±é€ï¼ï¼ˆé™¤éæœ‰å®¹å¿ï¼‰                â”‚
â”‚                                              â”‚
â”‚ ä½¿ç”¨åœºæ™¯ï¼š                                    â”‚
â”‚ - èŠ‚ç‚¹ç»´æŠ¤ï¼ˆéœ€è¦æ¸…ç©ºèŠ‚ç‚¹ï¼‰                    â”‚
â”‚ - èŠ‚ç‚¹æ•…éšœï¼ˆè‡ªåŠ¨æ·»åŠ ï¼Œè§¦å‘Podè¿ç§»ï¼‰           â”‚
â”‚ - èŠ‚ç‚¹éš”ç¦»ï¼ˆå®‰å…¨åŸå› éœ€è¦æ¸…ç©ºï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ±¡ç‚¹ç®¡ç†å‘½ä»¤ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ·»åŠ æ±¡ç‚¹
kubectl taint nodes k8s-node1 key=value:NoSchedule

# æŸ¥çœ‹èŠ‚ç‚¹æ±¡ç‚¹
kubectl describe node k8s-node1 | grep Taints

# åˆ é™¤æ±¡ç‚¹ï¼ˆkeyååŠ å‡å·ï¼‰
kubectl taint nodes k8s-node1 key=value:NoSchedule-

# åˆ é™¤æŸä¸ªkeyçš„æ‰€æœ‰æ±¡ç‚¹
kubectl taint nodes k8s-node1 key-

# ç¤ºä¾‹ï¼šæ·»åŠ GPUä¸“ç”¨èŠ‚ç‚¹æ±¡ç‚¹
kubectl taint nodes k8s-node1 gpu=nvidia:NoSchedule

# ç¤ºä¾‹ï¼šæ·»åŠ ç»´æŠ¤æ±¡ç‚¹ï¼ˆä¼šé©±é€Podï¼‰
kubectl taint nodes k8s-node1 maintenance=true:NoExecute
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.3 å®¹å¿çš„é…ç½®æ–¹å¼&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®¹å¿é…ç½®æ ¼å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;tolerations:
- key: &quot;key&quot;              # æ±¡ç‚¹çš„key
  operator: &quot;Equal&quot;       # æ“ä½œç¬¦ï¼šEqualæˆ–Exists
  value: &quot;value&quot;          # æ±¡ç‚¹çš„valueï¼ˆExistsæ—¶ä¸éœ€è¦ï¼‰
  effect: &quot;NoSchedule&quot;    # æ±¡ç‚¹çš„effectï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™åŒ¹é…æ‰€æœ‰effectï¼‰
  tolerationSeconds: 3600 # å®¹å¿æ—¶é—´ï¼ˆä»…NoExecuteæœ‰æ•ˆï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ“ä½œç¬¦è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Operator&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Equal&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;keyå’Œvalueéƒ½å¿…é¡»åŒ¹é…&lt;/td&gt;
&lt;td&gt;key=value&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Exists&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åªéœ€è¦keyå­˜åœ¨&lt;/td&gt;
&lt;td&gt;ä»»æ„valueéƒ½åŒ¹é…&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹1ï¼šç²¾ç¡®åŒ¹é…&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-toleration
spec:
  tolerations:
  - key: &quot;gpu&quot;
    operator: &quot;Equal&quot;
    value: &quot;nvidia&quot;
    effect: &quot;NoSchedule&quot;
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹2ï¼šåªåŒ¹é…key&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-toleration-exists
spec:
  tolerations:
  - key: &quot;gpu&quot;
    operator: &quot;Exists&quot;      # åªè¦æœ‰gpuè¿™ä¸ªkeyå°±å®¹å¿
    effect: &quot;NoSchedule&quot;
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹3ï¼šå®¹å¿æ‰€æœ‰æ±¡ç‚¹&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-tolerate-all
spec:
  tolerations:
  - operator: &quot;Exists&quot;      # å®¹å¿æ‰€æœ‰æ±¡ç‚¹ï¼ˆå±é™©ï¼ï¼‰
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹4ï¼šNoExecute + tolerationSeconds&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-toleration-seconds
spec:
  tolerations:
  - key: &quot;maintenance&quot;
    operator: &quot;Equal&quot;
    value: &quot;true&quot;
    effect: &quot;NoExecute&quot;
    tolerationSeconds: 3600   # å®¹å¿3600ç§’åè¢«é©±é€
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;tolerationSecondsè¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å½“èŠ‚ç‚¹æ·»åŠ NoExecuteæ±¡ç‚¹åï¼š
- Podæ²¡æœ‰å¯¹åº”å®¹å¿ â†’ ç«‹å³é©±é€
- Podæœ‰å®¹å¿ï¼Œæ— tolerationSeconds â†’ æ°¸ä¸é©±é€
- Podæœ‰å®¹å¿ï¼ŒtolerationSeconds=3600 â†’ 3600ç§’åé©±é€

ä½¿ç”¨åœºæ™¯ï¼š
- èŠ‚ç‚¹ç»´æŠ¤æ—¶ï¼Œç»™åº”ç”¨ä¸€å®šæ—¶é—´ä¼˜é›…é€€å‡º
- èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†è¿ç§»Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.4 å†…ç½®æ±¡ç‚¹&lt;/h4&gt;
&lt;p&gt;K8sä¼šè‡ªåŠ¨ä¸ºèŠ‚ç‚¹æ·»åŠ ä¸€äº›å†…ç½®æ±¡ç‚¹ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ±¡ç‚¹Key&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ä½•æ—¶æ·»åŠ &lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;node.kubernetes.io/not-ready&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹æœªå°±ç»ª&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹çŠ¶æ€NotReady&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;node.kubernetes.io/unreachable&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹ä¸å¯è¾¾&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹å¤±è”&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;node.kubernetes.io/memory-pressure&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;å†…å­˜å‹åŠ›&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹å†…å­˜ä¸è¶³&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;node.kubernetes.io/disk-pressure&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;ç£ç›˜å‹åŠ›&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹ç£ç›˜ä¸è¶³&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;node.kubernetes.io/pid-pressure&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;PIDå‹åŠ›&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹PIDä¸è¶³&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;node.kubernetes.io/network-unavailable&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;ç½‘ç»œä¸å¯ç”¨&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹ç½‘ç»œæ•…éšœ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;node.kubernetes.io/unschedulable&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;èŠ‚ç‚¹ä¸å¯è°ƒåº¦&lt;/td&gt;
&lt;td&gt;kubectl cordon&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;é»˜è®¤å®¹å¿ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Kubernetesé»˜è®¤ä¸ºæ‰€æœ‰Podæ·»åŠ ä»¥ä¸‹å®¹å¿ï¼ˆ300ç§’åé©±é€ï¼‰
tolerations:
- key: &quot;node.kubernetes.io/not-ready&quot;
  operator: &quot;Exists&quot;
  effect: &quot;NoExecute&quot;
  tolerationSeconds: 300
- key: &quot;node.kubernetes.io/unreachable&quot;
  operator: &quot;Exists&quot;
  effect: &quot;NoExecute&quot;
  tolerationSeconds: 300
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;4. Podäº²å’Œæ€§ä¸åäº²å’Œæ€§&lt;/h3&gt;
&lt;h4&gt;4.1 ä»€ä¹ˆæ˜¯Podäº²å’Œæ€§&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Podäº²å’Œæ€§ï¼ˆpodAffinityï¼‰&lt;/strong&gt; æ ¹æ®å·²è¿è¡ŒPodçš„æ ‡ç­¾ï¼Œå†³å®šæ–°Podè°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯1ï¼šå°†å‰ç«¯å’Œåç«¯è°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹ï¼ˆå‡å°‘ç½‘ç»œå»¶è¿Ÿï¼‰
  â†’ å‰ç«¯Podäº²å’Œåç«¯Pod

åœºæ™¯2ï¼šå°†åŒä¸€æœåŠ¡çš„å¤šä¸ªå‰¯æœ¬åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨ï¼‰
  â†’ Podåäº²å’Œï¼ˆpodAntiAffinityï¼‰

åœºæ™¯3ï¼šå°†æ—¥å¿—æ”¶é›†å™¨è°ƒåº¦åˆ°æœ‰åº”ç”¨Podçš„èŠ‚ç‚¹
  â†’ æ—¥å¿—æ”¶é›†Podäº²å’Œåº”ç”¨Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®æ¦‚å¿µ - topologyKeyï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;topologyKeyå®šä¹‰&quot;åŒä¸€ä½ç½®&quot;çš„èŒƒå›´ï¼š

topologyKey: kubernetes.io/hostname
  â†’ åŒä¸€èŠ‚ç‚¹ï¼ˆæœ€å¸¸ç”¨ï¼‰

topologyKey: topology.kubernetes.io/zone
  â†’ åŒä¸€å¯ç”¨åŒº

topologyKey: topology.kubernetes.io/region
  â†’ åŒä¸€åŒºåŸŸ

ç¤ºä¾‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Region: asia-east                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Zone: zone-a       â”‚  â”‚  Zone: zone-b       â”‚       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚       â”‚
â”‚  â”‚  â”‚Node1â”‚ â”‚Node2â”‚   â”‚  â”‚  â”‚Node3â”‚ â”‚Node4â”‚   â”‚       â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   â”‚  â”‚  â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”˜   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

topologyKey=hostname â†’ Node1å’ŒNode2æ˜¯ä¸åŒä½ç½®
topologyKey=zone     â†’ Node1å’ŒNode2æ˜¯åŒä¸€ä½ç½®ï¼ˆzone-aï¼‰
topologyKey=region   â†’ æ‰€æœ‰èŠ‚ç‚¹æ˜¯åŒä¸€ä½ç½®ï¼ˆasia-eastï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.2 Podäº²å’Œæ€§é…ç½®&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼šå°†ç¼“å­˜Podè°ƒåº¦åˆ°Web Podæ‰€åœ¨èŠ‚ç‚¹&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: cache-pod
spec:
  affinity:
    podAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:  # ç¡¬æ€§è¦æ±‚
      - labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - web           # é€‰æ‹©æ ‡ç­¾app=webçš„Pod
        topologyKey: kubernetes.io/hostname  # åŒä¸€èŠ‚ç‚¹
  containers:
  - name: redis
    image: redis:6.0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è½¯æ€§åå¥½ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: cache-pod-preferred
spec:
  affinity:
    podAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:  # è½¯æ€§åå¥½
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
            - key: app
              operator: In
              values:
              - web
          topologyKey: kubernetes.io/hostname
  containers:
  - name: redis
    image: redis:6.0
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.3 Podåäº²å’Œæ€§é…ç½®&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åäº²å’Œæ€§ï¼ˆpodAntiAffinityï¼‰&lt;/strong&gt; ç¡®ä¿Podä¸ä¼šè°ƒåº¦åˆ°åŒä¸€ä½ç½®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼šé«˜å¯ç”¨éƒ¨ç½²&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ha
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:  # ç¡¬æ€§è¦æ±‚
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - nginx       # åäº²å’Œè‡ªå·±ï¼ˆç›¸åŒæ ‡ç­¾çš„Podï¼‰
            topologyKey: kubernetes.io/hostname  # ä¸åœ¨åŒä¸€èŠ‚ç‚¹
      containers:
      - name: nginx
        image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ•ˆæœï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3ä¸ªnginxå‰¯æœ¬åˆ†æ•£åˆ°3ä¸ªä¸åŒèŠ‚ç‚¹ï¼š                      â”‚
â”‚                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Node1  â”‚    â”‚  Node2  â”‚    â”‚  Node3  â”‚          â”‚
â”‚  â”‚ nginx-1 â”‚    â”‚ nginx-2 â”‚    â”‚ nginx-3 â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                      â”‚
â”‚  å¦‚æœåªæœ‰2ä¸ªèŠ‚ç‚¹ï¼Œç¬¬3ä¸ªPodä¼šPendingï¼                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è½¯æ€§åäº²å’Œï¼ˆæ¨èç”Ÿäº§ä½¿ç”¨ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ha-soft
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:  # è½¯æ€§åå¥½
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - nginx
              topologyKey: kubernetes.io/hostname
      containers:
      - name: nginx
        image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;5. ä¼˜å…ˆçº§ä¸æŠ¢å &lt;/h3&gt;
&lt;h4&gt;5.1 PriorityClass&lt;/h4&gt;
&lt;p&gt;å½“é›†ç¾¤èµ„æºä¸è¶³æ—¶ï¼Œé«˜ä¼˜å…ˆçº§Podå¯ä»¥æŠ¢å ä½ä¼˜å…ˆçº§Podã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºPriorityClassï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000000           # ä¼˜å…ˆçº§å€¼ï¼Œè¶Šå¤§è¶Šä¼˜å…ˆ
globalDefault: false      # æ˜¯å¦ä¸ºé»˜è®¤ä¼˜å…ˆçº§
preemptionPolicy: PreemptLowerPriority  # å¯ä»¥æŠ¢å ä½ä¼˜å…ˆçº§Pod
description: &quot;ç”¨äºå…³é”®ä¸šåŠ¡Pod&quot;

---
apiVersion: scheduling.k8s.io/v1
kind: PriorityClass
metadata:
  name: low-priority
value: 1000
globalDefault: false
preemptionPolicy: Never   # ä¸æŠ¢å å…¶ä»–Pod
description: &quot;ç”¨äºéå…³é”®ä¸šåŠ¡Pod&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨PriorityClassï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: critical-pod
spec:
  priorityClassName: high-priority    # ä½¿ç”¨é«˜ä¼˜å…ˆçº§
  containers:
  - name: app
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŠ¢å æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;èµ„æºä¸è¶³æ—¶ï¼š
1. é«˜ä¼˜å…ˆçº§Podè¿›å…¥Pending
2. Scheduleræ£€æŸ¥æ˜¯å¦å¯ä»¥é€šè¿‡æŠ¢å ä½ä¼˜å…ˆçº§Podæ¥è°ƒåº¦
3. é€‰æ‹©è¢«æŠ¢å çš„Podï¼ˆå°½é‡é€‰æ‹©å½±å“æœ€å°çš„ï¼‰
4. é©±é€è¢«æŠ¢å çš„Podï¼ˆä¼˜é›…ç»ˆæ­¢ï¼‰
5. è°ƒåº¦é«˜ä¼˜å…ˆçº§Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;6. å®æˆ˜æ¼”ç»ƒ&lt;/h3&gt;
&lt;h4&gt;6.1 å®éªŒå‡†å¤‡&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºå®éªŒç›®å½•
mkdir -p /root/k8s-yaml/scheduling
cd /root/k8s-yaml/scheduling

# æŸ¥çœ‹å½“å‰èŠ‚ç‚¹å’Œæ ‡ç­¾
kubectl get nodes --show-labels
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;6.2 å®éªŒ1ï¼šnodeSelectoråŸºç¡€è°ƒåº¦&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç›®æ ‡ï¼š&lt;/strong&gt; å°†Podè°ƒåº¦åˆ°ç‰¹å®šæ ‡ç­¾çš„èŠ‚ç‚¹&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šä¸ºèŠ‚ç‚¹æ·»åŠ æ ‡ç­¾&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸ºnode1æ·»åŠ æ ‡ç­¾
kubectl label nodes k8s-node1 disk-type=ssd env=production

# ä¸ºnode2æ·»åŠ æ ‡ç­¾
kubectl label nodes k8s-node2 disk-type=hdd env=testing

# éªŒè¯æ ‡ç­¾
kubectl get nodes -L disk-type,env
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåˆ›å»ºä½¿ç”¨nodeSelectorçš„Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nodeselector-pod.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-ssd
spec:
  nodeSelector:
    disk-type: ssd
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f nodeselector-pod.yaml

# æŸ¥çœ‹Podè°ƒåº¦åˆ°å“ªä¸ªèŠ‚ç‚¹
kubectl get pod nginx-ssd -o wide
# åº”è¯¥è°ƒåº¦åˆ°k8s-node1ï¼ˆdisk-type=ssdï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šéªŒè¯è°ƒåº¦é™åˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºä¸€ä¸ªä¸å­˜åœ¨æ ‡ç­¾çš„Pod
cat &amp;gt; nodeselector-notexist.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-notexist
spec:
  nodeSelector:
    disk-type: nvme    # æ²¡æœ‰èŠ‚ç‚¹æœ‰è¿™ä¸ªæ ‡ç­¾
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f nodeselector-notexist.yaml

# æŸ¥çœ‹PodçŠ¶æ€ï¼ˆåº”è¯¥æ˜¯Pendingï¼‰
kubectl get pod nginx-notexist
kubectl describe pod nginx-notexist | grep -A5 Events
# Warning  FailedScheduling  ...  0/3 nodes are available: 3 node(s) didn&apos;t match Pod&apos;s node affinity/selector
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¸…ç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete pod nginx-ssd nginx-notexist
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;6.3 å®éªŒ2ï¼šnodeAffinityé«˜çº§è°ƒåº¦&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç›®æ ‡ï¼š&lt;/strong&gt; ä½¿ç”¨nodeAffinityå®ç°å¤æ‚çš„èŠ‚ç‚¹é€‰æ‹©é€»è¾‘&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šåˆ›å»ºç¡¬æ€§è¦æ±‚çš„Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nodeaffinity-required.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-affinity-required
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: disk-type
            operator: In
            values:
            - ssd
            - nvme        # disk-type=ssd æˆ– disk-type=nvme
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f nodeaffinity-required.yaml

# æŸ¥çœ‹è°ƒåº¦ç»“æœ
kubectl get pod nginx-affinity-required -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåˆ›å»ºè½¯æ€§åå¥½çš„Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nodeaffinity-preferred.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-affinity-preferred
spec:
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 80
        preference:
          matchExpressions:
          - key: disk-type
            operator: In
            values:
            - ssd
      - weight: 20
        preference:
          matchExpressions:
          - key: env
            operator: In
            values:
            - production
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f nodeaffinity-preferred.yaml

# æŸ¥çœ‹è°ƒåº¦ç»“æœï¼ˆåº”è¯¥ä¼˜å…ˆé€‰æ‹©ssdèŠ‚ç‚¹ï¼‰
kubectl get pod nginx-affinity-preferred -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šæµ‹è¯•NotInæ“ä½œç¬¦ï¼ˆæ’é™¤ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nodeaffinity-notin.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-not-hdd
spec:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: disk-type
            operator: NotIn
            values:
            - hdd           # ä¸è°ƒåº¦åˆ°hddèŠ‚ç‚¹
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f nodeaffinity-notin.yaml

# åº”è¯¥è°ƒåº¦åˆ°node1ï¼ˆssdï¼‰ï¼Œä¸ä¼šè°ƒåº¦åˆ°node2ï¼ˆhddï¼‰
kubectl get pod nginx-not-hdd -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¸…ç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete pod nginx-affinity-required nginx-affinity-preferred nginx-not-hdd
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;6.4 å®éªŒ3ï¼šæ±¡ç‚¹ä¸å®¹å¿&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç›®æ ‡ï¼š&lt;/strong&gt; ä½¿ç”¨Taintå’ŒTolerationå®ç°èŠ‚ç‚¹éš”ç¦»&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šä¸ºèŠ‚ç‚¹æ·»åŠ æ±¡ç‚¹&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸ºnode2æ·»åŠ æ±¡ç‚¹ï¼ˆGPUä¸“ç”¨èŠ‚ç‚¹ï¼‰
kubectl taint nodes k8s-node2 gpu=nvidia:NoSchedule

# æŸ¥çœ‹æ±¡ç‚¹
kubectl describe node k8s-node2 | grep Taints
# Taints:  gpu=nvidia:NoSchedule
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåˆ›å»ºæ™®é€šPodï¼ˆæ— æ³•è°ƒåº¦åˆ°node2ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; pod-no-toleration.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-no-toleration
spec:
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f pod-no-toleration.yaml

# å¤šæ¬¡åˆ›å»ºï¼Œè§‚å¯Ÿè°ƒåº¦æƒ…å†µï¼ˆéƒ½ä¸ä¼šè°ƒåº¦åˆ°node2ï¼‰
kubectl get pod nginx-no-toleration -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šåˆ›å»ºå¸¦å®¹å¿çš„Podï¼ˆå¯ä»¥è°ƒåº¦åˆ°node2ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; pod-with-toleration.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-with-toleration
spec:
  tolerations:
  - key: &quot;gpu&quot;
    operator: &quot;Equal&quot;
    value: &quot;nvidia&quot;
    effect: &quot;NoSchedule&quot;
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f pod-with-toleration.yaml

# å¯ä»¥è°ƒåº¦åˆ°ä»»æ„èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬node2ï¼‰
kubectl get pod nginx-with-toleration -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4ï¼šå¼ºåˆ¶è°ƒåº¦åˆ°æ±¡ç‚¹èŠ‚ç‚¹&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; pod-force-tainted-node.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-force-node2
spec:
  nodeSelector:
    kubernetes.io/hostname: k8s-node2    # æŒ‡å®šnode2
  tolerations:
  - key: &quot;gpu&quot;
    operator: &quot;Equal&quot;
    value: &quot;nvidia&quot;
    effect: &quot;NoSchedule&quot;
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f pod-force-tainted-node.yaml

# å¿…å®šè°ƒåº¦åˆ°node2
kubectl get pod nginx-force-node2 -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤5ï¼šæµ‹è¯•NoExecuteé©±é€&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å…ˆåˆ›å»ºä¸€ä¸ªPodåœ¨node2ä¸Šè¿è¡Œ
cat &amp;gt; pod-on-node2.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-on-node2
spec:
  nodeSelector:
    kubernetes.io/hostname: k8s-node2
  tolerations:
  - key: &quot;gpu&quot;
    operator: &quot;Equal&quot;
    value: &quot;nvidia&quot;
    effect: &quot;NoSchedule&quot;
  containers:
  - name: nginx
    image: nginx:1.20
EOF

kubectl apply -f pod-on-node2.yaml
kubectl get pod nginx-on-node2 -o wide

# æ·»åŠ NoExecuteæ±¡ç‚¹ï¼ˆä¼šé©±é€ä¸å®¹å¿çš„Podï¼‰
kubectl taint nodes k8s-node2 maintenance=true:NoExecute

# æŸ¥çœ‹PodçŠ¶æ€ï¼ˆè¢«é©±é€ï¼Œå˜æˆPendingæˆ–Terminatingï¼‰
kubectl get pods -o wide

# åˆ é™¤æ±¡ç‚¹
kubectl taint nodes k8s-node2 maintenance=true:NoExecute-
kubectl taint nodes k8s-node2 gpu=nvidia:NoSchedule-
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¸…ç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete pod nginx-no-toleration nginx-with-toleration nginx-force-node2 nginx-on-node2
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;6.5 å®éªŒ4ï¼šPodåäº²å’Œå®ç°é«˜å¯ç”¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç›®æ ‡ï¼š&lt;/strong&gt; å°†Deploymentçš„å¤šä¸ªå‰¯æœ¬åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šåˆ›å»ºå¸¦åäº²å’Œçš„Deployment&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nginx-ha-deployment.yaml &amp;lt;&amp;lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ha
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-ha
  template:
    metadata:
      labels:
        app: nginx-ha
    spec:
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchExpressions:
                - key: app
                  operator: In
                  values:
                  - nginx-ha
              topologyKey: kubernetes.io/hostname
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
        - containerPort: 80
EOF

kubectl apply -f nginx-ha-deployment.yaml

# æŸ¥çœ‹Podåˆ†å¸ƒï¼ˆåº”è¯¥åˆ†æ•£åœ¨ä¸åŒèŠ‚ç‚¹ï¼‰
kubectl get pods -l app=nginx-ha -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸç»“æœï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME                       READY   STATUS    NODE
nginx-ha-xxx-aaa           1/1     Running   k8s-node1
nginx-ha-xxx-bbb           1/1     Running   k8s-node2
nginx-ha-xxx-ccc           1/1     Running   k8s-masterï¼ˆå¦‚æœmasterå…è®¸è°ƒåº¦ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šæµ‹è¯•ç¡¬æ€§åäº²å’Œï¼ˆå¯èƒ½å¯¼è‡´Pendingï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nginx-ha-strict.yaml &amp;lt;&amp;lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ha-strict
spec:
  replicas: 5              # 5ä¸ªå‰¯æœ¬ï¼Œä½†åªæœ‰2-3ä¸ªèŠ‚ç‚¹
  selector:
    matchLabels:
      app: nginx-ha-strict
  template:
    metadata:
      labels:
        app: nginx-ha-strict
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:  # ç¡¬æ€§è¦æ±‚
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - nginx-ha-strict
            topologyKey: kubernetes.io/hostname
      containers:
      - name: nginx
        image: nginx:1.20
EOF

kubectl apply -f nginx-ha-strict.yaml

# æŸ¥çœ‹PodçŠ¶æ€ï¼ˆéƒ¨åˆ†ä¼šPendingï¼‰
kubectl get pods -l app=nginx-ha-strict -o wide
kubectl describe pod -l app=nginx-ha-strict | grep -A3 Events
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¸…ç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete deployment nginx-ha nginx-ha-strict
kubectl label nodes k8s-node1 disk-type- env-
kubectl label nodes k8s-node2 disk-type- env-
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;7. æ€»ç»“&lt;/h3&gt;
&lt;h4&gt;7.1 è°ƒåº¦ç­–ç•¥é€‰æ‹©æŒ‡å—&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è°ƒåº¦ç­–ç•¥é€‰æ‹©å†³ç­–æ ‘                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  éœ€æ±‚ï¼šPodå¿…é¡»è¿è¡Œåœ¨ç‰¹å®šèŠ‚ç‚¹                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ç®€å•åœºæ™¯ â†’ nodeSelector                              â”‚   â”‚
â”‚  â”‚ å¤æ‚åœºæ™¯ â†’ nodeAffinity.required                     â”‚   â”‚
â”‚  â”‚ è°ƒè¯•/ç´§æ€¥ â†’ nodeNameï¼ˆä¸æ¨èç”Ÿäº§ï¼‰                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  éœ€æ±‚ï¼šPodå°½é‡è¿è¡Œåœ¨ç‰¹å®šèŠ‚ç‚¹ï¼ˆä¸å¼ºåˆ¶ï¼‰                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â†’ nodeAffinity.preferred                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  éœ€æ±‚ï¼šæŸäº›èŠ‚ç‚¹ä¸å…è®¸æ™®é€šPodè°ƒåº¦                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â†’ Taint (NoSchedule)                                 â”‚   â”‚
â”‚  â”‚   + ç‰¹å®šPodé…ç½®Toleration                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  éœ€æ±‚ï¼šå¤šå‰¯æœ¬Podåˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ï¼ˆé«˜å¯ç”¨ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â†’ podAntiAffinity.preferredï¼ˆæ¨èï¼‰                  â”‚   â”‚
â”‚  â”‚ â†’ podAntiAffinity.requiredï¼ˆèŠ‚ç‚¹å……è¶³æ—¶ï¼‰             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  éœ€æ±‚ï¼šç›¸å…³Podè°ƒåº¦åˆ°ä¸€èµ·ï¼ˆå‡å°‘å»¶è¿Ÿï¼‰                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â†’ podAffinity                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;7.2 ç”Ÿäº§æœ€ä½³å®è·µ&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# ç”Ÿäº§ç¯å¢ƒDeploymentæ¨èé…ç½®
apiVersion: apps/v1
kind: Deployment
metadata:
  name: production-app
spec:
  replicas: 3
  selector:
    matchLabels:
      app: production-app
  template:
    metadata:
      labels:
        app: production-app
    spec:
      # 1. è½¯æ€§åäº²å’Œï¼šå°½é‡åˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: production-app
              topologyKey: kubernetes.io/hostname
      
      # 2. å®¹å¿èŠ‚ç‚¹ä¸´æ—¶æ•…éšœï¼ˆé»˜è®¤300ç§’ï¼‰
      tolerations:
      - key: &quot;node.kubernetes.io/not-ready&quot;
        operator: &quot;Exists&quot;
        effect: &quot;NoExecute&quot;
        tolerationSeconds: 300
      - key: &quot;node.kubernetes.io/unreachable&quot;
        operator: &quot;Exists&quot;
        effect: &quot;NoExecute&quot;
        tolerationSeconds: 300
      
      containers:
      - name: app
        image: myapp:v1
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;7.3 å¸¸ç”¨å‘½ä»¤æ€»ç»“&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# === èŠ‚ç‚¹æ ‡ç­¾ç®¡ç† ===
kubectl get nodes --show-labels
kubectl label nodes &amp;lt;node&amp;gt; key=value
kubectl label nodes &amp;lt;node&amp;gt; key-

# === æ±¡ç‚¹ç®¡ç† ===
kubectl taint nodes &amp;lt;node&amp;gt; key=value:effect
kubectl taint nodes &amp;lt;node&amp;gt; key:effect-
kubectl describe node &amp;lt;node&amp;gt; | grep Taints

# === æŸ¥çœ‹è°ƒåº¦ç»“æœ ===
kubectl get pods -o wide
kubectl describe pod &amp;lt;pod&amp;gt; | grep -A10 Events

# === è°ƒè¯•è°ƒåº¦é—®é¢˜ ===
kubectl get events --field-selector reason=FailedScheduling
kubectl describe pod &amp;lt;pending-pod&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
</content:encoded></item><item><title>05.Kubernetes å­¦ä¹ ç¬”è®°ï¼šç‰¹æ®Šå·¥ä½œè´Ÿè½½ä¸é…ç½®ç®¡ç†</title><link>https://dev-null-sec.github.io/posts/05-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%89%B9%E6%AE%8A%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E4%B8%8E%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/05-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E7%89%B9%E6%AE%8A%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E4%B8%8E%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86/</guid><description>æ·±å…¥ç†è§£ DaemonSetã€Jobã€CronJob ç‰¹æ®Šå·¥ä½œè´Ÿè½½ï¼Œä»¥åŠ ConfigMap é…ç½®ç®¡ç†</description><pubDate>Sat, 10 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;ä¸ƒã€DaemonSet å’Œ Jobï¼šç‰¹æ®Šçš„å·¥ä½œè´Ÿè½½&lt;/h2&gt;
&lt;h3&gt;1. DaemonSetï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦çš„&quot;å®ˆæŠ¤ç¥&quot;&lt;/h3&gt;
&lt;h4&gt;1.1 DaemonSetæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;DaemonSet&lt;/strong&gt; æ˜¯Kubernetesçš„ä¸€ç§å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨ï¼Œå®ƒç¡®ä¿åœ¨é›†ç¾¤çš„&lt;strong&gt;æ¯ä¸ªï¼ˆæˆ–ç‰¹å®šï¼‰èŠ‚ç‚¹&lt;/strong&gt;ä¸Šéƒ½è¿è¡Œä¸€ä¸ªPodå‰¯æœ¬ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»æ¥ç†è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æƒ³è±¡ä¸€ä¸ªå°åŒºçš„ç‰©ä¸šç®¡ç†ï¼š

èŠ‚ç‚¹ï¼ˆNodeï¼‰ = æ¯æ ‹æ¥¼
DaemonSet Pod = æ¯æ ‹æ¥¼çš„ä¿å®‰ï¼ˆæ¯æ ‹æ¥¼å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ªä¿å®‰ï¼‰

å°åŒºæ–°å»ºä¸€æ ‹æ¥¼ â†’ è‡ªåŠ¨åˆ†é…ä¸€ä¸ªä¿å®‰
æ‹†é™¤ä¸€æ ‹æ¥¼ â†’ è¿™æ ‹æ¥¼çš„ä¿å®‰ä¹Ÿä¼šæ’¤ç¦»
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;èŠ‚ç‚¹è¦†ç›–&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªPodå‰¯æœ¬ï¼ˆä¸”åªæœ‰ä¸€ä¸ªï¼‰&lt;/li&gt;
&lt;li&gt;æ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ï¼Œè‡ªåŠ¨åˆ›å»ºPod&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ç¦»å¼€é›†ç¾¤ï¼Œè‡ªåŠ¨åˆ é™¤Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¸å—è°ƒåº¦å™¨æ§åˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DaemonSet Podç»•è¿‡Schedulerç›´æ¥è°ƒåº¦&lt;/li&gt;
&lt;li&gt;å³ä½¿èŠ‚ç‚¹æœ‰æ±¡ç‚¹ï¼ˆTaintï¼‰ï¼Œä¹Ÿèƒ½è¿è¡Œï¼ˆå¦‚æœé…ç½®äº†å®¹å¿ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è‡ªåŠ¨ä¿®å¤&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Podè¢«åˆ é™¤åï¼Œä¼šç«‹å³åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šé‡å»º&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;1.2 ä¸ºä»€ä¹ˆéœ€è¦DaemonSet&lt;/h4&gt;
&lt;p&gt;åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†Deploymentï¼Œå®ƒç®¡ç†çš„Podå¯èƒ½åˆ†æ•£åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šã€‚ä½†æœ‰äº›æœåŠ¡æœ‰ç‰¹æ®Šéœ€æ±‚ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å¿…é¡»åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªå®ä¾‹&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æƒ³è±¡è¿™äº›åœºæ™¯ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯1ï¼šæ—¥å¿—æ”¶é›†&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ²¡æœ‰DaemonSetï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚ â”‚ Node2   â”‚ â”‚ Node3   â”‚
â”‚         â”‚ â”‚         â”‚ â”‚         â”‚
â”‚ 3ä¸ªPod  â”‚ â”‚ 5ä¸ªPod  â”‚ â”‚ 2ä¸ªPod  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     ?          ?          ?
  æ€ä¹ˆæ”¶é›†æ—¥å¿—ï¼Ÿè¦åœ¨å“ªé‡Œéƒ¨ç½²æ—¥å¿—æ”¶é›†å™¨ï¼Ÿ

æœ‰DaemonSetï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚ â”‚ Node2   â”‚ â”‚ Node3   â”‚
â”‚ Fluentd â”‚ â”‚ Fluentd â”‚ â”‚ Fluentd â”‚  &amp;lt;- æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰æ—¥å¿—æ”¶é›†å™¨
â”‚ 3ä¸ªPod  â”‚ â”‚ 5ä¸ªPod  â”‚ â”‚ 2ä¸ªPod  â”‚     è‡ªåŠ¨æ”¶é›†æœ¬èŠ‚ç‚¹æ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯2ï¼šèŠ‚ç‚¹ç›‘æ§&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;éœ€æ±‚ï¼šç›‘æ§æ¯ä¸ªèŠ‚ç‚¹çš„CPUã€å†…å­˜ã€ç£ç›˜
è§£å†³ï¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æ§Agentï¼ˆå¦‚node-exporterï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯3ï¼šç½‘ç»œæ’ä»¶&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;éœ€æ±‚ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½éœ€è¦ç½‘ç»œç»„ä»¶ï¼ˆå¦‚Calicoã€Flannelï¼‰
è§£å†³ï¼šç”¨DaemonSetéƒ¨ç½²ç½‘ç»œæ’ä»¶
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;1.3 DaemonSetçš„å…¸å‹åº”ç”¨åœºæ™¯&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åœºæ™¯&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ—¥å¿—æ”¶é›†&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Fluentdã€Filebeatã€Logstash&lt;/td&gt;
&lt;td&gt;æ”¶é›†èŠ‚ç‚¹ä¸Šæ‰€æœ‰å®¹å™¨çš„æ—¥å¿—&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ç›‘æ§Agent&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Prometheus Node Exporterã€Datadog Agent&lt;/td&gt;
&lt;td&gt;ç›‘æ§èŠ‚ç‚¹èµ„æºå’Œå®¹å™¨æŒ‡æ ‡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ç½‘ç»œæ’ä»¶&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Calicoã€Flannelã€Weave&lt;/td&gt;
&lt;td&gt;ä¸ºPodæä¾›ç½‘ç»œåŠŸèƒ½&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å­˜å‚¨æ’ä»¶&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Cephã€GlusterFSå®¢æˆ·ç«¯&lt;/td&gt;
&lt;td&gt;æä¾›åˆ†å¸ƒå¼å­˜å‚¨æ”¯æŒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å®‰å…¨æ‰«æ&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Falcoã€Sysdig&lt;/td&gt;
&lt;td&gt;ç›‘æ§èŠ‚ç‚¹å®‰å…¨äº‹ä»¶&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ€§èƒ½åˆ†æ&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;cAdvisor&lt;/td&gt;
&lt;td&gt;æ”¶é›†å®¹å™¨æ€§èƒ½æ•°æ®&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;DaemonSet vs Deploymentå¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Deploymentï¼šæˆ‘éœ€è¦3ä¸ªå‰¯æœ¬ï¼Œè°ƒåº¦å™¨å¸®æˆ‘åˆ†é…åˆ°åˆé€‚çš„èŠ‚ç‚¹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚ â”‚ Node2   â”‚ â”‚ Node3   â”‚
â”‚ Pod1    â”‚ â”‚ Pod2    â”‚ â”‚         â”‚
â”‚         â”‚ â”‚ Pod3    â”‚ â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DaemonSetï¼šæ¯ä¸ªèŠ‚ç‚¹å¿…é¡»è¿è¡Œä¸€ä¸ªå‰¯æœ¬
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚ â”‚ Node2   â”‚ â”‚ Node3   â”‚
â”‚ Pod1    â”‚ â”‚ Pod2    â”‚ â”‚ Pod3    â”‚  &amp;lt;- æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;2. DaemonSetçš„å®ç°é€»è¾‘å’Œå·¥ä½œåŸç†&lt;/h3&gt;
&lt;h4&gt;2.1 DaemonSet Controllerçš„å·¥ä½œæœºåˆ¶&lt;/h4&gt;
&lt;p&gt;DaemonSetç”±&lt;strong&gt;DaemonSet Controller&lt;/strong&gt;ç®¡ç†ï¼Œå®ƒçš„å·¥ä½œåŸç†å¾ˆåƒä¸€ä¸ª&quot;èŠ‚ç‚¹å·¡æŸ¥å‘˜&quot;ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œæµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;flowchart TD
    A[&quot;1. ç›‘å¬èŠ‚ç‚¹å˜åŒ–&amp;lt;br/&amp;gt;Watch Nodeèµ„æº&quot;] --&amp;gt; B
    B[&quot;2. éå†æ‰€æœ‰èŠ‚ç‚¹&amp;lt;br/&amp;gt;æ£€æŸ¥æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦åº”è¯¥è¿è¡ŒDaemonSet Pod&quot;] --&amp;gt; C
    C{&quot;3. åˆ¤æ–­èŠ‚ç‚¹&amp;lt;br/&amp;gt;æ˜¯å¦åŒ¹é…æ¡ä»¶?&quot;} --&amp;gt; |&quot;åŒ¹é…&quot;| D
    C --&amp;gt; |&quot;ä¸åŒ¹é…&quot;| E
    D{&quot;4. èŠ‚ç‚¹ä¸Šæ˜¯å¦&amp;lt;br/&amp;gt;å·²æœ‰Pod?&quot;} --&amp;gt; |&quot;æ²¡æœ‰&quot;| F
    D --&amp;gt; |&quot;æœ‰&quot;| G
    F[&quot;5. åˆ›å»ºPod&amp;lt;br/&amp;gt;åœ¨è¯¥èŠ‚ç‚¹ä¸Š&quot;] --&amp;gt; G
    E{&quot;6. èŠ‚ç‚¹ä¸Šæ˜¯å¦&amp;lt;br/&amp;gt;æœ‰Pod?&quot;} --&amp;gt; |&quot;æœ‰&quot;| H
    E --&amp;gt; |&quot;æ²¡æœ‰&quot;| G
    H[&quot;7. åˆ é™¤Pod&amp;lt;br/&amp;gt;ä¸åº”è¯¥è¿è¡Œ&quot;] --&amp;gt; G
    G[&quot;8. ç»§ç»­ç›‘å¬&amp;lt;br/&amp;gt;æŒç»­è°ƒè°&quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è¯¦ç»†æ­¥éª¤è§£æï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æŒç»­ç›‘å¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DaemonSet Controller watch API Serverçš„Nodeå’ŒPodèµ„æº&lt;/li&gt;
&lt;li&gt;ä¸€æ—¦æœ‰å˜åŒ–ï¼ˆæ–°å¢èŠ‚ç‚¹ã€èŠ‚ç‚¹æ ‡ç­¾æ”¹å˜ã€Podåˆ é™¤ï¼‰ï¼Œç«‹å³å“åº”&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;èŠ‚ç‚¹åŒ¹é…&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æ»¡è¶³nodeSelectorã€affinityç­‰æ¡ä»¶&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦æœ‰Taintï¼ŒPodæ˜¯å¦æœ‰å¯¹åº”çš„Toleration&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Podåˆ›å»º&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœèŠ‚ç‚¹éœ€è¦Podä½†æ²¡æœ‰ï¼Œåˆ›å»ºä¸€ä¸ª&lt;/li&gt;
&lt;li&gt;ç›´æ¥æŒ‡å®šPodè¿è¡Œçš„èŠ‚ç‚¹ï¼ˆä¸é€šè¿‡Schedulerï¼‰&lt;/li&gt;
&lt;li&gt;è®¾ç½®Podçš„ownerReferenceæŒ‡å‘DaemonSet&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Podåˆ é™¤&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœèŠ‚ç‚¹ä¸åº”è¯¥è¿è¡ŒPodä½†æœ‰Podï¼Œåˆ é™¤å®ƒ&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹è¢«åˆ é™¤æ—¶ï¼Œè‡ªåŠ¨æ¸…ç†Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;2.2 DaemonSetè°ƒåº¦æœºåˆ¶&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä¸Deploymentçš„é‡è¦åŒºåˆ«ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Deployment Podåˆ›å»ºæµç¨‹ï¼š
ç”¨æˆ· â†’ API Server â†’ Deployment Controlleråˆ›å»ºReplicaSet 
â†’ ReplicaSet Controlleråˆ›å»ºPodï¼ˆçŠ¶æ€ï¼šPendingï¼Œæœªåˆ†é…èŠ‚ç‚¹ï¼‰
â†’ Scheduleré€‰æ‹©èŠ‚ç‚¹å¹¶ç»‘å®š
â†’ Kubeletåˆ›å»ºå®¹å™¨

DaemonSet Podåˆ›å»ºæµç¨‹ï¼š
ç”¨æˆ· â†’ API Server â†’ DaemonSet Controlleråˆ›å»ºPod
â†’ ç›´æ¥æŒ‡å®šnodeNameï¼ˆç»•è¿‡Schedulerï¼‰
â†’ Kubeletåˆ›å»ºå®¹å™¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆè¦ç»•è¿‡Schedulerï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ˜ç¡®çš„è°ƒåº¦éœ€æ±‚&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DaemonSetçŸ¥é“Podå¿…é¡»è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;ä¸éœ€è¦Schedulerçš„å¤æ‚è°ƒåº¦ç®—æ³•&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¿½ç•¥èµ„æºé™åˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŸäº›ç³»ç»Ÿç»„ä»¶ï¼ˆå¦‚ç½‘ç»œæ’ä»¶ï¼‰å¿…é¡»è¿è¡Œï¼Œå³ä½¿èŠ‚ç‚¹èµ„æºä¸è¶³&lt;/li&gt;
&lt;li&gt;Schedulerå¯èƒ½å› èµ„æºä¸è¶³æ‹’ç»è°ƒåº¦ï¼Œä½†DaemonSetå¼ºåˆ¶åˆ›å»º&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¿½ç•¥æ±¡ç‚¹&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DaemonSetå¯ä»¥é…ç½®Tolerationå®¹å¿æ‰€æœ‰æ±¡ç‚¹&lt;/li&gt;
&lt;li&gt;åœ¨masterèŠ‚ç‚¹ä¸Šè¿è¡Œä¹Ÿæ²¡é—®é¢˜&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;2.3 DaemonSetçš„è‡ªæˆ‘ä¿®å¤&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯1ï¼šPodè¢«æ„å¤–åˆ é™¤&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤DaemonSetçš„ä¸€ä¸ªPod
kubectl delete pod &amp;lt;daemonset-pod&amp;gt; -n kube-system

# ç«‹å³ï¼ˆå‡ ç§’å†…ï¼‰é‡å»º
kubectl get pods -n kube-system -w
# ä½ ä¼šçœ‹åˆ°Podç«‹å³è¿›å…¥Pending â†’ Running
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯2ï¼šèŠ‚ç‚¹å®•æœºåæ¢å¤&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;èŠ‚ç‚¹å®•æœº â†’ PodçŠ¶æ€å˜ä¸ºUnknown 
â†’ èŠ‚ç‚¹æ¢å¤ â†’ DaemonSet Controlleræ£€æµ‹åˆ° 
â†’ é‡å»ºPod
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯3ï¼šæ–°èŠ‚ç‚¹åŠ å…¥é›†ç¾¤&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ·»åŠ æ–°èŠ‚ç‚¹
kubeadm join ...

# DaemonSetè‡ªåŠ¨åœ¨æ–°èŠ‚ç‚¹ä¸Šåˆ›å»ºPod
kubectl get pods -o wide
# ä½ ä¼šçœ‹åˆ°æ–°èŠ‚ç‚¹ä¸Šå·²ç»æœ‰DaemonSetçš„Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;3. DaemonSeté…ç½®è¯¦è§£&lt;/h3&gt;
&lt;h4&gt;3.1 åŸºæœ¬YAMLç»“æ„&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æœ€ç®€å•çš„DaemonSetï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: example-daemonset
  namespace: default
spec:
  selector:
    matchLabels:
      app: example
  template:
    metadata:
      labels:
        app: example
    spec:
      containers:
      - name: example-container
        image: busybox
        command: [&apos;sh&apos;, &apos;-c&apos;, &apos;echo Hello from $(hostname) &amp;amp;&amp;amp; sleep 3600&apos;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒå­—æ®µè¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;å¿…éœ€&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;apiVersion&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;apps/v1&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;kind&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;DaemonSet&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;metadata.name&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;DaemonSetåç§°&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;spec.selector&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾é€‰æ‹©å™¨ï¼ŒåŒ¹é…Pod&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;spec.template&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Podæ¨¡æ¿ï¼ˆä¸Podçš„specä¸€æ ·ï¼‰&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;spec.updateStrategy&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ›´æ–°ç­–ç•¥ï¼ˆRollingUpdate/OnDeleteï¼‰&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;spec.minReadySeconds&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Podå°±ç»ªåå¤šä¹…æ‰è®¤ä¸ºå¯ç”¨ï¼ˆç§’ï¼‰&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;3.2 èŠ‚ç‚¹é€‰æ‹©ï¼šæ§åˆ¶åœ¨å“ªäº›èŠ‚ç‚¹ä¸Šè¿è¡Œ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ–¹å¼1ï¼šnodeSelectorï¼ˆç®€å•æ ‡ç­¾åŒ¹é…ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nginx-daemonset
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      nodeSelector:
        disktype: ssd    # åªåœ¨æœ‰disktype=ssdæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šè¿è¡Œ
      containers:
      - name: nginx
        image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç»™èŠ‚ç‚¹æ‰“æ ‡ç­¾
kubectl label nodes k8s-node1 disktype=ssd
kubectl label nodes k8s-node2 disktype=ssd

# DaemonSetåªä¼šåœ¨node1å’Œnode2ä¸Šåˆ›å»ºPod
kubectl get pods -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ–¹å¼2ï¼šnodeAffinityï¼ˆçµæ´»çš„èŠ‚ç‚¹äº²å’Œæ€§ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: monitoring-daemonset
spec:
  selector:
    matchLabels:
      app: monitoring
  template:
    metadata:
      labels:
        app: monitoring
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                - k8s-node1
                - k8s-node2
      containers:
      - name: node-exporter
        image: prom/node-exporter:latest
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ“ä½œç¬¦è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ“ä½œç¬¦&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;In&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾å€¼åœ¨åˆ—è¡¨ä¸­&lt;/td&gt;
&lt;td&gt;&lt;code&gt;key: In values: [v1, v2]&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;NotIn&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾å€¼ä¸åœ¨åˆ—è¡¨ä¸­&lt;/td&gt;
&lt;td&gt;&lt;code&gt;key: NotIn values: [v1]&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Exists&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾å­˜åœ¨ï¼ˆä¸ç®¡å€¼æ˜¯ä»€ä¹ˆï¼‰&lt;/td&gt;
&lt;td&gt;&lt;code&gt;key: Exists&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DoesNotExist&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾ä¸å­˜åœ¨&lt;/td&gt;
&lt;td&gt;&lt;code&gt;key: DoesNotExist&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Gt&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾å€¼å¤§äºæŒ‡å®šå€¼ï¼ˆæ•°å€¼æ¯”è¾ƒï¼‰&lt;/td&gt;
&lt;td&gt;&lt;code&gt;key: Gt value: &quot;100&quot;&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Lt&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡ç­¾å€¼å°äºæŒ‡å®šå€¼&lt;/td&gt;
&lt;td&gt;&lt;code&gt;key: Lt value: &quot;50&quot;&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;3.3 æ±¡ç‚¹å’Œå®¹å¿ï¼šåœ¨ç‰¹æ®ŠèŠ‚ç‚¹ä¸Šè¿è¡Œ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä»€ä¹ˆæ˜¯Taintï¼ˆæ±¡ç‚¹ï¼‰å’ŒTolerationï¼ˆå®¹å¿ï¼‰ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ±¡ç‚¹ï¼ˆTaintï¼‰= èŠ‚ç‚¹çš„&quot;æ‹’å®¢ç‰Œ&quot;
å®¹å¿ï¼ˆTolerationï¼‰= Podçš„&quot;é€šè¡Œè¯&quot;

æƒ³è±¡ä¸€ä¸ªVIPé¤å…ï¼š
- é¤å…é—¨å£æŒ‚ç‰Œï¼š&quot;åªæ¥å¾…VIPå®¢æˆ·&quot;ï¼ˆè¿™æ˜¯æ±¡ç‚¹ï¼‰
- ä½ æœ‰VIPå¡ï¼ˆè¿™æ˜¯å®¹å¿ï¼‰ï¼Œå°±èƒ½è¿›å»
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ±¡ç‚¹çš„ä¸‰ç§æ•ˆæœï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ•ˆæœ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;NoSchedule&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¸å…è®¸æ–°Podè°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ï¼ˆå·²æœ‰Podä¸å—å½±å“ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;PreferNoSchedule&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å°½é‡ä¸è°ƒåº¦æ–°Podåˆ°è¯¥èŠ‚ç‚¹ï¼ˆä¸æ˜¯ç¡¬æ€§è¦æ±‚ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;NoExecute&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¸å…è®¸Podè¿è¡Œï¼Œå·²æœ‰Podå¦‚æœä¸å®¹å¿æ±¡ç‚¹ä¼šè¢«é©±é€&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;DaemonSetå®¹å¿æ‰€æœ‰æ±¡ç‚¹çš„ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluent-bit
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: fluent-bit
  template:
    metadata:
      labels:
        app: fluent-bit
    spec:
      tolerations:
      # å®¹å¿masterèŠ‚ç‚¹æ±¡ç‚¹ï¼ˆå…è®¸åœ¨masterä¸Šè¿è¡Œï¼‰
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      # å®¹å¿èŠ‚ç‚¹æœªå°±ç»ª
      - key: node.kubernetes.io/not-ready
        operator: Exists
        effect: NoExecute
      # å®¹å¿èŠ‚ç‚¹ä¸å¯è¾¾
      - key: node.kubernetes.io/unreachable
        operator: Exists
        effect: NoExecute
      containers:
      - name: fluent-bit
        image: fluent/fluent-bit:latest
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®¹å¿çš„é…ç½®é¡¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;key&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ±¡ç‚¹çš„é”®ï¼ˆç•™ç©ºè¡¨ç¤ºåŒ¹é…æ‰€æœ‰é”®ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;operator&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åŒ¹é…æ“ä½œç¬¦ï¼ˆExists=å­˜åœ¨å³å¯ï¼ŒEqual=å€¼å¿…é¡»ç›¸ç­‰ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;value&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ±¡ç‚¹çš„å€¼ï¼ˆoperatorä¸ºEqualæ—¶å¿…é¡»æŒ‡å®šï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;effect&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ±¡ç‚¹æ•ˆæœï¼ˆNoSchedule/PreferNoSchedule/NoExecuteï¼Œç•™ç©ºè¡¨ç¤ºåŒ¹é…æ‰€æœ‰æ•ˆæœï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
&lt;h3&gt;4. DaemonSetæ›´æ–°ç­–ç•¥&lt;/h3&gt;
&lt;h4&gt;4.1 æ›´æ–°ç­–ç•¥ç±»å‹&lt;/h4&gt;
&lt;p&gt;DaemonSetæ”¯æŒä¸¤ç§æ›´æ–°ç­–ç•¥ï¼š&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç­–ç•¥&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ä½¿ç”¨åœºæ™¯&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;RollingUpdate&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ»šåŠ¨æ›´æ–°ï¼ˆé»˜è®¤ï¼‰&lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨åŒ–æ›´æ–°ï¼Œæ¨è&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;OnDelete&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ‰‹åŠ¨åˆ é™¤Podåæ‰æ›´æ–°&lt;/td&gt;
&lt;td&gt;éœ€è¦ç²¾ç»†æ§åˆ¶æ›´æ–°æ—¶æœº&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;4.2 æ»šåŠ¨æ›´æ–°ï¼ˆRollingUpdateï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œåŸç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ»šåŠ¨æ›´æ–°æµç¨‹ï¼š
1. æ›´æ–°DaemonSetçš„Podæ¨¡æ¿
2. DaemonSet Controlleré€ä¸ªèŠ‚ç‚¹æ›´æ–°Pod
   - åˆ é™¤æ—§Pod
   - ç­‰å¾…æ—§Podç»ˆæ­¢
   - åˆ›å»ºæ–°Pod
   - ç­‰å¾…æ–°Podå°±ç»ª
   - ç»§ç»­ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
spec:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1    # åŒæ—¶æ›´æ–°çš„æœ€å¤§èŠ‚ç‚¹æ•°ï¼ˆé»˜è®¤1ï¼‰
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      containers:
      - name: fluentd
        image: fluent/fluentd:v1.14    # é•œåƒç‰ˆæœ¬
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;maxUnavailableå‚æ•°ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;maxUnavailable: 1 ï¼ˆä¿å®ˆæ›´æ–°ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚ â”‚ Node2   â”‚ â”‚ Node3   â”‚
â”‚ v1.14 âœ“ â”‚ â”‚ v1.13   â”‚ â”‚ v1.13   â”‚  &amp;lt;- ä¸€ä¸ªä¸€ä¸ªæ›´æ–°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†“           ç­‰å¾…         ç­‰å¾…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚ â”‚ Node2   â”‚ â”‚ Node3   â”‚
â”‚ v1.14 âœ“ â”‚ â”‚ v1.14 âœ“ â”‚ â”‚ v1.13   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

maxUnavailable: 2 ï¼ˆæ¿€è¿›æ›´æ–°ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Node1   â”‚ â”‚ Node2   â”‚ â”‚ Node3   â”‚
â”‚ v1.14 âœ“ â”‚ â”‚ v1.14 âœ“ â”‚ â”‚ v1.13   â”‚  &amp;lt;- ä¸¤ä¸ªåŒæ—¶æ›´æ–°
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰§è¡Œæ›´æ–°ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹å¼1ï¼šä¿®æ”¹é•œåƒ
kubectl set image daemonset/fluentd fluentd=fluent/fluentd:v1.15 -n kube-system

# æ–¹å¼2ï¼šä¿®æ”¹YAMLåapply
kubectl apply -f fluentd-daemonset.yaml

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status daemonset/fluentd -n kube-system

# æŸ¥çœ‹æ›´æ–°å†å²
kubectl rollout history daemonset/fluentd -n kube-system
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç›‘æ§æ›´æ–°è¿‡ç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å®æ—¶ç›‘æ§Podå˜åŒ–
kubectl get pods -n kube-system -l app=fluentd -w

# æŸ¥çœ‹DaemonSetçŠ¶æ€
kubectl get daemonset fluentd -n kube-system
# è¾“å‡ºï¼š
# NAME      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   
# fluentd   3         3         2       1            2
#
# DESIRED: æœŸæœ›çš„Podæ•°é‡ï¼ˆèŠ‚ç‚¹æ•°ï¼‰
# CURRENT: å½“å‰è¿è¡Œçš„Podæ•°é‡
# READY: å°±ç»ªçš„Podæ•°é‡
# UP-TO-DATE: å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬çš„Podæ•°é‡
# AVAILABLE: å¯ç”¨çš„Podæ•°é‡
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.3 æ‰‹åŠ¨æ›´æ–°ï¼ˆOnDeleteï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;éœ€è¦åœ¨ç‰¹å®šæ—¶é—´çª—å£æ›´æ–°&lt;/li&gt;
&lt;li&gt;éœ€è¦é€ä¸ªéªŒè¯æ›´æ–°æ•ˆæœ&lt;/li&gt;
&lt;li&gt;å…³é”®æœåŠ¡ä¸èƒ½è‡ªåŠ¨æ›´æ–°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: critical-monitoring
spec:
  updateStrategy:
    type: OnDelete    # æ‰‹åŠ¨æ›´æ–°æ¨¡å¼
  selector:
    matchLabels:
      app: monitoring
  template:
    metadata:
      labels:
        app: monitoring
    spec:
      containers:
      - name: monitor
        image: monitoring:v2.0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ›´æ–°æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# 1. ä¿®æ”¹DaemonSetï¼ˆåªæ›´æ–°æ¨¡æ¿ï¼Œä¸å½±å“ç°æœ‰Podï¼‰
kubectl apply -f daemonset.yaml

# 2. æ‰‹åŠ¨åˆ é™¤èŠ‚ç‚¹1çš„Podï¼ˆè§¦å‘æ›´æ–°ï¼‰
kubectl delete pod critical-monitoring-xxxxx -n default

# 3. æ–°Podè‡ªåŠ¨åˆ›å»ºï¼Œä½¿ç”¨æ–°æ¨¡æ¿

# 4. éªŒè¯æ–°Podæ­£å¸¸åï¼Œç»§ç»­åˆ é™¤ä¸‹ä¸€ä¸ª
kubectl delete pod critical-monitoring-yyyyy -n default
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.4 å›æ»šDaemonSet&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹å†å²ç‰ˆæœ¬ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹DaemonSetçš„å†å²ç‰ˆæœ¬
kubectl rollout history daemonset/fluentd -n kube-system

# è¾“å‡ºï¼š
# REVISION  CHANGE-CAUSE
# 1         &amp;lt;none&amp;gt;
# 2         kubectl apply --filename=fluentd-v1.14.yaml
# 3         kubectl set image daemonset/fluentd fluentd=fluent/fluentd:v1.15
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo daemonset/fluentd -n kube-system

# æŸ¥çœ‹å›æ»šçŠ¶æ€
kubectl rollout status daemonset/fluentd -n kube-system
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å›æ»šåˆ°revision 2
kubectl rollout undo daemonset/fluentd --to-revision=2 -n kube-system
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æš‚åœå’Œæ¢å¤æ›´æ–°ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æš‚åœæ›´æ–°ï¼ˆå·²æ›´æ–°çš„ä¸ä¼šå›æ»šï¼Œæœªæ›´æ–°çš„åœæ­¢æ›´æ–°ï¼‰
kubectl rollout pause daemonset/fluentd -n kube-system

# æ¢å¤æ›´æ–°
kubectl rollout resume daemonset/fluentd -n kube-system
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;5. Jobï¼šä¸€æ¬¡æ€§ä»»åŠ¡æ‰§è¡Œå™¨&lt;/h3&gt;
&lt;h4&gt;5.1 Jobæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Job&lt;/strong&gt; æ˜¯Kubernetesä¸­ç”¨äºè¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡çš„å·¥ä½œè´Ÿè½½æ§åˆ¶å™¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸Deployment/DaemonSetçš„åŒºåˆ«ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Deployment: æˆ‘è¦è¿™ä¸ªæœåŠ¡ä¸€ç›´è¿è¡Œç€ï¼ˆé•¿æœŸè¿è¡ŒæœåŠ¡ï¼‰
  - WebæœåŠ¡å™¨
  - APIæœåŠ¡
  - æ•°æ®åº“

DaemonSet: æ¯ä¸ªèŠ‚ç‚¹éƒ½è¦è¿è¡Œä¸€ä¸ªæœåŠ¡ï¼ˆèŠ‚ç‚¹çº§é•¿æœŸæœåŠ¡ï¼‰
  - æ—¥å¿—æ”¶é›†
  - ç›‘æ§Agent

Job: æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œå®Œæˆå°±ç»“æŸï¼ˆä¸€æ¬¡æ€§ä»»åŠ¡ï¼‰
  - æ•°æ®åº“å¤‡ä»½
  - æ‰¹é‡æ•°æ®å¤„ç†
  - å®šæ—¶æ¸…ç†ä»»åŠ¡
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿæ´»åŒ–æ¯”å–»ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Deployment = é¤å…çš„å¨å¸ˆï¼ˆä¸€ç›´å·¥ä½œï¼‰
DaemonSet = æ¯å±‚æ¥¼çš„ä¿æ´ï¼ˆæ¯å±‚éƒ½æœ‰ï¼Œä¸€ç›´å·¥ä½œï¼‰
Job = æ¬å®¶å·¥äººï¼ˆæ¬å®Œå°±èµ°ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;5.2 Jobçš„æ ¸å¿ƒç‰¹ç‚¹&lt;/h4&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä»»åŠ¡å®Œæˆå³ç»ˆæ­¢&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Podè¿è¡Œå®Œæˆï¼ˆé€€å‡ºç 0ï¼‰åï¼ŒJobæ ‡è®°ä¸ºComplete&lt;/li&gt;
&lt;li&gt;Podä¸ä¼šé‡å¯ï¼ˆé™¤éå¤±è´¥é‡è¯•ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¤±è´¥é‡è¯•&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ”¯æŒé…ç½®é‡è¯•æ¬¡æ•°&lt;/li&gt;
&lt;li&gt;å¤±è´¥çš„Podä¼šè¢«åˆ é™¤å¹¶é‡å»º&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¹¶è¡Œæ‰§è¡Œ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ”¯æŒåŒæ—¶è¿è¡Œå¤šä¸ªPod&lt;/li&gt;
&lt;li&gt;æ”¯æŒé¡ºåºæ‰§è¡Œæˆ–å¹¶è¡Œæ‰§è¡Œ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¿ç•™å†å²&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®Œæˆçš„Podé»˜è®¤ä¿ç•™ï¼ˆå¯ä»¥æŸ¥çœ‹æ—¥å¿—ï¼‰&lt;/li&gt;
&lt;li&gt;å¯é…ç½®è‡ªåŠ¨æ¸…ç†&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;5.3 Jobçš„å·¥ä½œæ¨¡å¼&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ¨¡å¼1ï¼šå•æ¬¡æ‰§è¡Œï¼ˆæœ€å¸¸è§ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: backup-job
spec:
  template:
    spec:
      containers:
      - name: backup
        image: mysql:8.0
        command: [&apos;sh&apos;, &apos;-c&apos;, &apos;mysqldump -h mysql -u root -pPassword123 mydb &amp;gt; /backup/mydb.sql&apos;]
      restartPolicy: Never    # é‡è¦ï¼šJobå¿…é¡»è®¾ç½®ä¸ºNeveræˆ–OnFailure
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰§è¡Œæµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åˆ›å»ºJob â†’ åˆ›å»ºPod â†’ Podè¿è¡Œ â†’ ä»»åŠ¡å®Œæˆ(é€€å‡ºç 0) â†’ PodçŠ¶æ€Completed â†’ JobçŠ¶æ€Complete
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¨¡å¼2ï¼šå›ºå®šå®Œæˆæ¬¡æ•°ï¼ˆcompletionsï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: data-process-job
spec:
  completions: 5    # éœ€è¦æˆåŠŸå®Œæˆ5æ¬¡
  template:
    spec:
      containers:
      - name: processor
        image: data-processor:latest
      restartPolicy: Never
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰§è¡Œæµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åˆ›å»º5ä¸ªPodï¼ˆå¯èƒ½é¡ºåºæ‰§è¡Œï¼‰â†’ æ¯ä¸ªPodå®Œæˆä¸€ä¸ªä»»åŠ¡ â†’ 5ä¸ªå…¨éƒ¨æˆåŠŸ â†’ Jobå®Œæˆ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¨¡å¼3ï¼šå¹¶è¡Œæ‰§è¡Œï¼ˆparallelismï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: parallel-job
spec:
  completions: 10       # æ€»å…±éœ€è¦å®Œæˆ10ä¸ªä»»åŠ¡
  parallelism: 3        # åŒæ—¶è¿è¡Œ3ä¸ªPod
  template:
    spec:
      containers:
      - name: worker
        image: worker:latest
      restartPolicy: Never
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰§è¡Œæµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç¬¬ä¸€æ‰¹ï¼šåˆ›å»º3ä¸ªPodåŒæ—¶è¿è¡Œ
  â†’ Pod1å®Œæˆ â†’ åˆ›å»ºPod4
  â†’ Pod2å®Œæˆ â†’ åˆ›å»ºPod5
  â†’ Pod3å®Œæˆ â†’ åˆ›å»ºPod6
...
â†’ 10ä¸ªå…¨éƒ¨å®Œæˆ â†’ Jobå®Œæˆ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å¯¹æ¯”å›¾ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;é¡ºåºæ‰§è¡Œï¼ˆparallelism=1, completions=3ï¼‰ï¼š
æ—¶é—´ â†’
Pod1 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 
              Pod2 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
                            Pod3 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]

å¹¶è¡Œæ‰§è¡Œï¼ˆparallelism=3, completions=3ï¼‰ï¼š
æ—¶é—´ â†’
Pod1 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
Pod2 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
Pod3 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]

æ··åˆæ¨¡å¼ï¼ˆparallelism=2, completions=5ï¼‰ï¼š
æ—¶é—´ â†’
Pod1 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
Pod2 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
              Pod3 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
              Pod4 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
                            Pod5 [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;5.4 Jobé…ç½®è¯¦è§£&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®Œæ•´çš„Job YAMLç»“æ„ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: example-job
  namespace: default
spec:
  # å¹¶è¡Œæ§åˆ¶
  completions: 3              # éœ€è¦æˆåŠŸå®Œæˆçš„Podæ•°é‡ï¼ˆé»˜è®¤1ï¼‰
  parallelism: 2              # åŒæ—¶è¿è¡Œçš„æœ€å¤§Podæ•°é‡ï¼ˆé»˜è®¤1ï¼‰
  
  # å¤±è´¥æ§åˆ¶
  backoffLimit: 6             # æœ€å¤§å¤±è´¥é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤6ï¼‰
  
  # è¶…æ—¶æ§åˆ¶
  activeDeadlineSeconds: 600  # Jobè¿è¡Œçš„æœ€å¤§æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œè¶…æ—¶åˆ™ç»ˆæ­¢
  
  # æ¸…ç†æ§åˆ¶
  ttlSecondsAfterFinished: 100  # Jobå®Œæˆåå¤šä¹…è‡ªåŠ¨åˆ é™¤ï¼ˆç§’ï¼‰
  
  # Podæ¨¡æ¿
  template:
    spec:
      restartPolicy: Never    # å¿…é¡»æ˜¯Neveræˆ–OnFailure
      containers:
      - name: worker
        image: busybox
        command: [&apos;sh&apos;, &apos;-c&apos;, &apos;echo Processing... &amp;amp;&amp;amp; sleep 10 &amp;amp;&amp;amp; echo Done!&apos;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®å­—æ®µè¯¦è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;é»˜è®¤å€¼&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;completions&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;éœ€è¦æˆåŠŸå®Œæˆçš„Podæ€»æ•°&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;parallelism&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åŒæ—¶è¿è¡Œçš„æœ€å¤§Podæ•°&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;backoffLimit&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¤±è´¥é‡è¯•æ¬¡æ•°é™åˆ¶&lt;/td&gt;
&lt;td&gt;6&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;activeDeadlineSeconds&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Jobè¿è¡Œæœ€å¤§æ—¶é•¿ï¼ˆç§’ï¼‰ï¼Œè¶…æ—¶ç»ˆæ­¢æ‰€æœ‰Pod&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ttlSecondsAfterFinished&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Jobå®Œæˆåè‡ªåŠ¨æ¸…ç†æ—¶é—´ï¼ˆç§’ï¼‰&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;restartPolicy&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;å¿…é¡»&lt;/strong&gt;æ˜¯Neveræˆ–OnFailureï¼ˆä¸èƒ½æ˜¯Alwaysï¼‰&lt;/td&gt;
&lt;td&gt;Never&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;restartPolicyçš„åŒºåˆ«ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Never: Podå¤±è´¥åä¸é‡å¯ï¼ŒJob Controlleråˆ›å»ºæ–°Pod
restartPolicy: Never
# è¡Œä¸ºï¼šPod1å¤±è´¥ â†’ åˆ›å»ºPod2 â†’ Pod2å¤±è´¥ â†’ åˆ›å»ºPod3 ...

# OnFailure: Podå¤±è´¥ååœ¨åŸåœ°é‡å¯å®¹å™¨
restartPolicy: OnFailure
# è¡Œä¸ºï¼šPod1å¤±è´¥ â†’ å®¹å™¨é‡å¯ â†’ å¤±è´¥ â†’ å®¹å™¨å†é‡å¯ ...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨å»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Never&lt;/strong&gt;ï¼šé€‚åˆæœ‰çŠ¶æ€ä»»åŠ¡æˆ–éœ€è¦é‡æ–°åˆå§‹åŒ–ç¯å¢ƒçš„ä»»åŠ¡&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;OnFailure&lt;/strong&gt;ï¼šé€‚åˆæ— çŠ¶æ€ä»»åŠ¡ï¼ŒèŠ‚çœPodåˆ›å»ºå¼€é”€&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;5.5 Jobå¤±è´¥å¤„ç†&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯1ï¼šbackoffLimité™åˆ¶é‡è¯•æ¬¡æ•°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: retry-job
spec:
  backoffLimit: 3    # æœ€å¤šå¤±è´¥3æ¬¡
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: worker
        image: busybox
        command: [&apos;sh&apos;, &apos;-c&apos;, &apos;exit 1&apos;]  # æ•…æ„å¤±è´¥
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰§è¡Œç»“æœï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åˆ›å»ºPod1 â†’ å¤±è´¥ï¼ˆé€€å‡ºç 1ï¼‰
â†’ åˆ›å»ºPod2 â†’ å¤±è´¥
â†’ åˆ›å»ºPod3 â†’ å¤±è´¥
â†’ åˆ›å»ºPod4 â†’ å¤±è´¥
â†’ è¾¾åˆ°backoffLimité™åˆ¶ï¼ŒJobæ ‡è®°ä¸ºFailed
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯2ï¼šè¶…æ—¶æ§åˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: timeout-job
spec:
  activeDeadlineSeconds: 30  # 30ç§’è¶…æ—¶
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: worker
        image: busybox
        command: [&apos;sh&apos;, &apos;-c&apos;, &apos;sleep 60&apos;]  # ç¡çœ 60ç§’
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰§è¡Œç»“æœï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åˆ›å»ºPod â†’ è¿è¡Œ30ç§’ â†’ è¶…æ—¶ â†’ Jobç»ˆæ­¢Pod â†’ JobçŠ¶æ€Failed
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹JobçŠ¶æ€ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Job
kubectl get jobs

# è¾“å‡ºç¤ºä¾‹ï¼š
# NAME        COMPLETIONS   DURATION   AGE
# backup-job  1/1           15s        1m     &amp;lt;- æˆåŠŸ
# retry-job   0/1           2m         2m     &amp;lt;- å¤±è´¥

# æŸ¥çœ‹è¯¦ç»†çŠ¶æ€
kubectl describe job retry-job

# æŸ¥çœ‹å¤±è´¥çš„Podæ—¥å¿—
kubectl logs &amp;lt;pod-name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;5.6 Jobæ¸…ç†&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é—®é¢˜ï¼šJobå®ŒæˆåPodä¼šä¸€ç›´å­˜åœ¨&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get jobs
# NAME        COMPLETIONS   DURATION   AGE
# backup-job  1/1           15s        7d    &amp;lt;- 7å¤©å‰å®Œæˆçš„Jobè¿˜åœ¨

kubectl get pods
# NAME              READY   STATUS      RESTARTS   AGE
# backup-job-xxxxx  0/1     Completed   0          7d    &amp;lt;- Podä¹Ÿè¿˜åœ¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è§£å†³æ–¹æ¡ˆ1ï¼šè‡ªåŠ¨æ¸…ç†ï¼ˆæ¨èï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: auto-cleanup-job
spec:
  ttlSecondsAfterFinished: 100  # å®Œæˆå100ç§’è‡ªåŠ¨åˆ é™¤
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: worker
        image: busybox
        command: [&apos;sh&apos;, &apos;-c&apos;, &apos;echo Done &amp;amp;&amp;amp; sleep 10&apos;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è§£å†³æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨æ¸…ç†&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤Jobï¼ˆä¼šçº§è”åˆ é™¤Podï¼‰
kubectl delete job backup-job

# æ‰¹é‡åˆ é™¤å·²å®Œæˆçš„Job
kubectl delete jobs --field-selector status.successful=1

# æ‰¹é‡åˆ é™¤å¤±è´¥çš„Job
kubectl delete jobs --field-selector status.failed=1
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;6. CronJobï¼šå®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨&lt;/h3&gt;
&lt;h4&gt;6.1 CronJobæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;CronJob&lt;/strong&gt; æ˜¯Kubernetesä¸­ç”¨äºå®šæ—¶æ‰§è¡Œä»»åŠ¡çš„æ§åˆ¶å™¨ï¼Œå°±åƒLinuxçš„crontabã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿæ´»åŒ–æ¯”å–»ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Job = ä¸´æ—¶å·¥ï¼ˆå¹²å®Œæ´»å°±èµ°ï¼‰
CronJob = å®šæ—¶é—¹é’Ÿï¼ˆæ¯å¤©æ—©ä¸Š7ç‚¹å«ä½ èµ·åºŠï¼‰

ç¤ºä¾‹ï¼š
- æ¯å¤©å‡Œæ™¨2ç‚¹å¤‡ä»½æ•°æ®åº“
- æ¯å°æ—¶æ¸…ç†ä¸´æ—¶æ–‡ä»¶
- æ¯å‘¨ä¸€ç”ŸæˆæŠ¥è¡¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å®šæ—¶æ‰§è¡Œ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‰ç…§Cronè¡¨è¾¾å¼å®šæ—¶åˆ›å»ºJob&lt;/li&gt;
&lt;li&gt;Jobæ‰§è¡Œå®Œæˆåè‡ªåŠ¨æ¸…ç†&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å†å²ç®¡ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¿ç•™æœ€è¿‘å‡ æ¬¡æˆåŠŸ/å¤±è´¥çš„Job&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨æ¸…ç†æ—§Job&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¹¶å‘æ§åˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ§åˆ¶åŒæ—¶è¿è¡Œçš„Jobæ•°é‡&lt;/li&gt;
&lt;li&gt;å¤„ç†ä¸Šæ¬¡Jobæœªå®Œæˆçš„æƒ…å†µ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;6.2 Cronè¡¨è¾¾å¼è¯¦è§£&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¼å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åˆ†é’Ÿ  å°æ—¶  æ—¥æœŸ  æœˆä»½  æ˜ŸæœŸ
*    *    *    *    *
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å­—æ®µè¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;å–å€¼èŒƒå›´&lt;/th&gt;
&lt;th&gt;ç‰¹æ®Šå­—ç¬¦&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;åˆ†é’Ÿ&lt;/td&gt;
&lt;td&gt;0-59&lt;/td&gt;
&lt;td&gt;* , - /&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;å°æ—¶&lt;/td&gt;
&lt;td&gt;0-23&lt;/td&gt;
&lt;td&gt;* , - /&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;æ—¥æœŸ&lt;/td&gt;
&lt;td&gt;1-31&lt;/td&gt;
&lt;td&gt;* , - / ?&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;æœˆä»½&lt;/td&gt;
&lt;td&gt;1-12&lt;/td&gt;
&lt;td&gt;* , - /&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;æ˜ŸæœŸ&lt;/td&gt;
&lt;td&gt;0-7 (0å’Œ7éƒ½æ˜¯å‘¨æ—¥)&lt;/td&gt;
&lt;td&gt;* , - / ?&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹æ®Šå­—ç¬¦å«ä¹‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—ç¬¦&lt;/th&gt;
&lt;th&gt;å«ä¹‰&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;*****&lt;/td&gt;
&lt;td&gt;ä»»æ„å€¼&lt;/td&gt;
&lt;td&gt;&lt;code&gt;* * * * *&lt;/code&gt; = æ¯åˆ†é’Ÿ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;,&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åˆ—ä¸¾å¤šä¸ªå€¼&lt;/td&gt;
&lt;td&gt;&lt;code&gt;0 8,12,18 * * *&lt;/code&gt; = 8ç‚¹ã€12ç‚¹ã€18ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;-&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;èŒƒå›´&lt;/td&gt;
&lt;td&gt;&lt;code&gt;0 9-17 * * *&lt;/code&gt; = 9ç‚¹åˆ°17ç‚¹æ¯å°æ—¶&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;/&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ­¥é•¿/é—´éš”&lt;/td&gt;
&lt;td&gt;&lt;code&gt;*/5 * * * *&lt;/code&gt; = æ¯5åˆ†é’Ÿ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;?&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¸æŒ‡å®šï¼ˆæ—¥æœŸå’Œæ˜ŸæœŸäº’æ–¥æ—¶ä½¿ç”¨ï¼‰&lt;/td&gt;
&lt;td&gt;&lt;code&gt;0 0 1 * ?&lt;/code&gt; = æ¯æœˆ1å·&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;å¸¸ç”¨ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;Cronè¡¨è¾¾å¼&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;*/5 * * * *&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ¯5åˆ†é’Ÿ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;0 * * * *&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ¯å°æ—¶æ•´ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;0 0 * * *&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ¯å¤©å‡Œæ™¨0ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;0 2 * * *&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ¯å¤©å‡Œæ™¨2ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;0 0 * * 0&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ¯å‘¨æ—¥å‡Œæ™¨0ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;0 0 1 * *&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ¯æœˆ1å·å‡Œæ™¨0ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;0 9-17 * * 1-5&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;å‘¨ä¸€åˆ°å‘¨äº”ï¼Œ9ç‚¹åˆ°17ç‚¹æ¯å°æ—¶&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;*/10 9-17 * * *&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;9ç‚¹åˆ°17ç‚¹ï¼Œæ¯10åˆ†é’Ÿ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;0 0 1 1 *&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æ¯å¹´1æœˆ1å·å‡Œæ™¨0ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;åœ¨çº¿æµ‹è¯•å·¥å…·ï¼š&lt;/strong&gt; https://crontab.guru/&lt;/p&gt;
&lt;h4&gt;6.3 CronJobåŸºæœ¬é…ç½®&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æœ€ç®€å•çš„CronJobï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello-cronjob
spec:
  schedule: &quot;*/1 * * * *&quot;    # æ¯åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: hello
            image: busybox
            command: [&apos;sh&apos;, &apos;-c&apos;, &apos;date; echo Hello from CronJob&apos;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®Œæ•´é…ç½®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: CronJob
metadata:
  name: backup-cronjob
  namespace: default
spec:
  # Cronè¡¨è¾¾å¼
  schedule: &quot;0 2 * * *&quot;              # æ¯å¤©å‡Œæ™¨2ç‚¹
  
  # æ—¶åŒºï¼ˆKubernetes 1.25+ï¼‰
  timeZone: &quot;Asia/Shanghai&quot;          # ä½¿ç”¨ä¸­å›½æ—¶åŒº
  
  # å¹¶å‘ç­–ç•¥
  concurrencyPolicy: Forbid          # Allow/Forbid/Replace
  
  # Jobå†å²ä¿ç•™
  successfulJobsHistoryLimit: 3      # ä¿ç•™3ä¸ªæˆåŠŸçš„Job
  failedJobsHistoryLimit: 1          # ä¿ç•™1ä¸ªå¤±è´¥çš„Job
  
  # å¯åŠ¨å»¶è¿Ÿ
  startingDeadlineSeconds: 100       # å¦‚æœé”™è¿‡è°ƒåº¦æ—¶é—´ï¼Œ100ç§’å†…è¿˜å¯ä»¥å¯åŠ¨
  
  # æš‚åœè°ƒåº¦
  suspend: false                     # trueè¡¨ç¤ºæš‚åœï¼Œä¸åˆ›å»ºæ–°Job
  
  # Jobæ¨¡æ¿ï¼ˆä¸Jobçš„specç›¸åŒï¼‰
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
          - name: backup
            image: mysql:8.0
            command: [&apos;sh&apos;, &apos;-c&apos;, &apos;mysqldump -h mysql -u root -p$MYSQL_PWD mydb &amp;gt; /backup/backup-$(date +%Y%m%d-%H%M%S).sql&apos;]
            env:
            - name: MYSQL_PWD
              valueFrom:
                secretKeyRef:
                  name: mysql-secret
                  key: password
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®å­—æ®µè¯¦è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;é»˜è®¤å€¼&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;schedule&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Cronè¡¨è¾¾å¼&lt;/td&gt;
&lt;td&gt;å¿…å¡«&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;timeZone&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ—¶åŒºï¼ˆK8s 1.25+ï¼‰&lt;/td&gt;
&lt;td&gt;UTC&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;concurrencyPolicy&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¹¶å‘ç­–ç•¥&lt;/td&gt;
&lt;td&gt;Allow&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;successfulJobsHistoryLimit&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¿ç•™æˆåŠŸJobæ•°é‡&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;failedJobsHistoryLimit&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¿ç•™å¤±è´¥Jobæ•°é‡&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;startingDeadlineSeconds&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;é”™è¿‡è°ƒåº¦åçš„å¯åŠ¨å®½é™æœŸï¼ˆç§’ï¼‰&lt;/td&gt;
&lt;td&gt;æ— é™åˆ¶&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;suspend&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ˜¯å¦æš‚åœ&lt;/td&gt;
&lt;td&gt;false&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;6.4 å¹¶å‘ç­–ç•¥è¯¦è§£&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;concurrencyPolicyå†³å®šå¦‚ä½•å¤„ç†Jobé‡å çš„æƒ…å†µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç­–ç•¥1ï¼šAllowï¼ˆå…è®¸å¹¶å‘ï¼Œé»˜è®¤ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;spec:
  schedule: &quot;*/1 * * * *&quot;
  concurrencyPolicy: Allow    # å…è®¸å¤šä¸ªJobåŒæ—¶è¿è¡Œ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ—¶é—´çº¿ï¼š
0:00 â†’ Job1åˆ›å»ºï¼Œè¿è¡Œä¸­
0:01 â†’ Job2åˆ›å»ºï¼Œè¿è¡Œä¸­ï¼ˆJob1è¿˜æ²¡å®Œæˆï¼‰
0:02 â†’ Job3åˆ›å»ºï¼Œè¿è¡Œä¸­ï¼ˆJob1ã€Job2éƒ½è¿˜æ²¡å®Œæˆï¼‰

ç»“æœï¼š3ä¸ªJobåŒæ—¶è¿è¡Œ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯ï¼š&lt;/strong&gt; ä»»åŠ¡ä¹‹é—´äº’ä¸å½±å“ï¼Œå¯ä»¥å¹¶è¡Œæ‰§è¡Œ&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç­–ç•¥2ï¼šForbidï¼ˆç¦æ­¢å¹¶å‘ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;spec:
  schedule: &quot;*/1 * * * *&quot;
  concurrencyPolicy: Forbid   # å¦‚æœä¸Šä¸€ä¸ªJobè¿˜åœ¨è¿è¡Œï¼Œè·³è¿‡æœ¬æ¬¡è°ƒåº¦
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ—¶é—´çº¿ï¼š
0:00 â†’ Job1åˆ›å»ºï¼Œè¿è¡Œä¸­
0:01 â†’ æ£€æŸ¥ï¼šJob1è¿˜åœ¨è¿è¡Œ â†’ è·³è¿‡ï¼Œä¸åˆ›å»ºJob2
0:02 â†’ æ£€æŸ¥ï¼šJob1è¿˜åœ¨è¿è¡Œ â†’ è·³è¿‡ï¼Œä¸åˆ›å»ºJob3
0:03 â†’ Job1å®Œæˆ
0:04 â†’ Job2åˆ›å»ºï¼Œè¿è¡Œä¸­

ç»“æœï¼šåŒä¸€æ—¶é—´åªæœ‰1ä¸ªJobè¿è¡Œ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯ï¼š&lt;/strong&gt; ä»»åŠ¡ä¸èƒ½å¹¶å‘ï¼ˆå¦‚æ•°æ®åº“å¤‡ä»½ã€èµ„æºæ¸…ç†ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç­–ç•¥3ï¼šReplaceï¼ˆæ›¿æ¢ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;spec:
  schedule: &quot;*/1 * * * *&quot;
  concurrencyPolicy: Replace  # ç»ˆæ­¢æ—§Jobï¼Œåˆ›å»ºæ–°Job
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ—¶é—´çº¿ï¼š
0:00 â†’ Job1åˆ›å»ºï¼Œè¿è¡Œä¸­
0:01 â†’ æ£€æŸ¥ï¼šJob1è¿˜åœ¨è¿è¡Œ â†’ ç»ˆæ­¢Job1 â†’ åˆ›å»ºJob2
0:02 â†’ æ£€æŸ¥ï¼šJob2è¿˜åœ¨è¿è¡Œ â†’ ç»ˆæ­¢Job2 â†’ åˆ›å»ºJob3

ç»“æœï¼šæ—§Jobè¢«æ–°Jobæ›¿æ¢
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯ï¼š&lt;/strong&gt; åªå…³å¿ƒæœ€æ–°çš„ä»»åŠ¡ç»“æœï¼ˆå¦‚ç›‘æ§æ•°æ®é‡‡é›†ï¼‰&lt;/p&gt;
&lt;h4&gt;6.5 CronJobç®¡ç†å‘½ä»¤&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºå’ŒæŸ¥çœ‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºCronJob
kubectl apply -f cronjob.yaml

# æŸ¥çœ‹CronJob
kubectl get cronjobs
# è¾“å‡ºï¼š
# NAME            SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
# backup-cronjob  0 2 * * *     False     0        15h             3d

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe cronjob backup-cronjob

# æŸ¥çœ‹CronJobåˆ›å»ºçš„Job
kubectl get jobs
# NAME                      COMPLETIONS   DURATION   AGE
# backup-cronjob-28441920   1/1           15s        15h
# backup-cronjob-28443360   1/1           16s        39m
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰‹åŠ¨è§¦å‘ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªJobï¼ˆä¸ç­‰è°ƒåº¦æ—¶é—´ï¼‰
kubectl create job --from=cronjob/backup-cronjob manual-backup-job

# æŸ¥çœ‹æ‰‹åŠ¨åˆ›å»ºçš„Job
kubectl get jobs manual-backup-job
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æš‚åœå’Œæ¢å¤ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æš‚åœCronJobï¼ˆä¸åˆ›å»ºæ–°Jobï¼Œå·²æœ‰Jobç»§ç»­è¿è¡Œï¼‰
kubectl patch cronjob backup-cronjob -p &apos;{&quot;spec&quot;:{&quot;suspend&quot;:true}}&apos;

# æ¢å¤CronJob
kubectl patch cronjob backup-cronjob -p &apos;{&quot;spec&quot;:{&quot;suspend&quot;:false}}&apos;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åˆ é™¤ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤CronJobï¼ˆä¸åˆ é™¤å·²åˆ›å»ºçš„Jobï¼‰
kubectl delete cronjob backup-cronjob

# åˆ é™¤CronJobåŠå…¶æ‰€æœ‰Job
kubectl delete cronjob backup-cronjob --cascade=foreground
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;7. å®æˆ˜1ï¼šéƒ¨ç½²Fluentd DaemonSetæ”¶é›†æ—¥å¿—&lt;/h3&gt;
&lt;h4&gt;7.1 å®æˆ˜ç›®æ ‡&lt;/h4&gt;
&lt;p&gt;éƒ¨ç½²Fluentdæ—¥å¿—æ”¶é›†å™¨åˆ°é›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹ï¼Œæ”¶é›†æ‰€æœ‰å®¹å™¨çš„æ—¥å¿—å¹¶è¾“å‡ºåˆ°stdoutï¼ˆç”Ÿäº§ç¯å¢ƒä¼šè¾“å‡ºåˆ°Elasticsearchç­‰ï¼‰ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¶æ„å›¾ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;graph TB
    subgraph &quot;K8s Cluster&quot;
        subgraph &quot;Node1&quot;
            P1[&quot;åº”ç”¨Pod1&amp;lt;br/&amp;gt;å†™æ—¥å¿—åˆ°/var/log/containers/&quot;]
            F1[&quot;Fluentd DaemonSet Pod&amp;lt;br/&amp;gt;æ”¶é›†/var/log/containers/&quot;]
            P1 -.æ—¥å¿—æ–‡ä»¶.-&amp;gt; F1
        end
        
        subgraph &quot;Node2&quot;
            P2[&quot;åº”ç”¨Pod2&amp;lt;br/&amp;gt;å†™æ—¥å¿—åˆ°/var/log/containers/&quot;]
            F2[&quot;Fluentd DaemonSet Pod&amp;lt;br/&amp;gt;æ”¶é›†/var/log/containers/&quot;]
            P2 -.æ—¥å¿—æ–‡ä»¶.-&amp;gt; F2
        end
        
        subgraph &quot;Node3&quot;
            P3[&quot;åº”ç”¨Pod3&amp;lt;br/&amp;gt;å†™æ—¥å¿—åˆ°/var/log/containers/&quot;]
            F3[&quot;Fluentd DaemonSet Pod&amp;lt;br/&amp;gt;æ”¶é›†/var/log/containers/&quot;]
            P3 -.æ—¥å¿—æ–‡ä»¶.-&amp;gt; F3
        end
    end
    
    F1 --&amp;gt; Output[&quot;è¾“å‡ºåˆ°stdout&amp;lt;br/&amp;gt;(æˆ–Elasticsearch)&quot;]
    F2 --&amp;gt; Output
    F3 --&amp;gt; Output
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;7.2 ç†è§£Fluentdå·¥ä½œåŸç†&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Fluentdæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Fluentdæ˜¯ä¸€ä¸ªå¼€æºçš„æ—¥å¿—æ”¶é›†å™¨ï¼Œä¸“é—¨è®¾è®¡ç”¨äºç»Ÿä¸€æ—¥å¿—æ”¶é›†å’Œåˆ†å‘ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åœ¨K8sä¸­çš„å·¥ä½œæ–¹å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å®¹å™¨æ—¥å¿—ä½ç½®&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å®¹å™¨æ—¥å¿— â†’ Docker/containerdå†™å…¥ â†’ /var/log/containers/

æ—¥å¿—æ–‡ä»¶å‘½åæ ¼å¼ï¼š
&amp;lt;pod-name&amp;gt;_&amp;lt;namespace&amp;gt;_&amp;lt;container-name&amp;gt;-&amp;lt;container-id&amp;gt;.log

ç¤ºä¾‹ï¼š
nginx-deployment-5d59d67564-abcde_default_nginx-a1b2c3d4.log
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Fluentdæ”¶é›†ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;DaemonSetéƒ¨ç½²åˆ°æ¯ä¸ªèŠ‚ç‚¹
â†’ æŒ‚è½½å®¿ä¸»æœºçš„/var/log/containersç›®å½•
â†’ è¯»å–æ‰€æœ‰æ—¥å¿—æ–‡ä»¶
â†’ è§£æã€è¿‡æ»¤ã€æ ¼å¼åŒ–
â†’ å‘é€åˆ°ç›®æ ‡ï¼ˆElasticsearchã€S3ã€Kafkaç­‰ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;7.3 å‡†å¤‡ConfigMapé…ç½®&lt;/h4&gt;
&lt;p&gt;Fluentdéœ€è¦é…ç½®æ–‡ä»¶å‘Šè¯‰å®ƒå¦‚ä½•å¤„ç†æ—¥å¿—ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºfluentd-config.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: fluentd-config
  namespace: kube-system
data:
  fluent.conf: |
    # è¾“å…¥æºï¼šè¯»å–å®¹å™¨æ—¥å¿—
    &amp;lt;source&amp;gt;
      @type tail                           # ä½¿ç”¨tailæ’ä»¶ï¼ˆç±»ä¼¼tail -få‘½ä»¤ï¼‰
      path /var/log/containers/*.log       # ç›‘æ§æ‰€æœ‰å®¹å™¨æ—¥å¿—
      pos_file /var/log/fluentd-containers.log.pos  # è®°å½•è¯»å–ä½ç½®ï¼ˆé¿å…é‡å¤ï¼‰
      tag kubernetes.*                     # æ—¥å¿—æ ‡ç­¾
      read_from_head true                  # ä»å¤´å¼€å§‹è¯»å–
      &amp;lt;parse&amp;gt;
        @type json                         # è§£æJSONæ ¼å¼æ—¥å¿—
        time_key time
        time_format %Y-%m-%dT%H:%M:%S.%NZ
        keep_time_key true
      &amp;lt;/parse&amp;gt;
    &amp;lt;/source&amp;gt;
    
    # è¿‡æ»¤å™¨ï¼šæ·»åŠ Kuberneteså…ƒæ•°æ®
    &amp;lt;filter kubernetes.**&amp;gt;
      @type kubernetes_metadata            # æ·»åŠ Podåç§°ã€å‘½åç©ºé—´ç­‰ä¿¡æ¯
    &amp;lt;/filter&amp;gt;
    
    # è¾“å‡ºï¼šæ‰“å°åˆ°stdoutï¼ˆæµ‹è¯•ç”¨ï¼‰
    &amp;lt;match **&amp;gt;
      @type stdout                         # è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
    &amp;lt;/match&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®è§£é‡Šï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;é…ç½®é¡¹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;@type tail&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç›‘æ§æ–‡ä»¶å˜åŒ–ï¼ˆç±»ä¼¼&lt;code&gt;tail -f&lt;/code&gt;ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;path&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ—¥å¿—æ–‡ä»¶è·¯å¾„ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;pos_file&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è®°å½•è¯»å–ä½ç½®çš„æ–‡ä»¶ï¼ˆé‡å¯åä»ä¸Šæ¬¡ä½ç½®ç»§ç»­ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;tag&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ—¥å¿—æ ‡ç­¾ï¼Œç”¨äºè·¯ç”±&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;@type json&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è§£æJSONæ ¼å¼çš„æ—¥å¿—&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;@type kubernetes_metadata&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨æ·»åŠ Podåç§°ã€å‘½åç©ºé—´ã€æ ‡ç­¾ç­‰Kubernetesä¿¡æ¯&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;@type stdout&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼ˆç”Ÿäº§ç¯å¢ƒæ”¹ä¸ºelasticsearchç­‰ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºConfigMapï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f fluentd-config.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;7.4 åˆ›å»ºFluentd DaemonSet&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºfluentd-daemonset.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd
  namespace: kube-system
  labels:
    app: fluentd
spec:
  selector:
    matchLabels:
      app: fluentd
  template:
    metadata:
      labels:
        app: fluentd
    spec:
      # æœåŠ¡è´¦å·ï¼ˆéœ€è¦æƒé™è¯»å–Podå…ƒæ•°æ®ï¼‰
      serviceAccountName: fluentd
      
      # å®¹å¿masterèŠ‚ç‚¹æ±¡ç‚¹ï¼ˆåœ¨æ‰€æœ‰èŠ‚ç‚¹è¿è¡Œï¼‰
      tolerations:
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      
      containers:
      - name: fluentd
        image: fluent/fluentd-kubernetes-daemonset:v1-debian-elasticsearch
        env:
        # ç¦ç”¨Elasticsearchè¾“å‡ºï¼ˆæˆ‘ä»¬åªç”¨stdoutæµ‹è¯•ï¼‰
        - name: FLUENT_ELASTICSEARCH_HOST
          value: &quot;localhost&quot;
        resources:
          limits:
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 200Mi
        volumeMounts:
        # æŒ‚è½½é…ç½®æ–‡ä»¶
        - name: config
          mountPath: /fluentd/etc/fluent.conf
          subPath: fluent.conf
        # æŒ‚è½½å®¹å™¨æ—¥å¿—ç›®å½•
        - name: varlog
          mountPath: /var/log
          readOnly: true
        # æŒ‚è½½å®¹å™¨è¿è¡Œæ—¶ç›®å½•
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers
          readOnly: true
      
      volumes:
      - name: config
        configMap:
          name: fluentd-config
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®é…ç½®è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ServiceAccount&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Fluentdéœ€è¦è°ƒç”¨K8s APIè·å–Podä¿¡æ¯
â†’ éœ€è¦åˆ›å»ºServiceAccountå’Œå¯¹åº”çš„RBACæƒé™
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;tolerations&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å…è®¸åœ¨masterèŠ‚ç‚¹è¿è¡Œ
â†’ æ”¶é›†masterèŠ‚ç‚¹ä¸Šçš„ç³»ç»Ÿç»„ä»¶æ—¥å¿—
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;volumeMounts&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;/var/log&lt;/code&gt;: å®¿ä¸»æœºæ—¥å¿—ç›®å½•&lt;/li&gt;
&lt;li&gt;&lt;code&gt;/var/lib/docker/containers&lt;/code&gt;: å®¹å™¨æ—¥å¿—æ–‡ä»¶çš„è½¯é“¾æ¥æº&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;7.5 åˆ›å»ºRBACæƒé™&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºfluentd-rbac.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: fluentd
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: fluentd
rules:
- apiGroups: [&quot;&quot;]
  resources:
  - pods
  - namespaces
  verbs:
  - get
  - list
  - watch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: fluentd
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: fluentd
subjects:
- kind: ServiceAccount
  name: fluentd
  namespace: kube-system
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æƒé™è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;get/list/watch pods&lt;/code&gt;: è·å–Podä¿¡æ¯ï¼ˆåç§°ã€æ ‡ç­¾ã€å‘½åç©ºé—´ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;code&gt;get/list/watch namespaces&lt;/code&gt;: è·å–å‘½åç©ºé—´ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;7.6 éƒ¨ç½²å’ŒéªŒè¯&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;1. éƒ¨ç½²Fluentd&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºRBACæƒé™
kubectl apply -f fluentd-rbac.yaml

# åˆ›å»ºConfigMap
kubectl apply -f fluentd-config.yaml

# åˆ›å»ºDaemonSet
kubectl apply -f fluentd-daemonset.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;2. éªŒè¯éƒ¨ç½²&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹DaemonSetçŠ¶æ€
kubectl get daemonset -n kube-system fluentd

# è¾“å‡ºï¼š
# NAME      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
# fluentd   3         3         3       3            3           &amp;lt;none&amp;gt;          1m

# æŸ¥çœ‹Podåˆ†å¸ƒ
kubectl get pods -n kube-system -l app=fluentd -o wide

# è¾“å‡ºï¼š
# NAME            READY   STATUS    RESTARTS   AGE   IP           NODE
# fluentd-abc12   1/1     Running   0          1m    10.244.0.5   k8s-master
# fluentd-def34   1/1     Running   0          1m    10.244.1.5   k8s-node1
# fluentd-ghi56   1/1     Running   0          1m    10.244.2.5   k8s-node2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;3. åˆ›å»ºæµ‹è¯•åº”ç”¨ç”Ÿæˆæ—¥å¿—&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºä¸€ä¸ªç®€å•çš„Podç”Ÿæˆæ—¥å¿—
kubectl run log-generator --image=busybox --restart=Never -- sh -c &apos;while true; do echo &quot;Log message at $(date)&quot;; sleep 5; done&apos;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;4. æŸ¥çœ‹Fluentdæ”¶é›†çš„æ—¥å¿—&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Fluentdæ—¥å¿—ï¼ˆä¼šçœ‹åˆ°æ”¶é›†åˆ°çš„åº”ç”¨æ—¥å¿—ï¼‰
kubectl logs -n kube-system -l app=fluentd --tail=50

# è¾“å‡ºç¤ºä¾‹ï¼š
# 2024-01-15 10:30:15 +0000 kubernetes.var.log.containers.log-generator_default_log-generator-xxx.log: 
# {
#   &quot;log&quot;:&quot;Log message at Mon Jan 15 10:30:15 UTC 2024\n&quot;,
#   &quot;stream&quot;:&quot;stdout&quot;,
#   &quot;time&quot;:&quot;2024-01-15T10:30:15.123456789Z&quot;,
#   &quot;kubernetes&quot;:{
#     &quot;pod_name&quot;:&quot;log-generator&quot;,
#     &quot;namespace_name&quot;:&quot;default&quot;,
#     &quot;pod_id&quot;:&quot;abc123&quot;,
#     &quot;container_name&quot;:&quot;log-generator&quot;,
#     &quot;host&quot;:&quot;k8s-node1&quot;
#   }
# }
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;5. æµ‹è¯•æ›´æ–°DaemonSet&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¿®æ”¹Fluentdé•œåƒç‰ˆæœ¬ï¼ˆè§¦å‘æ»šåŠ¨æ›´æ–°ï¼‰
kubectl set image daemonset/fluentd fluentd=fluent/fluentd-kubernetes-daemonset:v1.15-debian-elasticsearch-1 -n kube-system

# æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout status daemonset/fluentd -n kube-system

# ç›‘æ§æ›´æ–°è¿‡ç¨‹
kubectl get pods -n kube-system -l app=fluentd -w
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;8. å®æˆ˜2ï¼šä½¿ç”¨Jobæ‰§è¡Œä¸€æ¬¡æ€§æ•°æ®å¤„ç†ä»»åŠ¡&lt;/h3&gt;
&lt;h4&gt;8.1 å®æˆ˜ç›®æ ‡&lt;/h4&gt;
&lt;p&gt;åˆ›å»ºJobæ‰§è¡Œæ‰¹é‡æ•°æ®å¤„ç†ä»»åŠ¡ï¼Œæ¼”ç¤ºå¹¶è¡Œæ‰§è¡Œã€å¤±è´¥é‡è¯•æœºåˆ¶ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼š&lt;/strong&gt; æ‰¹é‡å¤„ç†å›¾ç‰‡ç¼©ç•¥å›¾ï¼ˆæ¨¡æ‹Ÿï¼‰&lt;/p&gt;
&lt;h4&gt;8.2 å‡†å¤‡æµ‹è¯•é•œåƒ&lt;/h4&gt;
&lt;p&gt;åœ¨harboræœºå™¨ä¸Šåˆ›å»ºå¤„ç†é•œåƒï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p /root/k8s-demo/image-processor
cd /root/k8s-demo/image-processor
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºprocess.shï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; process.sh &amp;lt;&amp;lt; &apos;EOF&apos;
#!/bin/sh
TASK_ID=${TASK_ID:-&quot;unknown&quot;}
echo &quot;=== Task $TASK_ID Started at $(date) ===&quot;
SLEEP_TIME=$((5 + RANDOM % 10))
echo &quot;Processing for $SLEEP_TIME seconds...&quot;
sleep $SLEEP_TIME
echo &quot;=== Task $TASK_ID Completed at $(date) ===&quot;
exit 0
EOF
chmod +x process.sh
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Dockerfileå’Œæ„å»ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM alpine:3.18
COPY process.sh /usr/local/bin/
CMD [&quot;/usr/local/bin/process.sh&quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;docker build -t reg.westos.org/library/image-processor:v1 .
docker push reg.westos.org/library/image-processor:v1
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;8.3 åˆ›å»ºå¹¶è¡ŒJob&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;parallel-job.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: batch/v1
kind: Job
metadata:
  name: parallel-image-job
spec:
  completions: 10
  parallelism: 3
  backoffLimit: 20
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: processor
        image: reg.westos.org/library/image-processor:v1
        env:
        - name: TASK_ID
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰§è¡Œï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f parallel-job.yaml
watch kubectl get jobs parallel-image-job
kubectl get pods -l job-name=parallel-image-job -w
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;9. å®æˆ˜3ï¼šetcdå¤‡ä»½å®Œå…¨æŒ‡å—&lt;/h3&gt;
&lt;h4&gt;9.1 ä¸ºä»€ä¹ˆå¿…é¡»å¤‡ä»½etcdï¼Ÿ&lt;/h4&gt;
&lt;h5&gt;9.1.1 etcdåœ¨K8sä¸­çš„åœ°ä½&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    K8sé›†ç¾¤çš„&quot;å¤§è„‘&quot;ä¸&quot;è®°å¿†&quot;                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  etcdå­˜å‚¨äº†K8sé›†ç¾¤çš„ã€ä¸€åˆ‡çŠ¶æ€ä¿¡æ¯ã€‘ï¼š                                    â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ‰€æœ‰èµ„æºå¯¹è±¡                                                     â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Namespaceã€Podã€Deploymentã€Service...                      â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ConfigMapã€Secretï¼ˆåŒ…å«æ•æ„Ÿæ•°æ®ï¼ï¼‰                          â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ PVã€PVCã€StorageClass                                       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ RBACè§„åˆ™ï¼ˆRoleã€ClusterRoleã€Bindingï¼‰                      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ æ‰€æœ‰è‡ªå®šä¹‰èµ„æºï¼ˆCRDï¼‰                                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  é›†ç¾¤é…ç½®                                                               â”‚
â”‚  â”œâ”€â”€ èŠ‚ç‚¹ä¿¡æ¯ã€è°ƒåº¦æ•°æ®                                                 â”‚
â”‚  â”œâ”€â”€ æœåŠ¡å‘ç°ä¿¡æ¯ï¼ˆEndpointsï¼‰                                         â”‚
â”‚  â””â”€â”€ ç§Ÿçº¦ï¼ˆLeaseï¼‰ä¿¡æ¯                                                  â”‚
â”‚                                                                         â”‚
â”‚  âš ï¸ ä¸€æ—¦etcdæ•°æ®ä¸¢å¤± = æ•´ä¸ªé›†ç¾¤é…ç½®å…¨éƒ¨ä¸¢å¤± = é›†ç¾¤æŠ¥åºŸï¼                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.1.2 ä»€ä¹ˆæƒ…å†µéœ€è¦ä»å¤‡ä»½æ¢å¤ï¼Ÿ&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç¾éš¾åœºæ™¯&lt;/th&gt;
&lt;th&gt;åæœ&lt;/th&gt;
&lt;th&gt;éœ€è¦å¤‡ä»½æ¢å¤ï¼Ÿ&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;MasterèŠ‚ç‚¹ç¡¬ç›˜æŸå&lt;/td&gt;
&lt;td&gt;etcdæ•°æ®å…¨ä¸¢&lt;/td&gt;
&lt;td&gt;âœ… å¿…é¡»&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;è¯¯åˆ é™¤å…³é”®èµ„æºï¼ˆå¦‚æ‰€æœ‰Deploymentï¼‰&lt;/td&gt;
&lt;td&gt;ä¸šåŠ¡å…¨æŒ‚&lt;/td&gt;
&lt;td&gt;âœ… å¿…é¡»&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;etcdé›†ç¾¤è„‘è£‚&lt;/td&gt;
&lt;td&gt;æ•°æ®ä¸ä¸€è‡´&lt;/td&gt;
&lt;td&gt;âœ… å¯èƒ½éœ€è¦&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;K8så‡çº§å¤±è´¥&lt;/td&gt;
&lt;td&gt;é›†ç¾¤æ— æ³•å¯åŠ¨&lt;/td&gt;
&lt;td&gt;âœ… å¿…é¡»&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;å‹’ç´¢è½¯ä»¶/æ¶æ„æ”»å‡»&lt;/td&gt;
&lt;td&gt;æ•°æ®è¢«åŠ å¯†æˆ–åˆ é™¤&lt;/td&gt;
&lt;td&gt;âœ… å¿…é¡»&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ§  &lt;strong&gt;æ€ç»´æ¨¡å‹&lt;/strong&gt;ï¼šæŠŠetcdæƒ³è±¡æˆé“¶è¡Œçš„è´¦æœ¬æ•°æ®åº“ã€‚æ‰€æœ‰å®¢æˆ·çš„å­˜æ¬¾è®°å½•éƒ½åœ¨é‡Œé¢ã€‚å¦‚æœæ²¡æœ‰å¤‡ä»½ï¼Œé“¶è¡Œå¤±ç«åå®¢æˆ·çš„é’±å°±&quot;æ¶ˆå¤±&quot;äº†â€”â€”è™½ç„¶é’±ï¼ˆå®¹å™¨é•œåƒï¼‰è¿˜åœ¨ï¼Œä½†è°æœ‰å¤šå°‘é’±ï¼ˆPodé…ç½®ï¼‰çš„è®°å½•æ²¡äº†ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h4&gt;9.2 etcdå¤‡ä»½åŸç†&lt;/h4&gt;
&lt;h5&gt;9.2.1 å¤‡ä»½çš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        etcdå¤‡ä»½æœºåˆ¶                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  etcdæ•°æ®å­˜å‚¨åœ¨ï¼š/var/lib/etcd/member/                                   â”‚
â”‚  â”œâ”€â”€ snap/  â† å¿«ç…§æ–‡ä»¶ï¼ˆæ•°æ®çš„å‹ç¼©å­˜æ¡£ï¼‰                                  â”‚
â”‚  â””â”€â”€ wal/   â† é¢„å†™æ—¥å¿—ï¼ˆWrite-Ahead Logï¼Œè®°å½•æ‰€æœ‰å˜æ›´ï¼‰                   â”‚
â”‚                                                                         â”‚
â”‚  âŒ ç›´æ¥å¤åˆ¶è¿™äº›æ–‡ä»¶ï¼Ÿ                                                    â”‚
â”‚  â””â”€â”€ ä¸è¡Œï¼æ–‡ä»¶å¯èƒ½æ­£åœ¨å†™å…¥ï¼Œå¤åˆ¶å‡ºæ¥çš„æ˜¯ä¸ä¸€è‡´çš„&quot;åŠæˆå“&quot;                  â”‚
â”‚                                                                         â”‚
â”‚  âœ… æ­£ç¡®åšæ³•ï¼šä½¿ç”¨etcdctl snapshot save                                  â”‚
â”‚  â””â”€â”€ etcdä¼šï¼š                                                           â”‚
â”‚      â”œâ”€â”€ 1. æš‚åœæ¥å—æ–°å†™å…¥ï¼ˆæˆ–ä½¿ç”¨MVCCå¿«ç…§ï¼‰                              â”‚
â”‚      â”œâ”€â”€ 2. å°†å½“å‰çŠ¶æ€å¯¼å‡ºä¸ºä¸€ä¸ªä¸€è‡´çš„å¿«ç…§æ–‡ä»¶                            â”‚
â”‚      â””â”€â”€ 3. å¿«ç…§åŒ…å«æŸä¸€æ—¶åˆ»çš„ã€å®Œæ•´æ•°æ®é•œåƒã€‘                            â”‚
â”‚                                                                         â”‚
â”‚  å¿«ç…§æ–‡ä»¶ï¼ˆ.dbï¼‰ï¼š                                                       â”‚
â”‚  â”œâ”€â”€ äºŒè¿›åˆ¶æ ¼å¼ï¼ŒåŒ…å«æ‰€æœ‰é”®å€¼å¯¹                                          â”‚
â”‚  â”œâ”€â”€ é€šå¸¸å‡ MBåˆ°å‡ ç™¾MBï¼ˆå–å†³äºé›†ç¾¤èµ„æºæ•°é‡ï¼‰                               â”‚
â”‚  â””â”€â”€ å¯ä»¥ç”¨æ¥æ¢å¤åˆ°å¿«ç…§æ—¶åˆ»çš„çŠ¶æ€                                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.2.2 etcdçš„å®‰å…¨è®¤è¯&lt;/h5&gt;
&lt;p&gt;etcdä½¿ç”¨**mTLSï¼ˆåŒå‘TLSï¼‰**è®¤è¯ï¼Œå¤‡ä»½æ—¶å¿…é¡»æä¾›è¯ä¹¦ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    etcdè¯ä¹¦è®¤è¯æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  etcdæœåŠ¡ç«¯                              å¤‡ä»½å®¢æˆ·ç«¯ï¼ˆetcdctlï¼‰            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚            â”‚  â†â”€â”€â”€ 1. å»ºç«‹TLSè¿æ¥ â”€â”€â”€â†’ â”‚            â”‚                  â”‚
â”‚  â”‚   éªŒè¯     â”‚                         â”‚   æä¾›     â”‚                  â”‚
â”‚  â”‚ å®¢æˆ·ç«¯è¯ä¹¦ â”‚  â†â”€â”€â”€ 2. å®¢æˆ·ç«¯è¯ä¹¦ â”€â”€â”€â”€â”€  â”‚  å®¢æˆ·ç«¯è¯ä¹¦â”‚                  â”‚
â”‚  â”‚            â”‚                         â”‚            â”‚                  â”‚
â”‚  â”‚   å…è®¸     â”‚  â”€â”€â”€â†’ 3. æ•°æ®è®¿é—® â”€â”€â”€â”€â”€â”€â†’ â”‚  æ‰§è¡Œå¤‡ä»½  â”‚                  â”‚
â”‚  â”‚   è®¿é—®     â”‚                         â”‚            â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                         â”‚
â”‚  éœ€è¦çš„è¯ä¹¦æ–‡ä»¶ï¼ˆkubeadmé›†ç¾¤ä½äº /etc/kubernetes/pki/etcd/ï¼‰ï¼š            â”‚
â”‚  â”œâ”€â”€ ca.crt      â† CAè¯ä¹¦ï¼Œç”¨äºéªŒè¯æœåŠ¡ç«¯èº«ä»½                            â”‚
â”‚  â”œâ”€â”€ server.crt  â† å®¢æˆ·ç«¯è¯ä¹¦ï¼Œè¯æ˜&quot;æˆ‘æœ‰æƒè®¿é—®&quot;                          â”‚
â”‚  â””â”€â”€ server.key  â† å®¢æˆ·ç«¯ç§é’¥ï¼Œç”¨äºç­¾å                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;9.3 æ‰‹åŠ¨å¤‡ä»½etcdï¼ˆå…ˆå­¦ä¼šæ‰‹åŠ¨ï¼Œå†è‡ªåŠ¨åŒ–ï¼‰&lt;/h4&gt;
&lt;h5&gt;9.3.1 ç¬¬ä¸€æ­¥ï¼šç¡®è®¤etcdä¿¡æ¯&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# ç™»å½•åˆ°masterèŠ‚ç‚¹
ssh root@192.168.100.20

# 1. ç¡®è®¤etcdæ­£åœ¨è¿è¡Œ
kubectl get pods -n kube-system | grep etcd
# è¾“å‡ºç¤ºä¾‹ï¼šetcd-k8s-master   1/1   Running   0   10d

# 2. æŸ¥çœ‹etcdçš„é…ç½®ï¼ˆä»é™æ€Podå®šä¹‰ä¸­è·å–ï¼‰
cat /etc/kubernetes/manifests/etcd.yaml | grep -E &quot;listen-client|cert-file|key-file|trusted-ca&quot;
# ä½ ä¼šçœ‹åˆ°ï¼š
# --listen-client-urls=https://127.0.0.1:2379,https://192.168.100.20:2379
# --cert-file=/etc/kubernetes/pki/etcd/server.crt
# --key-file=/etc/kubernetes/pki/etcd/server.key
# --trusted-ca-file=/etc/kubernetes/pki/etcd/ca.crt

# 3. ç¡®è®¤è¯ä¹¦æ–‡ä»¶å­˜åœ¨
ls -la /etc/kubernetes/pki/etcd/
# åº”è¯¥çœ‹åˆ°ï¼šca.crt, server.crt, server.key ç­‰æ–‡ä»¶
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.3.2 ç¬¬äºŒæ­¥ï¼šè®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆç®€åŒ–å‘½ä»¤ï¼‰&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# ä¸ºäº†é¿å…æ¯æ¬¡éƒ½è¾“å…¥é•¿é•¿çš„å‚æ•°ï¼Œå…ˆè®¾ç½®ç¯å¢ƒå˜é‡

# etcd APIç‰ˆæœ¬ï¼ˆå¿…é¡»æ˜¯3ï¼Œv2 APIå·²åºŸå¼ƒï¼‰
export ETCDCTL_API=3

# etcdæœåŠ¡åœ°å€ï¼ˆHTTPSåè®®ï¼‰
export ETCD_ENDPOINTS=&quot;https://192.168.100.20:2379&quot;

# è¯ä¹¦è·¯å¾„
export ETCD_CACERT=&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;
export ETCD_CERT=&quot;/etc/kubernetes/pki/etcd/server.crt&quot;
export ETCD_KEY=&quot;/etc/kubernetes/pki/etcd/server.key&quot;

# éªŒè¯å˜é‡æ˜¯å¦è®¾ç½®æˆåŠŸ
echo $ETCDCTL_API $ETCD_ENDPOINTS
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.3.3 ç¬¬ä¸‰æ­¥ï¼šæ‹·è´etcdctlå¹¶æµ‹è¯•etcdè¿æ¥&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;#æ‹·è´etcdctl
etcd_id=crictl ps | grep etcd | awk &apos;{print $1}&apos;
PID=$(crictl inspect $etcd_id | grep pid | head -2 | tail -1 | awk &apos;{print $2}&apos; | tr -d &apos;,&apos;)
# ç›´æ¥å»è¯¥è¿›ç¨‹çš„æ–‡ä»¶ç³»ç»Ÿé‡Œæ‹·
cp /proc/$PID/root/usr/local/bin/etcdctl /usr/local/bin/
chmod +x /usr/local/bin/etcdctl

# å…ˆæµ‹è¯•èƒ½å¦è¿æ¥åˆ°etcdï¼ˆè¿™ä¸€æ­¥å¾ˆé‡è¦ï¼ï¼‰
etcdctl --endpoints=$ETCD_ENDPOINTS \
        --cacert=$ETCD_CACERT \
        --cert=$ETCD_CERT \
        --key=$ETCD_KEY \
        endpoint health

# é¢„æœŸè¾“å‡ºï¼š
# https://192.168.100.20:2379 is healthy: successfully committed proposal: took = 1.234ms

# å¦‚æœæŠ¥é”™ï¼Œå¸¸è§åŸå› ï¼š
# - &quot;connection refused&quot;ï¼šetcdæ²¡è¿è¡Œæˆ–ç«¯å£ä¸å¯¹
# - &quot;certificate&quot;ç›¸å…³ï¼šè¯ä¹¦è·¯å¾„é”™è¯¯æˆ–è¯ä¹¦ä¸åŒ¹é…
# - &quot;context deadline exceeded&quot;ï¼šç½‘ç»œä¸é€šæˆ–é˜²ç«å¢™é˜»æ­¢
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.3.4 ç¬¬å››æ­¥ï¼šæ‰§è¡Œå¤‡ä»½&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p /data/etcd-backup

# ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶å
BACKUP_FILE=&quot;/data/etcd-backup/etcd-snapshot-$(date +%Y%m%d-%H%M%S).db&quot;
echo &quot;å¤‡ä»½æ–‡ä»¶å°†ä¿å­˜åˆ°: $BACKUP_FILE&quot;

# æ‰§è¡Œå¤‡ä»½ï¼
etcdctl --endpoints=$ETCD_ENDPOINTS \
        --cacert=$ETCD_CACERT \
        --cert=$ETCD_CERT \
        --key=$ETCD_KEY \
        snapshot save $BACKUP_FILE

# é¢„æœŸè¾“å‡ºï¼š
# {&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2024-01-15T10:30:00.123Z&quot;,&quot;msg&quot;:&quot;created temporary snapshot file&quot;,&quot;path&quot;:&quot;/data/etcd-backup/etcd-snapshot-20240115-103000.db.part&quot;}
# {&quot;level&quot;:&quot;info&quot;,&quot;ts&quot;:&quot;2024-01-15T10:30:00.456Z&quot;,&quot;msg&quot;:&quot;saved snapshot&quot;,&quot;path&quot;:&quot;/data/etcd-backup/etcd-snapshot-20240115-103000.db&quot;}
# Snapshot saved at /data/etcd-backup/etcd-snapshot-20240115-103000.db
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å‘½ä»¤å‚æ•°è§£é‡Šï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å‚æ•°&lt;/th&gt;
&lt;th&gt;å«ä¹‰&lt;/th&gt;
&lt;th&gt;ä¸ºä»€ä¹ˆéœ€è¦&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;--endpoints&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;etcdæœåŠ¡åœ°å€&lt;/td&gt;
&lt;td&gt;å‘Šè¯‰etcdctlå»å“ªé‡Œè¿æ¥etcd&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;--cacert&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;CAè¯ä¹¦&lt;/td&gt;
&lt;td&gt;éªŒè¯etcdæœåŠ¡ç«¯èº«ä»½ï¼ˆé˜²æ­¢è¿åˆ°å‡çš„etcdï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;--cert&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;å®¢æˆ·ç«¯è¯ä¹¦&lt;/td&gt;
&lt;td&gt;å‘etcdè¯æ˜&quot;æˆ‘æœ‰æƒé™è®¿é—®&quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;--key&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;å®¢æˆ·ç«¯ç§é’¥&lt;/td&gt;
&lt;td&gt;é…åˆè¯ä¹¦ä½¿ç”¨ï¼Œç”¨äºTLSæ¡æ‰‹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;snapshot save&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;ä¿å­˜å¿«ç…§&lt;/td&gt;
&lt;td&gt;etcdctlçš„å¤‡ä»½å­å‘½ä»¤&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h5&gt;9.3.5 ç¬¬äº”æ­¥ï¼šéªŒè¯å¤‡ä»½æ–‡ä»¶&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹å¤‡ä»½æ–‡ä»¶å¤§å°
ls -lh /data/etcd-backup/
# ç¤ºä¾‹è¾“å‡ºï¼š
# -rw------- 1 root root 5.2M Jan 15 10:30 etcd-snapshot-20240115-103000.db

# éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§ï¼ˆéå¸¸é‡è¦ï¼ï¼‰
etcdctl --write-out=table snapshot status $BACKUP_FILE

# è¾“å‡ºç¤ºä¾‹ï¼ˆè¡¨æ ¼å½¢å¼ï¼‰ï¼š
# +----------+----------+------------+------------+
# |   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |
# +----------+----------+------------+------------+
# | 3c5a6d2e |    12345 |       1024 |     5.2 MB |
# +----------+----------+------------+------------+

# å„å­—æ®µå«ä¹‰ï¼š
# HASH       - å¿«ç…§çš„å“ˆå¸Œå€¼ï¼Œç”¨äºæ ¡éªŒå®Œæ•´æ€§
# REVISION   - etcdçš„ä¿®è®¢ç‰ˆæœ¬å·ï¼ˆæ¯æ¬¡å†™æ“ä½œ+1ï¼‰
# TOTAL KEYS - å¿«ç…§ä¸­åŒ…å«çš„é”®å€¼å¯¹æ•°é‡
# TOTAL SIZE - å¿«ç…§æ–‡ä»¶å¤§å°
&lt;/code&gt;&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;âš ï¸ &lt;strong&gt;é‡è¦&lt;/strong&gt;ï¼šå¦‚æœ&lt;code&gt;snapshot status&lt;/code&gt;æŠ¥é”™ï¼Œè¯´æ˜å¤‡ä»½æ–‡ä»¶æŸåï¼Œä¸è¦ä½¿ç”¨ï¼&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h5&gt;9.3.6 æ‰‹åŠ¨å¤‡ä»½å®Œæ•´è„šæœ¬ï¼ˆä¸€é”®æ‰§è¡Œç‰ˆï¼‰&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash
# æ–‡ä»¶åï¼šmanual-etcd-backup.sh
# ç”¨é€”ï¼šæ‰‹åŠ¨å¤‡ä»½etcdï¼Œå¯ç›´æ¥åœ¨masterèŠ‚ç‚¹æ‰§è¡Œ

set -e  # ä»»ä½•å‘½ä»¤å¤±è´¥ç«‹å³é€€å‡º

# ============== é…ç½®åŒº ==============
ETCDCTL_API=3
ETCD_ENDPOINTS=&quot;https://192.168.100.20:2379&quot;
ETCD_CACERT=&quot;/etc/kubernetes/pki/etcd/ca.crt&quot;
ETCD_CERT=&quot;/etc/kubernetes/pki/etcd/server.crt&quot;
ETCD_KEY=&quot;/etc/kubernetes/pki/etcd/server.key&quot;
BACKUP_DIR=&quot;/data/etcd-backup&quot;
RETENTION_DAYS=7  # ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
# ====================================

# ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE=&quot;${BACKUP_DIR}/etcd-snapshot-${TIMESTAMP}.db&quot;

echo &quot;=========================================&quot;
echo &quot;  etcdå¤‡ä»½è„šæœ¬&quot;
echo &quot;  æ—¶é—´: $(date)&quot;
echo &quot;  ç›®æ ‡: $BACKUP_FILE&quot;
echo &quot;=========================================&quot;

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p ${BACKUP_DIR}

# æµ‹è¯•è¿æ¥
echo &quot;[1/4] æµ‹è¯•etcdè¿æ¥...&quot;
etcdctl --endpoints=$ETCD_ENDPOINTS \
        --cacert=$ETCD_CACERT \
        --cert=$ETCD_CERT \
        --key=$ETCD_KEY \
        endpoint health

# æ‰§è¡Œå¤‡ä»½
echo &quot;[2/4] æ‰§è¡Œå¤‡ä»½...&quot;
etcdctl --endpoints=$ETCD_ENDPOINTS \
        --cacert=$ETCD_CACERT \
        --cert=$ETCD_CERT \
        --key=$ETCD_KEY \
        snapshot save $BACKUP_FILE

# éªŒè¯å¤‡ä»½
echo &quot;[3/4] éªŒè¯å¤‡ä»½å®Œæ•´æ€§...&quot;
etcdctl snapshot status $BACKUP_FILE --write-out=table

# æ¸…ç†æ—§å¤‡ä»½
echo &quot;[4/4] æ¸…ç†${RETENTION_DAYS}å¤©å‰çš„æ—§å¤‡ä»½...&quot;
find ${BACKUP_DIR} -name &quot;etcd-snapshot-*.db&quot; -mtime +${RETENTION_DAYS} -delete -print

echo &quot;=========================================&quot;
echo &quot;  å¤‡ä»½å®Œæˆï¼&quot;
echo &quot;  æ–‡ä»¶: $BACKUP_FILE&quot;
echo &quot;  å¤§å°: $(ls -lh $BACKUP_FILE | awk &apos;{print $5}&apos;)&quot;
echo &quot;=========================================&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;# ä¿å­˜è„šæœ¬å¹¶æ‰§è¡Œ
chmod +x manual-etcd-backup.sh
./manual-etcd-backup.sh
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;9.4 ä½¿ç”¨CronJobè‡ªåŠ¨å®šæ—¶å¤‡ä»½&lt;/h4&gt;
&lt;h5&gt;9.4.1 ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨Linuxçš„crontabï¼Ÿ&lt;/h5&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ–¹å¼&lt;/th&gt;
&lt;th&gt;ä¼˜ç‚¹&lt;/th&gt;
&lt;th&gt;ç¼ºç‚¹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Linux crontab&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç®€å•ç›´æ¥&lt;/td&gt;
&lt;td&gt;åªåœ¨ä¸€å°æœºå™¨ä¸Šè¿è¡Œï¼Œæœºå™¨æŒ‚äº†å°±ä¸å¤‡ä»½äº†ï¼›æ—¥å¿—ç®¡ç†éº»çƒ¦&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;K8s CronJob&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;é«˜å¯ç”¨ï¼ˆå¯è°ƒåº¦åˆ°ä»»æ„èŠ‚ç‚¹ï¼‰ï¼›ç»Ÿä¸€ç®¡ç†ï¼›æ—¥å¿—é›†ä¸­&lt;/td&gt;
&lt;td&gt;éœ€è¦å®¹å™¨åŒ–ï¼›ä¾èµ–K8sæœ¬èº«è¿è¡Œ&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;ğŸ’¡ &lt;strong&gt;æœ€ä½³å®è·µ&lt;/strong&gt;ï¼šä¸¤ç§æ–¹å¼éƒ½é…ç½®ï¼ŒCronJobä½œä¸ºä¸»å¤‡ä»½ï¼Œcrontabä½œä¸ºå…œåº•ã€‚&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h5&gt;9.4.2 æ„å»ºå¤‡ä»½é•œåƒ&lt;/h5&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦ä¸“é—¨çš„é•œåƒï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;CronJobè¿è¡Œåœ¨Podä¸­ï¼ŒPodæ˜¯éš”ç¦»çš„å®¹å™¨ç¯å¢ƒã€‚æˆ‘ä»¬éœ€è¦ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;å®¹å™¨é‡Œæœ‰&lt;code&gt;etcdctl&lt;/code&gt;å·¥å…·&lt;/li&gt;
&lt;li&gt;å®¹å™¨èƒ½è®¿é—®etcdçš„è¯ä¹¦&lt;/li&gt;
&lt;li&gt;å®¹å™¨èƒ½æŠŠå¤‡ä»½æ–‡ä»¶å†™åˆ°å®¿ä¸»æœº&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Step 1ï¼šåˆ›å»ºå¤‡ä»½è„šæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p /root/k8s-demo/etcd-backup
cd /root/k8s-demo/etcd-backup

# åˆ›å»ºå¤‡ä»½è„šæœ¬ï¼ˆå®¹å™¨å†…æ‰§è¡Œç‰ˆï¼‰
cat &amp;gt; backup.sh &amp;lt;&amp;lt; &apos;EOF&apos;
#!/bin/sh
# etcdå¤‡ä»½è„šæœ¬ - å®¹å™¨ç‰ˆ
# ç¯å¢ƒå˜é‡ç”±CronJobçš„Podå®šä¹‰ä¼ å…¥

set -e  # ä»»ä½•é”™è¯¯ç«‹å³é€€å‡º

echo &quot;=========================================&quot;
echo &quot;  etcdè‡ªåŠ¨å¤‡ä»½&quot;
echo &quot;  æ—¶é—´: $(date)&quot;
echo &quot;=========================================&quot;

# é…ç½®
BACKUP_DIR=&quot;/backup&quot;
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_FILE=&quot;${BACKUP_DIR}/etcd-snapshot-${TIMESTAMP}.db&quot;

# åˆ›å»ºç›®å½•
mkdir -p ${BACKUP_DIR}

# æ‰§è¡Œå¤‡ä»½
echo &quot;[1/3] æ‰§è¡Œå¤‡ä»½...&quot;
ETCDCTL_API=3 etcdctl snapshot save ${BACKUP_FILE} \
  --endpoints=${ETCD_ENDPOINTS} \
  --cacert=${ETCD_CACERT} \
  --cert=${ETCD_CERT} \
  --key=${ETCD_KEY}

# éªŒè¯å¤‡ä»½
echo &quot;[2/3] éªŒè¯å¤‡ä»½...&quot;
ETCDCTL_API=3 etcdctl snapshot status ${BACKUP_FILE} -w table

# æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
ls -lh ${BACKUP_FILE}

# æ¸…ç†7å¤©å‰çš„æ—§å¤‡ä»½
echo &quot;[3/3] æ¸…ç†æ—§å¤‡ä»½...&quot;
find ${BACKUP_DIR} -name &quot;etcd-snapshot-*.db&quot; -mtime +7 -delete -print 2&amp;gt;/dev/null || true

echo &quot;=========================================&quot;
echo &quot;  å¤‡ä»½å®Œæˆ: ${BACKUP_FILE}&quot;
echo &quot;=========================================&quot;
EOF

chmod +x backup.sh
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Step 2ï¼šåˆ›å»ºDockerfile&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; Dockerfile &amp;lt;&amp;lt; &apos;EOF&apos;
# åŸºç¡€é•œåƒï¼šAlpineï¼ˆå°å·§ã€å®‰å…¨ï¼‰
FROM alpine:3.18

# å®‰è£…etcdctlå·¥å…·
# ä¸ºä»€ä¹ˆä¸ç”¨etcdé•œåƒï¼Ÿå› ä¸ºæˆ‘ä»¬åªéœ€è¦etcdctlå®¢æˆ·ç«¯ï¼Œå®Œæ•´etcdå¤ªå¤§äº†
RUN apk add --no-cache curl &amp;amp;&amp;amp; \
    ETCD_VER=v3.5.9 &amp;amp;&amp;amp; \
    echo &quot;ä¸‹è½½etcd ${ETCD_VER}...&quot; &amp;amp;&amp;amp; \
    curl -L https://github.com/etcd-io/etcd/releases/download/${ETCD_VER}/etcd-${ETCD_VER}-linux-amd64.tar.gz -o /tmp/etcd.tar.gz &amp;amp;&amp;amp; \
    tar xzvf /tmp/etcd.tar.gz -C /tmp &amp;amp;&amp;amp; \
    mv /tmp/etcd-${ETCD_VER}-linux-amd64/etcdctl /usr/local/bin/ &amp;amp;&amp;amp; \
    rm -rf /tmp/etcd* &amp;amp;&amp;amp; \
    apk del curl &amp;amp;&amp;amp; \
    etcdctl version

# å¤åˆ¶å¤‡ä»½è„šæœ¬
COPY backup.sh /usr/local/bin/backup.sh

# è®¾ç½®å…¥å£ç‚¹
ENTRYPOINT [&quot;/usr/local/bin/backup.sh&quot;]
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Step 3ï¼šæ„å»ºå¹¶æ¨é€é•œåƒ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ„å»ºé•œåƒ
docker build -t reg.westos.org/library/etcd-backup:v1 .

# éªŒè¯é•œåƒ
docker run --rm reg.westos.org/library/etcd-backup:v1 etcdctl version

# æ¨é€åˆ°ç§æœ‰ä»“åº“
docker push reg.westos.org/library/etcd-backup:v1
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.4.3 åœ¨MasterèŠ‚ç‚¹åˆ›å»ºå¤‡ä»½ç›®å½•&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# CronJobä¼šæŠŠå¤‡ä»½æ–‡ä»¶å†™åˆ°è¿™ä¸ªç›®å½•
ssh root@192.168.100.20 &quot;mkdir -p /data/etcd-backup &amp;amp;&amp;amp; chmod 755 /data/etcd-backup&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.4.4 åˆ›å»ºCronJobèµ„æº&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# æ–‡ä»¶åï¼šetcd-backup-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: etcd-backup
  namespace: kube-system        # æ”¾åœ¨ç³»ç»Ÿå‘½åç©ºé—´ï¼Œä¸etcdåœ¨ä¸€èµ·
spec:
  # ============== è°ƒåº¦é…ç½® ==============
  schedule: &quot;0 2 * * *&quot;         # Cronè¡¨è¾¾å¼ï¼šæ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œ
  #         â”‚ â”‚ â”‚ â”‚ â”‚
  #         â”‚ â”‚ â”‚ â”‚ â””â”€â”€ æ˜ŸæœŸå‡  (0-7, 0å’Œ7éƒ½æ˜¯å‘¨æ—¥)
  #         â”‚ â”‚ â”‚ â””â”€â”€â”€â”€ æœˆä»½ (1-12)
  #         â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€ æ—¥æœŸ (1-31)
  #         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0-23)
  #         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0-59)
  
  concurrencyPolicy: Forbid     # ç¦æ­¢å¹¶å‘ï¼šä¸Šä¸€ä¸ªæ²¡è·‘å®Œï¼Œä¸å¯åŠ¨æ–°çš„
  successfulJobsHistoryLimit: 3 # ä¿ç•™æœ€è¿‘3ä¸ªæˆåŠŸJobçš„è®°å½•
  failedJobsHistoryLimit: 1     # ä¿ç•™æœ€è¿‘1ä¸ªå¤±è´¥Jobçš„è®°å½•
  startingDeadlineSeconds: 200  # å¦‚æœé”™è¿‡è°ƒåº¦æ—¶é—´è¶…è¿‡200ç§’ï¼Œè·³è¿‡æœ¬æ¬¡
  
  # ============== Jobæ¨¡æ¿ ==============
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure  # å¤±è´¥æ—¶é‡è¯•
          
          # è°ƒåº¦åˆ°MasterèŠ‚ç‚¹ï¼ˆå› ä¸ºetcdè¯ä¹¦åœ¨Masterä¸Šï¼‰
          nodeSelector:
            node-role.kubernetes.io/control-plane: &quot;&quot;
          
          # å®¹å¿MasterèŠ‚ç‚¹çš„æ±¡ç‚¹
          tolerations:
          - key: node-role.kubernetes.io/control-plane
            operator: Exists
            effect: NoSchedule
          
          containers:
          - name: etcd-backup
            image: reg.westos.org/library/etcd-backup:v1
            
            # é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’é…ç½®ï¼ˆè„šæœ¬ä¸­ä½¿ç”¨ï¼‰
            env:
            - name: ETCD_ENDPOINTS
              value: &quot;https://192.168.100.20:2379&quot;
            - name: ETCD_CACERT
              value: &quot;/etc/kubernetes/pki/etcd/ca.crt&quot;
            - name: ETCD_CERT
              value: &quot;/etc/kubernetes/pki/etcd/server.crt&quot;
            - name: ETCD_KEY
              value: &quot;/etc/kubernetes/pki/etcd/server.key&quot;
            
            # æŒ‚è½½å·
            volumeMounts:
            - name: etcd-certs
              mountPath: /etc/kubernetes/pki/etcd  # æŒ‚è½½è¯ä¹¦ç›®å½•
              readOnly: true                       # åªè¯»ï¼Œå®‰å…¨
            - name: backup-dir
              mountPath: /backup                   # å¤‡ä»½æ–‡ä»¶å†™å…¥ä½ç½®
          
          # å·å®šä¹‰
          volumes:
          - name: etcd-certs
            hostPath:
              path: /etc/kubernetes/pki/etcd      # Masterä¸Šçš„è¯ä¹¦ç›®å½•
              type: Directory
          - name: backup-dir
            hostPath:
              path: /data/etcd-backup             # Masterä¸Šçš„å¤‡ä»½ç›®å½•
              type: DirectoryOrCreate             # ä¸å­˜åœ¨åˆ™åˆ›å»º
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®é…ç½®è§£é‡Šï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CronJobé…ç½®è¯¦è§£                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ä¸ºä»€ä¹ˆè¦ç”¨nodeSelectorè°ƒåº¦åˆ°Masterï¼Ÿ                                    â”‚
â”‚  â””â”€â”€ etcdè¯ä¹¦åªåœ¨MasterèŠ‚ç‚¹çš„/etc/kubernetes/pki/etcdç›®å½•ä¸‹              â”‚
â”‚      å¦‚æœè°ƒåº¦åˆ°WorkerèŠ‚ç‚¹ï¼Œè¯ä¹¦ç›®å½•æ˜¯ç©ºçš„ï¼Œå¤‡ä»½å¿…ç„¶å¤±è´¥                    â”‚
â”‚                                                                         â”‚
â”‚  ä¸ºä»€ä¹ˆè¦é…ç½®tolerationså®¹å¿æ±¡ç‚¹ï¼Ÿ                                        â”‚
â”‚  â””â”€â”€ MasterèŠ‚ç‚¹é»˜è®¤æœ‰æ±¡ç‚¹ï¼Œæ™®é€šPodæ— æ³•è°ƒåº¦ä¸Šå»                            â”‚
â”‚      node-role.kubernetes.io/control-plane:NoSchedule                   â”‚
â”‚      å¿…é¡»å®¹å¿è¿™ä¸ªæ±¡ç‚¹ï¼ŒPodæ‰èƒ½è°ƒåº¦åˆ°Master                                â”‚
â”‚                                                                         â”‚
â”‚  ä¸ºä»€ä¹ˆç”¨hostPathæŒ‚è½½ï¼Ÿ                                                  â”‚
â”‚  â””â”€â”€ è¯ä¹¦å’Œå¤‡ä»½æ–‡ä»¶éƒ½åœ¨å®¿ä¸»æœºä¸Šï¼Œå¿…é¡»ç”¨hostPathè®¿é—®                       â”‚
â”‚      etcd-certs: è¯»å–è¯ä¹¦ç”¨äºè®¤è¯                                        â”‚
â”‚      backup-dir: å†™å…¥å¤‡ä»½æ–‡ä»¶åˆ°å®¿ä¸»æœº                                    â”‚
â”‚                                                                         â”‚
â”‚  ä¸ºä»€ä¹ˆconcurrencyPolicyè®¾ä¸ºForbidï¼Ÿ                                     â”‚
â”‚  â””â”€â”€ å¤‡ä»½æ˜¯ç‹¬å æ“ä½œï¼ŒåŒæ—¶è¿è¡Œå¤šä¸ªå¤‡ä»½æ²¡æ„ä¹‰ï¼Œè¿˜å¯èƒ½å†²çª                    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.4.5 éƒ¨ç½²CronJob&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# åº”ç”¨CronJob
kubectl apply -f etcd-backup-cronjob.yaml

# æŸ¥çœ‹CronJobçŠ¶æ€
kubectl get cronjob -n kube-system etcd-backup
# NAME          SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
# etcd-backup   0 2 * * *   False     0        &amp;lt;none&amp;gt;          5s
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.4.6 æ‰‹åŠ¨è§¦å‘æµ‹è¯•ï¼ˆä¸ç­‰åˆ°å‡Œæ™¨2ç‚¹ï¼‰&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# ä»CronJobæ¨¡æ¿åˆ›å»ºä¸€ä¸ªç«‹å³æ‰§è¡Œçš„Job
kubectl create job etcd-backup-manual --from=cronjob/etcd-backup -n kube-system

# æŸ¥çœ‹JobçŠ¶æ€
kubectl get jobs -n kube-system | grep etcd-backup
# etcd-backup-manual   1/1           12s        20s

# å®æ—¶æŸ¥çœ‹å¤‡ä»½æ—¥å¿—
kubectl logs -n kube-system -l job-name=etcd-backup-manual -f

# é¢„æœŸçœ‹åˆ°ï¼š
# =========================================
#   etcdè‡ªåŠ¨å¤‡ä»½
#   æ—¶é—´: Mon Jan 15 10:30:00 UTC 2024
# =========================================
# [1/3] æ‰§è¡Œå¤‡ä»½...
# Snapshot saved at /backup/etcd-snapshot-20240115-103000.db
# [2/3] éªŒè¯å¤‡ä»½...
# +----------+----------+------------+------------+
# |   HASH   | REVISION | TOTAL KEYS | TOTAL SIZE |
# +----------+----------+------------+------------+
# | 3c5a6d2e |    12345 |       1024 |     5.2 MB |
# +----------+----------+------------+------------+
# [3/3] æ¸…ç†æ—§å¤‡ä»½...
# =========================================
#   å¤‡ä»½å®Œæˆ: /backup/etcd-snapshot-20240115-103000.db
# =========================================
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;9.4.7 éªŒè¯å¤‡ä»½æ–‡ä»¶&lt;/h5&gt;
&lt;pre&gt;&lt;code&gt;# ç™»å½•MasteræŸ¥çœ‹å¤‡ä»½æ–‡ä»¶
ssh root@192.168.100.20 &quot;ls -lh /data/etcd-backup/&quot;
# -rw------- 1 root root 5.2M Jan 15 10:30 etcd-snapshot-20240115-103000.db

# éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§
ssh root@192.168.100.20 &quot;ETCDCTL_API=3 etcdctl snapshot status /data/etcd-backup/etcd-snapshot-*.db --write-out=table&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;9.5 å¤‡ä»½ç­–ç•¥å»ºè®®&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”Ÿäº§ç¯å¢ƒå¤‡ä»½ç­–ç•¥                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  å¤‡ä»½é¢‘ç‡ï¼š                                                              â”‚
â”‚  â”œâ”€â”€ ç”Ÿäº§ç¯å¢ƒï¼šæ¯2-4å°æ—¶ä¸€æ¬¡                                             â”‚
â”‚  â”œâ”€â”€ æµ‹è¯•ç¯å¢ƒï¼šæ¯å¤©ä¸€æ¬¡                                                  â”‚
â”‚  â””â”€â”€ é‡å¤§å˜æ›´å‰ï¼šæ‰‹åŠ¨å¤‡ä»½ä¸€æ¬¡                                            â”‚
â”‚                                                                         â”‚
â”‚  å¤‡ä»½ä¿ç•™ï¼š                                                              â”‚
â”‚  â”œâ”€â”€ æœ¬åœ°ä¿ç•™ï¼š7å¤©                                                       â”‚
â”‚  â””â”€â”€ è¿œç¨‹å¤‡ä»½ï¼šè‡³å°‘30å¤©ï¼ˆå¼‚åœ°å­˜å‚¨ï¼ï¼‰                                     â”‚
â”‚                                                                         â”‚
â”‚  å¤‡ä»½å­˜å‚¨ï¼š                                                              â”‚
â”‚  â”œâ”€â”€ æœ¬åœ°ï¼š/data/etcd-backupï¼ˆå¿«é€Ÿæ¢å¤ï¼‰                                 â”‚
â”‚  â”œâ”€â”€ NFSï¼šæŒ‚è½½ç½‘ç»œå­˜å‚¨ï¼ˆé˜²å•ç‚¹æ•…éšœï¼‰                                     â”‚
â”‚  â””â”€â”€ å¯¹è±¡å­˜å‚¨ï¼šS3/OSS/MinIOï¼ˆå¼‚åœ°å®¹ç¾ï¼‰                                  â”‚
â”‚                                                                         â”‚
â”‚  âš ï¸ å…³é”®åŸåˆ™ï¼šå¤‡ä»½æ–‡ä»¶ç»ä¸èƒ½åªå­˜åœ¨etcdæ‰€åœ¨çš„åŒä¸€å°æœºå™¨ä¸Šï¼                 â”‚
â”‚     æœºå™¨æŒ‚äº†ï¼Œetcdå’Œå¤‡ä»½ä¸€èµ·ä¸¢å¤± = æ²¡æœ‰å¤‡ä»½                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;10. å®æˆ˜4ï¼šetcdæ¢å¤æ¼”ç»ƒï¼ˆç¾éš¾æ¢å¤ï¼‰&lt;/h3&gt;
&lt;h4&gt;10.1 æ¢å¤åŸç†&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    etcdæ¢å¤åŸç†                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  etcdctl snapshot restore åšäº†ä»€ä¹ˆï¼Ÿ                                    â”‚
â”‚                                                                         â”‚
â”‚  1. è¯»å–å¿«ç…§æ–‡ä»¶ (.db)                                                   â”‚
â”‚     â””â”€â”€ è§£æå…¶ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹                                             â”‚
â”‚                                                                         â”‚
â”‚  2. åˆ›å»ºæ–°çš„æ•°æ®ç›®å½•                                                     â”‚
â”‚     â””â”€â”€ --data-dir=/var/lib/etcd ï¼ˆå¿…é¡»æ˜¯ç©ºç›®å½•æˆ–ä¸å­˜åœ¨ï¼‰                â”‚
â”‚                                                                         â”‚
â”‚  3. åˆå§‹åŒ–etcdæˆå‘˜ä¿¡æ¯                                                   â”‚
â”‚     â”œâ”€â”€ --nameï¼šå½“å‰èŠ‚ç‚¹åç§°                                             â”‚
â”‚     â”œâ”€â”€ --initial-clusterï¼šé›†ç¾¤æˆå‘˜åˆ—è¡¨                                  â”‚
â”‚     â””â”€â”€ --initial-advertise-peer-urlsï¼šèŠ‚ç‚¹é—´é€šä¿¡åœ°å€                    â”‚
â”‚                                                                         â”‚
â”‚  4. å†™å…¥æ•°æ®                                                             â”‚
â”‚     â””â”€â”€ å°†å¿«ç…§æ•°æ®å†™å…¥æ–°æ•°æ®ç›®å½•                                         â”‚
â”‚                                                                         â”‚
â”‚  âš ï¸ æ³¨æ„ï¼šrestoreåçš„etcdæ˜¯&quot;æ–°é›†ç¾¤&quot;ï¼ŒèŠ‚ç‚¹IDä¼šå˜åŒ–                        â”‚
â”‚     æ‰€ä»¥å¿…é¡»é‡æ–°é…ç½®é›†ç¾¤æˆå‘˜ä¿¡æ¯                                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;10.2 å‡†å¤‡å·¥ä½œ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;âš ï¸ è­¦å‘Šï¼šä»¥ä¸‹æ“ä½œä¼šç ´åé›†ç¾¤ï¼Œä»…åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œï¼&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºè™šæ‹Ÿæœºå¿«ç…§ï¼ˆå¿…åšï¼ï¼‰
# åœ¨VMware/KVMä¸­ä¸ºæ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºå¿«ç…§
# å¿«ç…§åç§°å»ºè®®ï¼š&quot;Before-etcd-recovery-test-$(date +%Y%m%d)&quot;

# ç¬¬äºŒæ­¥ï¼šç¡®ä¿æœ‰å¯ç”¨çš„å¤‡ä»½
kubectl create job etcd-backup-before-test --from=cronjob/etcd-backup -n kube-system
kubectl wait --for=condition=complete job/etcd-backup-before-test -n kube-system --timeout=60s

# éªŒè¯å¤‡ä»½å­˜åœ¨
ssh root@192.168.100.20 &quot;ls -lh /data/etcd-backup/&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;10.3 æ¨¡æ‹Ÿåˆ›å»ºä¸šåŠ¡èµ„æº&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºä¸€äº›æµ‹è¯•èµ„æºï¼Œæ¢å¤åéªŒè¯æ˜¯å¦å­˜åœ¨
kubectl create namespace recovery-test
kubectl create deployment nginx --image=nginx:1.20 --replicas=3 -n recovery-test
kubectl expose deployment nginx --port=80 -n recovery-test
kubectl create configmap test-config --from-literal=env=production --from-literal=version=1.0 -n recovery-test
kubectl create secret generic test-secret --from-literal=password=abc123 -n recovery-test

# è®°å½•å½“å‰èµ„æºï¼ˆæ¢å¤åå¯¹æ¯”ï¼‰
echo &quot;=== å½“å‰èµ„æº ===&quot;
kubectl get all,cm,secret -n recovery-test
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;10.4 æ¨¡æ‹Ÿetcdç¾éš¾&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# ç™»å½•MasterèŠ‚ç‚¹
ssh root@192.168.100.20

# 1. åœæ­¢etcdï¼ˆç§»èµ°é™æ€Podé…ç½®ï¼‰
mv /etc/kubernetes/manifests/etcd.yaml /tmp/etcd.yaml.bak

# ç­‰å¾…etcd Podç»ˆæ­¢
sleep 10
crictl ps | grep etcd  # åº”è¯¥çœ‹ä¸åˆ°etcdå®¹å™¨äº†

# 2. ç ´åetcdæ•°æ®ï¼ˆæ¨¡æ‹Ÿç£ç›˜æŸåï¼‰
mv /var/lib/etcd /var/lib/etcd.broken

# æ­¤æ—¶é›†ç¾¤å®Œå…¨ä¸å¯ç”¨
kubectl get nodes
# Error: dial tcp: lookup ... connect: connection refused
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;10.5 æ‰§è¡Œæ¢å¤&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# ä»¥ä¸‹æ‰€æœ‰æ“ä½œåœ¨MasterèŠ‚ç‚¹ï¼ˆ192.168.100.20ï¼‰ä¸Šæ‰§è¡Œ

# ============== ç¬¬ä¸€æ­¥ï¼šåœæ­¢æ‰€æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶ ==============
cd /etc/kubernetes/manifests
mv kube-apiserver.yaml kube-controller-manager.yaml kube-scheduler.yaml /tmp/
# ç­‰å¾…ç»„ä»¶åœæ­¢
sleep 15

# ============== ç¬¬äºŒæ­¥ï¼šæ¢å¤etcdæ•°æ® ==============
# æ‰¾åˆ°æœ€æ–°çš„å¤‡ä»½æ–‡ä»¶
BACKUP_FILE=$(ls -t /data/etcd-backup/*.db | head -1)
echo &quot;ä½¿ç”¨å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE&quot;

# æ‰§è¡Œæ¢å¤ï¼ˆå…³é”®å‘½ä»¤ï¼ï¼‰
ETCDCTL_API=3 etcdctl snapshot restore $BACKUP_FILE \
  --data-dir=/var/lib/etcd \
  --name=k8s-master \
  --initial-cluster=k8s-master=https://192.168.100.20:2380 \
  --initial-advertise-peer-urls=https://192.168.100.20:2380

# å‚æ•°è§£é‡Šï¼š
# --data-dir          : æ¢å¤åˆ°çš„æ•°æ®ç›®å½•ï¼ˆä¼šè‡ªåŠ¨åˆ›å»ºï¼‰
# --name              : å½“å‰etcdèŠ‚ç‚¹åç§°ï¼ˆå¿…é¡»ä¸åŸæ¥ä¸€è‡´ï¼‰
# --initial-cluster   : é›†ç¾¤æˆå‘˜åˆ—è¡¨ï¼ˆæ ¼å¼ï¼šname=urlï¼‰
# --initial-advertise-peer-urls : èŠ‚ç‚¹é—´é€šä¿¡åœ°å€

# ============== ç¬¬ä¸‰æ­¥ï¼šè®¾ç½®æ­£ç¡®çš„æƒé™ ==============
chown -R root:root /var/lib/etcd
chmod 700 /var/lib/etcd

# ============== ç¬¬å››æ­¥ï¼šæ¢å¤æ§åˆ¶å¹³é¢ç»„ä»¶ ==============
mv /tmp/etcd.yaml.bak /etc/kubernetes/manifests/etcd.yaml
mv /tmp/kube-apiserver.yaml /etc/kubernetes/manifests/
mv /tmp/kube-controller-manager.yaml /etc/kubernetes/manifests/
mv /tmp/kube-scheduler.yaml /etc/kubernetes/manifests/

# ç­‰å¾…ç»„ä»¶å¯åŠ¨
echo &quot;ç­‰å¾…æ§åˆ¶å¹³é¢å¯åŠ¨...&quot;
sleep 30

# é€€å‡ºMaster
exit
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;10.6 éªŒè¯æ¢å¤ç»“æœ&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# å›åˆ°ç®¡ç†æœºéªŒè¯

# 1. æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€
kubectl get nodes
# NAME         STATUS   ROLES           AGE   VERSION
# k8s-master   Ready    control-plane   10d   v1.28.0
# k8s-node1    Ready    &amp;lt;none&amp;gt;          10d   v1.28.0
# k8s-node2    Ready    &amp;lt;none&amp;gt;          10d   v1.28.0

# 2. æ£€æŸ¥ç³»ç»Ÿç»„ä»¶
kubectl get pods -n kube-system
# æ‰€æœ‰ç»„ä»¶åº”è¯¥éƒ½æ˜¯Running

# 3. æ£€æŸ¥æµ‹è¯•èµ„æºæ˜¯å¦æ¢å¤
kubectl get all,cm,secret -n recovery-test
# åº”è¯¥çœ‹åˆ°ä¹‹å‰åˆ›å»ºçš„nginx Deploymentã€Serviceã€ConfigMapã€Secret

# 4. éªŒè¯åº”ç”¨å¯è®¿é—®
kubectl exec -it $(kubectl get pod -n recovery-test -o name | head -1) -n recovery-test -- curl localhost
# åº”è¯¥çœ‹åˆ°nginxæ¬¢è¿é¡µ
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;10.7 æ¢å¤åæ¸…ç†&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤æµ‹è¯•èµ„æº
kubectl delete namespace recovery-test

# åˆ é™¤æµ‹è¯•Job
kubectl delete job etcd-backup-before-test -n kube-system

# æ¸…ç†Masterä¸Šçš„ä¸´æ—¶æ–‡ä»¶
ssh root@192.168.100.20 &quot;rm -rf /var/lib/etcd.broken&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;10.8 æ¢å¤æµç¨‹æ€»ç»“&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    etcdæ¢å¤å®Œæ•´æµç¨‹                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ç¬¬ä¸€æ­¥ï¼šåœæ­¢æ‰€æœ‰æ§åˆ¶å¹³é¢ç»„ä»¶                                             â”‚
â”‚  â””â”€â”€ ç§»èµ° /etc/kubernetes/manifests/ ä¸‹çš„yamlæ–‡ä»¶                       â”‚
â”‚                                                                         â”‚
â”‚  ç¬¬äºŒæ­¥ï¼šæ¸…ç†æ—§æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨æŸåçš„æ•°æ®ï¼‰                                  â”‚
â”‚  â””â”€â”€ rm -rf /var/lib/etcd æˆ– mv /var/lib/etcd /var/lib/etcd.old        â”‚
â”‚                                                                         â”‚
â”‚  ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨etcdctl snapshot restoreæ¢å¤æ•°æ®                            â”‚
â”‚  â””â”€â”€ æŒ‡å®šæ­£ç¡®çš„--nameã€--initial-clusterç­‰å‚æ•°                          â”‚
â”‚                                                                         â”‚
â”‚  ç¬¬å››æ­¥ï¼šè®¾ç½®æƒé™                                                        â”‚
â”‚  â””â”€â”€ chown -R root:root /var/lib/etcd &amp;amp;&amp;amp; chmod 700 /var/lib/etcd       â”‚
â”‚                                                                         â”‚
â”‚  ç¬¬äº”æ­¥ï¼šæ¢å¤æ§åˆ¶å¹³é¢ç»„ä»¶                                                â”‚
â”‚  â””â”€â”€ ç§»å›yamlæ–‡ä»¶åˆ° /etc/kubernetes/manifests/                          â”‚
â”‚                                                                         â”‚
â”‚  ç¬¬å…­æ­¥ï¼šéªŒè¯                                                            â”‚
â”‚  â””â”€â”€ kubectl get nodes/podsï¼Œç¡®è®¤é›†ç¾¤æ­£å¸¸                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;æ€»ç»“&lt;/h3&gt;
&lt;p&gt;æœ¬ç« å­¦ä¹ äº†ä¸‰ç§ç‰¹æ®Šçš„å·¥ä½œè´Ÿè½½ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;DaemonSetï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªPod&lt;/li&gt;
&lt;li&gt;ç”¨äºæ—¥å¿—æ”¶é›†ã€ç›‘æ§ã€ç½‘ç»œæ’ä»¶&lt;/li&gt;
&lt;li&gt;æ”¯æŒæ»šåŠ¨æ›´æ–°å’Œå›æ»š&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Jobï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€æ¬¡æ€§ä»»åŠ¡æ‰§è¡Œ&lt;/li&gt;
&lt;li&gt;æ”¯æŒå¹¶è¡Œå’Œå¤±è´¥é‡è¯•&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨æ¸…ç†æœºåˆ¶&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;CronJobï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®šæ—¶ä»»åŠ¡è°ƒåº¦&lt;/li&gt;
&lt;li&gt;Cronè¡¨è¾¾å¼æ§åˆ¶æ‰§è¡Œæ—¶é—´&lt;/li&gt;
&lt;li&gt;å¹¶å‘ç­–ç•¥æ§åˆ¶&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;å®æˆ˜æ”¶è·ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;éƒ¨ç½²Fluentd DaemonSetæ”¶é›†æ—¥å¿—&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨Jobå¹¶è¡Œå¤„ç†ä»»åŠ¡&lt;/li&gt;
&lt;li&gt;CronJobå®šæ—¶å¤‡ä»½etcd&lt;/li&gt;
&lt;li&gt;etcdå¤‡ä»½æ¢å¤æ¼”ç»ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§å»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DaemonSetç”¨äºèŠ‚ç‚¹çº§æœåŠ¡&lt;/li&gt;
&lt;li&gt;Jobç”¨äºæ‰¹å¤„ç†ä»»åŠ¡&lt;/li&gt;
&lt;li&gt;CronJobå¿…é¡»å¤‡ä»½å…³é”®æ•°æ®&lt;/li&gt;
&lt;li&gt;etcdå¤‡ä»½æ˜¯é›†ç¾¤å®‰å…¨çš„æœ€åé˜²çº¿&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;&lt;/h3&gt;
&lt;h2&gt;å…«ã€é…ç½®ç®¡ç†ï¼šConfigMapå’ŒSecret&lt;/h2&gt;
&lt;h3&gt;1. ä¸ºä»€ä¹ˆéœ€è¦é…ç½®ç®¡ç†&lt;/h3&gt;
&lt;p&gt;åœ¨å‰é¢ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬æŠŠé…ç½®ä¿¡æ¯ç›´æ¥å†™åœ¨YAMLæ–‡ä»¶é‡Œã€‚è¿™æ ·åšæœ‰ä¸¥é‡é—®é¢˜ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é—®é¢˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯†ç æ˜æ–‡å­˜å‚¨&lt;/li&gt;
&lt;li&gt;æ— æ³•å¤ç”¨é…ç½®&lt;/li&gt;
&lt;li&gt;ç¯å¢ƒå·®å¼‚éš¾ä»¥å¤„ç†&lt;/li&gt;
&lt;li&gt;ç‰ˆæœ¬ç®¡ç†æ··ä¹±&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Kubernetesè§£å†³æ–¹æ¡ˆï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ConfigMap&lt;/strong&gt;ï¼šå­˜å‚¨éæ•æ„Ÿé…ç½®ï¼ˆæ•°æ®åº“åœ°å€ã€ç«¯å£ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Secret&lt;/strong&gt;ï¼šå­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç ã€å¯†é’¥ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;2. ConfigMapï¼šé…ç½®æ•°æ®çš„&quot;å­—å…¸&quot;&lt;/h3&gt;
&lt;h4&gt;2.1 ConfigMapæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ConfigMap&lt;/strong&gt; å­˜å‚¨éæ•æ„Ÿé…ç½®æ•°æ®ï¼Œä»¥é”®å€¼å¯¹å½¢å¼ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºæ–¹å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹å¼1ï¼šä»å­—é¢é‡
kubectl create configmap app-config \
  --from-literal=DB_HOST=mysql.example.com \
  --from-literal=DB_PORT=3306

# æ–¹å¼2ï¼šä»æ–‡ä»¶
kubectl create configmap app-config --from-file=app.properties

# æ–¹å¼3ï¼šä»YAML
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
data:
  DB_HOST: &quot;mysql-service&quot;
  DB_PORT: &quot;3306&quot;
  my.cnf: |
    [mysqld]
    max_connections=200
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2.2 ConfigMapä½¿ç”¨æ–¹å¼&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ–¹å¼1ï¼šç¯å¢ƒå˜é‡æ³¨å…¥&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#æ–¹å¼1ï¼šå•ç‹¬å¯¼å…¥
containers:
- name: app
  image: nginx:1.20
  env:
  - name: DATABASE_HOST
    valueFrom:
      configMapKeyRef:
        name: mysql-config
        key: DB_HOST
        
#æ–¹å¼2: æ‰¹é‡å¯¼å…¥
containers:
- name: app
  image: nginx:1.20
  envFrom:
  - configMapRef:
      name: mysql-config  
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ–¹å¼2ï¼šæ–‡ä»¶æŒ‚è½½&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;containers:
- name: app
  volumeMounts:
  - name: config-volume
    mountPath: /etc/config
volumes:
- name: config-volume
  configMap:
    name: mysql-config
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2.3 ConfigMapçƒ­æ›´æ–°&lt;/h4&gt;
&lt;p&gt;âš ï¸ &lt;strong&gt;é‡è¦ç‰¹æ€§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Volumeæ–¹å¼ï¼šæ”¯æŒçƒ­æ›´æ–°ï¼ˆ30-60ç§’ï¼‰&lt;/li&gt;
&lt;li&gt;ç¯å¢ƒå˜é‡ï¼šéœ€è¦é‡å¯Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;3. Secretï¼šæ•æ„Ÿæ•°æ®çš„&quot;ä¿é™©ç®±&quot;&lt;/h3&gt;
&lt;h4&gt;3.1 Secretæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Secret&lt;/strong&gt; å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼Œæ•°æ®Base64ç¼–ç ï¼ˆæ³¨æ„ï¼šä¸æ˜¯åŠ å¯†ï¼ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Secretç±»å‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Opaque&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;é€šç”¨ç±»å‹&lt;/td&gt;
&lt;td&gt;å¯†ç ã€å¯†é’¥&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;kubernetes.io/dockerconfigjson&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Dockerå‡­è¯&lt;/td&gt;
&lt;td&gt;æ‹‰å–ç§æœ‰é•œåƒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;kubernetes.io/tls&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;TLSè¯ä¹¦&lt;/td&gt;
&lt;td&gt;HTTPS&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;3.2 Secretåˆ›å»ºæ–¹å¼&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºé€šç”¨Secret
kubectl create secret generic mysql-secret \
  --from-literal=username=root \
  --from-literal=password=&apos;MyP@ssw0rd123&apos;

# åˆ›å»ºDockeré•œåƒä»“åº“Secret
kubectl create secret docker-registry harbor-secret \
  --docker-server=reg.westos.org \
  --docker-username=admin \
  --docker-password=Harbor12345
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;YAMLæ–¹å¼ï¼ˆstringDataè‡ªåŠ¨ç¼–ç ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret
type: Opaque
stringData:
  username: root
  password: MyP@ssw0rd123
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.3 Secretä½¿ç”¨æ–¹å¼&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç¯å¢ƒå˜é‡æ³¨å…¥ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#æ–¹å¼1ï¼šå•ä¸ªè¯»å–
containers:
- name: mysql
  image: mysql:8.0
  env:
  - name: MYSQL_ROOT_PASSWORD
    valueFrom:
      secretKeyRef:
        name: mysql-secret
        key: password
        
#æ–¹å¼2: æ‰¹é‡å¯¼å…¥
containers:
- name: mysql
  image: mysql:8.0
  envFrom:
  - secretRef:
      name: mysql-secret       
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ–‡ä»¶æŒ‚è½½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;containers:
- name: app
  volumeMounts:
  - name: secret-volume
    mountPath: /etc/secret
    readOnly: true
volumes:
- name: secret-volume
  secret:
    secretName: mysql-secret
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;âš ï¸ &lt;strong&gt;å®‰å…¨æ³¨æ„ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Base64ä¸æ˜¯åŠ å¯†&lt;/li&gt;
&lt;li&gt;ä¸è¦æäº¤åˆ°Git&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨RBACé™åˆ¶è®¿é—®&lt;/li&gt;
&lt;li&gt;é¿å…åœ¨æ—¥å¿—ä¸­æ‰“å°&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;4. å®æˆ˜ï¼šConfigMapå’ŒSecretç»¼åˆåº”ç”¨&lt;/h3&gt;
&lt;h4&gt;4.1 å®æˆ˜ç›®æ ‡&lt;/h4&gt;
&lt;p&gt;åˆ›å»ºä¸€ä¸ªå®Œæ•´çš„Webåº”ç”¨ï¼Œå±•ç¤ºé…ç½®ç®¡ç†çš„æœ€ä½³å®è·µã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¶æ„ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ConfigMap (app-config)  â†’  ç¯å¢ƒå˜é‡
Secret (db-secret)      â†’  æ•°æ®åº“å¯†ç 
Nginx Pod              â†’  æ˜¾ç¤ºé…ç½®ä¿¡æ¯
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.2 åˆ›å»ºConfigMap&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;app-configmap.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  APP_NAME: &quot;ConfigDemo&quot;
  APP_ENV: &quot;production&quot;
  DB_HOST: &quot;mysql-service&quot;
  DB_PORT: &quot;3306&quot;
  
  index.html: |
    &amp;lt;!DOCTYPE html&amp;gt;
    &amp;lt;html&amp;gt;
    &amp;lt;head&amp;gt;
      &amp;lt;title&amp;gt;Config Demo&amp;lt;/title&amp;gt;
      &amp;lt;style&amp;gt;
        body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; }
        .box { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; }
        h1 { color: #333; }
      &amp;lt;/style&amp;gt;
    &amp;lt;/head&amp;gt;
    &amp;lt;body&amp;gt;
      &amp;lt;h1&amp;gt;ConfigMapå’ŒSecretæ¼”ç¤º&amp;lt;/h1&amp;gt;
      &amp;lt;div class=&quot;box&quot;&amp;gt;
        &amp;lt;h2&amp;gt;é…ç½®ä¿¡æ¯ï¼š&amp;lt;/h2&amp;gt;
        &amp;lt;p&amp;gt;åº”ç”¨åç§°ï¼š&amp;lt;span id=&quot;app-name&quot;&amp;gt;&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
        &amp;lt;p&amp;gt;è¿è¡Œç¯å¢ƒï¼š&amp;lt;span id=&quot;app-env&quot;&amp;gt;&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
        &amp;lt;p&amp;gt;æ•°æ®åº“åœ°å€ï¼š&amp;lt;span id=&quot;db-host&quot;&amp;gt;&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
      &amp;lt;/div&amp;gt;
      &amp;lt;div class=&quot;box&quot;&amp;gt;
        &amp;lt;h2&amp;gt;æ•æ„Ÿä¿¡æ¯ï¼ˆä»Secretè¯»å–ï¼‰ï¼š&amp;lt;/h2&amp;gt;
        &amp;lt;p&amp;gt;æ•°æ®åº“ç”¨æˆ·ï¼š&amp;lt;span id=&quot;db-user&quot;&amp;gt;&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
        &amp;lt;p&amp;gt;æ•°æ®åº“å¯†ç ï¼š&amp;lt;span id=&quot;db-pass&quot;&amp;gt;&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
      &amp;lt;/div&amp;gt;
    &amp;lt;/body&amp;gt;
    &amp;lt;/html&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f app-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.3 åˆ›å»ºSecret&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;db-secret.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Secret
metadata:
  name: db-secret
type: Opaque
stringData:
  DB_USER: &quot;root&quot;
  DB_PASSWORD: &quot;MySecretPass123&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f db-secret.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.4 åˆ›å»ºåº”ç”¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;app-deployment.yamlï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: config-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: config-demo
  template:
    metadata:
      labels:
        app: config-demo
    spec:
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
        - containerPort: 80
        
        # ConfigMapç¯å¢ƒå˜é‡
        env:
        - name: APP_NAME
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: APP_NAME
        - name: APP_ENV
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: APP_ENV
        - name: DB_HOST
          valueFrom:
            configMapKeyRef:
              name: app-config
              key: DB_HOST
        
        # Secretç¯å¢ƒå˜é‡
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: DB_USER
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: DB_PASSWORD
        
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html/index.html
          subPath: index.html
        
        # å¯åŠ¨è„šæœ¬ï¼šç”Ÿæˆé¡µé¢
        command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
        args:
        - |
          cat &amp;gt; /usr/share/nginx/html/index.html &amp;lt;&amp;lt; EOF
          &amp;lt;!DOCTYPE html&amp;gt;
          &amp;lt;html&amp;gt;
          &amp;lt;head&amp;gt;&amp;lt;title&amp;gt;Config Demo&amp;lt;/title&amp;gt;
          &amp;lt;style&amp;gt;
            body { font-family: Arial; max-width: 800px; margin: 50px auto; padding: 20px; background: #f0f0f0; }
            .box { background: white; padding: 20px; border-radius: 8px; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            h1 { color: #333; }
            .label { font-weight: bold; }
            .value { color: #0066cc; }
          &amp;lt;/style&amp;gt;
          &amp;lt;/head&amp;gt;
          &amp;lt;body&amp;gt;
            &amp;lt;h1&amp;gt;ğŸ¯ ConfigMapå’ŒSecretæ¼”ç¤º&amp;lt;/h1&amp;gt;
            &amp;lt;div class=&quot;box&quot;&amp;gt;
              &amp;lt;h2&amp;gt;ConfigMapé…ç½®ï¼š&amp;lt;/h2&amp;gt;
              &amp;lt;p&amp;gt;&amp;lt;span class=&quot;label&quot;&amp;gt;åº”ç”¨åç§°ï¼š&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;value&quot;&amp;gt;$APP_NAME&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
              &amp;lt;p&amp;gt;&amp;lt;span class=&quot;label&quot;&amp;gt;è¿è¡Œç¯å¢ƒï¼š&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;value&quot;&amp;gt;$APP_ENV&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
              &amp;lt;p&amp;gt;&amp;lt;span class=&quot;label&quot;&amp;gt;æ•°æ®åº“åœ°å€ï¼š&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;value&quot;&amp;gt;$DB_HOST&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
            &amp;lt;/div&amp;gt;
            &amp;lt;div class=&quot;box&quot;&amp;gt;
              &amp;lt;h2&amp;gt;Secretæ•æ„Ÿä¿¡æ¯ï¼š&amp;lt;/h2&amp;gt;
              &amp;lt;p&amp;gt;&amp;lt;span class=&quot;label&quot;&amp;gt;æ•°æ®åº“ç”¨æˆ·ï¼š&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;value&quot;&amp;gt;$DB_USER&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
              &amp;lt;p&amp;gt;&amp;lt;span class=&quot;label&quot;&amp;gt;æ•°æ®åº“å¯†ç ï¼š&amp;lt;/span&amp;gt;&amp;lt;span class=&quot;value&quot;&amp;gt;$DB_PASSWORD&amp;lt;/span&amp;gt;&amp;lt;/p&amp;gt;
            &amp;lt;/div&amp;gt;
            &amp;lt;div class=&quot;box&quot;&amp;gt;
              &amp;lt;p&amp;gt;ğŸ’¡ æç¤ºï¼šæ­¤é¡µé¢å±•ç¤ºäº†ConfigMapå’ŒSecretçš„ä½¿ç”¨&amp;lt;/p&amp;gt;
            &amp;lt;/div&amp;gt;
          &amp;lt;/body&amp;gt;
          &amp;lt;/html&amp;gt;
          EOF
          nginx -g &apos;daemon off;&apos;
      
      volumes:
      - name: html
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: config-demo
spec:
  selector:
    app: config-demo
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30088
  type: NodePort
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f app-deployment.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.5 è®¿é—®å’Œæµ‹è¯•&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Pod
kubectl get pods -l app=config-demo

# è·å–Serviceåœ°å€
kubectl get svc config-demo

# è®¿é—®åº”ç”¨ï¼ˆæµè§ˆå™¨æ‰“å¼€ï¼‰
http://192.168.100.21:30088
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•é…ç½®æ›´æ–°ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# 1. æ›´æ–°ConfigMap
kubectl patch configmap app-config -p &apos;{&quot;data&quot;:{&quot;APP_ENV&quot;:&quot;development&quot;}}&apos;

# 2. é‡å¯Podï¼ˆç¯å¢ƒå˜é‡éœ€è¦é‡å¯ï¼‰
kubectl rollout restart deployment config-demo

# 3. å†æ¬¡è®¿é—®ï¼Œçœ‹åˆ°ç¯å¢ƒå˜é‡å·²æ›´æ–°
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•Secretæ›´æ–°ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ›´æ–°Secret
kubectl patch secret db-secret -p &apos;{&quot;stringData&quot;:{&quot;DB_PASSWORD&quot;:&quot;NewPassword456&quot;}}&apos;

# é‡å¯Pod
kubectl rollout restart deployment config-demo

# éªŒè¯å¯†ç å·²æ›´æ–°
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;æ€»ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;ConfigMapï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å­˜å‚¨éæ•æ„Ÿé…ç½®&lt;/li&gt;
&lt;li&gt;æ”¯æŒæ–‡ä»¶çƒ­æ›´æ–°&lt;/li&gt;
&lt;li&gt;å¤šç§åˆ›å»ºå’Œä½¿ç”¨æ–¹å¼&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;Secretï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å­˜å‚¨æ•æ„Ÿä¿¡æ¯&lt;/li&gt;
&lt;li&gt;Base64ç¼–ç ï¼ˆä¸æ˜¯åŠ å¯†ï¼‰&lt;/li&gt;
&lt;li&gt;RBACæƒé™æ§åˆ¶&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æœ€ä½³å®è·µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é…ç½®ä¸ä»£ç åˆ†ç¦»&lt;/li&gt;
&lt;li&gt;ä¸è¦æŠŠSecretæäº¤åˆ°Git&lt;/li&gt;
&lt;li&gt;ç¯å¢ƒå˜é‡ç”¨äºç®€å•é…ç½®&lt;/li&gt;
&lt;li&gt;æ–‡ä»¶æŒ‚è½½ç”¨äºå¤æ‚é…ç½®&lt;/li&gt;
&lt;li&gt;ç”Ÿäº§ç¯å¢ƒå¯ç”¨etcdåŠ å¯†&lt;/li&gt;
&lt;/ul&gt;
</content:encoded></item><item><title>04.Kubernetes å­¦ä¹ ç¬”è®°ï¼šStatefulSet æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†</title><link>https://dev-null-sec.github.io/posts/04-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-statefulset%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/04-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-statefulset%E6%9C%89%E7%8A%B6%E6%80%81%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86/</guid><description>æ·±å…¥ç†è§£ StatefulSetï¼ŒæŒæ¡æœ‰çŠ¶æ€åº”ç”¨çš„éƒ¨ç½²ã€æŒä¹…åŒ–å­˜å‚¨å’Œæœ‰åºç®¡ç†</description><pubDate>Sat, 10 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;å…­ã€StatefulSet - æœ‰çŠ¶æ€åº”ç”¨ç®¡ç†&lt;/h2&gt;
&lt;h3&gt;1. StatefulSet åŸºç¡€æ¦‚å¿µ&lt;/h3&gt;
&lt;h4&gt;1.1 ä»€ä¹ˆæ˜¯ StatefulSetï¼Ÿ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å›é¡¾ä¸€ä¸ªé—®é¢˜:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ç¬¬äº”ç« ä¸­ï¼Œæˆ‘ä»¬ç”¨ Deployment éƒ¨ç½²äº† Nginxã€PHP åº”ç”¨ï¼Œå®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒç‰¹ç‚¹ï¼š&lt;strong&gt;æ— çŠ¶æ€&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ— çŠ¶æ€åº”ç”¨çš„ç‰¹ç‚¹ï¼š
- Pod ä¹‹é—´å®Œå…¨ç›¸åŒï¼Œå¯ä»¥äº’ç›¸æ›¿æ¢
- Pod åç§°æ˜¯éšæœºçš„ï¼ˆnginx-xxxx-yyyyyï¼‰
- Pod é‡å¯å IP ä¼šå˜åŒ–ï¼Œä½†ä¸å½±å“ä½¿ç”¨
- å¯ä»¥ä»»æ„é¡ºåºå¯åŠ¨ã€åœæ­¢ã€åˆ é™¤
- ä¸éœ€è¦æŒä¹…åŒ–å­˜å‚¨ï¼ˆæˆ–ä½¿ç”¨å…±äº«å­˜å‚¨ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬è¦éƒ¨ç½² MySQL é›†ç¾¤å‘¢ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;MySQL ä¸»ä»é›†ç¾¤çš„è¦æ±‚ï¼š
1. æ¯ä¸ªå®ä¾‹éœ€è¦æœ‰å›ºå®šçš„ç½‘ç»œæ ‡è¯†ï¼ˆä¸»åº“æ˜¯master-0ï¼Œä»åº“æ˜¯slave-1ã€slave-2ï¼‰
2. å¿…é¡»å…ˆå¯åŠ¨ä¸»åº“ï¼Œå†å¯åŠ¨ä»åº“
3. æ¯ä¸ªå®ä¾‹éœ€è¦ç‹¬ç«‹çš„æŒä¹…åŒ–å­˜å‚¨ï¼ˆä¸èƒ½å…±äº«æ•°æ®ç›®å½•ï¼‰
4. ä»åº“éœ€è¦çŸ¥é“ä¸»åº“çš„å›ºå®šåœ°å€æ¥åŒæ­¥æ•°æ®
5. Pod é‡å¯åï¼Œå¿…é¡»ä¿æŒåŸæ¥çš„èº«ä»½å’Œæ•°æ®
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Deployment åšä¸åˆ°è¿™äº›ï¼è¿™æ—¶å€™å°±éœ€è¦ &lt;strong&gt;StatefulSet&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;strong&gt;StatefulSet æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;StatefulSet æ˜¯ Kubernetes ä¸­ä¸“é—¨ç”¨äºç®¡ç†&lt;strong&gt;æœ‰çŠ¶æ€åº”ç”¨&lt;/strong&gt;çš„æ§åˆ¶å™¨ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç”¨ä¸€ä¸ªç”Ÿæ´»åŒ–çš„æ¯”å–»æ¥ç†è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Deployment å°±åƒå·¥å‚æµæ°´çº¿ä¸Šçš„å·¥äººï¼š
- æ¯ä¸ªå·¥äººç©¿ç€ç»Ÿä¸€çš„å·¥ä½œæœ
- è°å¹²æ´»éƒ½ä¸€æ ·ï¼Œå¯ä»¥éšæ„æ›¿æ¢
- ç¼–å·æ˜¯ä¸´æ—¶çš„ï¼ˆå·¥äºº-a1b2c3ï¼‰
- æ¢ç­é¡ºåºæ— æ‰€è°“

StatefulSet å°±åƒå­¦æ ¡é‡Œçš„å­¦ç”Ÿï¼š
- æ¯ä¸ªå­¦ç”Ÿæœ‰å›ºå®šçš„å­¦å·ï¼ˆstudent-0, student-1, student-2ï¼‰
- å­¦å·æ˜¯æŒ‰é¡ºåºåˆ†é…çš„ï¼Œä¸ä¼šé‡å¤
- æ¯ä¸ªå­¦ç”Ÿæœ‰è‡ªå·±çš„è¯¾æ¡Œï¼ˆç‹¬ç«‹å­˜å‚¨ï¼‰
- æ’é˜Ÿå¿…é¡»æŒ‰å­¦å·é¡ºåºæ¥
- è½¬å­¦å›æ¥åï¼Œè¿˜æ˜¯ç”¨åŸæ¥çš„å­¦å·å’Œè¯¾æ¡Œ
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.2 StatefulSet vs Deployment&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŒºåˆ«å¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;Deployment&lt;/th&gt;
&lt;th&gt;StatefulSet&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Pod åç§°&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;éšæœºåç¼€ï¼ˆnginx-7d8-9f2ï¼‰&lt;/td&gt;
&lt;td&gt;æœ‰åºç¼–å·ï¼ˆweb-0, web-1, web-2ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Pod å¯åŠ¨é¡ºåº&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¹¶å‘å¯åŠ¨&lt;/td&gt;
&lt;td&gt;æŒ‰åºå¯åŠ¨ï¼ˆ0â†’1â†’2ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Pod åœæ­¢é¡ºåº&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;éšæœºåœæ­¢&lt;/td&gt;
&lt;td&gt;ååºåœæ­¢ï¼ˆ2â†’1â†’0ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ç½‘ç»œæ ‡è¯†&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¸ç¨³å®šï¼ˆIP å˜åŒ–ï¼‰&lt;/td&gt;
&lt;td&gt;ç¨³å®šï¼ˆå›ºå®š DNS åç§°ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å­˜å‚¨&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å…±äº«å­˜å‚¨æˆ–æ— çŠ¶æ€&lt;/td&gt;
&lt;td&gt;æ¯ä¸ª Pod ç‹¬ç«‹çš„ PVC&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Web åº”ç”¨ã€API æœåŠ¡&lt;/td&gt;
&lt;td&gt;æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€Zookeeper&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Pod æ›¿æ¢&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ–° Pod æ˜¯å…¨æ–°çš„&lt;/td&gt;
&lt;td&gt;æ–° Pod ç»§æ‰¿åŸèº«ä»½å’Œå­˜å‚¨&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;è¯¦ç»†è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. Pod åç§° - å›ºå®šä¸”æœ‰åº&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Deployment çš„ Pod åç§°ï¼ˆéšæœºï¼‰
nginx-deployment-7d8b9f2c-x7k9m
nginx-deployment-7d8b9f2c-p4q2n
nginx-deployment-7d8b9f2c-m8w5t

# StatefulSet çš„ Pod åç§°ï¼ˆå›ºå®šç¼–å·ï¼‰
mysql-0  # ç¬¬ä¸€ä¸ª Podï¼Œç¼–å·ä» 0 å¼€å§‹
mysql-1  # ç¬¬äºŒä¸ª Pod
mysql-2  # ç¬¬ä¸‰ä¸ª Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦å›ºå®šåç§°ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MySQL ä¸»ä»é…ç½®ä¸­ï¼Œä»åº“éœ€è¦è¿æ¥ &lt;code&gt;mysql-0.mysql-service&lt;/code&gt;ï¼ˆä¸»åº“çš„å›ºå®š DNSï¼‰&lt;/li&gt;
&lt;li&gt;Redis é›†ç¾¤ä¸­ï¼ŒèŠ‚ç‚¹éœ€è¦é€šè¿‡å›ºå®šåç§°ç›¸äº’å‘ç°&lt;/li&gt;
&lt;li&gt;Zookeeper éœ€è¦å›ºå®šçš„ server.id æ ‡è¯†&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2. å¯åŠ¨å’Œåœæ­¢é¡ºåº&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;graph TD
    subgraph Deployment[&quot;Deployment å¯åŠ¨(å¹¶å‘)&quot;]
        D1[&quot;Pod0&amp;lt;br/&amp;gt;åŒæ—¶å¯åŠ¨&quot;]
        D2[&quot;Pod1&amp;lt;br/&amp;gt;åŒæ—¶å¯åŠ¨&quot;]
        D3[&quot;Pod2&amp;lt;br/&amp;gt;åŒæ—¶å¯åŠ¨&quot;]
    end
    
    subgraph StatefulSet[&quot;StatefulSet å¯åŠ¨(é¡ºåº)&quot;]
        S1[&quot;Pod0&amp;lt;br/&amp;gt;å…ˆå¯åŠ¨&quot;] --&amp;gt; S2[&quot;Pod1&amp;lt;br/&amp;gt;Pod0 Readyåå¯åŠ¨&quot;]
        S2 --&amp;gt; S3[&quot;Pod2&amp;lt;br/&amp;gt;Pod1 Readyåå¯åŠ¨&quot;]
    end
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;StatefulSet åœæ­¢ï¼ˆååºï¼‰ï¼š&lt;/strong&gt; å…ˆåˆ é™¤ Pod2 â†’ å†åˆ é™¤ Pod1 â†’ æœ€ååˆ é™¤ Pod0&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦é¡ºåºï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MySQL ä¸»ä»ï¼šå¿…é¡»å…ˆå¯åŠ¨ä¸»åº“ï¼ˆPod0ï¼‰ï¼Œä»åº“æ‰èƒ½è¿æ¥å®ƒ&lt;/li&gt;
&lt;li&gt;Etcd é›†ç¾¤ï¼šéœ€è¦å…ˆæœ‰ leader èŠ‚ç‚¹ï¼Œå…¶ä»–èŠ‚ç‚¹æ‰èƒ½åŠ å…¥&lt;/li&gt;
&lt;li&gt;ä¼˜é›…å…³é—­ï¼šå…ˆå…³é—­ä»èŠ‚ç‚¹ï¼Œæœ€åå…³é—­ä¸»èŠ‚ç‚¹ï¼Œé¿å…æ•°æ®ä¸¢å¤±&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;3. ç¨³å®šçš„ç½‘ç»œæ ‡è¯†ï¼ˆå›ºå®š DNSï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;StatefulSet å¿…é¡»é…åˆ &lt;strong&gt;Headless Service&lt;/strong&gt; ä½¿ç”¨ï¼Œæ¯ä¸ª Pod æœ‰å›ºå®šçš„ DNS åç§°ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;DNS æ ¼å¼ï¼š
&amp;lt;pod-name&amp;gt;.&amp;lt;service-name&amp;gt;.&amp;lt;namespace&amp;gt;.svc.cluster.local

ç¤ºä¾‹ï¼š
mysql-0.mysql-service.default.svc.cluster.local
mysql-1.mysql-service.default.svc.cluster.local
mysql-2.mysql-service.default.svc.cluster.local
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å³ä½¿ Pod é‡å¯ï¼ŒDNS åç§°ä¹Ÿä¸å˜ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Pod mysql-1 å´©æºƒå‰çš„ IP
mysql-1: 10.244.1.100

# Pod mysql-1 é‡å¯åçš„ IP
mysql-1: 10.244.2.200  # IP å˜äº†

# ä½† DNS åç§°ä¸å˜ï¼Œå…¶ä»– Pod ä»ç„¶å¯ä»¥é€šè¿‡åç§°è®¿é—®
nslookup mysql-1.mysql-service
# è‡ªåŠ¨è§£æåˆ°æ–° IP: 10.244.2.200
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;4. ç‹¬ç«‹çš„æŒä¹…åŒ–å­˜å‚¨&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Deploymentï¼ˆå…±äº«å­˜å‚¨æˆ–æ— å­˜å‚¨ï¼‰ï¼š
  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”
  â”‚ Pod0â”‚  â”‚ Pod1â”‚  â”‚ Pod2â”‚
  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
      â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
            â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚ Shared PVC â”‚  â† æ‰€æœ‰ Pod å…±äº«ä¸€ä¸ªå­˜å‚¨
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

StatefulSetï¼ˆç‹¬ç«‹å­˜å‚¨ï¼‰ï¼š
  â”Œâ”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”
  â”‚ Pod0â”‚       â”‚ Pod1â”‚       â”‚ Pod2â”‚
  â””â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”˜
      â†“             â†“             â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”
  â”‚ PVC-0â”‚      â”‚ PVC-1â”‚      â”‚ PVC-2â”‚  â† æ¯ä¸ª Pod æœ‰ç‹¬ç«‹çš„ PVC
  â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦ç‹¬ç«‹å­˜å‚¨ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MySQL çš„æ¯ä¸ªå®ä¾‹å¿…é¡»æœ‰è‡ªå·±çš„æ•°æ®ç›®å½•&lt;/li&gt;
&lt;li&gt;Pod é‡å¯åï¼Œæ–° Pod ä¼šè‡ªåŠ¨ç»‘å®šåˆ°åŸæ¥çš„ PVCï¼Œæ•°æ®ä¸ä¸¢å¤±&lt;/li&gt;
&lt;li&gt;æ‰©å®¹æ—¶ï¼Œæ–° Pod ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ PVC&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;1.3 StatefulSet é€‚ç”¨åœºæ™¯&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;âœ… é€‚åˆä½¿ç”¨ StatefulSetï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ•°æ®åº“é›†ç¾¤&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;MySQL ä¸»ä»/MGR é›†ç¾¤&lt;/li&gt;
&lt;li&gt;PostgreSQL é›†ç¾¤&lt;/li&gt;
&lt;li&gt;MongoDB å‰¯æœ¬é›†&lt;/li&gt;
&lt;li&gt;Redis ä¸»ä»/Sentinel/Cluster&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åˆ†å¸ƒå¼å­˜å‚¨&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Ceph&lt;/li&gt;
&lt;li&gt;GlusterFS&lt;/li&gt;
&lt;li&gt;MinIO é›†ç¾¤&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åˆ†å¸ƒå¼åè°ƒæœåŠ¡&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Etcd é›†ç¾¤&lt;/li&gt;
&lt;li&gt;Zookeeper é›†ç¾¤&lt;/li&gt;
&lt;li&gt;Consul é›†ç¾¤&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ¶ˆæ¯é˜Ÿåˆ—&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Kafka é›†ç¾¤&lt;/li&gt;
&lt;li&gt;RabbitMQ é›†ç¾¤&lt;/li&gt;
&lt;li&gt;Pulsar é›†ç¾¤&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æœ‰çŠ¶æ€çš„å¤§æ•°æ®ç»„ä»¶&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Elasticsearch é›†ç¾¤&lt;/li&gt;
&lt;li&gt;Cassandra é›†ç¾¤&lt;/li&gt;
&lt;li&gt;HBase é›†ç¾¤&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;âŒ ä¸é€‚åˆä½¿ç”¨ StatefulSetï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;æ— çŠ¶æ€ Web åº”ç”¨&lt;/strong&gt; - Nginxã€Apacheã€å‰ç«¯é™æ€èµ„æºæœåŠ¡&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ— çŠ¶æ€ API æœåŠ¡&lt;/strong&gt; - RESTful APIã€å¾®æœåŠ¡ï¼ˆä¸éœ€è¦å›ºå®šæ ‡è¯†çš„ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ‰¹å¤„ç†ä»»åŠ¡&lt;/strong&gt; - ä½¿ç”¨ Job/CronJob æ›´åˆé€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;hr /&gt;
&lt;h4&gt;1.4 å¿«é€Ÿå®éªŒï¼šå¯¹æ¯” Deployment å’Œ StatefulSet&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒç›®æ ‡ï¼š&lt;/strong&gt; ç›´è§‚æ„Ÿå—ä¸¤è€…çš„åŒºåˆ«&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šåˆ›å»º Deployment&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd /root/k8s-yaml

cat &amp;gt; nginx-deployment.yaml &amp;lt;&amp;lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deploy
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-deploy
  template:
    metadata:
      labels:
        app: nginx-deploy
    spec:
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
        - containerPort: 80
EOF

kubectl apply -f nginx-deployment.yaml

# æŸ¥çœ‹ Pod åç§°ï¼ˆéšæœºåç¼€ï¼‰
kubectl get pods -l app=nginx-deploy
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME                            READY   STATUS    RESTARTS   AGE
nginx-deploy-7d8b9f2c-x7k9m     1/1     Running   0          10s
nginx-deploy-7d8b9f2c-p4q2n     1/1     Running   0          10s
nginx-deploy-7d8b9f2c-m8w5t     1/1     Running   0          10s
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåˆ›å»º StatefulSet&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å…ˆåˆ›å»º Headless Serviceï¼ˆå¿…é¡»çš„ï¼ï¼‰
cat &amp;gt; nginx-headless.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-sts
spec:
  clusterIP: None  # Headless Service
  selector:
    app: nginx-sts
  ports:
  - port: 80
EOF

kubectl apply -f nginx-headless.yaml

# åˆ›å»º StatefulSet
cat &amp;gt; nginx-statefulset.yaml &amp;lt;&amp;lt;EOF
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: nginx-sts
spec:
  serviceName: nginx-sts  # å…³è” Headless Service
  replicas: 3
  selector:
    matchLabels:
      app: nginx-sts
  template:
    metadata:
      labels:
        app: nginx-sts
    spec:
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
        - containerPort: 80
EOF

kubectl apply -f nginx-statefulset.yaml

# è§‚å¯Ÿ Pod å¯åŠ¨è¿‡ç¨‹ï¼ˆä¼šçœ‹åˆ°æŒ‰é¡ºåºå¯åŠ¨ï¼‰
watch kubectl get pods -l app=nginx-sts
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼ˆæ³¨æ„å¯åŠ¨é¡ºåºï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç¬¬ä¸€é˜¶æ®µï¼šåªæœ‰ Pod-0 å¯åŠ¨
NAME          READY   STATUS    RESTARTS   AGE
nginx-sts-0   1/1     Running   0          5s

# ç¬¬äºŒé˜¶æ®µï¼šPod-0 Ready åï¼ŒPod-1 å¯åŠ¨
NAME          READY   STATUS    RESTARTS   AGE
nginx-sts-0   1/1     Running   0          15s
nginx-sts-1   1/1     Running   0          5s

# ç¬¬ä¸‰é˜¶æ®µï¼šPod-1 Ready åï¼ŒPod-2 å¯åŠ¨
NAME          READY   STATUS    RESTARTS   AGE
nginx-sts-0   1/1     Running   0          25s
nginx-sts-1   1/1     Running   0          15s
nginx-sts-2   1/1     Running   0          5s
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šæµ‹è¯•å›ºå®š DNS&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æµ‹è¯• StatefulSet çš„ Podï¼ˆæœ‰å›ºå®š DNSï¼‰
kubectl exec -it nginx-sts-0 -- nslookup nginx-sts-1.nginx-sts

# é¢„æœŸè¾“å‡ºï¼š
# Server:    10.96.0.10
# Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
# 
# Name:      nginx-sts-1.nginx-sts
# Address 1: 10.244.2.100 nginx-sts-1.nginx-sts.default.svc.cluster.local

# æ¯ä¸ª StatefulSet Pod éƒ½æœ‰å›ºå®š DNS
kubectl exec -it nginx-sts-0 -- nslookup nginx-sts-0.nginx-sts
kubectl exec -it nginx-sts-0 -- nslookup nginx-sts-2.nginx-sts
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4ï¼šæµ‹è¯•åˆ é™¤ Pod åçš„è¡Œä¸º&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤ Deployment çš„ä¸€ä¸ª Pod
DEPLOY_POD=$(kubectl get pods -l app=nginx-deploy -o jsonpath=&apos;{.items[0].metadata.name}&apos;)
kubectl delete pod $DEPLOY_POD
kubectl get pods -l app=nginx-deploy
# è¾“å‡ºï¼šæ–° Pod åç§°å®Œå…¨ä¸åŒ

# åˆ é™¤ StatefulSet çš„ä¸€ä¸ª Pod
kubectl delete pod nginx-sts-1
kubectl get pods -l app=nginx-sts
# è¾“å‡ºï¼šæ–° Pod åç§°å®Œå…¨ç›¸åŒ
# nginx-sts-1  â† åç§°ä¸å˜ï¼
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤5ï¼šæ¸…ç†å®éªŒèµ„æº&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete deployment nginx-deploy
kubectl delete statefulset nginx-sts
kubectl delete svc nginx-sts
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒæ€»ç»“ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;Deployment è¡¨ç°&lt;/th&gt;
&lt;th&gt;StatefulSet è¡¨ç°&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;Pod åç§°&lt;/td&gt;
&lt;td&gt;éšæœºåç¼€&lt;/td&gt;
&lt;td&gt;å›ºå®šç¼–å·ï¼ˆ0ã€1ã€2ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;å¯åŠ¨é¡ºåº&lt;/td&gt;
&lt;td&gt;å¹¶å‘å¯åŠ¨&lt;/td&gt;
&lt;td&gt;é¡ºåºå¯åŠ¨ï¼ˆ0â†’1â†’2ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;å›ºå®š DNS&lt;/td&gt;
&lt;td&gt;âŒ ä¸æ”¯æŒ&lt;/td&gt;
&lt;td&gt;âœ… æ”¯æŒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Pod é‡å»º&lt;/td&gt;
&lt;td&gt;æ–°åç§°&lt;/td&gt;
&lt;td&gt;åç§°ä¸å˜&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h3&gt;2. StatefulSet è®¾è®¡åŸç†&lt;/h3&gt;
&lt;h4&gt;2.1 StatefulSet çš„ç»„æˆéƒ¨åˆ†&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä¸€ä¸ªå®Œæ•´çš„ StatefulSet åº”ç”¨éœ€è¦ä¸‰ä¸ªå¯¹è±¡ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              StatefulSet æ¶æ„                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Headless Serviceï¼ˆå¿…é¡»ï¼‰                     â”‚
â”‚     æä¾›ç¨³å®šçš„ç½‘ç»œæ ‡è¯†                           â”‚
â”‚  2. StatefulSetï¼ˆæ ¸å¿ƒï¼‰                          â”‚
â”‚     ç®¡ç† Pod çš„åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤                   â”‚
â”‚  3. PersistentVolumeClaimï¼ˆå¯é€‰ï¼‰                â”‚
â”‚     ä¸ºæ¯ä¸ª Pod è‡ªåŠ¨åˆ›å»ºç‹¬ç«‹çš„å­˜å‚¨                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;1. Headless Service&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  clusterIP: None      # å…³é”®ï¼è®¾ç½®ä¸º None
  selector:
    app: mysql
  ports:
  - port: 3306
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä½œç”¨ï¼šä¸ºæ¯ä¸ª Pod åˆ›å»ºå›ºå®šçš„ DNS è®°å½•ï¼ˆ&lt;code&gt;&amp;lt;pod-name&amp;gt;.&amp;lt;service-name&amp;gt;&lt;/code&gt;ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. StatefulSet å®šä¹‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: mysql-service  # å…³è” Headless Service
  replicas: 3
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
  volumeClaimTemplates:  # PVC æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰
  - metadata:
      name: data
    spec:
      accessModes: [&quot;ReadWriteOnce&quot;]
      resources:
        requests:
          storage: 10Gi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;3. è‡ªåŠ¨åˆ›å»ºçš„ PVC&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å‘½åè§„åˆ™ï¼š&amp;lt;pvc-name&amp;gt;-&amp;lt;statefulset-name&amp;gt;-&amp;lt;ordinal&amp;gt;
data-mysql-0  # mysql-0 çš„ PVC
data-mysql-1  # mysql-1 çš„ PVC
data-mysql-2  # mysql-2 çš„ PVC
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.2 ç®¡ç†ç­–ç•¥&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;1. Pod ç®¡ç†ç­–ç•¥ï¼ˆpodManagementPolicyï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;spec:
  podManagementPolicy: OrderedReady  # æˆ– Parallel
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;OrderedReady&lt;/strong&gt;ï¼ˆé»˜è®¤ï¼‰ï¼šæŒ‰é¡ºåºå¯åŠ¨ï¼ˆ0â†’1â†’2ï¼‰ï¼Œå‰ä¸€ä¸ª Ready æ‰å¯åŠ¨ä¸‹ä¸€ä¸ª&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Parallel&lt;/strong&gt;ï¼šå¹¶å‘å¯åŠ¨ï¼Œä¸ç­‰å¾…&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2. æ›´æ–°ç­–ç•¥ï¼ˆupdateStrategyï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;spec:
  updateStrategy:
    type: RollingUpdate  # æˆ– OnDelete
    rollingUpdate:
      partition: 0  # é‡‘ä¸é›€å‘å¸ƒ
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;RollingUpdate&lt;/strong&gt;ï¼šè‡ªåŠ¨æ»šåŠ¨æ›´æ–°ï¼Œååºæ›´æ–°ï¼ˆ2â†’1â†’0ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;OnDelete&lt;/strong&gt;ï¼šæ‰‹åŠ¨åˆ é™¤ Pod æ‰æ›´æ–°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;3. Partition é‡‘ä¸é›€å‘å¸ƒ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;partition: 2  # åªæ›´æ–°ç¼–å· &amp;gt;= 2 çš„ Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;å‡è®¾æœ‰ 5 ä¸ª Podï¼ˆ0-4ï¼‰ï¼Œpartition: 2
æ›´æ–°åï¼š
mysql-0 (v1)  mysql-1 (v1)  mysql-2 (v2)  mysql-3 (v2)  mysql-4 (v2)
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.3 å‡çº§å’Œå›æ»š&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å‡çº§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl set image statefulset/mysql mysql=mysql:8.0.35
kubectl rollout status statefulset/mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å›æ»šï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;StatefulSet ä¸æ”¯æŒ &lt;code&gt;kubectl rollout undo&lt;/code&gt;ï¼Œéœ€æ‰‹åŠ¨å›æ»šï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl set image statefulset/mysql mysql=mysql:8.0.30
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆä¸æ”¯æŒè‡ªåŠ¨å›æ»šï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœ‰çŠ¶æ€åº”ç”¨çš„å›æ»šæ¶‰åŠæ•°æ®å…¼å®¹æ€§&lt;/li&gt;
&lt;li&gt;éœ€è¦äººå·¥åˆ¤æ–­å’Œå¹²é¢„&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;2.4 æ‰©ç¼©å®¹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ‰©å®¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl scale statefulset mysql --replicas=5
# é¡ºåºåˆ›å»ºï¼šmysql-3 â†’ mysql-4
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç¼©å®¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl scale statefulset mysql --replicas=3
# ååºåˆ é™¤ï¼šmysql-4 â†’ mysql-3
# PVC ä¸ä¼šè¢«åˆ é™¤ï¼ˆæ•°æ®ä¿ç•™ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¸…ç† PVCï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete statefulset mysql
kubectl get pvc  # PVC ä»ç„¶å­˜åœ¨
kubectl delete pvc -l app=mysql  # æ‰‹åŠ¨åˆ é™¤
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;3. å®æˆ˜ï¼šç”¨ StatefulSet æ­å»º MySQL ä¸»ä»é›†ç¾¤&lt;/h3&gt;
&lt;h4&gt;3.1 å®éªŒæ¶æ„&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MySQL ä¸»ä»å¤åˆ¶é›†ç¾¤                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  mysql-0 (ä¸»åº“ Master)  â† å†™å…¥æ•°æ®               â”‚
â”‚    â†“                                             â”‚
â”‚  mysql-1 (ä»åº“ Slave)   â† åŒæ­¥æ•°æ®               â”‚
â”‚  mysql-2 (ä»åº“ Slave)   â† åŒæ­¥æ•°æ®               â”‚
â”‚                                                  â”‚
â”‚  è¯»å†™åˆ†ç¦»ï¼š                                       â”‚
â”‚  - å†™æ“ä½œ â†’ mysql-0                              â”‚
â”‚  - è¯»æ“ä½œ â†’ mysql-1, mysql-2ï¼ˆè´Ÿè½½å‡è¡¡ï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒç›®æ ‡ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;éƒ¨ç½² 1 ä¸» 2 ä»çš„ MySQL é›†ç¾¤&lt;/li&gt;
&lt;li&gt;é…ç½®ä¸»ä»å¤åˆ¶&lt;/li&gt;
&lt;li&gt;éªŒè¯æ•°æ®åŒæ­¥&lt;/li&gt;
&lt;li&gt;æµ‹è¯• Pod æ•…éšœæ¢å¤&lt;/li&gt;
&lt;/ol&gt;
&lt;hr /&gt;
&lt;h4&gt;3.2 æ­¥éª¤1ï¼šåˆ›å»º ConfigMap&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;cd /root/k8s-yaml

cat &amp;gt; mysql-configmap.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config
data:
  master.cnf: |
    [mysqld]
    log-bin=mysql-bin   # å¼€å¯ binlog
    server-id=1         # ä¸»åº“ ID
    
  slave.cnf: |
    [mysqld]
    server-id=2         # ä»åº“ IDï¼ˆä¼šè¢«åŠ¨æ€ä¿®æ”¹ï¼‰
    read_only=1         # åªè¯»æ¨¡å¼
EOF

kubectl apply -f mysql-configmap.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.3 æ­¥éª¤2ï¼šåˆ›å»º Service&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; mysql-service.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  clusterIP: None       # Headless Service
  selector:
    app: mysql
  ports:
  - name: mysql
    port: 3306
---
apiVersion: v1
kind: Service
metadata:
  name: mysql-read     # è¯»è¯·æ±‚è´Ÿè½½å‡è¡¡
spec:
  selector:
    app: mysql
  ports:
  - name: mysql
    port: 3306
EOF

kubectl apply -f mysql-service.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸¤ä¸ª Service çš„ä½œç”¨ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;mysql&lt;/code&gt;: Headlessï¼Œæä¾›å›ºå®š DNS&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mysql-read&lt;/code&gt;: æ™®é€š Serviceï¼Œè¯»è¯·æ±‚è´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;3.4 æ­¥éª¤3ï¼šåˆ›å»º StatefulSet&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; mysql-statefulset.yaml &amp;lt;&amp;lt;&apos;EOF&apos;
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: mysql
  replicas: 3
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      initContainers:
      - name: init-mysql
        image: reg.westos.org/library/mysql:8.0
        command:
        - bash
        - &quot;-c&quot;
        - |
          set -ex
          # æå– Pod ç¼–å·
          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1
          ordinal=${BASH_REMATCH[1]}
          echo &quot;Pod ordinal: $ordinal&quot;
          
          # mysql-0 ç”¨ä¸»åº“é…ç½®ï¼Œå…¶ä»–ç”¨ä»åº“é…ç½®
          if [[ $ordinal -eq 0 ]]; then
            cp /mnt/config-map/master.cnf /mnt/conf.d/
          else
            cp /mnt/config-map/slave.cnf /mnt/conf.d/
            # åŠ¨æ€è®¾ç½® server-id
            sed -i &quot;s/server-id=2/server-id=$((100 + $ordinal))/&quot; /mnt/conf.d/slave.cnf
          fi
          cat /mnt/conf.d/*.cnf
        volumeMounts:
        - name: conf
          mountPath: /mnt/conf.d
        - name: config-map
          mountPath: /mnt/config-map
          
      containers:
      - name: mysql
        image: reg.westos.org/library/mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: &quot;Westos123&quot;
        - name: MYSQL_DATABASE
          value: &quot;testdb&quot;
        ports:
        - name: mysql
          containerPort: 3306
        volumeMounts:
        - name: data
          mountPath: /var/lib/mysql
          subPath: mysql
        - name: conf
          mountPath: /etc/mysql/conf.d
        livenessProbe:
          exec:
            command: [&quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-uroot&quot;, &quot;-p${MYSQL_ROOT_PASSWORD}&quot;]
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          exec:
            command: [&quot;mysql&quot;, &quot;-uroot&quot;, &quot;-p${MYSQL_ROOT_PASSWORD}&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;]
          initialDelaySeconds: 10
          periodSeconds: 5
          
      volumes:
      - name: conf
        emptyDir: {}
      - name: config-map
        configMap:
          name: mysql-config
      - name: data
        emptyDir: {}  # ç®€åŒ–ç‰ˆï¼šä½¿ç”¨ emptyDir
EOF

kubectl apply -f mysql-statefulset.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®ç‚¹è¯´æ˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. initContainers çš„ä½œç”¨ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ ¹æ® Pod ç¼–å·ç”Ÿæˆä¸åŒé…ç½®&lt;/li&gt;
&lt;li&gt;mysql-0 ä½¿ç”¨ä¸»åº“é…ç½®&lt;/li&gt;
&lt;li&gt;mysql-1/2 ä½¿ç”¨ä»åº“é…ç½®&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;2. Pod ç¼–å·æå–ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[[ $(hostname) =~ -([0-9]+)$ ]] || exit 1
ordinal=${BASH_REMATCH[1]}
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;3. åŠ¨æ€ server-idï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;mysql-0: server-id = 1&lt;/li&gt;
&lt;li&gt;mysql-1: server-id = 101&lt;/li&gt;
&lt;li&gt;mysql-2: server-id = 102&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;3.5 æ­¥éª¤4ï¼šè§‚å¯Ÿå¯åŠ¨è¿‡ç¨‹&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# è§‚å¯Ÿ Pod å¯åŠ¨é¡ºåº
watch kubectl get pods -l app=mysql

# æŸ¥çœ‹ init å®¹å™¨æ—¥å¿—
kubectl logs mysql-0 -c init-mysql
kubectl logs mysql-1 -c init-mysql

# æŸ¥çœ‹ MySQL æ—¥å¿—
kubectl logs mysql-0 -c mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼ˆæŒ‰é¡ºåºå¯åŠ¨ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME      READY   STATUS    RESTARTS   AGE
mysql-0   1/1     Running   0          30s    â† å…ˆå¯åŠ¨

NAME      READY   STATUS    RESTARTS   AGE
mysql-0   1/1     Running   0          60s
mysql-1   1/1     Running   0          25s    â† mysql-0 Ready åå¯åŠ¨

NAME      READY   STATUS    RESTARTS   AGE
mysql-0   1/1     Running   0          90s
mysql-1   1/1     Running   0          55s
mysql-2   1/1     Running   0          20s    â† mysql-1 Ready åå¯åŠ¨
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.6 æ­¥éª¤5ï¼šé…ç½®ä¸»ä»å¤åˆ¶&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœ¨ä¸»åº“åˆ›å»ºå¤åˆ¶ç”¨æˆ·ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl exec -it mysql-0 -c mysql -- mysql -uroot -pWestos123 &amp;lt;&amp;lt;EOF
CREATE USER &apos;repl&apos;@&apos;%&apos; IDENTIFIED BY &apos;Repl123!@#&apos;;
GRANT REPLICATION SLAVE ON *.* TO &apos;repl&apos;@&apos;%&apos;;
FLUSH PRIVILEGES;
SHOW MASTER STATUS;
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è®°å½•è¾“å‡ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;+------------------+----------+
| File             | Position |
+------------------+----------+
| mysql-bin.000003 |      157 |
+------------------+----------+
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ä»åº“ï¼ˆmysql-1 å’Œ mysql-2ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# é…ç½® mysql-1
kubectl exec -it mysql-1 -c mysql -- mysql -uroot -pWestos123 &amp;lt;&amp;lt;EOF
STOP SLAVE;
CHANGE MASTER TO
  MASTER_HOST=&apos;mysql-0.mysql&apos;,
  MASTER_USER=&apos;repl&apos;,
  MASTER_PASSWORD=&apos;Repl123!@#&apos;,
  MASTER_LOG_FILE=&apos;mysql-bin.000003&apos;,
  MASTER_LOG_POS=157;
START SLAVE;
SHOW SLAVE STATUS\G
EOF

# é…ç½® mysql-2
kubectl exec -it mysql-2 -c mysql -- mysql -uroot -pWestos123 &amp;lt;&amp;lt;EOF
STOP SLAVE;
CHANGE MASTER TO
  MASTER_HOST=&apos;mysql-0.mysql&apos;,
  MASTER_USER=&apos;repl&apos;,
  MASTER_PASSWORD=&apos;Repl123!@#&apos;,
  MASTER_LOG_FILE=&apos;mysql-bin.000003&apos;,
  MASTER_LOG_POS=157;
START SLAVE;
SHOW SLAVE STATUS\G
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ£€æŸ¥ä»åº“çŠ¶æ€ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl exec -it mysql-1 -c mysql -- mysql -uroot -pWestos123 -e &quot;SHOW SLAVE STATUS\G&quot; | grep -E &quot;Slave_IO_Running|Slave_SQL_Running&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Slave_IO_Running: Yes   â† å¿…é¡»æ˜¯ Yes
Slave_SQL_Running: Yes  â† å¿…é¡»æ˜¯ Yes
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.7 æ­¥éª¤6ï¼šæµ‹è¯•ä¸»ä»åŒæ­¥&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœ¨ä¸»åº“å†™å…¥æ•°æ®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl exec -it mysql-0 -c mysql -- mysql -uroot -pWestos123 &amp;lt;&amp;lt;EOF
USE testdb;
CREATE TABLE users (
  id INT PRIMARY KEY AUTO_INCREMENT,
  name VARCHAR(50),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
INSERT INTO users (name) VALUES (&apos;Alice&apos;), (&apos;Bob&apos;), (&apos;Charlie&apos;);
SELECT * FROM users;
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœ¨ä»åº“æŸ¥è¯¢æ•°æ®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä»åº“1
kubectl exec -it mysql-1 -c mysql -- mysql -uroot -pWestos123 -e &quot;SELECT * FROM testdb.users;&quot;

# ä»åº“2
kubectl exec -it mysql-2 -c mysql -- mysql -uroot -pWestos123 -e &quot;SELECT * FROM testdb.users;&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼ˆæ•°æ®å·²åŒæ­¥ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;+----+---------+---------------------+
| id | name    | created_at          |
+----+---------+---------------------+
|  1 | Alice   | 2024-01-15 10:30:00 |
|  2 | Bob     | 2024-01-15 10:30:00 |
|  3 | Charlie | 2024-01-15 10:30:00 |
+----+---------+---------------------+
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç»§ç»­æ’å…¥ï¼Œè§‚å¯Ÿå®æ—¶åŒæ­¥ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸»åº“æ’å…¥
kubectl exec -it mysql-0 -c mysql -- mysql -uroot -pWestos123 -e \
  &quot;INSERT INTO testdb.users (name) VALUES (&apos;David&apos;), (&apos;Eve&apos;);&quot;

# ä»åº“æŸ¥è¯¢
kubectl exec -it mysql-1 -c mysql -- mysql -uroot -pWestos123 -e \
  &quot;SELECT * FROM testdb.users;&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.8 æ­¥éª¤7ï¼šæµ‹è¯•è¯»å†™åˆ†ç¦»&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºæµ‹è¯• Podï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl run mysql-client --image=reg.westos.org/library/mysql:8.0 --rm -it --restart=Never -- bash
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœ¨æµ‹è¯• Pod ä¸­ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å†™æ“ä½œ â†’ ä¸»åº“
mysql -h mysql-0.mysql -uroot -pWestos123 -e \
  &quot;INSERT INTO testdb.users (name) VALUES (&apos;Frank&apos;);&quot;

# è¯»æ“ä½œ â†’ è´Ÿè½½å‡è¡¡
mysql -h mysql-read -uroot -pWestos123 -e &quot;SELECT * FROM testdb.users;&quot;

# å¤šæ¬¡æŸ¥è¯¢è§‚å¯Ÿè´Ÿè½½å‡è¡¡
for i in {1..5}; do
  mysql -h mysql-read -uroot -pWestos123 -e \
    &quot;SELECT @@hostname AS pod_name, COUNT(*) AS count FROM testdb.users;&quot;
done
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.9 æ­¥éª¤8ï¼šæµ‹è¯• Pod æ•…éšœæ¢å¤&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ é™¤ä»åº“ Podï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete pod mysql-2
watch kubectl get pods -l app=mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;éªŒè¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pod åç§°ä¸å˜ï¼ˆmysql-2ï¼‰&lt;/li&gt;
&lt;li&gt;DNS åç§°ä¸å˜ï¼ˆmysql-2.mysqlï¼‰&lt;/li&gt;
&lt;li&gt;ç”±äºä½¿ç”¨ emptyDirï¼Œæ•°æ®ä¸¢å¤±ï¼ˆéœ€é‡æ–°é…ç½®ä¸»ä»ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ PVCï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Pod é‡å»ºè‡ªåŠ¨æŒ‚è½½åŸ PVC&lt;/li&gt;
&lt;li&gt;æ•°æ®ä¸ä¸¢å¤±ï¼ŒMySQL è‡ªåŠ¨æ¢å¤&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;3.10 æ­¥éª¤9ï¼šæ‰©ç¼©å®¹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ‰©å®¹åˆ° 4 ä¸ªå‰¯æœ¬ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl scale statefulset mysql --replicas=4
watch kubectl get pods -l app=mysql

# é…ç½®æ–°ä»åº“ mysql-3
kubectl exec -it mysql-3 -c mysql -- mysql -uroot -pWestos123 &amp;lt;&amp;lt;EOF
CHANGE MASTER TO
  MASTER_HOST=&apos;mysql-0.mysql&apos;,
  MASTER_USER=&apos;repl&apos;,
  MASTER_PASSWORD=&apos;Repl123!@#&apos;,
  MASTER_LOG_FILE=&apos;mysql-bin.000003&apos;,
  MASTER_LOG_POS=157;
START SLAVE;
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç¼©å®¹å› 3 ä¸ªï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl scale statefulset mysql --replicas=3
# mysql-3 è¢«åˆ é™¤
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.11 æ¸…ç†èµ„æº&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;kubectl delete statefulset mysql
kubectl delete svc mysql mysql-read
kubectl delete configmap mysql-config
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;4. æ€»ç»“&lt;/h3&gt;
&lt;h4&gt;4.1 æ ¸å¿ƒè¦ç‚¹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;StatefulSet ä¸‰å¤§ç‰¹æ€§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;å›ºå®šæ ‡è¯†&lt;/strong&gt;ï¼šPodåç§°å’ŒDNSä¸å˜ï¼ˆmysql-0, mysql-1, mysql-2ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æœ‰åºç®¡ç†&lt;/strong&gt;ï¼šæŒ‰åºå¯åŠ¨/åœæ­¢/æ›´æ–°ï¼ˆ0â†’1â†’2 æˆ– 2â†’1â†’0ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç‹¬ç«‹å­˜å‚¨&lt;/strong&gt;ï¼šæ¯ä¸ªPodè‡ªåŠ¨åˆ›å»ºç‹¬ç«‹PVCï¼ŒPodé‡å»ºåæ•°æ®ä¿ç•™&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;vs Deploymentï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Deploymentï¼šæ— çŠ¶æ€ï¼ŒPodå¯æ›¿æ¢ï¼Œå¹¶å‘ç®¡ç†&lt;/li&gt;
&lt;li&gt;StatefulSetï¼šæœ‰çŠ¶æ€ï¼ŒPodä¸å¯æ›¿æ¢ï¼Œæœ‰åºç®¡ç†&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;4.2 é€‚ç”¨åœºæ™¯&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;âœ… ä½¿ç”¨ StatefulSetï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ•°æ®åº“é›†ç¾¤ï¼ˆMySQLã€PostgreSQLã€MongoDBï¼‰&lt;/li&gt;
&lt;li&gt;æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaã€RabbitMQï¼‰&lt;/li&gt;
&lt;li&gt;åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆCephã€MinIOï¼‰&lt;/li&gt;
&lt;li&gt;åè°ƒæœåŠ¡ï¼ˆEtcdã€Zookeeperï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;âŒ ä¸è¦ä½¿ç”¨ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Webåº”ç”¨ã€APIæœåŠ¡ â†’ ç”¨Deployment&lt;/li&gt;
&lt;li&gt;æ‰¹å¤„ç†ä»»åŠ¡ â†’ ç”¨Job/CronJob&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;4.3 é‡è¦é™åˆ¶&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;StatefulSet åªæä¾›åŸºç¡€èƒ½åŠ›ï¼Œä¸æä¾›ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âŒ è‡ªåŠ¨æ•…éšœåˆ‡æ¢ï¼ˆä¸»åº“æŒ‚äº†ä¸ä¼šè‡ªåŠ¨æå‡ä»åº“ï¼‰&lt;/li&gt;
&lt;li&gt;âŒ è‡ªåŠ¨å¤‡ä»½å’Œæ¢å¤&lt;/li&gt;
&lt;li&gt;âŒ è‡ªåŠ¨ç›‘æ§å‘Šè­¦&lt;/li&gt;
&lt;li&gt;âŒ ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼ˆå¦‚ä¸»ä»å¤åˆ¶é…ç½®ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;è§£å†³æ–¹æ¡ˆï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®€å•åœºæ™¯ï¼šæ‰‹åŠ¨é…ç½® + StatefulSet&lt;/li&gt;
&lt;li&gt;ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨ &lt;strong&gt;Operator&lt;/strong&gt;ï¼ˆPerconaã€Vitessã€Strimziç­‰ï¼‰&lt;/li&gt;
&lt;li&gt;å…³é”®ä¸šåŠ¡ï¼šè€ƒè™‘æ‰˜ç®¡æœåŠ¡ï¼ˆRDSã€äº‘æ•°æ®åº“ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;4.4 å¸¸ç”¨å‘½ä»¤&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# åŸºæœ¬æ“ä½œ
kubectl get statefulset
kubectl describe sts &amp;lt;name&amp;gt;
kubectl get pods -l app=mysql

# æ‰©ç¼©å®¹
kubectl scale sts mysql --replicas=5

# æ›´æ–°
kubectl set image sts/mysql mysql=mysql:8.0.35
kubectl rollout status sts/mysql

# å›æ»šï¼ˆæ‰‹åŠ¨ï¼‰
kubectl set image sts/mysql mysql=mysql:8.0.30

# åˆ é™¤ï¼ˆä¿ç•™PVCï¼‰
kubectl delete sts mysql
kubectl get pvc
kubectl delete pvc -l app=mysql  # æ‰‹åŠ¨æ¸…ç†PVC
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;4.5 ç”Ÿäº§æœ€ä½³å®è·µ&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# 1. å¿…é¡»ä½¿ç”¨æŒä¹…åŒ–å­˜å‚¨
volumeClaimTemplates:
- metadata:
    name: data
  spec:
    storageClassName: fast-ssd
    accessModes: [&quot;ReadWriteOnce&quot;]
    resources:
      requests:
        storage: 100Gi

# 2. é…ç½®å¥åº·æ£€æŸ¥
livenessProbe:
  exec:
    command: [&quot;mysqladmin&quot;, &quot;ping&quot;]
readinessProbe:
  exec:
    command: [&quot;mysql&quot;, &quot;-e&quot;, &quot;SELECT 1&quot;]

# 3. è®¾ç½®èµ„æºé™åˆ¶
resources:
  requests:
    memory: &quot;2Gi&quot;
    cpu: &quot;1000m&quot;
  limits:
    memory: &quot;4Gi&quot;
    cpu: &quot;2000m&quot;

# 4. Podåäº²å’Œï¼ˆåˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ï¼‰
affinity:
  podAntiAffinity:
    requiredDuringSchedulingIgnoredDuringExecution:
    - labelSelector:
        matchLabels:
          app: mysql
      topologyKey: kubernetes.io/hostname
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;p&gt;ç¬¬ä¸ƒç« ï¼šdaemonsetå’Œjob&lt;/p&gt;
&lt;p&gt;1.ä»‹ç»daemonsetï¼Œä»–çš„ä½œç”¨å’Œé€‚ç”¨åœºæ™¯ï¼Œä»–çš„å®ç°é€»è¾‘ï¼Œéœ€è¦é…ç½®ä»€ä¹ˆï¼Œä»–çš„æ›´æ–°å’Œå›æ»šç­–ç•¥
2.ä»‹ç»jobå’Œcronjobï¼Œä»‹ç»ä½œç”¨å’Œé€‚ç”¨åœºæ™¯ï¼Œä»‹ç»é…ç½®é¡¹
3.å®æˆ˜
æ­å»ºä¸€ä¸ªdaemonsetå®ä¾‹ï¼Œå¦‚Fluentd
åˆ›å»ºä¸€ä¸ªjobæ‰§è¡Œä¸€æ¬¡æ€§ä»»åŠ¡
å­¦ä¼šç”¨cronjobè¿›è¡Œå®šæœŸå¤‡ä»½etcd
æå‰å¤‡ä»½ç³»ç»Ÿå¿«ç…§ï¼Œæ•…æ„å¼„åetcdï¼Œå­¦ä¼šç”¨å¤‡ä»½æ¢å¤etcd&lt;/p&gt;
&lt;hr /&gt;
</content:encoded></item><item><title>03.Kubernetes å­¦ä¹ ç¬”è®°ï¼šDeployment ä¸ ReplicaSet åº”ç”¨ç®¡ç†</title><link>https://dev-null-sec.github.io/posts/03-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-deployment%E4%B8%8Ereplicaset%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/03-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-deployment%E4%B8%8Ereplicaset%E5%BA%94%E7%94%A8%E7%AE%A1%E7%90%86/</guid><description>æ·±å…¥ç†è§£ Deployment å’Œ ReplicaSetï¼ŒæŒæ¡åº”ç”¨çš„å£°æ˜å¼ç®¡ç†ã€æ»šåŠ¨æ›´æ–°å’Œè‡ªåŠ¨æ¢å¤</description><pubDate>Sat, 10 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;äº”ã€åº”ç”¨çš„ç®¡ç†è€… - Deployment ä¸ ReplicaSet&lt;/h2&gt;
&lt;h3&gt;1. ä¸ºä»€ä¹ˆéœ€è¦Deploymentï¼Ÿä»ç—›ç‚¹è¯´èµ·&lt;/h3&gt;
&lt;h4&gt;1.1 æ‰‹åŠ¨ç®¡ç†Podçš„å™©æ¢¦&lt;/h4&gt;
&lt;p&gt;è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰åˆ›å»ºPodçš„æ–¹å¼å—ï¼Ÿæ¯æ¬¡éƒ½è¦æ‰‹åŠ¨å†™YAMLï¼Œä¸€ä¸ªä¸ªåˆ›å»ºPodã€‚æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯1ï¼šåº”ç”¨å‡çº§çš„å›°å¢ƒ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç°åœ¨çš„åšæ³•ï¼ˆç—›è‹¦ç‰ˆï¼‰
1. åˆ›å»ºæ–°ç‰ˆæœ¬Podï¼škubectl apply -f app-v2-pod.yaml
2. ç­‰å¾…æ–°Podå°±ç»ª
3. æ‰‹åŠ¨åˆ é™¤æ—§Podï¼škubectl delete pod app-v1-pod
4. å¦‚æœå‡ºé—®é¢˜ï¼Ÿå†æ‰‹åŠ¨åˆ›å»ºv1ç‰ˆæœ¬ï¼Ÿ
5. æœ‰10ä¸ªPodï¼Ÿé‡å¤10éï¼ğŸ˜±
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯2ï¼šPodæŒ‚äº†æ€ä¹ˆåŠï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸä¸ªPodçªç„¶å´©æºƒäº†
kubectl get pods
# app-pod-1   1/1   Running   0   5m
# app-pod-2   0/1   Error     0   2m    â† æŒ‚äº†ï¼
# app-pod-3   1/1   Running   0   5m

# ä½ éœ€è¦ï¼š
1. å‘ç°å®ƒæŒ‚äº†ï¼ˆç›¯ç€ç›‘æ§ï¼Ÿï¼‰
2. æ‰‹åŠ¨é‡å»ºï¼škubectl apply -f app-pod-2.yaml
3. 24å°æ—¶å€¼ç­ï¼ŸğŸ˜­
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯3ï¼šæ‰©å®¹éœ€æ±‚æ¥äº†&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# è€æ¿ï¼šæµé‡æš´å¢ï¼Œèµ¶ç´§ä»3ä¸ªPodæ‰©åˆ°10ä¸ªï¼
# ä½ ï¼šå¥½çš„ï¼ï¼ˆå¼€å§‹å¤åˆ¶ç²˜è´´YAML...ï¼‰

cat &amp;gt; app-pod-4.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: app-pod-4  # æ‰‹åŠ¨æ”¹å
  labels:
    app: myapp
spec:
  containers:
  - name: app
    image: myapp:v1
EOF

# é‡å¤7æ¬¡...æ‰‹æŒ‡æŠ½ç­‹ ğŸ˜µ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦Deploymentï¼&lt;/strong&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;h4&gt;1.2 Deploymentï¼šåº”ç”¨ç®¡ç†çš„&quot;è‡ªåŠ¨é©¾é©¶&quot;&lt;/h4&gt;
&lt;p&gt;æŠŠDeploymentæƒ³è±¡æˆä¸€ä¸ª&lt;strong&gt;æ™ºèƒ½ç®¡å®¶&lt;/strong&gt;ï¼Œä½ åªéœ€è¦å‘Šè¯‰å®ƒï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æˆ‘è¦è¿è¡Œä»€ä¹ˆåº”ç”¨&lt;/li&gt;
&lt;li&gt;æˆ‘è¦å‡ ä¸ªå‰¯æœ¬&lt;/li&gt;
&lt;li&gt;ç”¨ä»€ä¹ˆé•œåƒç‰ˆæœ¬&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‰©ä¸‹çš„äº‹æƒ…ï¼Œå®ƒå…¨åŒ…äº†ï¼&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Deploymentèƒ½åšä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. è‡ªåŠ¨åˆ›å»ºå’Œç®¡ç†Pod
   â””â”€ ä½ è¯´è¦3ä¸ªå‰¯æœ¬ï¼Œå®ƒå°±åˆ›å»º3ä¸ªPod
   
2. è‡ªåŠ¨æ•…éšœæ¢å¤
   â””â”€ PodæŒ‚äº†ï¼Ÿè‡ªåŠ¨é‡å»ºï¼
   â””â”€ èŠ‚ç‚¹æŒ‚äº†ï¼Ÿè‡ªåŠ¨åœ¨å…¶ä»–èŠ‚ç‚¹é‡å»ºï¼
   
3. æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºå‡çº§ï¼‰
   â””â”€ æ—§ç‰ˆæœ¬é€æ­¥æ›¿æ¢ä¸ºæ–°ç‰ˆæœ¬
   â””â”€ ç”¨æˆ·æ— æ„ŸçŸ¥ï¼ŒæœåŠ¡ä¸ä¸­æ–­
   
4. ä¸€é”®å›æ»š
   â””â”€ æ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Ÿä¸€æ¡å‘½ä»¤å›é€€åˆ°æ—§ç‰ˆæœ¬
   
5. å¼¹æ€§ä¼¸ç¼©
   â””â”€ ä¸€æ¡å‘½ä»¤ä»3ä¸ªå‰¯æœ¬æ‰©åˆ°10ä¸ª
   â””â”€ æˆ–è€…ç¼©å‡åˆ°1ä¸ª
   
6. ç‰ˆæœ¬å†å²ç®¡ç†
   â””â”€ è®°å½•æ¯æ¬¡æ›´æ–°ï¼Œæƒ³å›åˆ°å“ªä¸ªç‰ˆæœ¬éƒ½è¡Œ
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.3 æ¶æ„è§£æï¼šDeploymentã€ReplicaSetã€Podä¸‰å…„å¼Ÿ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®ƒä»¬çš„å…³ç³»åƒè¿™æ ·ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;graph TD
    D[&quot;Deployment&amp;lt;br/&amp;gt;ç‰ˆæœ¬ç®¡ç†ã€æ›´æ–°ç­–ç•¥ã€å›æ»š&amp;lt;br/&amp;gt;replicas: 3&amp;lt;br/&amp;gt;strategy: RollingUpdate&amp;lt;br/&amp;gt;image: myapp:v2&quot;]
    R[&quot;ReplicaSet&amp;lt;br/&amp;gt;ç»´æŒPodæ•°é‡&amp;lt;br/&amp;gt;æœŸæœ›: 3 | å½“å‰: 3 | å°±ç»ª: 3&quot;]
    P1[&quot;Pod-1&amp;lt;br/&amp;gt;Running&quot;]
    P2[&quot;Pod-2&amp;lt;br/&amp;gt;Running&quot;]
    P3[&quot;Pod-3&amp;lt;br/&amp;gt;Running&quot;]
    
    D --&amp;gt;|ç®¡ç†| R
    R --&amp;gt; P1
    R --&amp;gt; P2
    R --&amp;gt; P3
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åˆ†å·¥æ˜ç¡®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;è§’è‰²&lt;/th&gt;
&lt;th&gt;èŒè´£&lt;/th&gt;
&lt;th&gt;æ¯”å–»&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Deployment&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç‰ˆæœ¬ç®¡ç†ã€æ›´æ–°ç­–ç•¥ã€å›æ»š&lt;/td&gt;
&lt;td&gt;é¡¹ç›®ç»ç†&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ReplicaSet&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç»´æŒPodæ•°é‡ã€è‡ªåŠ¨æ¢å¤&lt;/td&gt;
&lt;td&gt;è´¨æ£€å‘˜&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Pod&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è¿è¡Œå®¹å™¨&lt;/td&gt;
&lt;td&gt;å·¥äºº&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
&lt;h4&gt;1.4 å·¥ä½œæµç¨‹ï¼šä»åˆ›å»ºåˆ°è¿è¡Œ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºDeploymentçš„å®Œæ•´è¿‡ç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;flowchart TD
    A[&quot;æ­¥éª¤1: åˆ›å»ºDeployment&amp;lt;br/&amp;gt;kubectl apply -f deployment.yaml&quot;] --&amp;gt; B
    B[&quot;Deployment Controllerç›‘å¬&amp;lt;br/&amp;gt;éœ€è¦åˆ›å»ºReplicaSet&quot;] --&amp;gt; C
    C[&quot;æ­¥éª¤2: åˆ›å»ºReplicaSet&amp;lt;br/&amp;gt;nginx-deployment-7d64c8b9f5&amp;lt;br/&amp;gt;æœŸæœ›å‰¯æœ¬æ•°: 3&quot;] --&amp;gt; D
    D[&quot;ReplicaSet Controllerç›‘å¬&amp;lt;br/&amp;gt;éœ€è¦åˆ›å»º3ä¸ªPod&quot;] --&amp;gt; E
    E[&quot;æ­¥éª¤3: åˆ›å»ºPods&amp;lt;br/&amp;gt;- nginx-deployment-xxx-abc12&amp;lt;br/&amp;gt;- nginx-deployment-xxx-def34&amp;lt;br/&amp;gt;- nginx-deployment-xxx-ghi56&quot;] --&amp;gt; F
    F[&quot;æ­¥éª¤4: Podè°ƒåº¦&amp;lt;br/&amp;gt;Scheduleråˆ†é…åˆ°ä¸åŒèŠ‚ç‚¹&amp;lt;br/&amp;gt;kubeletæ‹‰å–é•œåƒå¹¶å¯åŠ¨&quot;] --&amp;gt; G
    G[&quot;æ­¥éª¤5: æŒç»­ç›‘æ§&amp;lt;br/&amp;gt;ReplicaSetç›‘æ§PodçŠ¶æ€&amp;lt;br/&amp;gt;è‡ªåŠ¨æ¢å¤æ•…éšœPod&quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è‡ªåŠ¨æ¢å¤æ¼”ç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;flowchart LR
    subgraph æ­£å¸¸çŠ¶æ€
        P1[&quot;Pod-1&amp;lt;br/&amp;gt;Running&quot;]
        P2[&quot;Pod-2&amp;lt;br/&amp;gt;Running&quot;]
        P3[&quot;Pod-3&amp;lt;br/&amp;gt;Running&quot;]
    end
    
    subgraph æ•…éšœå‘ç”Ÿ
        P1b[&quot;Pod-1&amp;lt;br/&amp;gt;Running&quot;]
        P2b[&quot;Pod-2&amp;lt;br/&amp;gt;ğŸ’¥ Crashed&quot;]
        P3b[&quot;Pod-3&amp;lt;br/&amp;gt;Running&quot;]
    end
    
    subgraph è‡ªåŠ¨æ¢å¤
        P1c[&quot;Pod-1&amp;lt;br/&amp;gt;Running&quot;]
        P4[&quot;Pod-4&amp;lt;br/&amp;gt;Running&amp;lt;br/&amp;gt;(æ–°å»º)&quot;]
        P3c[&quot;Pod-3&amp;lt;br/&amp;gt;Running&quot;]
    end
    
    æ­£å¸¸çŠ¶æ€ --&amp;gt;|&quot;Pod-2å´©æºƒ&quot;| æ•…éšœå‘ç”Ÿ
    æ•…éšœå‘ç”Ÿ --&amp;gt;|&quot;ReplicaSetè‡ªåŠ¨é‡å»º&amp;lt;br/&amp;gt;(10ç§’å†…)&quot;| è‡ªåŠ¨æ¢å¤
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.5 Deployment vs æ‰‹åŠ¨åˆ›å»ºPodå¯¹æ¯”&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;æ‰‹åŠ¨åˆ›å»ºPod&lt;/th&gt;
&lt;th&gt;ä½¿ç”¨Deployment&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;åˆ›å»ºå¤æ‚åº¦&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ¯ä¸ªPodä¸€ä¸ªYAML&lt;/td&gt;
&lt;td&gt;ä¸€ä¸ªYAMLç®¡ç†æ‰€æœ‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å‰¯æœ¬ç®¡ç†&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ‰‹åŠ¨å¤åˆ¶ç²˜è´´Næ¬¡&lt;/td&gt;
&lt;td&gt;replicas: Nï¼Œä¸€è¡Œæå®š&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ•…éšœæ¢å¤&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;éœ€è¦äººå·¥ä»‹å…¥&lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨é‡å»ºï¼ˆç§’çº§ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ»šåŠ¨æ›´æ–°&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ‰‹åŠ¨åˆ æ—§å»ºæ–°&lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨æ»šåŠ¨ï¼ˆé›¶åœæœºï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å›æ»š&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ‰‹åŠ¨é‡å»ºæ—§ç‰ˆæœ¬&lt;/td&gt;
&lt;td&gt;ä¸€æ¡å‘½ä»¤&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ‰©ç¼©å®¹&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ‰‹åŠ¨å¢åˆ Pod&lt;/td&gt;
&lt;td&gt;ä¸€æ¡å‘½ä»¤&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ç‰ˆæœ¬å†å²&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨è®°å½•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å­¦ä¹ ã€ä¸´æ—¶æµ‹è¯•&lt;/td&gt;
&lt;td&gt;&lt;strong&gt;ç”Ÿäº§ç¯å¢ƒå¿…å¤‡&lt;/strong&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒä»·å€¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ‰‹åŠ¨ç®¡ç†Pod = å¼€æ‰‹åŠ¨æŒ¡æ±½è½¦
  âœ— ç´¯
  âœ— å®¹æ˜“å‡ºé”™
  âœ— æ•ˆç‡ä½
  âœ— æ— æ³•åº”å¯¹å¤æ‚åœºæ™¯

ä½¿ç”¨Deployment = å¼€è‡ªåŠ¨æŒ¡æ±½è½¦
  âœ“ çœå¿ƒ
  âœ“ å¯é 
  âœ“ é«˜æ•ˆ
  âœ“ ç”Ÿäº§çº§åˆ«
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;å°ç»“ï¼šDeploymentçš„æ ¸å¿ƒä»·å€¼&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦Deploymentï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;è‡ªåŠ¨åŒ–&lt;/strong&gt; - ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºå’Œç®¡ç†æ¯ä¸ªPod&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é«˜å¯ç”¨&lt;/strong&gt; - PodæŒ‚äº†è‡ªåŠ¨é‡å»ºï¼Œä¿è¯æœåŠ¡æ°¸ä¸ä¸­æ–­&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é›¶åœæœºæ›´æ–°&lt;/strong&gt; - æ»šåŠ¨æ›´æ–°ï¼Œç”¨æˆ·æ— æ„ŸçŸ¥&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¿«é€Ÿå›æ»š&lt;/strong&gt; - æ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Ÿä¸€é”®å›é€€&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¼¹æ€§ä¼¸ç¼©&lt;/strong&gt; - æ ¹æ®è´Ÿè½½åŠ¨æ€è°ƒæ•´å‰¯æœ¬æ•°&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å£°æ˜å¼ç®¡ç†&lt;/strong&gt; - æè¿°æœŸæœ›çŠ¶æ€ï¼ŒK8sè‡ªåŠ¨å®ç°&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ä¸€å¥è¯æ€»ç»“ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Deploymentè®©ä½ èƒ½å¤Ÿåƒç®¡ç†1ä¸ªPodä¸€æ ·ç®¡ç†1000ä¸ªPodï¼Œè¿™å°±æ˜¯å®ƒçš„é­”åŠ›ï¼&lt;/p&gt;
&lt;/blockquote&gt;
&lt;hr /&gt;
&lt;h3&gt;2. Deploymenté…ç½®è¯¦è§£ï¼šYAMLèµ„æºæ¸…å•å‰–æ&lt;/h3&gt;
&lt;h4&gt;2.1 æœ€ç®€å•çš„Deploymentç¤ºä¾‹&lt;/h4&gt;
&lt;p&gt;å…ˆçœ‹ä¸€ä¸ªæœ€åŸºç¡€çš„ä¾‹å­ï¼Œç†è§£æ ¸å¿ƒé…ç½®ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1          # APIç‰ˆæœ¬
kind: Deployment             # èµ„æºç±»å‹
metadata:
  name: nginx-deployment     # Deploymentåç§°
  labels:
    app: nginx              # Deploymentè‡ªèº«çš„æ ‡ç­¾
spec:
  replicas: 3               # æœŸæœ›çš„Podå‰¯æœ¬æ•°
  selector:                  # Podé€‰æ‹©å™¨ï¼ˆé‡è¦ï¼ï¼‰
    matchLabels:
      app: nginx            # åŒ¹é…å“ªäº›Pod
  template:                  # Podæ¨¡æ¿ï¼ˆä¸‹é¢æ˜¯Podçš„å®šä¹‰ï¼‰
    metadata:
      labels:
        app: nginx          # Podçš„æ ‡ç­¾ï¼ˆå¿…é¡»ä¸selectoråŒ¹é…ï¼‰
    spec:
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
        - containerPort: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®å­—æ®µè§£æï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;ä½œç”¨&lt;/th&gt;
&lt;th&gt;ç±»æ¯”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;replicas&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;æœŸæœ›çš„Podå‰¯æœ¬æ•°&lt;/td&gt;
&lt;td&gt;&quot;æˆ‘è¦3ä¸ªå·¥äºº&quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;selector&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;é€‰æ‹©ç®¡ç†å“ªäº›Pod&lt;/td&gt;
&lt;td&gt;&quot;æ ‡è®°ä¸ºapp=nginxçš„Podéƒ½æ˜¯æˆ‘çš„&quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;code&gt;template&lt;/code&gt;&lt;/td&gt;
&lt;td&gt;Podæ¨¡æ¿&lt;/td&gt;
&lt;td&gt;&quot;æŒ‰è¿™ä¸ªæ¨¡æ¿åˆ›å»ºPod&quot;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹åˆ«æ³¨æ„ï¼šselectorå’Œtemplate.labelså¿…é¡»åŒ¹é…ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;selector:
  matchLabels:
    app: nginx    â† å¿…é¡»åŒ¹é…
    
template:
  metadata:
    labels:
      app: nginx  â† å¿…é¡»åŒ¹é…
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¦‚æœä¸åŒ¹é…ä¼šæŠ¥é”™ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Error: selector does not match template labels
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.2 å®Œæ•´é…ç½®ç¤ºä¾‹ï¼šç”Ÿäº§çº§åˆ«&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: Deployment
metadata:
  name: web-app
  namespace: default
  labels:
    app: web
    version: v1
    environment: production
  annotations:
    description: &quot;Webåº”ç”¨å‰ç«¯æœåŠ¡&quot;
spec:
  # === å‰¯æœ¬ç®¡ç† ===
  replicas: 5
  
  # === é€‰æ‹©å™¨ ===
  selector:
    matchLabels:
      app: web
      
  # === æ›´æ–°ç­–ç•¥ ===
  strategy:
    type: RollingUpdate        # æ»šåŠ¨æ›´æ–°
    rollingUpdate:
      maxSurge: 1              # æ›´æ–°æ—¶æœ€å¤šå¤šå‡ ä¸ªPodï¼ˆå¯ä»¥æ˜¯æ•°å­—æˆ–ç™¾åˆ†æ¯”ï¼‰
      maxUnavailable: 0        # æ›´æ–°æ—¶æœ€å¤šä¸å¯ç”¨å‡ ä¸ªPod
      
  # === ç‰ˆæœ¬å†å²ä¿ç•™ ===
  revisionHistoryLimit: 10     # ä¿ç•™10ä¸ªå†å²ç‰ˆæœ¬
  
  # === Podæ¨¡æ¿ ===
  template:
    metadata:
      labels:
        app: web
        version: v1
    spec:
      # === å®¹å™¨é…ç½® ===
      containers:
      - name: web
        image: reg.westos.org/library/nginx-php:v2
        ports:
        - containerPort: 80
          name: http
          protocol: TCP
          
        # === èµ„æºé™åˆ¶ ===
        resources:
          requests:              # æœ€ä½éœ€æ±‚
            cpu: &quot;100m&quot;          # 0.1æ ¸
            memory: &quot;128Mi&quot;
          limits:                # ä¸Šé™
            cpu: &quot;500m&quot;          # 0.5æ ¸
            memory: &quot;512Mi&quot;
            
        # === å¥åº·æ£€æŸ¥ ===
        livenessProbe:           # å­˜æ´»æ¢é’ˆ
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5
          
        readinessProbe:          # å°±ç»ªæ¢é’ˆ
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 3
          
        # === ç¯å¢ƒå˜é‡ ===
        env:
        - name: APP_VERSION
          value: &quot;v2.0&quot;
        - name: DB_HOST
          value: &quot;mysql-service&quot;
          
      # === é‡å¯ç­–ç•¥ ===
      restartPolicy: Always
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®è¯¦è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç¬¬1å±‚ï¼šDeploymentåŸºæœ¬ä¿¡æ¯
â”œâ”€ metadata: åç§°ã€å‘½åç©ºé—´ã€æ ‡ç­¾
â””â”€ spec: Deploymentè§„æ ¼

ç¬¬2å±‚ï¼šå‰¯æœ¬å’Œæ›´æ–°ç­–ç•¥
â”œâ”€ replicas: å‰¯æœ¬æ•°
â”œâ”€ selector: Podé€‰æ‹©å™¨
â”œâ”€ strategy: æ›´æ–°ç­–ç•¥
â””â”€ revisionHistoryLimit: å†å²ç‰ˆæœ¬æ•°

ç¬¬3å±‚ï¼šPodæ¨¡æ¿
â””â”€ template
    â”œâ”€ metadata: Podæ ‡ç­¾
    â””â”€ spec: Podè§„æ ¼
        â”œâ”€ containers: å®¹å™¨åˆ—è¡¨
        â”œâ”€ resources: èµ„æºé…ç½®
        â”œâ”€ livenessProbe: å­˜æ´»æ¢é’ˆ
        â”œâ”€ readinessProbe: å°±ç»ªæ¢é’ˆ
        â””â”€ env: ç¯å¢ƒå˜é‡
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.3 æ›´æ–°ç­–ç•¥è¯¦è§£ï¼šRollingUpdate vs Recreate&lt;/h4&gt;
&lt;p&gt;Kubernetesæ”¯æŒä¸¤ç§æ›´æ–°ç­–ç•¥ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. RollingUpdateï¼ˆæ»šåŠ¨æ›´æ–°ï¼‰- é»˜è®¤æ¨è&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1              # æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæœ€å¤šæ¯”replicaså¤šå‡ ä¸ªPod
    maxUnavailable: 0        # æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œæœ€å¤šæœ‰å‡ ä¸ªPodä¸å¯ç”¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å‚æ•°è¯¦è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;maxSurgeï¼ˆå†²åˆºæ•°é‡ï¼‰
  â””â”€ æ§åˆ¶æ›´æ–°æ—¶èƒ½åˆ›å»ºå¤šå°‘é¢å¤–çš„Pod
  â””â”€ å€¼è¶Šå¤§ï¼Œæ›´æ–°è¶Šå¿«ï¼Œä½†èµ„æºæ¶ˆè€—è¶Šå¤š
  
  ç¤ºä¾‹ï¼šreplicas=3, maxSurge=1
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  æ›´æ–°è¿‡ç¨‹ä¸­æœ€å¤š4ä¸ªPodåŒæ—¶å­˜åœ¨   â”‚
  â”‚  3ä¸ªæ—§ç‰ˆæœ¬ + 1ä¸ªæ–°ç‰ˆæœ¬ = 4ä¸ª   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

maxUnavailableï¼ˆæœ€å¤§ä¸å¯ç”¨æ•°ï¼‰
  â””â”€ æ§åˆ¶æ›´æ–°æ—¶å…è®¸å¤šå°‘Podä¸å¯ç”¨
  â””â”€ å€¼è¶Šå°ï¼ŒæœåŠ¡ç¨³å®šæ€§è¶Šé«˜
  
  ç¤ºä¾‹ï¼šreplicas=3, maxUnavailable=1
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚  æ›´æ–°è¿‡ç¨‹ä¸­è‡³å°‘2ä¸ªPodå¯ç”¨       â”‚
  â”‚  3 - 1 = 2ä¸ªPodå¿…é¡»å¥åº·        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ»šåŠ¨æ›´æ–°æµç¨‹æ¼”ç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åˆå§‹çŠ¶æ€ï¼ˆ3ä¸ªPodï¼Œv1ç‰ˆæœ¬ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v1-1 â”‚ â”‚ v1-2 â”‚ â”‚ v1-3 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

é…ç½®ï¼šreplicas=3, maxSurge=1, maxUnavailable=0

æ­¥éª¤1ï¼šåˆ›å»º1ä¸ªæ–°Podï¼ˆv2ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v1-1 â”‚ â”‚ v1-2 â”‚ â”‚ v1-3 â”‚ â”‚ v2-1 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ å¯åŠ¨ä¸­â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
æ€»æ•°:4ï¼ˆ3æ—§+1æ–°ï¼‰maxSurgeå…è®¸

æ­¥éª¤2ï¼šv2-1å°±ç»ªåï¼Œåˆ é™¤1ä¸ªæ—§Pod
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v1-1 â”‚ â”‚ v1-2 â”‚ â”‚ âœ—    â”‚ â”‚ v2-1 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ åˆ é™¤  â”‚ â”‚ Readyâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
å¯ç”¨:3ï¼ˆ2æ—§+1æ–°ï¼‰maxUnavailable=0ä¿è¯

æ­¥éª¤3ï¼šåˆ›å»ºç¬¬2ä¸ªæ–°Pod
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v1-1 â”‚ â”‚ v1-2 â”‚ â”‚ v2-1 â”‚ â”‚ v2-2 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ å¯åŠ¨ä¸­â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤4ï¼šv2-2å°±ç»ªåï¼Œåˆ é™¤1ä¸ªæ—§Pod
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v1-1 â”‚ â”‚ âœ—    â”‚ â”‚ v2-1 â”‚ â”‚ v2-2 â”‚
â”‚ Readyâ”‚ â”‚ åˆ é™¤  â”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤5ï¼šåˆ›å»ºç¬¬3ä¸ªæ–°Pod
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v1-1 â”‚ â”‚ v2-1 â”‚ â”‚ v2-2 â”‚ â”‚ v2-3 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ å¯åŠ¨ä¸­â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤6ï¼šv2-3å°±ç»ªåï¼Œåˆ é™¤æœ€åçš„æ—§Pod
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v2-1 â”‚ â”‚ v2-2 â”‚ â”‚ v2-3 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
æ›´æ–°å®Œæˆï¼å…¨éƒ¨v2ç‰ˆæœ¬
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ… é›¶åœæœºï¼ˆå§‹ç»ˆæœ‰Podå¯ç”¨ï¼‰&lt;/li&gt;
&lt;li&gt;âœ… æ¸è¿›å¼ï¼ˆé€ä¸ªæ›¿æ¢ï¼‰&lt;/li&gt;
&lt;li&gt;âœ… å¯æ§åˆ¶ï¼ˆé€šè¿‡å‚æ•°è°ƒèŠ‚é€Ÿåº¦ï¼‰&lt;/li&gt;
&lt;li&gt;âœ… å¯å›æ»šï¼ˆå‘ç°é—®é¢˜ç«‹å³åœæ­¢ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;p&gt;&lt;strong&gt;2. Recreateï¼ˆé‡å»ºç­–ç•¥ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;strategy:
  type: Recreate
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµç¨‹ï¼šå…ˆåˆ æ‰€æœ‰æ—§Podï¼Œå†åˆ›å»ºæ‰€æœ‰æ–°Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åˆå§‹çŠ¶æ€ï¼ˆ3ä¸ªPodï¼Œv1ç‰ˆæœ¬ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v1-1 â”‚ â”‚ v1-2 â”‚ â”‚ v1-3 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

æ­¥éª¤1ï¼šåˆ é™¤æ‰€æœ‰æ—§Pod
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚  âœ—   â”‚ â”‚  âœ—   â”‚ â”‚  âœ—   â”‚
â”‚ åˆ é™¤  â”‚ â”‚ åˆ é™¤  â”‚ â”‚ åˆ é™¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
âš ï¸  æœåŠ¡å®Œå…¨ä¸å¯ç”¨ï¼

æ­¥éª¤2ï¼šåˆ›å»ºæ‰€æœ‰æ–°Pod
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v2-1 â”‚ â”‚ v2-2 â”‚ â”‚ v2-3 â”‚
â”‚ å¯åŠ¨ä¸­â”‚ â”‚ å¯åŠ¨ä¸­â”‚ â”‚ å¯åŠ¨ä¸­â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

å®Œæˆï¼šæ‰€æœ‰Podå°±ç»ª
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v2-1 â”‚ â”‚ v2-2 â”‚ â”‚ v2-3 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ— æœ‰åœæœºæ—¶é—´&lt;/li&gt;
&lt;li&gt;âœ“ ç®€å•ç²—æš´&lt;/li&gt;
&lt;li&gt;âœ“ ä¸ä¼šå‡ºç°æ–°æ—§ç‰ˆæœ¬å…±å­˜&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;é€‚åˆRecreateï¼š
  âœ“ ä¸èƒ½å®¹å¿æ–°æ—§ç‰ˆæœ¬å…±å­˜ï¼ˆå¦‚æ•°æ®åº“schemaå˜æ›´ï¼‰
  âœ“ æµ‹è¯•ç¯å¢ƒ
  âœ“ å•å‰¯æœ¬åº”ç”¨

æ¨èRollingUpdateï¼š
  âœ“ Webåº”ç”¨
  âœ“ å¾®æœåŠ¡
  âœ“ ç”Ÿäº§ç¯å¢ƒ
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.4 æ»šåŠ¨æ›´æ–°å‚æ•°æœ€ä½³å®è·µ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯1ï¼šå¿«é€Ÿæ›´æ–°ï¼Œå¯ä»¥æ¥å—çŸ­æš‚ä¸å¯ç”¨&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;strategy:
  rollingUpdate:
    maxSurge: 50%           # å…è®¸å¤š50%çš„Pod
    maxUnavailable: 50%     # å…è®¸50%ä¸å¯ç”¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯2ï¼šç¨³å®šä¼˜å…ˆï¼Œé›¶åœæœºæ›´æ–°ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;strategy:
  rollingUpdate:
    maxSurge: 25%           # é€æ­¥å¢åŠ 25%
    maxUnavailable: 0       # ä¸å…è®¸ä¸å¯ç”¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯3ï¼šèµ„æºå—é™ï¼Œä¸èƒ½å¤šPod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;strategy:
  rollingUpdate:
    maxSurge: 0             # ä¸å…è®¸è¶…è¿‡replicas
    maxUnavailable: 1       # æ¯æ¬¡åªæ›¿æ¢1ä¸ª
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å‚æ•°å¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åœºæ™¯&lt;/th&gt;
&lt;th&gt;maxSurge&lt;/th&gt;
&lt;th&gt;maxUnavailable&lt;/th&gt;
&lt;th&gt;æ›´æ–°é€Ÿåº¦&lt;/th&gt;
&lt;th&gt;èµ„æºæ¶ˆè€—&lt;/th&gt;
&lt;th&gt;å¯ç”¨æ€§&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;å¿«é€Ÿæ›´æ–°&lt;/td&gt;
&lt;td&gt;50%&lt;/td&gt;
&lt;td&gt;50%&lt;/td&gt;
&lt;td&gt;âš¡âš¡âš¡&lt;/td&gt;
&lt;td&gt;ğŸ”¥ğŸ”¥&lt;/td&gt;
&lt;td&gt;â­â­&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;ç”Ÿäº§æ¨è&lt;/td&gt;
&lt;td&gt;25%&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;âš¡âš¡&lt;/td&gt;
&lt;td&gt;ğŸ”¥ğŸ”¥&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;èµ„æºå—é™&lt;/td&gt;
&lt;td&gt;0&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;âš¡&lt;/td&gt;
&lt;td&gt;ğŸ”¥&lt;/td&gt;
&lt;td&gt;â­â­â­&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
&lt;h3&gt;3. Deploymentæ“ä½œå®æˆ˜ï¼šå‡çº§ã€å›æ»šã€æ‰©ç¼©å®¹&lt;/h3&gt;
&lt;h4&gt;3.1 åº”ç”¨å‡çº§ï¼šä»v1åˆ°v2&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å‡çº§æ–¹å¼æœ‰ä¸‰ç§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ–¹æ³•1ï¼šä¿®æ”¹YAMLæ–‡ä»¶å¹¶é‡æ–°applyï¼ˆæ¨èï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¿®æ”¹deployment.yamlä¸­çš„é•œåƒç‰ˆæœ¬
vi nginx-deployment.yaml
# å°† image: nginx:1.20 æ”¹ä¸º image: nginx:1.21

# åº”ç”¨æ›´æ”¹
kubectl apply -f nginx-deployment.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ–¹æ³•2ï¼šä½¿ç”¨kubectl set imageå‘½ä»¤&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# è¯­æ³•ï¼škubectl set image deployment/&amp;lt;åç§°&amp;gt; &amp;lt;å®¹å™¨å&amp;gt;=&amp;lt;æ–°é•œåƒ&amp;gt;
kubectl set image deployment/nginx-deployment nginx=nginx:1.21

# å¦‚æœæœ‰å¤šä¸ªå®¹å™¨
kubectl set image deployment/nginx-deployment \
  nginx=nginx:1.21 \
  sidecar=busybox:1.30.1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ–¹æ³•3ï¼šä½¿ç”¨kubectl editç›´æ¥ç¼–è¾‘&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl edit deployment nginx-deployment
# åœ¨ç¼–è¾‘å™¨ä¸­ä¿®æ”¹imageå­—æ®µ
# ä¿å­˜é€€å‡ºåè‡ªåŠ¨åº”ç”¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¨èæ–¹å¼å¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ–¹å¼&lt;/th&gt;
&lt;th&gt;ä¼˜ç‚¹&lt;/th&gt;
&lt;th&gt;ç¼ºç‚¹&lt;/th&gt;
&lt;th&gt;é€‚ç”¨åœºæ™¯&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;apply -f&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æœ‰ç‰ˆæœ¬è®°å½•ã€å¯å®¡è®¡&lt;/td&gt;
&lt;td&gt;éœ€è¦æ”¹æ–‡ä»¶&lt;/td&gt;
&lt;td&gt;ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;set image&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å¿«é€Ÿã€å‘½ä»¤è¡Œæ“ä½œ&lt;/td&gt;
&lt;td&gt;æ— æ–‡ä»¶è®°å½•&lt;/td&gt;
&lt;td&gt;ä¸´æ—¶æµ‹è¯•&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;edit&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ‰€è§å³æ‰€å¾—&lt;/td&gt;
&lt;td&gt;å®¹æ˜“è¯¯æ“ä½œ&lt;/td&gt;
&lt;td&gt;ç´§æ€¥ä¿®å¤&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
&lt;h4&gt;3.2 ç›‘æ§æ›´æ–°è¿›åº¦&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®æ—¶æŸ¥çœ‹æ»šåŠ¨æ›´æ–°è¿‡ç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹DeploymentçŠ¶æ€
kubectl get deployment nginx-deployment

# å®æ—¶ç›‘æ§ï¼ˆwatchæ¨¡å¼ï¼‰
kubectl get deployment nginx-deployment -w

# æŸ¥çœ‹è¯¦ç»†æ›´æ–°è¿‡ç¨‹
kubectl rollout status deployment/nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è¾“å‡ºç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ kubectl rollout status deployment/nginx-deployment
Waiting for deployment &quot;nginx-deployment&quot; rollout to finish: 1 out of 3 new replicas have been updated...
Waiting for deployment &quot;nginx-deployment&quot; rollout to finish: 1 out of 3 new replicas have been updated...
Waiting for deployment &quot;nginx-deployment&quot; rollout to finish: 2 out of 3 new replicas have been updated...
Waiting for deployment &quot;nginx-deployment&quot; rollout to finish: 2 out of 3 new replicas have been updated...
Waiting for deployment &quot;nginx-deployment&quot; rollout to finish: 2 out of 3 new replicas have been updated...
Waiting for deployment &quot;nginx-deployment&quot; rollout to finish: 1 old replicas are pending termination...
Waiting for deployment &quot;nginx-deployment&quot; rollout to finish: 1 old replicas are pending termination...
deployment &quot;nginx-deployment&quot; successfully rolled out
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹ReplicaSetå˜åŒ–ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get replicaset
# NAME                          DESIRED   CURRENT   READY   AGE
# nginx-deployment-7d64c8b9f5   3         3         3       5m   â† æ—§ç‰ˆæœ¬ï¼ˆä¿ç•™ï¼‰
# nginx-deployment-86b7dbdd8b   3         3         3       1m   â† æ–°ç‰ˆæœ¬ï¼ˆæ´»è·ƒï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹Podå˜åŒ–ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get pods -l app=nginx --watch
# å¯ä»¥çœ‹åˆ°æ—§Podé€ä¸ªåˆ é™¤ï¼Œæ–°Podé€ä¸ªåˆ›å»º
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.3 æŸ¥çœ‹æ›´æ–°å†å²&lt;/h4&gt;
&lt;p&gt;Kubernetesä¼šè‡ªåŠ¨è®°å½•æ¯æ¬¡Deploymentçš„æ›´æ–°å†å²ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹å†å²ç‰ˆæœ¬
kubectl rollout history deployment/nginx-deployment

# è¾“å‡ºç¤ºä¾‹ï¼š
# REVISION  CHANGE-CAUSE
# 1         &amp;lt;none&amp;gt;
# 2         &amp;lt;none&amp;gt;
# 3         kubectl set image deployment/nginx-deployment nginx=nginx:1.21
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å¦‚ä½•è®©å†å²è®°å½•æ›´æœ‰æ„ä¹‰ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹æ³•1ï¼šåœ¨applyæ—¶æ·»åŠ --recordå‚æ•°ï¼ˆå·²åºŸå¼ƒï¼Œä½†ä»å¯ç”¨ï¼‰
kubectl apply -f nginx-deployment.yaml --record

# æ–¹æ³•2ï¼šä½¿ç”¨kubernetes.io/change-causeæ³¨è§£ï¼ˆæ¨èï¼‰
kubectl annotate deployment/nginx-deployment \
  kubernetes.io/change-cause=&quot;å‡çº§åˆ°nginx 1.21ç‰ˆæœ¬&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹ç‰¹å®šç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹ç‰ˆæœ¬2çš„è¯¦ç»†é…ç½®
kubectl rollout history deployment/nginx-deployment --revision=2
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.4 å›æ»šæ“ä½œï¼šçŠ¯é”™ä¸å¯æ€•&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼šæ–°ç‰ˆæœ¬æœ‰bugï¼Œéœ€è¦ç´§æ€¥å›é€€&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl rollout undo deployment/nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;2. å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å…ˆæŸ¥çœ‹å†å²
kubectl rollout history deployment/nginx-deployment

# å›æ»šåˆ°ç‰ˆæœ¬2
kubectl rollout undo deployment/nginx-deployment --to-revision=2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å›æ»šè¿‡ç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å½“å‰çŠ¶æ€ï¼ˆv3æœ‰bugï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v3-1 â”‚ â”‚ v3-2 â”‚ â”‚ v3-3 â”‚
â”‚ Errorâ”‚ â”‚ Errorâ”‚ â”‚ Errorâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

æ‰§è¡Œå›æ»šï¼škubectl rollout undo deployment/nginx-deployment

å¼€å§‹å›æ»šåˆ°v2:
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v3-1 â”‚ â”‚ v3-2 â”‚ â”‚ v3-3 â”‚ â”‚ v2-1 â”‚
â”‚ Errorâ”‚ â”‚ Errorâ”‚ â”‚ Errorâ”‚ â”‚ å¯åŠ¨ä¸­â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

é€æ­¥æ›¿æ¢ï¼ˆå°±åƒæ»šåŠ¨æ›´æ–°ä¸€æ ·ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ v2-1 â”‚ â”‚ v2-2 â”‚ â”‚ v2-3 â”‚
â”‚ Readyâ”‚ â”‚ Readyâ”‚ â”‚ Readyâ”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
å›æ»šå®Œæˆï¼æœåŠ¡æ¢å¤æ­£å¸¸
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å›æ»šä¹Ÿéµå¾ªæ»šåŠ¨æ›´æ–°ç­–ç•¥ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ… é›¶åœæœº&lt;/li&gt;
&lt;li&gt;âœ… æ¸è¿›å¼&lt;/li&gt;
&lt;li&gt;âœ… å¯ä»¥éšæ—¶æš‚åœ&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h4&gt;3.5 æš‚åœå’Œæ¢å¤æ›´æ–°&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼šå‘ç°é—®é¢˜ï¼Œç«‹å³æš‚åœæ›´æ–°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æš‚åœæ›´æ–°
kubectl rollout pause deployment/nginx-deployment

# æ­¤æ—¶æ›´æ–°ä¼šåœæ­¢ï¼Œéƒ¨åˆ†Podæ˜¯æ–°ç‰ˆæœ¬ï¼Œéƒ¨åˆ†æ˜¯æ—§ç‰ˆæœ¬
# å¯ä»¥éªŒè¯æ–°ç‰ˆæœ¬æ˜¯å¦æ­£å¸¸

# ç¡®è®¤æ— é—®é¢˜åï¼Œæ¢å¤æ›´æ–°
kubectl rollout resume deployment/nginx-deployment

# å¦‚æœæœ‰é—®é¢˜ï¼Œç›´æ¥å›æ»š
kubectl rollout undo deployment/nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é‡‘ä¸é›€å‘å¸ƒç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# 1. å‡†å¤‡æ›´æ–°
kubectl set image deployment/nginx-deployment nginx=nginx:1.21

# 2. ç«‹å³æš‚åœï¼ˆåªæ›´æ–°å°‘é‡Podï¼‰
kubectl rollout pause deployment/nginx-deployment

# 3. éªŒè¯æ–°ç‰ˆæœ¬ï¼ˆå¯èƒ½åªæœ‰1-2ä¸ªPodæ˜¯æ–°ç‰ˆæœ¬ï¼‰
curl http://new-pod-ip  # æµ‹è¯•æ–°ç‰ˆæœ¬

# 4. å¦‚æœæ­£å¸¸ï¼Œæ¢å¤æ›´æ–°
kubectl rollout resume deployment/nginx-deployment

# 5. å¦‚æœå¼‚å¸¸ï¼Œå›æ»š
kubectl rollout undo deployment/nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.6 æ‰‹åŠ¨æ‰©ç¼©å®¹ï¼šåº”å¯¹æµé‡å˜åŒ–&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ‰©å®¹ï¼šå¢åŠ å‰¯æœ¬æ•°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹æ³•1ï¼šä½¿ç”¨kubectl scale
kubectl scale deployment/nginx-deployment --replicas=10

# æ–¹æ³•2ï¼šä¿®æ”¹YAMLå¹¶apply
# å°†replicas: 3 æ”¹ä¸º replicas: 10
kubectl apply -f nginx-deployment.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ‰©å®¹è¿‡ç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å½“å‰çŠ¶æ€ï¼ˆ3ä¸ªPodï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Pod-1â”‚ â”‚ Pod-2â”‚ â”‚ Pod-3â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

æ‰©å®¹åˆ°10ä¸ª:
kubectl scale deployment/nginx-deployment --replicas=10

K8sç«‹å³åˆ›å»º7ä¸ªæ–°Pod:
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Pod-1â”‚ â”‚ Pod-2â”‚ â”‚ Pod-3â”‚ â”‚ Pod-4â”‚ â”‚ Pod-5â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”
â”‚ Pod-6â”‚ â”‚ Pod-7â”‚ â”‚ Pod-8â”‚ â”‚ Pod-9â”‚ â”‚Pod-10â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜

é€šå¸¸10-30ç§’å†…å®Œæˆ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç¼©å®¹ï¼šå‡å°‘å‰¯æœ¬æ•°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç¼©å‡åˆ°1ä¸ªå‰¯æœ¬
kubectl scale deployment/nginx-deployment --replicas=1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç¼©å®¹è¿‡ç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å½“å‰çŠ¶æ€ï¼ˆ10ä¸ªPodï¼‰:
10ä¸ªPodå…¨éƒ¨è¿è¡Œä¸­

ç¼©å®¹åˆ°1ä¸ª:
kubectl scale deployment/nginx-deployment --replicas=1

K8sé€‰æ‹©9ä¸ªPodåˆ é™¤ï¼ˆé€šå¸¸æ˜¯æœ€æ–°åˆ›å»ºçš„ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â” 
â”‚ Pod-1â”‚  â† ä¿ç•™1ä¸ª
â””â”€â”€â”€â”€â”€â”€â”˜ 
å…¶ä»–9ä¸ªPodè¢«ç»ˆæ­¢

5-10ç§’å†…å®Œæˆ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹æ‰©ç¼©å®¹æ•ˆæœï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å®æ—¶ç›‘æ§
kubectl get pods -l app=nginx -w

# æŸ¥çœ‹DeploymentçŠ¶æ€
kubectl get deployment nginx-deployment
# NAME                READY   UP-TO-DATE   AVAILABLE   AGE
# nginx-deployment    10/10   10           10          5m
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.7 è‡ªåŠ¨æ‰©ç¼©å®¹ï¼šHPAï¼ˆHorizontal Pod Autoscalerï¼‰&lt;/h4&gt;
&lt;p&gt;HPAå¯ä»¥æ ¹æ®CPUã€å†…å­˜ç­‰æŒ‡æ ‡&lt;strong&gt;è‡ªåŠ¨è°ƒæ•´Podæ•°é‡&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å‰æï¼šå¿…é¡»å…ˆéƒ¨ç½²Metrics Server&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šéƒ¨ç½²Metrics Server&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸‹è½½éƒ¨ç½²æ–‡ä»¶
wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

# ä¿®æ”¹é…ç½®ï¼ˆé‡è¦ï¼ï¼‰
vi components.yaml

# åœ¨Deploymentçš„å®¹å™¨argsä¸­æ·»åŠ ï¼š
# - --kubelet-insecure-tls
# - --kubelet-preferred-address-types=InternalIP

# åº”ç”¨éƒ¨ç½²
kubectl apply -f components.yaml

# éªŒè¯æ˜¯å¦æ­£å¸¸
kubectl get pods -n kube-system | grep metrics-server
kubectl top nodes   # æŸ¥çœ‹èŠ‚ç‚¹èµ„æºä½¿ç”¨æƒ…å†µ
kubectl top pods    # æŸ¥çœ‹Podèµ„æºä½¿ç”¨æƒ…å†µ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šä¸ºDeploymenté…ç½®èµ„æºè¯·æ±‚&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# HPAéœ€è¦çŸ¥é“Podçš„èµ„æºéœ€æ±‚æ‰èƒ½è®¡ç®—
spec:
  template:
    spec:
      containers:
      - name: nginx
        image: nginx:1.20
        resources:
          requests:
            cpu: 100m       # å¿…é¡»é…ç½®ï¼
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šåˆ›å»ºHPA&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹æ³•1ï¼šå‘½ä»¤è¡Œåˆ›å»º
kubectl autoscale deployment nginx-deployment \
  --min=2 \
  --max=10 \
  --cpu-percent=50

# æ–¹æ³•2ï¼šä½¿ç”¨YAMLï¼ˆæ›´çµæ´»ï¼‰
cat &amp;gt; nginx-hpa.yaml &amp;lt;&amp;lt;EOF
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx-deployment
  minReplicas: 2          # æœ€å°‘2ä¸ªPod
  maxReplicas: 10         # æœ€å¤š10ä¸ªPod
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50  # CPUå¹³å‡ä½¿ç”¨ç‡50%
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 70  # å†…å­˜å¹³å‡ä½¿ç”¨ç‡70%
EOF

kubectl apply -f nginx-hpa.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;HPAé…ç½®è¯¦è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;minReplicas: 2        # æœ€å°å‰¯æœ¬æ•°ï¼ˆå³ä½¿è´Ÿè½½ä¸º0ä¹Ÿä¿æŒï¼‰
maxReplicas: 10       # æœ€å¤§å‰¯æœ¬æ•°ï¼ˆä¿æŠ¤é›†ç¾¤èµ„æºï¼‰

metrics:              # ç›‘æ§æŒ‡æ ‡
- type: Resource      # èµ„æºç±»å‹
  resource:
    name: cpu         # CPUä½¿ç”¨ç‡
    target:
      averageUtilization: 50  # ç›®æ ‡ï¼š50%
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œåŸç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç›‘æ§å‘¨æœŸï¼šé»˜è®¤15ç§’æ£€æŸ¥ä¸€æ¬¡

åœºæ™¯1ï¼šCPUä½¿ç”¨ç‡ &amp;gt; 50%ï¼ˆéœ€è¦æ‰©å®¹ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å½“å‰ï¼š3ä¸ªPodï¼ŒCPUä½¿ç”¨ç‡70%     â”‚
â”‚  HPAè®¡ç®—ï¼š70% &amp;gt; 50%ï¼Œéœ€è¦æ‰©å®¹   â”‚
â”‚  æ–°å‰¯æœ¬æ•° = 3 Ã— (70/50) = 4.2   â”‚
â”‚  å‘ä¸Šå–æ•´ = 5ä¸ªPod              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
HPAæ‰§è¡Œï¼škubectl scale deployment --replicas=5

åœºæ™¯2ï¼šCPUä½¿ç”¨ç‡ &amp;lt; 50%ï¼ˆéœ€è¦ç¼©å®¹ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å½“å‰ï¼š5ä¸ªPodï¼ŒCPUä½¿ç”¨ç‡30%     â”‚
â”‚  HPAè®¡ç®—ï¼š30% &amp;lt; 50%ï¼Œéœ€è¦ç¼©å®¹   â”‚
â”‚  æ–°å‰¯æœ¬æ•° = 5 Ã— (30/50) = 3     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
HPAæ‰§è¡Œï¼škubectl scale deployment --replicas=3

æ³¨æ„ï¼šç¼©å®¹æœ‰ä¿æŠ¤æœºåˆ¶ï¼Œé»˜è®¤5åˆ†é’Ÿæ‰ç¼©ä¸€æ¬¡
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹HPAçŠ¶æ€ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹HPA
kubectl get hpa

# è¾“å‡ºç¤ºä¾‹ï¼š
# NAME        REFERENCE                    TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
# nginx-hpa   Deployment/nginx-deployment  45%/50%   2         10        3          5m

# TARGETSæ˜¾ç¤ºï¼šå½“å‰å€¼/ç›®æ ‡å€¼

# æŸ¥çœ‹HPAè¯¦ç»†ä¿¡æ¯
kubectl describe hpa nginx-hpa
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•HPAï¼ˆå‹åŠ›æµ‹è¯•ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹æ³•1ï¼šä½¿ç”¨Apache Bench
kubectl run -it --rm load-generator --image=busybox -- /bin/sh
# åœ¨å®¹å™¨å†…æ‰§è¡Œï¼š
while true; do wget -q -O- http://nginx-service; done

# æ–¹æ³•2ï¼šä½¿ç”¨ä¸“ä¸šå‹æµ‹å·¥å…·
kubectl run load-generator --image=k8s.gcr.io/hpa-example \
  --requests=cpu=200m -- /bin/sh -c &quot;while true; do echo &apos;test&apos;; done&quot;

# è§‚å¯ŸHPAè‡ªåŠ¨æ‰©å®¹
kubectl get hpa -w
kubectl get deployment nginx-deployment -w
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;HPAçš„æ™ºèƒ½ç‰¹æ€§ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. é˜²æŠ–åŠ¨æœºåˆ¶
   â””â”€ æ‰©å®¹ï¼šç«‹å³æ‰§è¡Œ
   â””â”€ ç¼©å®¹ï¼šç­‰å¾…5åˆ†é’Ÿï¼ˆé¿å…é¢‘ç¹ç¼©æ”¾ï¼‰

2. æ¸è¿›å¼æ‰©ç¼©
   â””â”€ ä¸ä¼šä¸€æ¬¡æ€§ä»3ä¸ªæ‰©åˆ°100ä¸ª
   â””â”€ æ¯æ¬¡æœ€å¤šç¿»å€ï¼ˆ3â†’6â†’12...ï¼‰

3. ä¼˜é›…ç»ˆæ­¢
   â””â”€ ç¼©å®¹æ—¶ä¼šç­‰å¾…Podå¤„ç†å®Œè¯·æ±‚

4. å¤šæŒ‡æ ‡æ”¯æŒ
   â””â”€ å¯ä»¥åŒæ—¶åŸºäºCPUã€å†…å­˜ã€è‡ªå®šä¹‰æŒ‡æ ‡
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.8 æ‰©ç¼©å®¹æœ€ä½³å®è·µ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ‰‹åŠ¨ vs è‡ªåŠ¨æ‰©ç¼©å®¹é€‰æ‹©ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;åœºæ™¯&lt;/th&gt;
&lt;th&gt;æ¨èæ–¹å¼&lt;/th&gt;
&lt;th&gt;åŸå› &lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;æµé‡å¯é¢„æµ‹ï¼ˆå¦‚å®šæ—¶ä»»åŠ¡ï¼‰&lt;/td&gt;
&lt;td&gt;æ‰‹åŠ¨ + å®šæ—¶ä»»åŠ¡&lt;/td&gt;
&lt;td&gt;ç²¾ç¡®æ§åˆ¶ï¼ŒèŠ‚çœèµ„æº&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;æµé‡ä¸å¯é¢„æµ‹ï¼ˆå¦‚WebæœåŠ¡ï¼‰&lt;/td&gt;
&lt;td&gt;HPA&lt;/td&gt;
&lt;td&gt;è‡ªåŠ¨é€‚åº”ï¼Œçœå¿ƒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;çªå‘æµé‡ï¼ˆå¦‚ç§’æ€ï¼‰&lt;/td&gt;
&lt;td&gt;é¢„æ‰©å®¹ + HPA&lt;/td&gt;
&lt;td&gt;å¿«é€Ÿå“åº”&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;èµ„æºå—é™&lt;/td&gt;
&lt;td&gt;æ‰‹åŠ¨&lt;/td&gt;
&lt;td&gt;ç²¾ç¡®æ§åˆ¶æˆæœ¬&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;HPAé…ç½®å»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
minReplicas: 3           # è‡³å°‘3ä¸ªä¿è¯é«˜å¯ç”¨
maxReplicas: 20          # é™åˆ¶ä¸Šé™ä¿æŠ¤é›†ç¾¤
metrics:
- type: Resource
  resource:
    name: cpu
    target:
      averageUtilization: 70   # 70%æ¯”è¾ƒåˆç†ï¼ˆä¸è¦è®¾å¤ªä½ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆCPUç›®æ ‡ä¸è¦è®¾å¤ªä½ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;CPUç›®æ ‡=30%:
  âœ— èµ„æºåˆ©ç”¨ç‡ä½ï¼ˆæµªè´¹ï¼‰
  âœ— Podæ•°é‡è¿‡å¤šï¼ˆç®¡ç†å¤æ‚ï¼‰
  âœ— æˆæœ¬é«˜

CPUç›®æ ‡=70%:
  âœ“ èµ„æºåˆ©ç”¨åˆç†
  âœ“ ç•™æœ‰ç¼“å†²ç©ºé—´
  âœ“ æˆæœ¬å¯æ§

CPUç›®æ ‡=90%:
  âœ— æ‰©å®¹å“åº”æ…¢
  âœ— æ²¡æœ‰ç¼“å†²
  âœ— å®¹æ˜“è¿‡è½½
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;4. å®æˆ˜æ¼”ç»ƒï¼šå®Œæ•´çš„Deploymentç”Ÿå‘½å‘¨æœŸ&lt;/h3&gt;
&lt;h4&gt;4.1 å®éªŒ1ï¼šåˆ›å»ºç¬¬ä¸€ä¸ªDeployment&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šå‡†å¤‡é•œåƒï¼ˆä½¿ç”¨ä¹‹å‰çš„nginx-phpé•œåƒï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç¡®è®¤é•œåƒå­˜åœ¨
curl -u admin:12345 http://reg.westos.org/v2/library/nginx-php/tags/list
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåˆ›å»ºDeployment YAML&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd /root/k8s-yaml

cat &amp;gt; nginx-deployment.yaml &amp;lt;&amp;lt;EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: reg.westos.org/library/nginx-php:v1
        ports:
        - containerPort: 80
        env:
        - name: APP_VERSION
          value: &quot;v1.0&quot;
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 512Mi
        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 5
        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 3
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šéƒ¨ç½²Deployment&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºDeployment
kubectl apply -f nginx-deployment.yaml

# æŸ¥çœ‹Deployment
kubectl get deployment nginx-deployment

# æŸ¥çœ‹ReplicaSet
kubectl get replicaset

# æŸ¥çœ‹Pod
kubectl get pods -l app=nginx -o wide

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe deployment nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME                READY   UP-TO-DATE   AVAILABLE   AGE
nginx-deployment    3/3     3            3           30s

NAME                           DESIRED   CURRENT   READY   AGE
nginx-deployment-7d64c8b9f5    3         3         3       30s

NAME                              READY   STATUS    IP             NODE
nginx-deployment-7d64c8b9f5-abc   1/1     Running   10.244.1.10    node1
nginx-deployment-7d64c8b9f5-def   1/1     Running   10.244.2.11    node2
nginx-deployment-7d64c8b9f5-ghi   1/1     Running   10.244.1.12    node1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4ï¼šåˆ›å»ºServiceè®¿é—®åº”ç”¨&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nginx-service.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
    nodePort: 30080
EOF

kubectl apply -f nginx-service.yaml

# æµ‹è¯•è®¿é—®
curl http://192.168.100.21:30080
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Nginx-PHP Container
Hostname: nginx-deployment-7d64c8b9f5-abc
Server IP: 10.244.1.10

Database connected successfully!
MySQL Version: 8.0.44
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;4.2 å®éªŒ2ï¼šæ»šåŠ¨æ›´æ–°å‡çº§åˆ°v2&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šç¡®è®¤v2é•œåƒå­˜åœ¨&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å¦‚æœè¿˜æ²¡æœ‰v2é•œåƒï¼Œéœ€è¦å…ˆæ„å»ºï¼ˆå‚è€ƒç¬¬å››ç« ï¼‰
docker images | grep nginx-php
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šæ‰§è¡Œæ»šåŠ¨æ›´æ–°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹æ³•1ï¼šä¿®æ”¹YAMLæ–‡ä»¶
sed -i &apos;s/nginx-php:v1/nginx-php:v2/&apos; nginx-deployment.yaml
sed -i &apos;s/v1.0/v2.0/&apos; nginx-deployment.yaml

# æ·»åŠ æ›´æ–°è®°å½•
kubectl annotate deployment/nginx-deployment \
  kubernetes.io/change-cause=&quot;å‡çº§åˆ°v2ç‰ˆæœ¬&quot;

# åº”ç”¨æ›´æ–°
kubectl apply -f nginx-deployment.yaml

# æ–¹æ³•2ï¼šç›´æ¥ä½¿ç”¨å‘½ä»¤ï¼ˆæ›´å¿«ï¼‰
kubectl set image deployment/nginx-deployment \
  nginx=reg.westos.org/library/nginx-php:v2

kubectl annotate deployment/nginx-deployment \
  kubernetes.io/change-cause=&quot;å‡çº§åˆ°v2ç‰ˆæœ¬&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šå®æ—¶ç›‘æ§æ›´æ–°è¿‡ç¨‹&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç»ˆç«¯1ï¼šç›‘æ§æ›´æ–°çŠ¶æ€
kubectl rollout status deployment/nginx-deployment

# ç»ˆç«¯2ï¼šç›‘æ§Podå˜åŒ–
kubectl get pods -l app=nginx -w

# ç»ˆç«¯3ï¼šç›‘æ§ReplicaSet
kubectl get replicaset -w
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è§‚å¯Ÿåˆ°çš„ç°è±¡ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. åˆ›å»º1ä¸ªæ–°Podï¼ˆv2ï¼‰
   nginx-deployment-86b7dbdd8b-new1  0/1  ContainerCreating

2. æ–°Podå°±ç»ªåï¼Œåˆ é™¤1ä¸ªæ—§Podï¼ˆv1ï¼‰
   nginx-deployment-7d64c8b9f5-abc   1/1  Terminating
   nginx-deployment-86b7dbdd8b-new1  1/1  Running

3. é‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰Podéƒ½æ˜¯v2
   
æ€»è€—æ—¶ï¼šçº¦1-2åˆ†é’Ÿï¼ˆå–å†³äºé•œåƒå¤§å°ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4ï¼šéªŒè¯æ›´æ–°ç»“æœ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹æ‰€æœ‰Podçš„é•œåƒç‰ˆæœ¬
kubectl get pods -l app=nginx -o jsonpath=&apos;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.containers[0].image}{&quot;\n&quot;}{end}&apos;

# è®¿é—®åº”ç”¨éªŒè¯
curl http://192.168.100.21:30080 | grep Version
# è¾“å‡ºï¼šNginx-PHP - Version: v2.0

# æŸ¥çœ‹å†å²ç‰ˆæœ¬
kubectl rollout history deployment/nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;4.3 å®éªŒ3ï¼šå›æ»šåˆ°v1ç‰ˆæœ¬&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼šå‘ç°v2ç‰ˆæœ¬æœ‰bugï¼Œéœ€è¦ç´§æ€¥å›é€€&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šæ¨¡æ‹Ÿv2ç‰ˆæœ¬æ•…éšœ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å‡è®¾æˆ‘ä»¬å‘ç°v2ç‰ˆæœ¬æœ‰ä¸¥é‡bug
# æŸ¥çœ‹å½“å‰ç‰ˆæœ¬
kubectl rollout history deployment/nginx-deployment
# REVISION  CHANGE-CAUSE
# 1         åˆ›å»ºåˆå§‹ç‰ˆæœ¬
# 2         å‡çº§åˆ°v2ç‰ˆæœ¬
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šæ‰§è¡Œå›æ»š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼ˆv1ï¼‰
kubectl rollout undo deployment/nginx-deployment

# æˆ–è€…å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo deployment/nginx-deployment --to-revision=1

# ç›‘æ§å›æ»šè¿‡ç¨‹
kubectl rollout status deployment/nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šéªŒè¯å›æ»šç»“æœ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Podé•œåƒ
kubectl get pods -l app=nginx -o jsonpath=&apos;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.containers[0].image}{&quot;\n&quot;}{end}&apos;
# åº”è¯¥æ˜¾ç¤ºï¼šreg.westos.org/library/nginx-php:v1

# è®¿é—®åº”ç”¨éªŒè¯
curl http://192.168.100.21:30080 | grep Version
# è¾“å‡ºï¼šNginx-PHP Containerï¼ˆv1ç‰ˆæœ¬ï¼‰

# æŸ¥çœ‹å†å²ï¼ˆæ³¨æ„ç‰ˆæœ¬å·å˜åŒ–ï¼‰
kubectl rollout history deployment/nginx-deployment
# REVISION  CHANGE-CAUSE
# 2         å‡çº§åˆ°v2ç‰ˆæœ¬
# 3         å›æ»šåˆ°v1ç‰ˆæœ¬
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;4.4 å®éªŒ4ï¼šæ‰‹åŠ¨æ‰©ç¼©å®¹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯1ï¼šæ‰©å®¹åº”å¯¹æµé‡å¢é•¿&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å½“å‰3ä¸ªå‰¯æœ¬ï¼Œæ‰©å®¹åˆ°10ä¸ª
kubectl scale deployment/nginx-deployment --replicas=10

# è§‚å¯Ÿæ‰©å®¹è¿‡ç¨‹
kubectl get pods -l app=nginx -w

# æŸ¥çœ‹DeploymentçŠ¶æ€
kubectl get deployment nginx-deployment
# NAME                READY   UP-TO-DATE   AVAILABLE   AGE
# nginx-deployment    10/10   10           10          5m

# æŸ¥çœ‹Podåˆ†å¸ƒ
kubectl get pods -l app=nginx -o wide | awk &apos;{print $7}&apos; | sort | uniq -c
#   5 node1
#   5 node2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯2ï¼šç¼©å®¹èŠ‚çœèµ„æº&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æµé‡ä¸‹é™ï¼Œç¼©å‡åˆ°2ä¸ªå‰¯æœ¬
kubectl scale deployment/nginx-deployment --replicas=2

# è§‚å¯Ÿç¼©å®¹è¿‡ç¨‹
kubectl get pods -l app=nginx -w

# éªŒè¯æœåŠ¡ä»å¯è®¿é—®
for i in {1..10}; do curl -s http://192.168.100.21:30080 | grep Hostname; done
# è™½ç„¶åªæœ‰2ä¸ªPodï¼Œä½†Serviceä¼šè½®è¯¢è´Ÿè½½å‡è¡¡
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯3ï¼šæ¢å¤åˆ°åˆå§‹å‰¯æœ¬æ•°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ¢å¤åˆ°3ä¸ªå‰¯æœ¬
kubectl scale deployment/nginx-deployment --replicas=3
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;4.5 å®éªŒ5ï¼šéƒ¨ç½²Metrics Serverå¹¶é…ç½®HPA&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šéƒ¨ç½²Metrics Server&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸‹è½½é…ç½®æ–‡ä»¶
wget https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml -O metrics-server.yaml

# ä¿®æ”¹é…ç½®ï¼ˆæ·»åŠ å‚æ•°ï¼‰
vi metrics-server.yaml

# æ‰¾åˆ°Deploymentçš„containers.argséƒ¨åˆ†ï¼Œæ·»åŠ ï¼š
# - --kubelet-insecure-tls
# - --kubelet-preferred-address-types=InternalIP

# å®Œæ•´ç¤ºä¾‹ï¼š
spec:
  containers:
  - args:
    - --cert-dir=/tmp
    - --secure-port=4443
    - --kubelet-preferred-address-types=InternalIP
    - --kubelet-use-node-status-port
    - --metric-resolution=15s
    - --kubelet-insecure-tls  # æ·»åŠ è¿™è¡Œ
    image: registry.k8s.io/metrics-server/metrics-server:v0.6.4
    name: metrics-server
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåº”ç”¨éƒ¨ç½²&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f metrics-server.yaml

# ç­‰å¾…Metrics Serverå°±ç»ª
kubectl get pods -n kube-system | grep metrics-server
kubectl wait --for=condition=ready pod -l k8s-app=metrics-server -n kube-system --timeout=300s

# éªŒè¯ï¼ˆéœ€è¦ç­‰å¾…1-2åˆ†é’Ÿæ”¶é›†æ•°æ®ï¼‰
sleep 60
kubectl top nodes
kubectl top pods
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ kubectl top nodes
NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
master   234m         11%    1456Mi          38%       
node1    156m         7%     1123Mi          29%       
node2    145m         7%     1089Mi          28%       

$ kubectl top pods
NAME                               CPU(cores)   MEMORY(bytes)   
nginx-deployment-7d64c8b9f5-abc   1m           15Mi            
nginx-deployment-7d64c8b9f5-def   1m           14Mi            
nginx-deployment-7d64c8b9f5-ghi   1m           16Mi
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šæ›´æ–°Deploymentæ·»åŠ èµ„æºè¯·æ±‚&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¿®æ”¹deployment.yamlï¼Œç¡®ä¿æœ‰resourcesé…ç½®
vi nginx-deployment.yaml

# ç¡®è®¤åŒ…å«resourcesï¼š
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        cpu: 500m
        memory: 512Mi

# é‡æ–°åº”ç”¨
kubectl apply -f nginx-deployment.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4ï¼šåˆ›å»ºHPA&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nginx-hpa.yaml &amp;lt;&amp;lt;EOF
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: nginx-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: nginx-deployment
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 50
EOF

kubectl apply -f nginx-hpa.yaml

# æŸ¥çœ‹HPAçŠ¶æ€
kubectl get hpa
# NAME        REFERENCE                    TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
# nginx-hpa   Deployment/nginx-deployment  2%/50%    2         10        2          10s
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤5ï¼šæµ‹è¯•HPAè‡ªåŠ¨æ‰©å®¹&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºå‹åŠ›æµ‹è¯•Pod
kubectl run load-generator \
  --image=reg.westos.org/library/busybox:1.30.1 \
  --restart=Never \
  --rm -it -- sh -c \
  &quot;while true; do wget -q -O- http://nginx-service; done&quot;

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯ç›‘æ§HPA
kubectl get hpa nginx-hpa -w

# åœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯ç›‘æ§Podæ•°é‡
kubectl get pods -l app=nginx -w
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è§‚å¯Ÿåˆ°çš„ç°è±¡ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. CPUä½¿ç”¨ç‡é€æ¸ä¸Šå‡
   TARGETS: 2%/50% â†’ 45%/50% â†’ 75%/50%

2. HPAè§¦å‘æ‰©å®¹ï¼ˆçº¦15-30ç§’åï¼‰
   REPLICAS: 2 â†’ 4 â†’ 6

3. æ–°Podåˆ›å»ºå¹¶å°±ç»ª
   nginx-deployment-xxx-new4  ContainerCreating â†’ Running
   nginx-deployment-xxx-new5  ContainerCreating â†’ Running

4. CPUä½¿ç”¨ç‡ä¸‹é™
   TARGETS: 75%/50% â†’ 40%/50%

5. åœæ­¢å‹æµ‹åï¼Œç­‰å¾…5åˆ†é’Ÿï¼ŒHPAè‡ªåŠ¨ç¼©å®¹
   REPLICAS: 6 â†’ 4 â†’ 2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤6ï¼šæ¸…ç†å‹æµ‹ç¯å¢ƒ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœæ­¢load-generatorï¼ˆCtrl+Cï¼‰

# ç­‰å¾…è‡ªåŠ¨ç¼©å®¹ï¼ˆçº¦5åˆ†é’Ÿï¼‰
kubectl get hpa nginx-hpa -w

# æŸ¥çœ‹æœ€ç»ˆçŠ¶æ€
kubectl get deployment nginx-deployment
kubectl get hpa nginx-hpa
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;4.6 å®éªŒ6ï¼šé‡‘ä¸é›€å‘å¸ƒï¼ˆæš‚åœ/æ¢å¤ï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœºæ™¯ï¼šè°¨æ…å‘å¸ƒv2ç‰ˆæœ¬ï¼Œå…ˆæ›´æ–°éƒ¨åˆ†PodéªŒè¯&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šå‡†å¤‡æ›´æ–°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å‡è®¾å½“å‰æ˜¯v1ï¼Œè¦æ›´æ–°åˆ°v2
kubectl set image deployment/nginx-deployment \
  nginx=reg.westos.org/library/nginx-php:v2
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šç«‹å³æš‚åœæ›´æ–°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨æ›´æ–°å¼€å§‹åç«‹å³æš‚åœ
kubectl rollout pause deployment/nginx-deployment

# æŸ¥çœ‹å½“å‰çŠ¶æ€ï¼ˆå¯èƒ½æœ‰1-2ä¸ªPodå·²æ›´æ–°ï¼‰
kubectl get pods -l app=nginx -o jsonpath=&apos;{range .items[*]}{.metadata.name}{&quot;\t&quot;}{.spec.containers[0].image}{&quot;\n&quot;}{end}&apos;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šæµ‹è¯•æ–°ç‰ˆæœ¬&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ‰¾åˆ°æ–°ç‰ˆæœ¬Podçš„IP
NEW_POD_IP=$(kubectl get pods -l app=nginx -o jsonpath=&apos;{.items[0].status.podIP}&apos;)

# å¤šæ¬¡è®¿é—®æµ‹è¯•
for i in {1..20}; do curl -s http://$NEW_POD_IP | grep Version; done

# é€šè¿‡Serviceè®¿é—®ï¼ˆä¼šçœ‹åˆ°æ–°æ—§ç‰ˆæœ¬æ··åˆï¼‰
for i in {1..20}; do curl -s http://192.168.100.21:30080 | grep Version; done
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4ï¼šå†³ç­–&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# å¦‚æœæ–°ç‰ˆæœ¬æ­£å¸¸ï¼Œæ¢å¤æ›´æ–°
kubectl rollout resume deployment/nginx-deployment

# å¦‚æœæ–°ç‰ˆæœ¬æœ‰é—®é¢˜ï¼Œå›æ»š
kubectl rollout undo deployment/nginx-deployment
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;4.7 å¸¸ç”¨ç®¡ç†å‘½ä»¤æ€»ç»“&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# === åˆ›å»ºå’Œåˆ é™¤ ===
kubectl apply -f deployment.yaml        # åˆ›å»º/æ›´æ–°
kubectl delete deployment &amp;lt;name&amp;gt;        # åˆ é™¤
kubectl delete -f deployment.yaml       # é€šè¿‡æ–‡ä»¶åˆ é™¤

# === æŸ¥çœ‹çŠ¶æ€ ===
kubectl get deployment                  # åˆ—å‡ºæ‰€æœ‰Deployment
kubectl get deployment &amp;lt;name&amp;gt;           # æŸ¥çœ‹ç‰¹å®šDeployment
kubectl get deployment &amp;lt;name&amp;gt; -o yaml   # æŸ¥çœ‹å®Œæ•´YAML
kubectl describe deployment &amp;lt;name&amp;gt;      # æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯

# === æ›´æ–°æ“ä½œ ===
kubectl set image deployment/&amp;lt;name&amp;gt; &amp;lt;container&amp;gt;=&amp;lt;image&amp;gt;  # æ›´æ–°é•œåƒ
kubectl edit deployment &amp;lt;name&amp;gt;                           # ç¼–è¾‘é…ç½®
kubectl patch deployment &amp;lt;name&amp;gt; -p &apos;{json}&apos;              # éƒ¨åˆ†æ›´æ–°

# === å›æ»šæ“ä½œ ===
kubectl rollout status deployment/&amp;lt;name&amp;gt;              # æŸ¥çœ‹æ›´æ–°çŠ¶æ€
kubectl rollout history deployment/&amp;lt;name&amp;gt;             # æŸ¥çœ‹å†å²
kubectl rollout undo deployment/&amp;lt;name&amp;gt;                # å›æ»šåˆ°ä¸Šä¸€ç‰ˆæœ¬
kubectl rollout undo deployment/&amp;lt;name&amp;gt; --to-revision=2  # å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout pause deployment/&amp;lt;name&amp;gt;               # æš‚åœæ›´æ–°
kubectl rollout resume deployment/&amp;lt;name&amp;gt;              # æ¢å¤æ›´æ–°

# === æ‰©ç¼©å®¹ ===
kubectl scale deployment/&amp;lt;name&amp;gt; --replicas=5          # æ‰‹åŠ¨æ‰©ç¼©å®¹
kubectl autoscale deployment/&amp;lt;name&amp;gt; --min=2 --max=10 --cpu-percent=50  # è‡ªåŠ¨æ‰©ç¼©å®¹

# === è°ƒè¯• ===
kubectl logs deployment/&amp;lt;name&amp;gt;                        # æŸ¥çœ‹æ—¥å¿—
kubectl logs -f deployment/&amp;lt;name&amp;gt;                     # å®æ—¶æ—¥å¿—
kubectl exec -it deployment/&amp;lt;name&amp;gt; -- bash            # è¿›å…¥å®¹å™¨
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;å°ç»“ï¼šDeploymentå®æˆ˜æ€»ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒæ¦‚å¿µå›é¡¾ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Deployment = Podæ¨¡æ¿ + å‰¯æœ¬ç®¡ç† + æ›´æ–°ç­–ç•¥&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ReplicaSetè´Ÿè´£ç»´æŒPodæ•°é‡ï¼ŒDeploymentè´Ÿè´£ç‰ˆæœ¬ç®¡ç†&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æ»šåŠ¨æ›´æ–°å®ç°é›¶åœæœºéƒ¨ç½²&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å›æ»šæœºåˆ¶ä¿è¯å¿«é€Ÿæ¢å¤&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;HPAå®ç°è‡ªåŠ¨å¼¹æ€§ä¼¸ç¼©&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§ç¯å¢ƒæœ€ä½³å®è·µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;âœ“ å§‹ç»ˆä½¿ç”¨Deploymentç®¡ç†æ— çŠ¶æ€åº”ç”¨
âœ“ é…ç½®å¥åº·æ£€æŸ¥ï¼ˆliveness + readinessï¼‰
âœ“ è®¾ç½®èµ„æºé™åˆ¶ï¼ˆrequests + limitsï¼‰
âœ“ ä½¿ç”¨RollingUpdateç­–ç•¥
âœ“ ä¿ç•™è¶³å¤Ÿçš„å†å²ç‰ˆæœ¬ï¼ˆrevisionHistoryLimit: 10ï¼‰
âœ“ é…ç½®HPAåº”å¯¹æµé‡æ³¢åŠ¨
âœ“ ä½¿ç”¨YAMLæ–‡ä»¶ç®¡ç†ï¼Œçº³å…¥ç‰ˆæœ¬æ§åˆ¶
âœ“ æ·»åŠ meaningfulçš„change-causeæ³¨è§£
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
</content:encoded></item><item><title>02.Kubernetes å­¦ä¹ ç¬”è®°ï¼šService æœåŠ¡å‘ç°ä¸è´Ÿè½½å‡è¡¡</title><link>https://dev-null-sec.github.io/posts/02-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-service%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/02-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-service%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0%E4%B8%8E%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</guid><description>æ·±å…¥ç†è§£ K8s Service å·¥ä½œåŸç†ã€ç±»å‹ã€kube-proxy æœºåˆ¶å’ŒæœåŠ¡å‘ç°</description><pubDate>Fri, 09 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;ä¸‰ã€Service è¯¦è§£&lt;/h2&gt;
&lt;h3&gt;1. Serviceæ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆéœ€è¦å®ƒ&lt;/h3&gt;
&lt;h4&gt;1.1 å›é¡¾Podçš„é—®é¢˜&lt;/h4&gt;
&lt;p&gt;åœ¨ä¸Šä¸€ç« ï¼Œæˆ‘ä»¬å­¦ä¼šäº†åˆ›å»ºPodï¼Œå¹¶ä¸”è®©nginxé€šè¿‡æ•°æ®åº“çš„IPåœ°å€ï¼ˆæ¯”å¦‚10.244.1.10ï¼‰è¿›è¡Œè¿æ¥ã€‚ä½†è¿™é‡Œæœ‰ä¸ªå¤§é—®é¢˜ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Podçš„IPæ˜¯ä¸ç¨³å®šçš„ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æƒ³è±¡ä¸€ä¸‹è¿™äº›åœºæ™¯ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Podé‡å¯äº†ï¼ŒIPåœ°å€ä¼šå˜&lt;/li&gt;
&lt;li&gt;Podè¢«è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ï¼ŒIPåœ°å€ä¼šå˜&lt;/li&gt;
&lt;li&gt;Podè¢«åˆ é™¤é‡å»ºï¼ŒIPåœ°å€è¿˜ä¼šå˜&lt;/li&gt;
&lt;li&gt;Deploymentç®¡ç†å¤šä¸ªPodå‰¯æœ¬ï¼Œæ¯ä¸ªPodçš„IPéƒ½ä¸ä¸€æ ·&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;è¿™å°±åƒä½ æœ‹å‹æ¬å®¶äº†ï¼Œä½†æ²¡å‘Šè¯‰ä½ æ–°åœ°å€ã€‚&lt;/strong&gt; ä½ æ¯æ¬¡æƒ³æ‰¾ä»–ï¼Œéƒ½å¾—é‡æ–°æ‰“å¬ä»–ä½å“ªå„¿ï¼Œè¿™å¤ªéº»çƒ¦äº†ï¼&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬éœ€è¦ä¸€ä¸ª&lt;strong&gt;ç¨³å®šçš„&quot;é—¨ç‰Œå·&quot;&lt;/strong&gt;ï¼Œæ— è®ºPodæ€ä¹ˆå˜åŒ–ï¼Œéƒ½èƒ½é€šè¿‡è¿™ä¸ªé—¨ç‰Œå·æ‰¾åˆ°å®ƒã€‚è¿™å°±æ˜¯Serviceçš„ä½œç”¨ã€‚&lt;/p&gt;
&lt;h4&gt;1.2 Serviceæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Serviceï¼ˆæœåŠ¡ï¼‰&lt;/strong&gt; æ˜¯Kubernetesä¸­ä¸€ä¸ªæŠ½è±¡æ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„Podçš„é€»è¾‘é›†åˆï¼Œä»¥åŠè®¿é—®è¿™äº›Podçš„ç­–ç•¥ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç”¨ç”Ÿæ´»åŒ–çš„æ¯”å–»æ¥ç†è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æƒ³è±¡ä¸€ä¸ªå¤§å‹è¶…å¸‚ï¼š

Pod = æ”¶é“¶å‘˜ï¼ˆå¯èƒ½ä¼šæ¢ç­ã€ä¼‘å‡ã€ç¦»èŒï¼‰
Service = æ”¶é“¶å°çš„&quot;2å·çª—å£&quot;æ ‡è¯†

é¡¾å®¢ï¼ˆå®¢æˆ·ç«¯ï¼‰åªéœ€è¦è®¤å‡†&quot;2å·çª—å£&quot;ï¼Œ
ä¸ç”¨å…³å¿ƒä»Šå¤©æ˜¯å“ªä¸ªæ”¶é“¶å‘˜åœ¨å€¼ç­ã€‚
è¶…å¸‚å¯ä»¥éšæ„è°ƒæ•´æ”¶é“¶å‘˜ï¼Œåªè¦ä¿è¯2å·çª—å£æœ‰äººæœåŠ¡å°±è¡Œã€‚
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Serviceçš„æ ¸å¿ƒç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ç¨³å®šçš„è®¿é—®å…¥å£&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Serviceæœ‰ä¸€ä¸ªå›ºå®šçš„IPåœ°å€ï¼ˆClusterIPï¼‰&lt;/li&gt;
&lt;li&gt;Serviceæœ‰ä¸€ä¸ªå›ºå®šçš„DNSåç§°ï¼ˆå¦‚ï¼šmysql-serviceï¼‰&lt;/li&gt;
&lt;li&gt;æ— è®ºåç«¯Podå¦‚ä½•å˜åŒ–ï¼ŒServiceçš„IPå’Œåç§°éƒ½ä¸å˜&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœæœ‰å¤šä¸ªPodå‰¯æœ¬ï¼ŒServiceä¼šè‡ªåŠ¨åˆ†å‘æµé‡&lt;/li&gt;
&lt;li&gt;å°±åƒé“¶è¡Œæœ‰å¤šä¸ªçª—å£ï¼Œå«å·ç³»ç»Ÿè‡ªåŠ¨åˆ†é…&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æœåŠ¡å‘ç°&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šè¿‡Serviceåç§°å°±èƒ½è®¿é—®ï¼Œæ— éœ€è®°ä½IP&lt;/li&gt;
&lt;li&gt;é›†ç¾¤å†…çš„DNSè‡ªåŠ¨è§£æServiceåç§°&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;1.3 ä¸ºä»€ä¹ˆéœ€è¦Service&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é—®é¢˜1ï¼šPod IPä¸ç¨³å®š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ²¡æœ‰Serviceçš„æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx Pod  â”‚ -------&amp;gt; â”‚  MySQL Pod  â”‚
â”‚             â”‚  ç¡¬ç¼–ç IP  â”‚  10.244.1.10â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ Podé‡å¯
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚  MySQL Pod  â”‚
                         â”‚  10.244.2.20â”‚ &amp;lt;- æ–°IPï¼Œnginxè¿ä¸ä¸Šäº†ï¼
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰Serviceçš„æƒ…å†µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx Pod  â”‚ -------&amp;gt; â”‚ MySQL Serviceâ”‚ -------&amp;gt; â”‚  MySQL Pod  â”‚
â”‚             â”‚  ç¨³å®šåŸŸå  â”‚ mysql-svc   â”‚  è‡ªåŠ¨è¿½è¸ª  â”‚  ä»»ä½•IPéƒ½è¡Œ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é—®é¢˜2ï¼šå¤šå‰¯æœ¬è´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ²¡æœ‰Serviceï¼šæ€ä¹ˆçŸ¥é“æœ‰å‡ ä¸ªPodï¼Ÿè¦æ‰‹åŠ¨é…ç½®è´Ÿè½½å‡è¡¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     ??? 
â”‚  Client  â”‚ --------&amp;gt; â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  Pod 1   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  Pod 2   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚  Pod 3   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰Serviceï¼šè‡ªåŠ¨è´Ÿè½½å‡è¡¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client  â”‚ --------&amp;gt; â”‚   Service   â”‚ ----è½®è¯¢----&amp;gt; â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  è‡ªåŠ¨åˆ†å‘æµé‡ â”‚               â”‚  Pod 1   â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€&amp;gt; â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚           â”‚  Pod 2   â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€&amp;gt; â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                      â”‚  Pod 3   â”‚
                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é—®é¢˜3ï¼šæœåŠ¡å‘ç°å›°éš¾&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦é…ç½®ä¸­å¿ƒã€æ³¨å†Œä¸­å¿ƒï¼ˆå¦‚Consulã€Eurekaï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    1.æ³¨å†Œ    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL   â”‚ -----------&amp;gt; â”‚ æ³¨å†Œä¸­å¿ƒ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â†‘ 2.æŸ¥è¯¢
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  Nginx   â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

K8sæ–¹å¼ï¼šService + CoreDNS è‡ªåŠ¨æå®š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL   â”‚ &amp;lt;--è‡ªåŠ¨å‘ç°-- â”‚  Service â”‚ &amp;lt;-- DNSè§£æ -- Nginx
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 åªéœ€è¦çŸ¥é“æœåŠ¡å
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;1.4 Serviceçš„å·¥ä½œåŸç†&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Serviceç”±ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶åä½œå®ç°ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Serviceå¯¹è±¡æœ¬èº«&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;kube-proxyï¼ˆç½‘ç»œä»£ç†ï¼‰&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CoreDNSï¼ˆDNSæœåŠ¡ï¼‰&lt;/strong&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å®Œæ•´çš„å·¥ä½œæµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;flowchart TD
    A[&quot;1. ç”¨æˆ·åˆ›å»ºService&amp;lt;br/&amp;gt;kubectl apply -f service.yaml&amp;lt;br/&amp;gt;selector: app=mysql&amp;lt;br/&amp;gt;port: 3306&quot;] --&amp;gt; B
    B[&quot;2. API Serverå¤„ç†&amp;lt;br/&amp;gt;åˆ†é…ClusterIP: 10.96.100.50&amp;lt;br/&amp;gt;å­˜å‚¨åˆ°etcd&quot;] --&amp;gt; C
    C[&quot;3. Endpoint Controller&amp;lt;br/&amp;gt;æ ¹æ®selectoræ‰¾åˆ°åŒ¹é…Pod&amp;lt;br/&amp;gt;åˆ›å»ºEndpoints:&amp;lt;br/&amp;gt;10.244.1.10:3306&amp;lt;br/&amp;gt;10.244.2.20:3306&quot;] --&amp;gt; D
    D[&quot;4. kube-proxyé…ç½®è½¬å‘&amp;lt;br/&amp;gt;ç›‘å¬Serviceå’ŒEndpointå˜åŒ–&amp;lt;br/&amp;gt;é…ç½®iptables/ipvsè§„åˆ™&quot;] --&amp;gt; E
    E[&quot;5. CoreDNSæ³¨å†ŒåŸŸå&amp;lt;br/&amp;gt;mysql-service â†’ 10.96.100.50&quot;] --&amp;gt; F
    F[&quot;6. å®¢æˆ·ç«¯è®¿é—®&amp;lt;br/&amp;gt;â‘  DNSè§£æ mysql-service&amp;lt;br/&amp;gt;â‘¡ è¯·æ±‚ 10.96.100.50:3306&amp;lt;br/&amp;gt;â‘¢ kube-proxyæ‹¦æˆª&amp;lt;br/&amp;gt;â‘£ DNATè½¬æ¢åˆ°Pod IP&amp;lt;br/&amp;gt;â‘¤ åˆ°è¾¾MySQL Pod&quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;1.5 Serviceä¸å…³è”ç»„ä»¶è¯¦è§£&lt;/h4&gt;
&lt;h5&gt;1.5.1 kube-proxyï¼šServiceçš„å®ç°è€…&lt;/h5&gt;
&lt;p&gt;{{ ... }}&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;kube-proxyæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;kube-proxyæ˜¯è¿è¡Œåœ¨æ¯ä¸ªNodeä¸Šçš„ç½‘ç»œä»£ç†ç»„ä»¶ï¼Œè´Ÿè´£å®ç°Serviceçš„ç½‘ç»œè½¬å‘åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;kube-proxyçš„å·¥ä½œæ¨¡å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¨¡å¼1ï¼šiptablesæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åŸç†ï¼šä½¿ç”¨Linux iptablesè§„åˆ™å®ç°æµé‡è½¬å‘

å·¥ä½œæµç¨‹ï¼š
è¯·æ±‚ï¼šcurl http://10.96.100.50:3306
   â†“
iptablesè§„åˆ™æ‹¦æˆªï¼ˆPREROUTINGé“¾ï¼‰
   â†“
DNATè½¬æ¢ï¼š10.96.100.50 -&amp;gt; 10.244.1.10ï¼ˆéšæœºé€‰æ‹©ä¸€ä¸ªPodï¼‰
   â†“
åˆ°è¾¾Pod

ä¼˜ç‚¹ï¼š
  âœ“ æ€§èƒ½å¥½ï¼Œåœ¨å†…æ ¸å±‚é¢å·¥ä½œ
  âœ“ ä¸éœ€è¦é¢å¤–æ¨¡å—

ç¼ºç‚¹ï¼š
  âœ— Service/Podæ•°é‡å¤šæ—¶ï¼Œiptablesè§„åˆ™ä¼šçˆ†ç‚¸å¼å¢é•¿
  âœ— è§„åˆ™åŒ¹é…æ˜¯çº¿æ€§çš„ï¼Œæ€§èƒ½ä¸‹é™
  âœ— è´Ÿè½½å‡è¡¡ç®—æ³•å•ä¸€ï¼ˆåªæœ‰éšæœºï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç¤ºä¾‹ï¼šæŸ¥çœ‹iptablesè§„åˆ™&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Serviceç›¸å…³çš„iptablesè§„åˆ™
iptables -t nat -L | grep mysql-service

# ä½ ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„è§„åˆ™ï¼š
# -A KUBE-SERVICES -d 10.96.100.50/32 -p tcp -m tcp --dport 3306 -j KUBE-SVC-XXXXX
# -A KUBE-SVC-XXXXX -m statistic --mode random --probability 0.5 -j KUBE-SEP-AAAA
# -A KUBE-SVC-XXXXX -j KUBE-SEP-BBBB
# -A KUBE-SEP-AAAA -p tcp -j DNAT --to-destination 10.244.1.10:3306
# -A KUBE-SEP-BBBB -p tcp -j DNAT --to-destination 10.244.2.20:3306
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¨¡å¼2ï¼šIPVSæ¨¡å¼ï¼ˆæ¨èï¼Œç”Ÿäº§ç¯å¢ƒå¿…å¤‡ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åŸç†ï¼šä½¿ç”¨Linux IPVSï¼ˆIP Virtual Serverï¼‰å†…æ ¸æ¨¡å—

IPVSæ˜¯ä»€ä¹ˆï¼Ÿ
  - Linuxå†…æ ¸çš„å››å±‚è´Ÿè½½å‡è¡¡å™¨
  - ä¸“ä¸ºé«˜æ€§èƒ½è´Ÿè½½å‡è¡¡è®¾è®¡
  - æ¯”iptableså¿«å¾—å¤š

å·¥ä½œæµç¨‹ï¼š
è¯·æ±‚ï¼šcurl http://10.96.100.50:3306
   â†“
IPVSè§„åˆ™æ‹¦æˆªï¼ˆå†…æ ¸netfilterï¼‰
   â†“
æ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•é€‰æ‹©åç«¯ï¼ˆå¯é€‰rrã€lcã€dhç­‰ï¼‰
   â†“
DNATè½¬æ¢ï¼š10.96.100.50 -&amp;gt; 10.244.1.10
   â†“
åˆ°è¾¾Pod

ä¼˜ç‚¹ï¼š
  âœ“ æ€§èƒ½æé«˜ï¼Œä½¿ç”¨hashè¡¨æŸ¥æ‰¾ï¼ŒO(1)å¤æ‚åº¦
  âœ“ æ”¯æŒå¤šç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼š
    - rrï¼ˆè½®è¯¢ï¼‰
    - lcï¼ˆæœ€å°‘è¿æ¥ï¼‰
    - dhï¼ˆç›®æ ‡åœ°å€hashï¼‰
    - shï¼ˆæºåœ°å€hashï¼‰
    - sedï¼ˆæœ€çŸ­æœŸæœ›å»¶è¿Ÿï¼‰
    - nqï¼ˆæ°¸ä¸æ’é˜Ÿï¼‰
  âœ“ æ”¯æŒå¤§è§„æ¨¡é›†ç¾¤ï¼ˆå¯å¤„ç†æ•°ä¸‡Serviceï¼‰
  âœ“ æ›´å¥½çš„æ€§èƒ½ï¼šè¿æ¥è°ƒåº¦æ›´å¿«

ç¼ºç‚¹ï¼š
  âœ— éœ€è¦åŠ è½½å†…æ ¸æ¨¡å—
  âœ— é…ç½®ç¨å¤æ‚ï¼ˆä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿™ä¸æ˜¯é—®é¢˜ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;iptables vs IPVS æ€§èƒ½å¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼š1000ä¸ªServiceï¼Œæ¯ä¸ªServiceæœ‰10ä¸ªPod

iptablesæ¨¡å¼ï¼š
  - è§„åˆ™æ•°é‡ï¼š10,000+æ¡
  - è§„åˆ™åŒ¹é…ï¼šçº¿æ€§æŸ¥æ‰¾ O(n)
  - æµé‡è½¬å‘å»¶è¿Ÿï¼šéšServiceæ•°é‡å¢åŠ æ˜¾è‘—ä¸Šå‡
  - åˆ›å»º/åˆ é™¤Serviceï¼šéœ€è¦é‡å»ºå¤§é‡è§„åˆ™ï¼Œè€—æ—¶

IPVSæ¨¡å¼ï¼š
  - è§„åˆ™æ•°é‡ï¼š1,000ä¸ªè™šæ‹ŸæœåŠ¡ + 10,000ä¸ªåç«¯
  - è§„åˆ™åŒ¹é…ï¼šå“ˆå¸ŒæŸ¥æ‰¾ O(1)
  - æµé‡è½¬å‘å»¶è¿Ÿï¼šæ’å®šï¼Œä¸å—Serviceæ•°é‡å½±å“
  - åˆ›å»º/åˆ é™¤Serviceï¼šåªæ“ä½œå¯¹åº”æ¡ç›®ï¼Œå¿«é€Ÿ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;DNATæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;DNATï¼ˆDestination Network Address Translationï¼Œç›®æ ‡ç½‘ç»œåœ°å€è½¬æ¢ï¼‰&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç®€å•ç†è§£ï¼šæŠŠæ•°æ®åŒ…çš„ç›®æ ‡åœ°å€æ”¹æ‰

åŸå§‹è¯·æ±‚ï¼š
  æºIP: 10.244.3.5 (nginx pod)
  ç›®æ ‡IP: 10.96.100.50 (Service ClusterIP)
  ç›®æ ‡ç«¯å£: 3306

ç»è¿‡DNATè½¬æ¢åï¼š
  æºIP: 10.244.3.5 (ä¸å˜)
  ç›®æ ‡IP: 10.244.1.10 (æ”¹æˆäº†Pod IP)
  ç›®æ ‡ç«¯å£: 3306 (ä¸å˜)

è¿™ä¸ªè½¬æ¢å¯¹å®¢æˆ·ç«¯æ˜¯é€æ˜çš„ï¼Œnginx podä¸çŸ¥é“ç›®æ ‡åœ°å€è¢«æ”¹äº†ã€‚
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®Œæ•´çš„ç½‘ç»œåŒ…æµè½¬ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx Pod (10.244.3.5)                                      â”‚
â”‚  æ‰§è¡Œï¼šmysql_connect(&quot;mysql-service&quot;, ...)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ DNSè§£æ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CoreDNS                                                     â”‚
â”‚  mysql-service -&amp;gt; 10.96.100.50                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ å‘é€TCPè¿æ¥è¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åŒ…ï¼ˆå‡ºç«™ï¼‰                                               â”‚
â”‚  SRC: 10.244.3.5:éšæœºç«¯å£                                    â”‚
â”‚  DST: 10.96.100.50:3306                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ ç»è¿‡kube-proxyï¼ˆiptables/IPVSï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DNATè½¬æ¢                                                    â”‚
â”‚  è§„åˆ™ï¼š10.96.100.50:3306 -&amp;gt; 10.244.1.10:3306 (Pod1)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åŒ…ï¼ˆè½¬æ¢åï¼‰                                             â”‚
â”‚  SRC: 10.244.3.5:éšæœºç«¯å£                                    â”‚
â”‚  DST: 10.244.1.10:3306  &amp;lt;- å·²ç»æ”¹æˆPod IP                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ è·¯ç”±åˆ°ç›®æ ‡Node
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MySQL Pod (10.244.1.10)                                    â”‚
â”‚  æ¥æ”¶è¿æ¥ï¼Œå¤„ç†è¯·æ±‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ è¿”å›å“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å“åº”æ•°æ®åŒ…                                                   â”‚
â”‚  SRC: 10.244.1.10:3306                                      â”‚
â”‚  DST: 10.244.3.5:éšæœºç«¯å£                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“ ç»è¿‡kube-proxyï¼ˆåå‘SNATï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SNATè½¬æ¢ï¼ˆè‡ªåŠ¨ï¼‰                                             â”‚
â”‚  10.244.1.10:3306 -&amp;gt; 10.96.100.50:3306                      â”‚
â”‚  ï¼ˆè®©nginxä»¥ä¸ºæ˜¯Serviceå›å¤çš„ï¼‰                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Nginx Podæ”¶åˆ°å“åº”                                            â”‚
â”‚  çœ‹åˆ°çš„æºåœ°å€ï¼š10.96.100.50:3306                             â”‚
â”‚  ï¼ˆå®Œå…¨ä¸çŸ¥é“å®é™…æ˜¯10.244.1.10ï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;h5&gt;1.5.2 CoreDNSï¼šServiceçš„æœåŠ¡å‘ç°&lt;/h5&gt;
&lt;p&gt;&lt;strong&gt;CoreDNSæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;CoreDNSæ˜¯Kubernetesé›†ç¾¤çš„DNSæœåŠ¡å™¨ï¼Œè´Ÿè´£ä¸ºServiceæä¾›åŸŸåè§£æã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;DNSè®°å½•æ ¼å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å®Œæ•´æ ¼å¼ï¼š
&amp;lt;service-name&amp;gt;.&amp;lt;namespace&amp;gt;.svc.&amp;lt;cluster-domain&amp;gt;

ç¤ºä¾‹ï¼š
mysql-service.default.svc.cluster.local

ç®€å†™æ–¹å¼ï¼ˆåŒnamespaceå†…ï¼‰ï¼š
mysql-service.default
mysql-service                    &amp;lt;- æœ€å¸¸ç”¨

è·¨namespaceè®¿é—®ï¼š
mysql-service.production
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;CoreDNSå·¥ä½œåŸç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Podåˆ›å»ºæ—¶ï¼Œkubeletè‡ªåŠ¨é…ç½®DNS                             â”‚
â”‚                                                             â”‚
â”‚  Podå†…çš„ /etc/resolv.conf:                                  â”‚
â”‚  nameserver 10.96.0.10    &amp;lt;- CoreDNSçš„Service IP           â”‚
â”‚  search default.svc.cluster.local svc.cluster.local        â”‚
â”‚  options ndots:5                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. åº”ç”¨å‘èµ·DNSæŸ¥è¯¢                                           â”‚
â”‚  curl http://mysql-service:3306                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. DNSæŸ¥è¯¢å‘é€åˆ°CoreDNS (10.96.0.10)                       â”‚
â”‚  æŸ¥è¯¢ï¼šmysql-service.default.svc.cluster.local çš„Aè®°å½•      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. CoreDNSç›‘å¬etcdï¼Œå®æ—¶çŸ¥é“æ‰€æœ‰Serviceä¿¡æ¯                  â”‚
â”‚  è¿”å›ï¼š10.96.100.50 (Serviceçš„ClusterIP)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. åº”ç”¨ä½¿ç”¨è§£æå‡ºçš„IPè®¿é—®                                     â”‚
â”‚  curl http://10.96.100.50:3306                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹CoreDNSï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹CoreDNS Pod
kubectl get pods -n kube-system | grep coredns

# æŸ¥çœ‹CoreDNSé…ç½®
kubectl get configmap coredns -n kube-system -o yaml

# æµ‹è¯•DNSè§£æ
kubectl run test-dns --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- nslookup mysql-service
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;1.6 Serviceå¦‚ä½•å…³è”åˆ°Podï¼šLabelå’ŒSelector&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Labelï¼ˆæ ‡ç­¾ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Labelæ˜¯é™„åŠ åˆ°K8så¯¹è±¡ä¸Šçš„é”®å€¼å¯¹ï¼Œç”¨äºæ ‡è¯†å’Œåˆ†ç±»èµ„æºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Podå®šä¹‰ä¸­çš„Label
metadata:
  labels:
    app: mysql           # åº”ç”¨åç§°
    version: &quot;8.0&quot;       # ç‰ˆæœ¬
    env: production      # ç¯å¢ƒ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Selectorï¼ˆé€‰æ‹©å™¨ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Selectorç”¨äºæ ¹æ®Labelé€‰æ‹©ä¸€ç»„èµ„æºã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Serviceå®šä¹‰ä¸­çš„Selector
spec:
  selector:
    app: mysql          # é€‰æ‹©æ‰€æœ‰ app=mysql çš„Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®Œæ•´çš„å…³è”æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å®šä¹‰Podï¼Œæ‰“ä¸Šæ ‡ç­¾                                         â”‚
â”‚                                                             â”‚
â”‚  apiVersion: v1                                             â”‚
â”‚  kind: Pod                                                  â”‚
â”‚  metadata:                                                  â”‚
â”‚    name: mysql-pod-1                                        â”‚
â”‚    labels:                                                  â”‚
â”‚      app: mysql         &amp;lt;- æ ‡ç­¾1                            â”‚
â”‚      version: &quot;8.0&quot;     &amp;lt;- æ ‡ç­¾2                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. å®šä¹‰Serviceï¼Œä½¿ç”¨Selector                                â”‚
â”‚                                                             â”‚
â”‚  apiVersion: v1                                             â”‚
â”‚  kind: Service                                              â”‚
â”‚  metadata:                                                  â”‚
â”‚    name: mysql-service                                      â”‚
â”‚  spec:                                                      â”‚
â”‚    selector:                                                â”‚
â”‚      app: mysql         &amp;lt;- é€‰æ‹©å™¨ï¼šåŒ¹é… app=mysql çš„Pod      â”‚
â”‚    ports:                                                   â”‚
â”‚    - port: 3306                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. Endpoint Controllerè‡ªåŠ¨åŒ¹é…                              â”‚
â”‚                                                             â”‚
â”‚  æŸ¥æ‰¾æ‰€æœ‰ app=mysql çš„Podï¼š                                  â”‚
â”‚    - mysql-pod-1  (10.244.1.10)  âœ“ åŒ¹é…                    â”‚
â”‚    - mysql-pod-2  (10.244.2.20)  âœ“ åŒ¹é…                    â”‚
â”‚    - nginx-pod    (10.244.3.5)   âœ— ä¸åŒ¹é…ï¼ˆæ ‡ç­¾ä¸åŒï¼‰        â”‚
â”‚                                                             â”‚
â”‚  åˆ›å»ºEndpointå¯¹è±¡ï¼š                                          â”‚
â”‚  mysql-service:                                             â”‚
â”‚    - 10.244.1.10:3306                                       â”‚
â”‚    - 10.244.2.20:3306                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. PodåŠ¨æ€å˜åŒ–ï¼Œè‡ªåŠ¨æ›´æ–°                                     â”‚
â”‚                                                             â”‚
â”‚  æ–°å¢Podï¼šmysql-pod-3 (æ ‡ç­¾: app=mysql)                     â”‚
â”‚    â†’ Endpointè‡ªåŠ¨æ·»åŠ ï¼š10.244.1.30:3306                     â”‚
â”‚                                                             â”‚
â”‚  Podåˆ é™¤ï¼šmysql-pod-1                                       â”‚
â”‚    â†’ Endpointè‡ªåŠ¨ç§»é™¤ï¼š10.244.1.10:3306                     â”‚
â”‚                                                             â”‚
â”‚  Podæœªå°±ç»ªï¼ˆReadinessæ¢é’ˆå¤±è´¥ï¼‰ï¼š                            â”‚
â”‚    â†’ Endpointä¸´æ—¶ç§»é™¤ï¼Œä¸å†è½¬å‘æµé‡                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Selectorçš„åŒ¹é…è§„åˆ™ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# 1. ç²¾ç¡®åŒ¹é…ï¼ˆANDå…³ç³»ï¼‰
selector:
  app: mysql
  version: &quot;8.0&quot;
# é€‰æ‹©ï¼šapp=mysql ä¸” version=8.0 çš„Pod

# 2. é›†åˆåŒ¹é…ï¼ˆServiceä¸æ”¯æŒï¼ŒDeploymentæ”¯æŒï¼‰
selector:
  matchLabels:
    app: mysql
  matchExpressions:
  - key: version
    operator: In
    values: [&quot;8.0&quot;, &quot;8.1&quot;]
# é€‰æ‹©ï¼šapp=mysql ä¸” version in (8.0, 8.1)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹Labelå’ŒEndpointï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Podçš„æ ‡ç­¾
kubectl get pods --show-labels

# æ ¹æ®æ ‡ç­¾è¿‡æ»¤Pod
kubectl get pods -l app=mysql

# æŸ¥çœ‹Serviceçš„Endpoint
kubectl get endpoints mysql-service

# è¯¦ç»†ä¿¡æ¯
kubectl describe endpoints mysql-service
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆä½¿ç”¨Label/Selectorè€Œä¸æ˜¯ç›´æ¥æŒ‡å®šPodåç§°ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç›´æ¥æŒ‡å®šPodåç§°çš„é—®é¢˜ï¼š
  âœ— Podåç§°ä¼šå˜ï¼ˆé‡å»ºååç§°ä¸åŒï¼‰
  âœ— æ— æ³•åŠ¨æ€æ·»åŠ æ–°Pod
  âœ— æ— æ³•å®ç°è‡ªåŠ¨æ‰©ç¼©å®¹
  âœ— ç®¡ç†å›°éš¾ï¼ˆè¦æ‰‹åŠ¨ç»´æŠ¤åˆ—è¡¨ï¼‰

Label/Selectorçš„ä¼˜åŠ¿ï¼š
  âœ“ æ¾è€¦åˆï¼šServiceä¸å…³å¿ƒå…·ä½“å“ªä¸ªPod
  âœ“ åŠ¨æ€ï¼šæ–°Podè‡ªåŠ¨åŠ å…¥ï¼Œæ—§Podè‡ªåŠ¨ç§»é™¤
  âœ“ çµæ´»ï¼šå¯ä»¥æ ¹æ®ä¸åŒç»´åº¦é€‰æ‹©ï¼ˆç¯å¢ƒã€ç‰ˆæœ¬ç­‰ï¼‰
  âœ“ ç¬¦åˆK8så£°æ˜å¼ç†å¿µ
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;2. Serviceçš„ç±»å‹è¯¦è§£&lt;/h3&gt;
&lt;p&gt;Kubernetesæä¾›äº†äº”ç§Serviceç±»å‹ï¼Œæ¯ç§ç±»å‹é€‚ç”¨äºä¸åŒçš„è®¿é—®åœºæ™¯ã€‚&lt;/p&gt;
&lt;h4&gt;2.1 ClusterIPï¼šé›†ç¾¤å†…éƒ¨è®¿é—®ï¼ˆé»˜è®¤ç±»å‹ï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä»€ä¹ˆæ˜¯ClusterIPï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ClusterIPæ˜¯Serviceçš„é»˜è®¤ç±»å‹ï¼ŒK8sä¼šä¸ºServiceåˆ†é…ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„è™šæ‹ŸIPåœ°å€ï¼Œè¿™ä¸ªIPåªèƒ½åœ¨é›†ç¾¤å†…éƒ¨è®¿é—®ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šå‰ç«¯åº”ç”¨è®¿é—®åç«¯æ•°æ®åº“

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ K8s Cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    ClusterIP    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Nginx   â”‚ --------------&amp;gt;  â”‚  MySQL   â”‚    â”‚
â”‚  â”‚  Pod     â”‚  mysql-service  â”‚  Pods    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   10.96.100.50  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                 â”‚
â”‚  ç‰¹ç‚¹ï¼šåªèƒ½é›†ç¾¤å†…éƒ¨è®¿é—®ï¼Œå¤–éƒ¨æ— æ³•ç›´æ¥è®¿é—®         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;YAMLç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  type: ClusterIP          # å¯ä»¥çœç•¥ï¼Œé»˜è®¤å°±æ˜¯ClusterIP
  selector:
    app: mysql             # é€‰æ‹©æ ‡ç­¾ä¸ºapp=mysqlçš„Pod
  ports:
  - port: 3306             # Serviceå¯¹å¤–æš´éœ²çš„ç«¯å£
    targetPort: 3306       # Podå®¹å™¨çš„ç«¯å£
    protocol: TCP
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é‡è¦å­—æ®µè§£é‡Šï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;port&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Serviceæš´éœ²çš„ç«¯å£ï¼ˆå®¢æˆ·ç«¯è®¿é—®è¿™ä¸ªç«¯å£ï¼‰&lt;/td&gt;
&lt;td&gt;3306&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;targetPort&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Podå®¹å™¨ç›‘å¬çš„ç«¯å£ï¼ˆæµé‡è½¬å‘åˆ°è¿™ä¸ªç«¯å£ï¼‰&lt;/td&gt;
&lt;td&gt;3306&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;protocol&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åè®®ç±»å‹&lt;/td&gt;
&lt;td&gt;TCP/UDP&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;port å’Œ targetPort çš„åŒºåˆ«ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç¤ºä¾‹åœºæ™¯ï¼šService port=80, targetPort=8080

å®¢æˆ·ç«¯è¯·æ±‚ï¼šcurl http://my-service:80
              â†“
          Serviceæ¥æ”¶ï¼ˆport: 80ï¼‰
              â†“
          kube-proxyè½¬å‘
              â†“
     åˆ°è¾¾Podå®¹å™¨ï¼ˆtargetPort: 8080ï¼‰

å¥½å¤„ï¼š
  - Serviceå¯¹å¤–ç»Ÿä¸€ä½¿ç”¨æ ‡å‡†ç«¯å£ï¼ˆå¦‚80ï¼‰
  - å®¹å™¨å†…éƒ¨å¯ä»¥ç”¨ä»»æ„ç«¯å£ï¼ˆå¦‚8080ï¼‰
  - ä¾¿äºç«¯å£æ ‡å‡†åŒ–ç®¡ç†
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹ClusterIPï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºService
kubectl apply -f mysql-service.yaml

# æŸ¥çœ‹Serviceåˆ—è¡¨
kubectl get svc
# NAME            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)    AGE
# mysql-service   ClusterIP   10.96.100.50    &amp;lt;none&amp;gt;        3306/TCP   1m

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
kubectl describe svc mysql-service

# æŸ¥çœ‹Endpointï¼ˆåç«¯Podåˆ—è¡¨ï¼‰
kubectl get endpoints mysql-service
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.2 NodePortï¼šé€šè¿‡èŠ‚ç‚¹ç«¯å£æš´éœ²æœåŠ¡&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä»€ä¹ˆæ˜¯NodePortï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;NodePortåœ¨ClusterIPçš„åŸºç¡€ä¸Šï¼Œä¼šåœ¨æ¯ä¸ªNodeèŠ‚ç‚¹ä¸Šå¼€æ”¾ä¸€ä¸ªå›ºå®šç«¯å£ï¼ˆèŒƒå›´ï¼š30000-32767ï¼‰ï¼Œå¤–éƒ¨å¯ä»¥é€šè¿‡&lt;code&gt;&amp;lt;ä»»æ„NodeIP&amp;gt;:&amp;lt;NodePort&amp;gt;&lt;/code&gt;è®¿é—®æœåŠ¡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œåŸç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨è®¿é—®æµç¨‹ï¼š

å¤–éƒ¨ç”¨æˆ·
  â†“ è®¿é—®ï¼šhttp://192.168.100.21:30080
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ K8s Cluster â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Node1      â”‚  â”‚  Node2      â”‚  â”‚  Node3      â”‚â”‚
â”‚  â”‚ :30080 â†â”€â”€â”€â”€â”¼â”€â”€â”‚ :30080      â”‚  â”‚ :30080      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚         â”‚                                           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â†’ kube-proxyè½¬å‘                  â”‚
â”‚                          â†“                         â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                  â”‚  Service     â”‚                  â”‚
â”‚                  â”‚  ClusterIP   â”‚                  â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                          â†“                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚              â†“           â†“           â†“             â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚         â”‚ Pod1   â”‚  â”‚ Pod2   â”‚  â”‚ Pod3   â”‚       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç‰¹ç‚¹ï¼š
  1. å¯ä»¥é€šè¿‡ä»»æ„Nodeçš„IPè®¿é—®
  2. å³ä½¿Podä¸åœ¨è¯¥Nodeä¸Šä¹Ÿèƒ½è®¿é—®
  3. è‡ªåŠ¨åˆ›å»ºClusterIP
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;YAMLç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: nginx-nodeport
spec:
  type: NodePort
  selector:
    app: nginx
  ports:
  - port: 80               # ClusterIPç«¯å£
    targetPort: 80         # Podç«¯å£
    nodePort: 30080        # Nodeç«¯å£ï¼ˆå¯é€‰ï¼Œä¸æŒ‡å®šåˆ™è‡ªåŠ¨åˆ†é…ï¼‰
    protocol: TCP
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸‰ç§è®¿é—®æ–¹å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹å¼1ï¼šé›†ç¾¤å†…é€šè¿‡ClusterIPè®¿é—®
curl http://10.96.100.60:80

# æ–¹å¼2ï¼šé›†ç¾¤å†…é€šè¿‡Serviceåç§°è®¿é—®
curl http://nginx-nodeport:80

# æ–¹å¼3ï¼šé›†ç¾¤å¤–é€šè¿‡NodePortè®¿é—®ï¼ˆä»»æ„Node IPéƒ½å¯ä»¥ï¼‰
curl http://192.168.100.21:30080
curl http://192.168.100.22:30080
curl http://192.168.100.20:30080
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;NodePortç«¯å£èŒƒå›´ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# é»˜è®¤èŒƒå›´ï¼š30000-32767
# å¯ä»¥åœ¨kube-apiserverå¯åŠ¨å‚æ•°ä¸­ä¿®æ”¹ï¼š
# --service-node-port-range=30000-32767
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ä¸é™åˆ¶ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;âœ“ é€‚ç”¨åœºæ™¯ï¼š
  - å¼€å‘/æµ‹è¯•ç¯å¢ƒå¿«é€Ÿæš´éœ²æœåŠ¡
  - å°è§„æ¨¡åº”ç”¨
  - ä¸´æ—¶è®¿é—®éœ€æ±‚

âœ— ä¸é€‚ç”¨åœºæ™¯ï¼š
  - ç”Ÿäº§ç¯å¢ƒï¼ˆç«¯å£ä¸å¥½è®°ï¼Œä¸ä¼˜é›…ï¼‰
  - å¤§é‡æœåŠ¡ï¼ˆç«¯å£å®¹æ˜“å†²çªï¼‰
  - éœ€è¦åŸŸåå’ŒHTTPSï¼ˆè¦é¢å¤–é…ç½®ï¼‰

ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š
  ä½¿ç”¨LoadBalanceræˆ–Ingress
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.3 LoadBalancerï¼šäº‘å¹³å°è´Ÿè½½å‡è¡¡å™¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä»€ä¹ˆæ˜¯LoadBalancerï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;LoadBalanceræ˜¯åœ¨NodePortåŸºç¡€ä¸Šï¼Œè‡ªåŠ¨åˆ›å»ºäº‘å¹³å°çš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œæä¾›ç»Ÿä¸€çš„å¤–éƒ¨è®¿é—®å…¥å£ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æœ¬è´¨ç†è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;LoadBalancer = ClusterIP + NodePort + äº‘å¹³å°LB

åˆ›å»ºæµç¨‹ï¼š
1. è‡ªåŠ¨åˆ›å»ºClusterIP
2. è‡ªåŠ¨åˆ›å»ºNodePort
3. è°ƒç”¨äº‘å¹³å°APIåˆ›å»ºå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨
4. å¤–éƒ¨LBæŒ‡å‘æ‰€æœ‰Nodeçš„NodePort
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œåŸç†ï¼ˆäº‘å¹³å°ç¯å¢ƒï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤–éƒ¨ç”¨æˆ·                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ http://lb-12345.elb.amazonaws.com
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  äº‘å¹³å°è´Ÿè½½å‡è¡¡å™¨ (AWS ELB/é˜¿é‡Œäº‘SLB/è…¾è®¯äº‘CLB)      â”‚
â”‚  å¤–éƒ¨IP: 1.2.3.4                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚            â”‚            â”‚
       â†“ :30080     â†“ :30080     â†“ :30080
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Node1   â”‚  â”‚ Node2   â”‚  â”‚ Node3   â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚            â”‚            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Service     â”‚
            â”‚  ClusterIP   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â†“           â†“           â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Pod1   â”‚  â”‚ Pod2   â”‚  â”‚ Pod3   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;YAMLç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: nginx-lb
spec:
  type: LoadBalancer
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŸ¥çœ‹LoadBalancerï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f nginx-lb.yaml

kubectl get svc nginx-lb
# NAME       TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE
# nginx-lb   LoadBalancer   10.96.100.80   1.2.3.4          80:30123/TCP   2m
#                                          â†‘ äº‘å¹³å°åˆ†é…çš„å¤–éƒ¨IP

# å¤–éƒ¨è®¿é—®
curl http://1.2.3.4
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;äº‘å¹³å° vs è£¸é‡‘å±ï¼ˆæœ¬åœ°é›†ç¾¤ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;äº‘å¹³å°ï¼ˆAWSã€é˜¿é‡Œäº‘ã€Azureã€GCPç­‰ï¼‰ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. åˆ›å»ºLoadBalancer Service            â”‚
  â”‚ 2. Cloud Controller Manageræ£€æµ‹åˆ°      â”‚
  â”‚ 3. è°ƒç”¨äº‘å¹³å°APIåˆ›å»ºLB                  â”‚
  â”‚ 4. äº‘å¹³å°è¿”å›å¤–éƒ¨IP                     â”‚
  â”‚ 5. K8sæ›´æ–°Serviceçš„EXTERNAL-IPå­—æ®µ      â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  âœ“ å®Œå…¨è‡ªåŠ¨åŒ–
  âœ“ æœ‰çœŸå®å¤–éƒ¨IP
  âœ“ äº‘å¹³å°ç®¡ç†ï¼Œé«˜å¯ç”¨
  âœ— éœ€è¦ä»˜è´¹

è£¸é‡‘å±/æœ¬åœ°é›†ç¾¤ï¼š
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ 1. åˆ›å»ºLoadBalancer Service            â”‚
  â”‚ 2. æ²¡æœ‰Cloud Controller Manager        â”‚
  â”‚ 3. æ— æ³•è°ƒç”¨äº‘å¹³å°API                    â”‚
  â”‚ 4. EXTERNAL-IPä¸€ç›´æ˜¾ç¤º&amp;lt;pending&amp;gt;        â”‚
  â”‚ 5. LoadBalanceråŠŸèƒ½æ— æ³•ä½¿ç”¨             â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  âœ— æ— å¤–éƒ¨LB
  âœ— åŠŸèƒ½ä¸å¯ç”¨
  âœ“ è§£å†³æ–¹æ¡ˆï¼šMetalLB
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;MetalLBï¼šè£¸é‡‘å±ç¯å¢ƒçš„LoadBalancerå®ç°&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;MetalLBæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;MetalLBæ˜¯ä¸€ä¸ªä¸ºè£¸é‡‘å±Kubernetesé›†ç¾¤æä¾›LoadBalancerå®ç°çš„å¼€æºé¡¹ç›®ï¼Œè®©æœ¬åœ°é›†ç¾¤ä¹Ÿèƒ½ä½¿ç”¨LoadBalancerç±»å‹çš„Serviceã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;MetalLBå·¥ä½œåŸç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åˆ›å»ºLoadBalancer Service                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. MetalLB Controllerç›‘å¬                      â”‚
â”‚     - ä»IPæ± åˆ†é…ä¸€ä¸ªå¤–éƒ¨IP                       â”‚
â”‚     - æ›´æ–°Serviceçš„EXTERNAL-IPå­—æ®µ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. MetalLB Speakerï¼ˆDaemonSetï¼Œæ¯ä¸ªNodeè¿è¡Œï¼‰   â”‚
â”‚     - Layer 2æ¨¡å¼ï¼šé€šè¿‡ARPå“åº”å®£å‘ŠIP             â”‚
â”‚     - BGPæ¨¡å¼ï¼šé€šè¿‡BGPåè®®å®£å‘Šè·¯ç”±                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;MetalLBé…ç½®ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# IPåœ°å€æ± 
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.100.100-192.168.100.150    # IPèŒƒå›´

---
# Layer 2æ¨¡å¼é…ç½®
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-adv
  namespace: metallb-system
spec:
  ipAddressPools:
  - first-pool
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;MetalLBä¸¤ç§æ¨¡å¼å¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;Layer 2æ¨¡å¼&lt;/th&gt;
&lt;th&gt;BGPæ¨¡å¼&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;åŸç†&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ARPæ¬ºéª—ï¼Œè®©Nodeå£°ç§°æ‹¥æœ‰è¯¥IP&lt;/td&gt;
&lt;td&gt;é€šè¿‡BGPåè®®å®£å‘Šè·¯ç”±&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;é…ç½®éš¾åº¦&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç®€å•ï¼Œæ— éœ€é¢å¤–è®¾å¤‡&lt;/td&gt;
&lt;td&gt;éœ€è¦æ”¯æŒBGPçš„è·¯ç”±å™¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å•ç‚¹é—®é¢˜&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æœ‰ï¼ˆä¸€ä¸ªNodeå“åº”ï¼Œæ•…éšœæ—¶åˆ‡æ¢ï¼‰&lt;/td&gt;
&lt;td&gt;æ— ï¼ˆECMPçœŸæ­£çš„è´Ÿè½½å‡è¡¡ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ€§èƒ½&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å—é™äºå•Nodeå¸¦å®½&lt;/td&gt;
&lt;td&gt;æ›´é«˜ï¼Œå¤šNodeåˆ†æ‹…&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å°è§„æ¨¡é›†ç¾¤ã€ç®€å•ç½‘ç»œ&lt;/td&gt;
&lt;td&gt;å¤§è§„æ¨¡é›†ç¾¤ã€ä¼ä¸šç½‘ç»œ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æ•…éšœåˆ‡æ¢&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;~10ç§’&lt;/td&gt;
&lt;td&gt;ç§’çº§&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Layer 2æ¨¡å¼ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;IPæ± ï¼š192.168.100.100-192.168.100.110

åˆ›å»ºç¬¬1ä¸ªLoadBalancer Serviceï¼š
  â†’ MetalLBåˆ†é…ï¼š192.168.100.100
  â†’ Node1çš„Speakerå“åº”è¯¥IPçš„ARPè¯·æ±‚
  â†’ å¤–éƒ¨è®¿é—®192.168.100.100æµé‡å…¨éƒ¨è¿›å…¥Node1
  â†’ Node1çš„kube-proxyè½¬å‘åˆ°Pod

ä¼˜ç‚¹ï¼šç®€å•ï¼Œæ— éœ€é¢å¤–é…ç½®
ç¼ºç‚¹ï¼šå•Nodeå¤„ç†æ‰€æœ‰æµé‡ï¼Œæœ‰å•ç‚¹ç“¶é¢ˆ
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.4 ExternalNameï¼šDNS CNAMEæ˜ å°„&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä»€ä¹ˆæ˜¯ExternalNameï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;ExternalNameæ˜¯ä¸€ç§ç‰¹æ®Šçš„Serviceï¼Œå®ƒä¸é€‰æ‹©Podï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªDNS CNAMEè®°å½•ï¼Œå°†æœåŠ¡åæ˜ å°„åˆ°å¤–éƒ¨åŸŸåã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯1ï¼šè®¿é—®å¤–éƒ¨æœåŠ¡
  åº”ç”¨éœ€è¦è®¿é—®å¤–éƒ¨æ•°æ®åº“ï¼šdb.external.com
  â†’ åˆ›å»ºExternalName ServiceæŒ‡å‘è¯¥åŸŸå
  â†’ åº”ç”¨ä»£ç ä½¿ç”¨Serviceåç§°
  â†’ ä¾¿äºå°†æ¥è¿ç§»åˆ°é›†ç¾¤å†…éƒ¨ï¼ˆåªéœ€ä¿®æ”¹Serviceå®šä¹‰ï¼‰

åœºæ™¯2ï¼šæœåŠ¡è¿ç§»è¿‡æ¸¡æœŸ
  æ—§æœåŠ¡åœ¨é›†ç¾¤å¤–ï¼šold-service.external.com
  â†’ å…ˆç”¨ExternalNameæŒ‡å‘å¤–éƒ¨
  â†’ é€æ­¥è¿ç§»åˆ°K8så†…éƒ¨
  â†’ å®Œæˆåæ”¹ä¸ºClusterIPç±»å‹
  â†’ åº”ç”¨ä»£ç æ— éœ€ä¿®æ”¹

åœºæ™¯3ï¼šè·¨é›†ç¾¤æœåŠ¡å¼•ç”¨
  é›†ç¾¤Aéœ€è¦è®¿é—®é›†ç¾¤Bçš„æœåŠ¡
  â†’ åœ¨é›†ç¾¤Aåˆ›å»ºExternalNameæŒ‡å‘é›†ç¾¤B
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;DNSè§£æå¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ™®é€šServiceï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nslookup nginx-service             â”‚
â”‚  è¿”å›ï¼š10.96.100.50 (ClusterIP)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ExternalName Serviceï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nslookup nginx-external            â”‚
â”‚  è¿”å›ï¼š                              â”‚
â”‚    CNAME db.external.com            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;YAMLç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: nginx-external
spec:
  type: ExternalName
  externalName: mysql.external-domain.com
  # æ³¨æ„ï¼šæ²¡æœ‰selectorï¼Œæ²¡æœ‰ports
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºService
kubectl apply -f nginx-external.yaml

# æŸ¥çœ‹ï¼ˆæ²¡æœ‰ClusterIPï¼‰
kubectl get svc nginx-external
# NAME          TYPE           CLUSTER-IP   EXTERNAL-IP                  PORT(S)   AGE
# nginx-external   ExternalName   &amp;lt;none&amp;gt;       mysql.external-domain.com    &amp;lt;none&amp;gt;    1m

# DNSè§£ææµ‹è¯•
kubectl run test --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- nslookup nginx-external
# Server:    10.96.0.10
# Name:      nginx-external.default.svc.cluster.local
# Address 1: mysql.external-domain.com
#            â†‘ è¿”å›CNAMEï¼Œä¸æ˜¯IP
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹æ€»ç»“ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
  âœ“ ä¾¿äºæœåŠ¡è¿ç§»ï¼ˆå¤–éƒ¨â†’å†…éƒ¨ï¼‰
  âœ“ åº”ç”¨ä»£ç ä½¿ç”¨ç»Ÿä¸€çš„Serviceåç§°
  âœ“ ç¬¦åˆK8sæœåŠ¡å‘ç°æ¨¡å¼

ç¼ºç‚¹ï¼š
  âœ— ä¸æ”¯æŒç«¯å£æ˜ å°„
  âœ— ä¸æä¾›è´Ÿè½½å‡è¡¡
  âœ— ä¾èµ–å¤–éƒ¨DNSè§£æ
  âœ— ä¸ç»è¿‡kube-proxy

æ³¨æ„ï¼šExternalNameä¸åˆ›å»ºEndpointï¼Œçº¯DNSå±‚é¢æ˜ å°„
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.5 Headless Serviceï¼šæ— å¤´æœåŠ¡&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä»€ä¹ˆæ˜¯Headless Serviceï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Headless Serviceæ˜¯ä¸€ç§ç‰¹æ®Šçš„ClusterIP Serviceï¼Œé€šè¿‡è®¾ç½®&lt;code&gt;clusterIP: None&lt;/code&gt;ï¼Œä½¿DNSç›´æ¥è¿”å›Pod IPåˆ—è¡¨ï¼Œè€Œä¸æ˜¯Service IPã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆéœ€è¦Headless Serviceï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ™®é€šServiceçš„é™åˆ¶ï¼š
  - DNSåªè¿”å›Serviceçš„ClusterIP
  - å®¢æˆ·ç«¯æ— æ³•è·çŸ¥åç«¯Podåˆ—è¡¨
  - æ— æ³•ç›´æ¥è¿æ¥ç‰¹å®šPod
  - å¿…é¡»é€šè¿‡Serviceä»£ç†

æŸäº›åº”ç”¨çš„éœ€æ±‚ï¼š
  âœ“ StatefulSetéœ€è¦ç¨³å®šçš„ç½‘ç»œæ ‡è¯†
  âœ“ æ•°æ®åº“ä¸»ä»å¤åˆ¶ï¼ˆéœ€è¦ç›´è¿ç‰¹å®šå®ä¾‹ï¼‰
  âœ“ åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆèŠ‚ç‚¹äº’ç›¸å‘ç°ï¼‰
  âœ“ å®¢æˆ·ç«¯è‡ªå·±åšè´Ÿè½½å‡è¡¡
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;DNSè§£æå¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ™®é€šServiceï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nslookup nginx-service             â”‚
â”‚  è¿”å›ï¼š10.96.100.50 (ClusterIP)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Headless Serviceï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nslookup nginx-headless            â”‚
â”‚  è¿”å›ï¼š                              â”‚
â”‚    10.244.1.10  (Pod1)              â”‚
â”‚    10.244.2.20  (Pod2)              â”‚
â”‚    10.244.3.30  (Pod3)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;YAMLç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: nginx-headless
spec:
  clusterIP: None          # å…³é”®ï¼šè®¾ç½®ä¸ºNone
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;StatefulSet + Headless Serviceï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Headless Service
apiVersion: v1
kind: Service
metadata:
  name: web-headless
spec:
  clusterIP: None
  selector:
    app: web
  ports:
  - port: 80

---
# StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: web
spec:
  serviceName: web-headless    # å…³è”Headless Service
  replicas: 3
  selector:
    matchLabels:
      app: web
  template:
    metadata:
      labels:
        app: web
    spec:
      containers:
      - name: nginx
        image: nginx:1.20
        ports:
        - containerPort: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;DNSå‘½åè§„åˆ™ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;StatefulSet Podçš„DNSæ ¼å¼ï¼š
&amp;lt;pod-name&amp;gt;.&amp;lt;service-name&amp;gt;.&amp;lt;namespace&amp;gt;.svc.cluster.local

ç¤ºä¾‹ï¼š
  web-0.web-headless.default.svc.cluster.local
  web-1.web-headless.default.svc.cluster.local
  web-2.web-headless.default.svc.cluster.local

ç‰¹ç‚¹ï¼š
  âœ“ æ¯ä¸ªPodæœ‰å›ºå®šçš„DNSåç§°
  âœ“ Podé‡å»ºåDNSåç§°ä¸å˜
  âœ“ å¯ä»¥ç›´æ¥è®¿é—®ç‰¹å®šPod
  âœ“ é€‚åˆæœ‰çŠ¶æ€åº”ç”¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºèµ„æº
kubectl apply -f web-headless.yaml

# DNSæµ‹è¯•
kubectl run test --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- \
  nslookup web-headless

kubectl run test --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- \
  nslookup web-0.web-headless

# è®¿é—®ç‰¹å®šPod
kubectl run test --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- \
  nslookup web-0.web-headless
# Address 1: 10.244.1.10
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…¸å‹ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. æœ‰çŠ¶æ€åº”ç”¨ï¼ˆStatefulSetï¼‰
   - MySQLä¸»ä»é›†ç¾¤
   - MongoDBå‰¯æœ¬é›†
   - Redis Cluster
   - Kafkaé›†ç¾¤

2. åˆ†å¸ƒå¼ç³»ç»Ÿ
   - Elasticsearchï¼ˆèŠ‚ç‚¹äº’ç›¸å‘ç°ï¼‰
   - ZooKeeperï¼ˆé€‰ä¸¾å’Œæ•°æ®åŒæ­¥ï¼‰
   - Etcdé›†ç¾¤

3. å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡
   - åº”ç”¨è‡ªå·±é€‰æ‹©Podï¼ˆå¦‚è¯»å†™åˆ†ç¦»ï¼‰
   - æ ¹æ®æ•°æ®åˆ†ç‰‡é€‰æ‹©ç‰¹å®šPod
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.6 Serviceç±»å‹æ€»ç»“å¯¹æ¯”&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç±»å‹&lt;/th&gt;
&lt;th&gt;ClusterIP&lt;/th&gt;
&lt;th&gt;NodePort&lt;/th&gt;
&lt;th&gt;LoadBalancer&lt;/th&gt;
&lt;th&gt;ExternalName&lt;/th&gt;
&lt;th&gt;Headless&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ClusterIP&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;td&gt;None&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;è®¿é—®èŒƒå›´&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…éƒ¨&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…+NodePort&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…+å¤–éƒ¨LB&lt;/td&gt;
&lt;td&gt;è½¬å‘å¤–éƒ¨&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…éƒ¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å¤–éƒ¨è®¿é—®&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DNSè§£æ&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Service IP&lt;/td&gt;
&lt;td&gt;Service IP&lt;/td&gt;
&lt;td&gt;Service IP&lt;/td&gt;
&lt;td&gt;CNAME&lt;/td&gt;
&lt;td&gt;Pod IPåˆ—è¡¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;è´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å†…éƒ¨æœåŠ¡&lt;/td&gt;
&lt;td&gt;å¼€å‘æµ‹è¯•&lt;/td&gt;
&lt;td&gt;ç”Ÿäº§ç¯å¢ƒ&lt;/td&gt;
&lt;td&gt;å¤–éƒ¨æœåŠ¡&lt;/td&gt;
&lt;td&gt;æœ‰çŠ¶æ€åº”ç”¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ä¾èµ–&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;td&gt;äº‘å¹³å°/MetalLB&lt;/td&gt;
&lt;td&gt;å¤–éƒ¨DNS&lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;é€‰æ‹©å»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å†…éƒ¨æœåŠ¡é€šä¿¡ï¼šClusterIPï¼ˆé»˜è®¤ï¼‰
å¿«é€Ÿæš´éœ²æœåŠ¡ï¼ˆæµ‹è¯•ï¼‰ï¼šNodePort
ç”Ÿäº§ç¯å¢ƒå¯¹å¤–æš´éœ²ï¼šLoadBalancerï¼ˆäº‘å¹³å°ï¼‰æˆ– Ingress
è®¿é—®å¤–éƒ¨æœåŠ¡ï¼šExternalName
æœ‰çŠ¶æ€åº”ç”¨ï¼šHeadless + StatefulSet
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;3. Serviceå®æˆ˜æ“ä½œ&lt;/h3&gt;
&lt;h4&gt;3.1 å°†kube-proxyåˆ‡æ¢åˆ°IPVSæ¨¡å¼&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£…IPVSæ¨¡å—(è‹¥æœªå®‰è£…)ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨masterã€node1ã€node2ä¸Šæ‰§è¡Œ

# åŠ è½½IPVSå†…æ ¸æ¨¡å—
modprobe -- ip_vs
modprobe -- ip_vs_rr
modprobe -- ip_vs_wrr
modprobe -- ip_vs_sh
modprobe -- nf_conntrack

# éªŒè¯
lsmod | grep -e ip_vs -e nf_conntrack

# è®¾ç½®å¼€æœºè‡ªåŠ¨åŠ è½½
cat &amp;gt; /etc/modules-load.d/ipvs.conf &amp;lt;&amp;lt;EOF
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
EOF

# å®‰è£…ipvsadmå·¥å…·
yum install -y ipvsadm ipset
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¿®æ”¹kube-proxyé…ç½®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç¼–è¾‘ConfigMap
kubectl edit configmap kube-proxy -n kube-system

# æ‰¾åˆ°modeå­—æ®µï¼Œä¿®æ”¹ä¸ºï¼š
mode: &quot;ipvs&quot;
ipvs:
  scheduler: &quot;rr&quot;  # è½®è¯¢ç®—æ³•
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é‡å¯kube-proxyï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ é™¤æ‰€æœ‰kube-proxy Podï¼Œè®©å…¶è‡ªåŠ¨é‡å»º
kubectl delete pod -n kube-system -l k8s-app=kube-proxy

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -n kube-system | grep kube-proxy
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;éªŒè¯IPVSæ¨¡å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨é›†ç¾¤æœºå™¨ä¸ŠæŸ¥çœ‹IPVSè§„åˆ™
ipvsadm -Ln

# æŸ¥çœ‹kube-proxyæ—¥å¿—
kubectl logs -n kube-system &amp;lt;kube-proxy-pod-name&amp;gt; | grep -i ipvs
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.2 å®éªŒå‡†å¤‡:æ”¹é€ nginxé•œåƒæ”¯æŒé€šè¿‡Serviceåç§°è®¿é—®æ•°æ®åº“&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆè¦è¿™æ ·åš?&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨ç”Ÿäº§ç¯å¢ƒä¸­,æˆ‘ä»¬&lt;strong&gt;ç»ä¸åº”è¯¥&lt;/strong&gt;åœ¨åº”ç”¨ä¸­ç¡¬ç¼–ç æ•°æ®åº“çš„IPåœ°å€ã€‚åŸå› å¾ˆç®€å•:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Podçš„IPæ˜¯åŠ¨æ€å˜åŒ–çš„,Podé‡å¯åIPä¼šæ”¹å˜&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨Serviceåç§°å¯ä»¥å®ç°æœåŠ¡å‘ç°,K8sçš„DNSä¼šè‡ªåŠ¨è§£æ&lt;/li&gt;
&lt;li&gt;è¿™æ˜¯äº‘åŸç”Ÿåº”ç”¨çš„æœ€ä½³å®è·µ&lt;/li&gt;
&lt;/ul&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1:åˆ›å»ºæ”¯æŒç¯å¢ƒå˜é‡é…ç½®çš„PHPåº”ç”¨(åœ¨harboræœºå™¨)&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd /root/k8s-demo/nginx

# åˆ›å»ºæ–°ç‰ˆæœ¬çš„index.php
cat &amp;gt; index.php &amp;lt;&amp;lt;&apos;EOF&apos;
&amp;lt;?php
header(&apos;Content-Type: text/plain; charset=utf-8&apos;);  

// ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®(ç”Ÿäº§æœ€ä½³å®è·µ)
$db_host = getenv(&apos;DB_HOST&apos;) ?: &apos;localhost&apos;;
$db_user = getenv(&apos;DB_USER&apos;) ?: &apos;root&apos;;
$db_pass = getenv(&apos;DB_PASS&apos;) ?: &apos;&apos;;
$db_name = getenv(&apos;DB_NAME&apos;) ?: &apos;testdb&apos;;

echo &quot;=== Nginx-PHP Container Info ===&quot;.&quot;\\n&quot;;
echo &quot;nginx v2&quot;\\n&quot;;
echo &quot;Hostname: &quot; . gethostname() . &quot;\\n&quot;;
echo &quot;Server IP: &quot; . $_SERVER[&apos;SERVER_ADDR&apos;] . &quot;\\n&quot;;
echo &quot;\\n&quot;;
echo &quot;=== Database Configuration ===&quot;.&quot;\\n&quot;;
echo &quot;DB Host: $db_host\\n&quot;;
echo &quot;DB User: $db_user\\n&quot;;
echo &quot;DB Name: $db_name\\n&quot;;
echo &quot;\\n&quot;;
echo &quot;=== Database Connection Test ===&quot;.&quot;\\n&quot;;

// å°è¯•è¿æ¥æ•°æ®åº“
$conn = @new mysqli($db_host, $db_user, $db_pass, $db_name);
if ($conn-&amp;gt;connect_error) {
    echo &quot;Connection FAILED: &quot; . $conn-&amp;gt;connect_error . &quot;\\n&quot;;
} else {
    echo &quot;Database connected successfully!\\n&quot;;
    echo &quot;MySQL Version: &quot; . $conn-&amp;gt;server_info . &quot;\\n&quot;;
    $conn-&amp;gt;close();
}
?&amp;gt;
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è¿™æ®µä»£ç åšäº†ä»€ä¹ˆ?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;getenv(&apos;DB_HOST&apos;)&lt;/code&gt;:ä»ç¯å¢ƒå˜é‡è¯»å–æ•°æ®åº“åœ°å€,è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¼ å…¥Serviceåç§°&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;code&gt;@&lt;/code&gt;ç¬¦å·æŠ‘åˆ¶è¿æ¥é”™è¯¯,æ”¹ä¸ºå‹å¥½æç¤º&lt;/li&gt;
&lt;li&gt;è¾“å‡ºæ¸…æ™°çš„ä¿¡æ¯,æ–¹ä¾¿è°ƒè¯•&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2:æ„å»ºå¹¶æ¨é€æ–°é•œåƒ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ„å»ºé•œåƒ(ä½¿ç”¨ä¹‹å‰çš„Dockerfile)
docker build -t reg.westos.org/library/nginx-php:v2 .

# æ¨é€åˆ°ç§æœ‰ä»“åº“
docker push reg.westos.org/library/nginx-php:v2

# éªŒè¯é•œåƒå·²æ¨é€
docker images | grep nginx-php
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.3 å®éªŒ:ä½¿ç”¨Podæ¼”ç¤ºå„ç±»Service&lt;/h4&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒç›®æ ‡:&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç†è§£ ClusterIPã€NodePortã€LoadBalancerã€Headless å››ç§Serviceç±»å‹çš„åŒºåˆ«&lt;/li&gt;
&lt;li&gt;æŒæ¡é€šè¿‡Serviceåç§°å®ç°æœåŠ¡å‘ç°çš„æ–¹æ³•&lt;/li&gt;
&lt;li&gt;å­¦ä¼šä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®åº”ç”¨&lt;/li&gt;
&lt;/ol&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒæ¶æ„:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Service Types                       â”‚
â”‚                                                     â”‚
â”‚  Nginx Pods  â”€â”€â†’  MySQL Pod                         â”‚
â”‚  (é€šè¿‡Serviceåç§°è®¿é—®æ•°æ®åº“)                         â”‚
â”‚                                                     â”‚
â”‚  ClusterIP    : é›†ç¾¤å†…éƒ¨è®¿é—®                        â”‚
â”‚  NodePort     : æš´éœ²åˆ°èŠ‚ç‚¹ç«¯å£                      â”‚
â”‚  LoadBalancer : äº‘å¹³å°è´Ÿè½½å‡è¡¡(å¯é€‰)                â”‚
â”‚  Headless     : DNSç›´æ¥è§£æåˆ°Pod IP                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h5&gt;å®éªŒ1:ClusterIP Service - é›†ç¾¤å†…éƒ¨è®¿é—®æ•°æ®åº“&lt;/h5&gt;
&lt;p&gt;&lt;strong&gt;è¿™æ˜¯ä»€ä¹ˆ?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ClusterIPæ˜¯é»˜è®¤çš„Serviceç±»å‹&lt;/li&gt;
&lt;li&gt;ä¸ºServiceåˆ†é…ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„è™šæ‹ŸIP(åªèƒ½åœ¨é›†ç¾¤å†…è®¿é—®)&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰è®¿é—®è¿™ä¸ªIPçš„æµé‡ä¼šè¢«è´Ÿè½½å‡è¡¡åˆ°åç«¯Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ•°æ®åº“ã€ç¼“å­˜ç­‰åç«¯æœåŠ¡&lt;/li&gt;
&lt;li&gt;å¾®æœåŠ¡ä¹‹é—´çš„å†…éƒ¨è°ƒç”¨&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1:åˆ›å»ºMySQL Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd /root/k8s-yaml

# åˆ›å»ºMySQL Podé…ç½®æ–‡ä»¶
cat &amp;gt; mysql-pod.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
  labels:
	# é‡è¦!Serviceé€šè¿‡è¿™ä¸ªæ ‡ç­¾æ‰¾åˆ°Pod
    app: mysql        
    tier: backend
spec:
  containers:
  - name: mysql
    image: reg.westos.org/library/mysql:8.0
    ports:
    - containerPort: 3306
      name: mysql
    env:
    - name: MYSQL_ROOT_PASSWORD
      value: &quot;Westos123&quot;
    - name: MYSQL_DATABASE
      value: &quot;testdb&quot;
    # å¥åº·æ£€æŸ¥
    livenessProbe:
      tcpSocket:
        port: 3306
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      exec:
        command:
        - sh
        - -c
        - &quot;mysqladmin ping -u root -p\${MYSQL_ROOT_PASSWORD}&quot;
      initialDelaySeconds: 10
      periodSeconds: 5
EOF

# åˆ›å»ºPod
kubectl apply -f mysql-pod.yaml

# æŸ¥çœ‹PodçŠ¶æ€(ç­‰å¾…Running)
kubectl get pods -l app=mysql
kubectl get pods mysql-pod -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å‚æ•°è¯¦è§£:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;labels: app: mysql&lt;/code&gt;:ç»™Podæ‰“æ ‡ç­¾,Serviceä¼šé€šè¿‡selectoré€‰æ‹©è¿™ä¸ªæ ‡ç­¾&lt;/li&gt;
&lt;li&gt;&lt;code&gt;containerPort: 3306&lt;/code&gt;:å£°æ˜å®¹å™¨ç›‘å¬çš„ç«¯å£&lt;/li&gt;
&lt;li&gt;&lt;code&gt;livenessProbe&lt;/code&gt;:å­˜æ´»æ¢é’ˆ,æ£€æµ‹MySQLè¿›ç¨‹æ˜¯å¦å­˜åœ¨&lt;/li&gt;
&lt;li&gt;&lt;code&gt;readinessProbe&lt;/code&gt;:å°±ç»ªæ¢é’ˆ,æ£€æµ‹MySQLæ˜¯å¦å¯ä»¥æ¥å—è¿æ¥&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2:åˆ›å»ºClusterIP Service&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºServiceé…ç½®æ–‡ä»¶
cat &amp;gt; mysql-service.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  type: ClusterIP        
  selector:
    app: mysql           
  ports:
  - port: 3306           
    targetPort: 3306     
    protocol: TCP
    name: mysql
EOF

# åˆ›å»ºService
kubectl apply -f mysql-service.yaml

# æŸ¥çœ‹Serviceè¯¦ç»†ä¿¡æ¯
kubectl get svc mysql-service
kubectl describe svc mysql-service

# æŸ¥çœ‹Endpoints(Serviceä¼šè‡ªåŠ¨å‘ç°åç«¯Pod)
kubectl get endpoints mysql-service
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å‚æ•°è¯¦è§£:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;selector: app: mysql&lt;/code&gt;:é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨,Serviceè‡ªåŠ¨å‘ç°åŒ¹é…çš„Pod&lt;/li&gt;
&lt;li&gt;&lt;code&gt;port: 3306&lt;/code&gt;:Serviceå¯¹å¤–æš´éœ²çš„ç«¯å£(åˆ«äººè®¿é—®Serviceç”¨è¿™ä¸ªç«¯å£)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;targetPort: 3306&lt;/code&gt;:Podå®é™…ç›‘å¬çš„ç«¯å£(æµé‡è½¬å‘åˆ°Podçš„è¿™ä¸ªç«¯å£)&lt;/li&gt;
&lt;li&gt;Endpoints:Serviceè‡ªåŠ¨åˆ›å»º,è®°å½•æ‰€æœ‰åŒ¹é…Podçš„IPå’Œç«¯å£&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆä¼šè‡ªåŠ¨å…³è”?&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. Podæœ‰æ ‡ç­¾:app=mysql
2. Serviceæœ‰é€‰æ‹©å™¨:selector: app=mysql
3. K8sè‡ªåŠ¨åŒ¹é…:Serviceå‘ç°æ‰€æœ‰å¸¦app=mysqlæ ‡ç­¾çš„Pod
4. åˆ›å»ºEndpoints:è®°å½•Podçš„IP:Portåˆ—è¡¨
5. é…ç½®è´Ÿè½½å‡è¡¡:kube-proxyé…ç½®iptables/ipvsè§„åˆ™
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3:æµ‹è¯•Serviceçš„DNSè§£æ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æµ‹è¯•DNSè§£æ(Serviceåç§° â†’ IP)
kubectl run test-dns --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- \
  nslookup mysql-service

# é¢„æœŸè¾“å‡º:
# Server:    10.96.0.10
# Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
# 
# Name:      mysql-service
# Address 1: 10.96.100.10 mysql-service.default.svc.cluster.local

# æµ‹è¯•å®Œæ•´åŸŸå
kubectl run test-dns --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- \
  nslookup mysql-service.default.svc.cluster.local
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;DNSè§£æè§„åˆ™:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨K8sé›†ç¾¤ä¸­,Serviceæœ‰å¤šç§DNSåç§°å½¢å¼:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;çŸ­åç§°(åŒnamespace):  mysql-service
å¸¦namespace :          mysql-service.default
å®Œæ•´åŸŸå(FQDN):        mysql-service.default.svc.cluster.local
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4:æµ‹è¯•æ•°æ®åº“è¿æ¥&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä½¿ç”¨MySQLå®¢æˆ·ç«¯æµ‹è¯•è¿æ¥
kubectl run mysql-client --image=reg.westos.org/library/mysql:8.0 --rm -it --restart=Never -- \
  mysql -h mysql-service -uroot -pWestos123 -e &quot;SELECT version();&quot;

# é¢„æœŸè¾“å‡º:
# +-----------+
# | version() |
# +-----------+
# | 8.0.x     |
# +-----------+
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç»„åˆè¿ç”¨:è¿™ä¸ªå®éªŒå±•ç¤ºäº†ä»€ä¹ˆ?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ… Podé€šè¿‡æ ‡ç­¾å’ŒServiceå…³è”&lt;/li&gt;
&lt;li&gt;âœ… Serviceæä¾›ç¨³å®šçš„è®¿é—®å…¥å£(åç§°å’ŒIPä¸å˜)&lt;/li&gt;
&lt;li&gt;âœ… DNSè‡ªåŠ¨è§£æServiceåç§°åˆ°ClusterIP&lt;/li&gt;
&lt;li&gt;âœ… åç«¯Podå¯ä»¥åŠ¨æ€å˜åŒ–,Serviceè‡ªåŠ¨æ›´æ–°Endpoints&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h5&gt;å®éªŒ2:NodePort Service - é€šè¿‡Serviceåç§°è®¿é—®æ•°æ®åº“&lt;/h5&gt;
&lt;p&gt;&lt;strong&gt;è¿™æ˜¯ä»€ä¹ˆ?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;NodePortåœ¨ClusterIPçš„åŸºç¡€ä¸Š,é¢å¤–åœ¨æ¯ä¸ªNodeä¸Šå¼€æ”¾ä¸€ä¸ªç«¯å£(30000-32767)&lt;/li&gt;
&lt;li&gt;å¯ä»¥é€šè¿‡&lt;code&gt;&amp;lt;NodeIP&amp;gt;:&amp;lt;NodePort&amp;gt;&lt;/code&gt;ä»é›†ç¾¤å¤–éƒ¨è®¿é—®Service&lt;/li&gt;
&lt;li&gt;æµé‡è·¯å¾„:å¤–éƒ¨ â†’ NodePort â†’ Service â†’ Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¼€å‘æµ‹è¯•ç¯å¢ƒå¿«é€Ÿæš´éœ²æœåŠ¡&lt;/li&gt;
&lt;li&gt;æ²¡æœ‰LoadBalancerçš„ç¯å¢ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1:åˆ›å»ºNginx Pod(é€šè¿‡Serviceåç§°è¿æ¥MySQL)&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºé…ç½®æ–‡ä»¶
cat &amp;gt; nginx-pod-1.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod-1
  labels:
    app: nginx
    version: v2
spec:
  containers:
  - name: nginx-php
    image: reg.westos.org/library/nginx-php:v2
    ports:
    - containerPort: 80
    env:
    # å…³é”®!ä½¿ç”¨Serviceåç§°è€Œä¸æ˜¯IP
    - name: DB_HOST
      value: &quot;mysql-service&quot;    # â† è¿™é‡Œä½¿ç”¨Serviceåç§°!
    - name: DB_USER
      value: &quot;root&quot;
    - name: DB_PASS
      value: &quot;Westos123&quot;
    - name: DB_NAME
      value: &quot;testdb&quot;
    # å¥åº·æ£€æŸ¥
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 3
EOF

# åº”ç”¨é…ç½®
kubectl apply -f nginx-pod-1.yaml

# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods nginx-pod-1 -o wide

# æŸ¥çœ‹Podæ—¥å¿—(æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯)
kubectl logs nginx-pod-1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é‡ç‚¹ç†è§£:ç¯å¢ƒå˜é‡çš„ä½œç”¨&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;env:
- name: DB_HOST
  value: &quot;mysql-service&quot;   # PHPä»£ç ä¸­ getenv(&apos;DB_HOST&apos;) ä¼šè¯»åˆ°è¿™ä¸ªå€¼
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¿™æ ·é…ç½®å:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;PHPåº”ç”¨å¯åŠ¨æ—¶,ç¯å¢ƒå˜é‡ &lt;code&gt;DB_HOST&lt;/code&gt; = &quot;mysql-service&quot;&lt;/li&gt;
&lt;li&gt;ä»£ç æ‰§è¡Œ &lt;code&gt;new mysqli($db_host, ...)&lt;/code&gt; æ—¶,ä¼šè¿æ¥åˆ° &quot;mysql-service&quot;&lt;/li&gt;
&lt;li&gt;K8sçš„DNSæŠŠ &quot;mysql-service&quot; è§£æä¸ºServiceçš„ClusterIP&lt;/li&gt;
&lt;li&gt;ServiceæŠŠæµé‡è½¬å‘åˆ°MySQL Pod&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2:åˆ›å»ºæ›´å¤šNginx Pod(æ¨¡æ‹Ÿå¤šå‰¯æœ¬)&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºç¬¬2ä¸ªPod
cat &amp;gt; nginx-pod-2.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod-2
  labels:
    app: nginx
    version: v2
spec:
  containers:
  - name: nginx-php
    image: reg.westos.org/library/nginx-php:v2
    ports:
    - containerPort: 80
    env:
    - name: DB_HOST
      value: &quot;mysql-service&quot;
    - name: DB_USER
      value: &quot;root&quot;
    - name: DB_PASS
      value: &quot;Westos123&quot;
    - name: DB_NAME
      value: &quot;testdb&quot;
EOF

# åˆ›å»ºç¬¬3ä¸ªPod
cat &amp;gt; nginx-pod-3.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod-3
  labels:
    app: nginx
    version: v2
spec:
  containers:
  - name: nginx-php
    image: reg.westos.org/library/nginx-php:v2
    ports:
    - containerPort: 80
    env:
    - name: DB_HOST
      value: &quot;mysql-service&quot;
    - name: DB_USER
      value: &quot;root&quot;
    - name: DB_PASS
      value: &quot;Westos123&quot;
    - name: DB_NAME
      value: &quot;testdb&quot;
EOF

# åº”ç”¨é…ç½®
kubectl apply -f nginx-pod-2.yaml
kubectl apply -f nginx-pod-3.yaml

# æŸ¥çœ‹æ‰€æœ‰Nginx Pod
kubectl get pods -l app=nginx -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3:åˆ›å»ºNodePort Service&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºé…ç½®æ–‡ä»¶
cat &amp;gt; nginx-nodeport.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-nodeport
spec:
  type: NodePort           # æŒ‡å®šä¸ºNodePortç±»å‹
  selector:
    app: nginx             # é€‰æ‹©æ‰€æœ‰app=nginxçš„Pod
  ports:
  - port: 80               # Serviceç«¯å£
    targetPort: 80         # Podç«¯å£
    nodePort: 30080        # Nodeç«¯å£(30000-32767)
    protocol: TCP
    name: http
EOF

# åº”ç”¨é…ç½®
kubectl apply -f nginx-nodeport.yaml

# æŸ¥çœ‹Service
kubectl get svc nginx-nodeport
# è¾“å‡ºç¤ºä¾‹:
# NAME             TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
# nginx-nodeport   NodePort   10.96.200.100   &amp;lt;none&amp;gt;        80:30080/TCP   10s

# æŸ¥çœ‹Endpoints(åº”è¯¥çœ‹åˆ°3ä¸ªPod)
kubectl get endpoints nginx-nodeport
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å‚æ•°è¯¦è§£:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;type: NodePort&lt;/code&gt;:åœ¨ClusterIPåŸºç¡€ä¸Š,é¢å¤–æš´éœ²NodePort&lt;/li&gt;
&lt;li&gt;&lt;code&gt;nodePort: 30080&lt;/code&gt;:æŒ‡å®šNodeç«¯å£(ä¸æŒ‡å®šåˆ™è‡ªåŠ¨åˆ†é…30000-32767èŒƒå›´å†…çš„ç«¯å£)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;port: 80&lt;/code&gt;:ClusterIPçš„ç«¯å£&lt;/li&gt;
&lt;li&gt;&lt;code&gt;targetPort: 80&lt;/code&gt;:Podçš„ç«¯å£&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;è®¿é—®è·¯å¾„ç†è§£:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨å®¢æˆ·ç«¯
   â†“
192.168.100.21:30080 (Node1çš„30080ç«¯å£)
   â†“
iptables/ipvsè§„åˆ™
   â†“
nginx-nodeport Service (ClusterIP: 10.96.200.100:80)
   â†“
è´Ÿè½½å‡è¡¡åˆ°å…¶ä¸­ä¸€ä¸ªPod
   â†“
nginx-pod-1 (10.244.1.10:80)
nginx-pod-2 (10.244.2.20:80)
nginx-pod-3 (10.244.1.30:80)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4:æµ‹è¯•è®¿é—®å’Œè´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä»é›†ç¾¤å¤–éƒ¨è®¿é—®(å¯ä»¥ä½¿ç”¨ä»»æ„Nodeçš„IP)
curl http://192.168.100.21:30080
curl http://192.168.100.22:30080
curl http://192.168.100.20:30080

# å¤šæ¬¡è®¿é—®,è§‚å¯Ÿè´Ÿè½½å‡è¡¡æ•ˆæœ(Hostnameä¼šå˜åŒ–)
for i in {1..6}; do
  echo &quot;=== Request $i ===&quot;
  curl -s http://192.168.100.21:30080 | grep &quot;Hostname:&quot;
  echo &quot;&quot;
done

# é¢„æœŸè¾“å‡º:
# === Request 1 ===
# Hostname: nginx-pod-1
# === Request 2 ===
# Hostname: nginx-pod-3
# === Request 3 ===
# Hostname: nginx-pod-2
# ...
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è§‚å¯Ÿæ•°æ®åº“è¿æ¥:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹å®Œæ•´è¾“å‡º
curl http://192.168.100.21:30080

# é¢„æœŸè¾“å‡º:
# === Nginx-PHP Container Info ===
# Hostname: nginx-pod-1
# Server IP: 10.244.1.10
# 
# === Database Configuration ===
# DB Host: mysql-service
# DB User: root
# DB Name: testdb
# 
# === Database Connection Test ===
# Database connected successfully!
# MySQL Version: 8.0.x
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒéªŒè¯:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ… å¤–éƒ¨å¯ä»¥é€šè¿‡NodePortè®¿é—®æœåŠ¡&lt;/li&gt;
&lt;li&gt;âœ… æµé‡è‡ªåŠ¨è´Ÿè½½å‡è¡¡åˆ°3ä¸ªNginx Pod&lt;/li&gt;
&lt;li&gt;âœ… Nginx Podé€šè¿‡Serviceåç§°æˆåŠŸè®¿é—®MySQL&lt;/li&gt;
&lt;li&gt;âœ… å³ä½¿MySQL Podé‡å¯IPå˜åŒ–,è¿æ¥ä¾ç„¶æ­£å¸¸&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤5:éªŒè¯Serviceåç§°çš„ä¼˜åŠ¿&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹MySQL Podå½“å‰IP
kubectl get pod mysql-pod -o wide
# å‡è®¾IPæ˜¯: 10.244.1.5

# åˆ é™¤å¹¶é‡å»ºMySQL Pod(æ¨¡æ‹ŸPodé‡å¯)
kubectl delete pod mysql-pod
kubectl apply -f mysql-pod.yaml

# ç­‰å¾…Podå°±ç»ª
kubectl get pods mysql-pod -o wide
# æ–°IPå¯èƒ½æ˜¯: 10.244.2.15 (IPå·²æ”¹å˜!)

# å†æ¬¡è®¿é—®Nginx,æ•°æ®åº“è¿æ¥ä¾ç„¶æ­£å¸¸!
curl http://192.168.100.21:30080

# åŸå› :Nginxä½¿ç”¨çš„æ˜¯&quot;mysql-service&quot;åç§°,ä¸æ˜¯IP
# Serviceä¼šè‡ªåŠ¨æ›´æ–°EndpointsæŒ‡å‘æ–°Pod
kubectl get endpoints mysql-service
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®ç‚¹ç†è§£:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¦‚æœç¡¬ç¼–ç IP:
  Nginx â†’ 10.244.1.5 (æ—§IP) â†’ è¿æ¥å¤±è´¥ âŒ

ä½¿ç”¨Serviceåç§°:
  Nginx â†’ mysql-service â†’ DNSè§£æ â†’ Service ClusterIP â†’ 10.244.2.15 (æ–°IP) â†’ è¿æ¥æˆåŠŸ âœ…
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h5&gt;å®éªŒ3:LoadBalancer Service - äº‘å¹³å°è´Ÿè½½å‡è¡¡å™¨&lt;/h5&gt;
&lt;p&gt;&lt;strong&gt;è¿™æ˜¯ä»€ä¹ˆ?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LoadBalanceråœ¨NodePortåŸºç¡€ä¸Š,è¿›ä¸€æ­¥åˆ›å»ºäº‘å¹³å°çš„è´Ÿè½½å‡è¡¡å™¨&lt;/li&gt;
&lt;li&gt;åˆ†é…ä¸€ä¸ªå¤–éƒ¨å¯è®¿é—®çš„IPåœ°å€&lt;/li&gt;
&lt;li&gt;é€‚ç”¨äºå…¬æœ‰äº‘ç¯å¢ƒ(AWS ELBã€Azure LBã€GCP LBç­‰)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç”Ÿäº§ç¯å¢ƒå¯¹å¤–æä¾›æœåŠ¡&lt;/li&gt;
&lt;li&gt;éœ€è¦å›ºå®šçš„å¤–éƒ¨IPå’Œæ›´å¥½çš„è´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ³¨æ„:&lt;/strong&gt; æœ¬åœ°ç¯å¢ƒæˆ–ç§æœ‰äº‘é»˜è®¤ä¸æ”¯æŒLoadBalancer,å¯ä»¥ä½¿ç”¨MetalLBå®ç°ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºLoadBalancer Service:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; nginx-loadbalancer.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-loadbalancer
spec:
  type: LoadBalancer      # æŒ‡å®šä¸ºLoadBalancerç±»å‹
  selector:
    app: nginx
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
EOF

# åº”ç”¨é…ç½®
kubectl apply -f nginx-loadbalancer.yaml

# æŸ¥çœ‹Service
kubectl get svc nginx-loadbalancer

# åœ¨äº‘å¹³å°ä¸Š,EXTERNAL-IPä¼šæ˜¾ç¤ºåˆ†é…çš„å…¬ç½‘IP
# NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)        AGE
# nginx-loadbalancer     LoadBalancer   10.96.200.200   1.2.3.4         80:31234/TCP   1m

# æœ¬åœ°ç¯å¢ƒä¼šæ˜¾ç¤º&amp;lt;pending&amp;gt;,å› ä¸ºæ²¡æœ‰äº‘å¹³å°è´Ÿè½½å‡è¡¡å™¨
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è®¿é—®æ–¹å¼:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# äº‘å¹³å°ç¯å¢ƒ:é€šè¿‡EXTERNAL-IPè®¿é—®
curl http://&amp;lt;EXTERNAL-IP&amp;gt;

# æœ¬åœ°ç¯å¢ƒ:ä»ç„¶å¯ä»¥é€šè¿‡NodePortè®¿é—®
curl http://192.168.100.21:31234
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;LoadBalancer vs NodePort vs ClusterIP:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;LoadBalancer = ClusterIP + NodePort + äº‘å¹³å°LB
   â†“
å¤–éƒ¨LB (1.2.3.4:80) â†’ NodePort (ä»»æ„Node:31234) â†’ Service (ClusterIP) â†’ Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h5&gt;å®éªŒ4:Headless Service - DNSç›´æ¥è§£æåˆ°Pod IP&lt;/h5&gt;
&lt;p&gt;&lt;strong&gt;è¿™æ˜¯ä»€ä¹ˆ?&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Headless Serviceä¸åˆ†é…ClusterIP(&lt;code&gt;clusterIP: None&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;DNSç›´æ¥è¿”å›æ‰€æœ‰åç«¯Podçš„IPåˆ—è¡¨,è€Œä¸æ˜¯Service IP&lt;/li&gt;
&lt;li&gt;å®¢æˆ·ç«¯å¯ä»¥ç›´æ¥è¿æ¥åˆ°Pod,å®ç°å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœ‰çŠ¶æ€åº”ç”¨(StatefulSet)éœ€è¦è®¿é—®ç‰¹å®šPod&lt;/li&gt;
&lt;li&gt;å®¢æˆ·ç«¯éœ€è¦çŸ¥é“æ‰€æœ‰Podçš„IP(å¦‚æ•°æ®åº“ä¸»ä»ã€Redisé›†ç¾¤)&lt;/li&gt;
&lt;li&gt;è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1:åˆ›å»ºæµ‹è¯•ç”¨çš„Web Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»º3ä¸ªæµ‹è¯•Pod
cat &amp;gt; web-pods.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: web-pod-1
  labels:
    app: web
    role: backend
spec:
  containers:
  - name: nginx
    image: nginx:1.20
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: web-pod-2
  labels:
    app: web
    role: backend
spec:
  containers:
  - name: nginx
    image: nginx:1.20
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: web-pod-3
  labels:
    app: web
    role: backend
spec:
  containers:
  - name: nginx
    image: nginx:1.20
    ports:
    - containerPort: 80
EOF

# åº”ç”¨é…ç½®
kubectl apply -f web-pods.yaml

# æŸ¥çœ‹PodåŠå…¶IP
kubectl get pods -l app=web -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2:åˆ›å»ºHeadless Service&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; web-headless.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: web-headless
spec:
  clusterIP: None    # å…³é”®!è®¾ç½®ä¸ºNoneè¡¨ç¤ºHeadless
  selector:
    app: web
  ports:
  - port: 80
    targetPort: 80
EOF

# åº”ç”¨é…ç½®
kubectl apply -f web-headless.yaml

# æŸ¥çœ‹Service(æ³¨æ„CLUSTER-IPæ˜¯None)
kubectl get svc web-headless
# NAME           TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
# web-headless   ClusterIP   None         &amp;lt;none&amp;gt;        80/TCP    5s
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3:æµ‹è¯•DNSè§£æ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# DNSè§£æ(è¿”å›æ‰€æœ‰Podçš„IP,è€Œä¸æ˜¯Service IP)
kubectl run test-dns --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- \
  nslookup web-headless

# é¢„æœŸè¾“å‡º:
# Server:    10.96.0.10
# Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local
#
# Name:      web-headless
# Address 1: 10.244.1.20 web-pod-1.web-headless.default.svc.cluster.local
# Address 2: 10.244.2.30 web-pod-2.web-headless.default.svc.cluster.local
# Address 3: 10.244.1.40 web-pod-3.web-headless.default.svc.cluster.local
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Headless vs æ™®é€šServiceçš„DNSå¯¹æ¯”:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ™®é€šClusterIP Service:
  nslookup mysql-service
  â†’ è¿”å›: 10.96.100.10 (Serviceçš„ClusterIP)

Headless Service:
  nslookup web-headless
  â†’ è¿”å›: 10.244.1.20, 10.244.2.30, 10.244.1.40 (æ‰€æœ‰Podçš„IP)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤4:ç›´æ¥è®¿é—®ç‰¹å®šPod(StatefulSetåœºæ™¯)&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Headless Serviceå¸¸ä¸StatefulSeté…åˆä½¿ç”¨
# æ¯ä¸ªPodæœ‰å›ºå®šçš„DNSåç§°: &amp;lt;pod-name&amp;gt;.&amp;lt;service-name&amp;gt;

# ç¤ºä¾‹:å‡è®¾æˆ‘ä»¬æœ‰StatefulSetåˆ›å»ºçš„Pod
# web-0, web-1, web-2
# å¯ä»¥é€šè¿‡ä»¥ä¸‹DNSç›´æ¥è®¿é—®:
# web-0.web-headless.default.svc.cluster.local
# web-1.web-headless.default.svc.cluster.local
# web-2.web-headless.default.svc.cluster.local

# æµ‹è¯•(è™½ç„¶æˆ‘ä»¬ç”¨çš„æ˜¯æ™®é€šPod,ä½†åŸç†ç›¸åŒ)
kubectl run test --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- \
  wget -qO- web-pod-1.web-headless
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒæ€»ç»“:&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ… Headless Serviceä¸åˆ†é…ClusterIP&lt;/li&gt;
&lt;li&gt;âœ… DNSè¿”å›æ‰€æœ‰Podçš„IPåˆ—è¡¨&lt;/li&gt;
&lt;li&gt;âœ… é€‚åˆå®¢æˆ·ç«¯è‡ªå·±é€‰æ‹©è¦è¿æ¥çš„Pod&lt;/li&gt;
&lt;li&gt;âœ… StatefulSetä¸­æ¯ä¸ªPodæœ‰å›ºå®šçš„DNSåç§°&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ¸…ç†å®éªŒèµ„æº:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ¸…ç†Nginx Podå’ŒService
kubectl delete pod nginx-pod-1 nginx-pod-2 nginx-pod-3
kubectl delete svc nginx-nodeport nginx-loadbalancer

# æ¸…ç†Web Podå’ŒService
kubectl delete pod web-pod-1 web-pod-2 web-pod-3
kubectl delete svc web-headless

# ä¿ç•™MySQL Podå’ŒServiceä¾›åç»­å®éªŒä½¿ç”¨
# kubectl delete pod mysql-pod
# kubectl delete svc mysql-service
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.4 Serviceå®éªŒæ€»ç»“ä¸æœ€ä½³å®è·µ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å››ç§Serviceç±»å‹å¯¹æ¯”:&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;ClusterIP&lt;/th&gt;
&lt;th&gt;NodePort&lt;/th&gt;
&lt;th&gt;LoadBalancer&lt;/th&gt;
&lt;th&gt;Headless&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ClusterIP&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;None&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;è®¿é—®èŒƒå›´&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…éƒ¨&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…+NodePort&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…+å¤–éƒ¨LB&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…éƒ¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å¤–éƒ¨è®¿é—®&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;DNSè§£æ&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Service IP&lt;/td&gt;
&lt;td&gt;Service IP&lt;/td&gt;
&lt;td&gt;Service IP&lt;/td&gt;
&lt;td&gt;Pod IPåˆ—è¡¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;è´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ—(å®¢æˆ·ç«¯)&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å†…éƒ¨æœåŠ¡&lt;/td&gt;
&lt;td&gt;å¼€å‘æµ‹è¯•&lt;/td&gt;
&lt;td&gt;ç”Ÿäº§ç¯å¢ƒ&lt;/td&gt;
&lt;td&gt;æœ‰çŠ¶æ€åº”ç”¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ä¾èµ–&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;td&gt;äº‘å¹³å°&lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§æœ€ä½³å®è·µ:&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æœåŠ¡å‘ç° - æ°¸è¿œä½¿ç”¨Serviceåç§°&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# âœ… æ­£ç¡®
env:
- name: DB_HOST
  value: &quot;mysql-service&quot;

# âŒ é”™è¯¯
env:
- name: DB_HOST
  value: &quot;10.244.1.5&quot;  # ç¡¬ç¼–ç IPä¼šåœ¨Podé‡å¯åå¤±æ•ˆ
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å†…éƒ¨æœåŠ¡ä½¿ç”¨ClusterIP&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ•°æ®åº“ã€ç¼“å­˜ç­‰åç«¯æœåŠ¡ä¸éœ€è¦å¯¹å¤–æš´éœ²
apiVersion: v1
kind: Service
metadata:
  name: mysql-service
spec:
  type: ClusterIP  # æˆ–çœç•¥,é»˜è®¤å°±æ˜¯ClusterIP
  selector:
    app: mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¤–éƒ¨è®¿é—®ä¼˜å…ˆä½¿ç”¨Ingress&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç”Ÿäº§ç¯å¢ƒæ¨è:
å¤–éƒ¨ â†’ Ingress Controller â†’ Service (ClusterIP) â†’ Pod

è€Œä¸æ˜¯:
å¤–éƒ¨ â†’ NodePort â†’ Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ç¯å¢ƒå˜é‡vs ConfigMap&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç®€å•é…ç½®:ç›´æ¥ä½¿ç”¨env
env:
- name: DB_HOST
  value: &quot;mysql-service&quot;

# å¤æ‚é…ç½®:ä½¿ç”¨ConfigMap
envFrom:
- configMapRef:
    name: app-config
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¥åº·æ£€æŸ¥å¿…ä¸å¯å°‘&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç¡®ä¿Podå¥åº·æ‰åŠ å…¥Endpoints
readinessProbe:
  httpGet:
    path: /health
    port: 80
  initialDelaySeconds: 5
  periodSeconds: 3
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å®éªŒæ”¶è·:&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;é€šè¿‡æœ¬æ¬¡å®éªŒ,æˆ‘ä»¬å­¦ä¼šäº†:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;âœ… åˆ›å»ºå’Œç®¡ç†å››ç§ç±»å‹çš„Service&lt;/li&gt;
&lt;li&gt;âœ… ä½¿ç”¨æ ‡ç­¾é€‰æ‹©å™¨å…³è”Podå’ŒService&lt;/li&gt;
&lt;li&gt;âœ… é€šè¿‡Serviceåç§°å®ç°æœåŠ¡å‘ç°&lt;/li&gt;
&lt;li&gt;âœ… ä½¿ç”¨ç¯å¢ƒå˜é‡é…ç½®åº”ç”¨&lt;/li&gt;
&lt;li&gt;âœ… ç†è§£K8sçš„DNSæœºåˆ¶&lt;/li&gt;
&lt;li&gt;âœ… æŒæ¡ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸‹ä¸€æ­¥,æˆ‘ä»¬å°†å­¦ä¹ Deployment,ç”¨æ›´é«˜çº§çš„æ–¹å¼ç®¡ç†Podå‰¯æœ¬!&lt;/p&gt;
&lt;h3&gt;4.æ€»ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Serviceæ ¸å¿ƒä»·å€¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ç¨³å®šçš„è®¿é—®å…¥å£&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æä¾›å›ºå®šçš„ClusterIPå’ŒDNSåç§°&lt;/li&gt;
&lt;li&gt;Pod IPå˜åŒ–å¯¹åº”ç”¨é€æ˜&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æœåŠ¡å‘ç°&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šè¿‡DNSè‡ªåŠ¨è§£æServiceåç§°&lt;/li&gt;
&lt;li&gt;æ— éœ€é…ç½®ä¸­å¿ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨åœ¨å¤šä¸ªPodä¹‹é—´åˆ†å‘æµé‡&lt;/li&gt;
&lt;li&gt;æ”¯æŒå¤šç§ç®—æ³•ï¼ˆIPVSæ¨¡å¼ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®è§£è€¦&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åº”ç”¨ä½¿ç”¨Serviceåç§°ï¼Œä¸å…³å¿ƒå…·ä½“IP&lt;/li&gt;
&lt;li&gt;ä¾¿äºå®ç°è“ç»¿éƒ¨ç½²ã€ç°åº¦å‘å¸ƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;âœ“ ä½¿ç”¨IPVSæ¨¡å¼ï¼ˆé«˜æ€§èƒ½ï¼‰
âœ“ æ‰€æœ‰å†…éƒ¨æœåŠ¡ä½¿ç”¨ClusterIP
âœ“ é…ç½®ä½¿ç”¨ConfigMapç®¡ç†
âœ“ åº”ç”¨é€šè¿‡Serviceåç§°è®¿é—®å…¶ä»–æœåŠ¡
âœ“ å¤–éƒ¨è®¿é—®ä½¿ç”¨Ingressï¼ˆè€ŒéNodePortï¼‰
âœ“ æœ‰çŠ¶æ€åº”ç”¨ä½¿ç”¨Headless Service + StatefulSet
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h2&gt;å››ã€Ingressï¼šK8sçš„7å±‚ç½‘å…³&lt;/h2&gt;
&lt;h3&gt;1. Ingressæ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ&lt;/h3&gt;
&lt;h4&gt;1.1 Serviceæš´éœ²æœåŠ¡çš„å±€é™æ€§&lt;/h4&gt;
&lt;p&gt;åœ¨å‰é¢çš„ç« èŠ‚ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†å¦‚ä½•ä½¿ç”¨Serviceæš´éœ²æœåŠ¡ã€‚ä½†åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼ŒServiceæœ‰ä¸€äº›æ˜æ˜¾çš„å±€é™æ€§ï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;NodePortçš„é—®é¢˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šä½ æœ‰10ä¸ªå¾®æœåŠ¡éœ€è¦å¯¹å¤–æš´éœ²

ä½¿ç”¨NodePortï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·éœ€è¦è®°ä½10ä¸ªä¸åŒçš„ç«¯å£ï¼š                      â”‚
â”‚  - ç”¨æˆ·æœåŠ¡ï¼šhttp://k8s.example.com:30001       â”‚
â”‚  - è®¢å•æœåŠ¡ï¼šhttp://k8s.example.com:30002       â”‚
â”‚  - å•†å“æœåŠ¡ï¼šhttp://k8s.example.com:30003       â”‚
â”‚  - æ”¯ä»˜æœåŠ¡ï¼šhttp://k8s.example.com:30004       â”‚
â”‚  ... è¿˜æœ‰6ä¸ª                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
  âœ— ç«¯å£éš¾è®°ï¼Œç”¨æˆ·ä½“éªŒå·®
  âœ— ä¸æ”¯æŒåŸŸåè®¿é—®
  âœ— æ— æ³•ä½¿ç”¨æ ‡å‡†HTTP/HTTPSç«¯å£ï¼ˆ80/443ï¼‰
  âœ— æ— æ³•å®ç°åŸºäºåŸŸå/è·¯å¾„çš„è·¯ç”±
  âœ— æ— æ³•ç»Ÿä¸€ç®¡ç†SSLè¯ä¹¦
  âœ— ç«¯å£æ•°é‡æœ‰é™ï¼ˆ30000-32767ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;LoadBalancerçš„é—®é¢˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šä½ æœ‰10ä¸ªå¾®æœåŠ¡éœ€è¦å¯¹å¤–æš´éœ²

ä½¿ç”¨LoadBalancerï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éœ€è¦åˆ›å»º10ä¸ªLoadBalancerï¼ˆäº‘å¹³å°ï¼‰ï¼š              â”‚
â”‚  - ç”¨æˆ·æœåŠ¡ï¼šLB1 (IP: 1.2.3.4)                  â”‚
â”‚  - è®¢å•æœåŠ¡ï¼šLB2 (IP: 1.2.3.5)                  â”‚
â”‚  - å•†å“æœåŠ¡ï¼šLB3 (IP: 1.2.3.6)                  â”‚
â”‚  ... è¿˜æœ‰7ä¸ª                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼š
  âœ— æ¯ä¸ªLoadBalanceréƒ½è¦æ”¶è´¹ï¼ˆæŒ‰å°æ—¶/æŒ‰æµé‡ï¼‰
  âœ— 10ä¸ªæœåŠ¡ = 10ä¸ªLB = æˆæœ¬é«˜æ˜‚
  âœ— éœ€è¦10ä¸ªå…¬ç½‘IPï¼ˆIPèµ„æºæµªè´¹ï¼‰
  âœ— ç®¡ç†å¤æ‚ï¼ˆ10ä¸ªLBéœ€è¦åˆ†åˆ«é…ç½®ï¼‰
  âœ— æ— æ³•å®ç°æ™ºèƒ½è·¯ç”±ï¼ˆåŸŸåã€è·¯å¾„ã€Headerï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç†æƒ³çš„è§£å†³æ–¹æ¡ˆï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç”¨æˆ·æœŸæœ›çš„è®¿é—®æ–¹å¼ï¼š

- ç”¨æˆ·æœåŠ¡ï¼šhttp://user.example.com
- è®¢å•æœåŠ¡ï¼šhttp://order.example.com
- å•†å“æœåŠ¡ï¼šhttp://api.example.com/products
- æ”¯ä»˜æœåŠ¡ï¼šhttp://api.example.com/payment

ç‰¹ç‚¹ï¼š
  âœ“ ä½¿ç”¨æ ‡å‡†ç«¯å£ï¼ˆ80/443ï¼‰
  âœ“ ä½¿ç”¨å‹å¥½çš„åŸŸå
  âœ“ æ”¯æŒè·¯å¾„è·¯ç”±
  âœ“ ç»Ÿä¸€ç®¡ç†SSLè¯ä¹¦
  âœ“ åªéœ€è¦1ä¸ªå…¬ç½‘IP
  âœ“ ç»Ÿä¸€å…¥å£ï¼Œä¾¿äºç®¡ç†
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è¿™å°±æ˜¯Ingressçš„ä»·å€¼æ‰€åœ¨ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;hr /&gt;
&lt;h4&gt;1.2 Ingressæ˜¯ä»€ä¹ˆï¼Ÿ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç”¨ç”Ÿæ´»åœºæ™¯æ¥ç†è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æƒ³è±¡ä¸€ä¸ªå¤§å‹è´­ç‰©ä¸­å¿ƒï¼š

æ²¡æœ‰Ingressï¼ˆä½¿ç”¨NodePort/LoadBalancerï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¯ä¸ªå•†é“ºéƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å¤§é—¨ï¼š                â”‚
â”‚  - æ˜Ÿå·´å…‹ï¼šä»ä¸œé—¨è¿›ï¼Œä¸Š3æ¥¼ï¼Œå³è½¬           â”‚
â”‚  - ä¼˜è¡£åº“ï¼šä»è¥¿é—¨è¿›ï¼Œä¸‹åœ°ä¸‹1å±‚             â”‚
â”‚  - ç”µå½±é™¢ï¼šä»åŒ—é—¨è¿›ï¼Œåç”µæ¢¯åˆ°5æ¥¼           â”‚
â”‚                                            â”‚
â”‚  é¡¾å®¢ï¼šæˆ‘åªæ˜¯æƒ³ä¹°æ¯å’–å•¡ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆå¤æ‚ï¼Ÿ   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰äº†Ingressï¼ˆç»Ÿä¸€å…¥å£ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è´­ç‰©ä¸­å¿ƒåªæœ‰1ä¸ªä¸»å…¥å£ï¼š                    â”‚
â”‚  é¡¾å®¢è¿›é—¨åï¼Œçœ‹æŒ‡ç¤ºç‰Œï¼š                     â”‚
â”‚    â†’ è¦å–å’–å•¡ï¼Ÿå¾€å·¦èµ°ï¼Œ3æ¥¼æ˜Ÿå·´å…‹            â”‚
â”‚    â†’ è¦ä¹°è¡£æœï¼Ÿå¾€å³èµ°ï¼Œåœ°ä¸‹1å±‚ä¼˜è¡£åº“        â”‚
â”‚    â†’ è¦çœ‹ç”µå½±ï¼Ÿåç”µæ¢¯ï¼Œ5æ¥¼ç”µå½±é™¢            â”‚
â”‚                                            â”‚
â”‚  Ingress = è´­ç‰©ä¸­å¿ƒçš„&quot;æ™ºèƒ½æŒ‡ç¤ºç‰Œ&quot;           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æŠ€æœ¯å®šä¹‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Ingressæ˜¯ä»€ä¹ˆï¼Ÿ

Ingressæ˜¯Kubernetesçš„APIå¯¹è±¡ï¼Œç”¨äºç®¡ç†å¤–éƒ¨è®¿é—®é›†ç¾¤å†…æœåŠ¡çš„è§„åˆ™ã€‚

æ ¸å¿ƒç‰¹ç‚¹ï¼š
1. 7å±‚ï¼ˆHTTP/HTTPSï¼‰æµé‡ç®¡ç†
2. åŸºäºåŸŸåã€è·¯å¾„ã€Headerç­‰è¿›è¡Œæ™ºèƒ½è·¯ç”±
3. ç»Ÿä¸€çš„å¤–éƒ¨è®¿é—®å…¥å£
4. æ”¯æŒSSL/TLSç»ˆæ­¢
5. æ”¯æŒè´Ÿè½½å‡è¡¡ã€é‡å®šå‘ã€é‡å†™ç­‰é«˜çº§åŠŸèƒ½

ç±»æ¯”ï¼š
  Service = 4å±‚è´Ÿè½½å‡è¡¡ï¼ˆIP + Portï¼‰
  Ingress = 7å±‚è´Ÿè½½å‡è¡¡ï¼ˆåŸŸå + è·¯å¾„ + Headerï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.3 Ingressçš„ç»„æˆéƒ¨åˆ†&lt;/h4&gt;
&lt;p&gt;Ingressä¸æ˜¯ä¸€ä¸ªå•ç‹¬çš„ç»„ä»¶ï¼Œå®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;1. Ingressèµ„æºï¼ˆé…ç½®è§„åˆ™ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# è¿™æ˜¯ä¸€ä¸ªIngressèµ„æºçš„ç¤ºä¾‹
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-ingress
spec:
  rules:
  - host: www.example.com        # åŸŸå
    http:
      paths:
      - path: /api               # è·¯å¾„
        pathType: Prefix
        backend:
          service:
            name: api-service    # æŒ‡å‘çš„Service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Ingressèµ„æºåªæ˜¯é…ç½®è§„åˆ™ï¼Œæœ¬èº«ä¸å¤„ç†æµé‡ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;2. Ingress Controllerï¼ˆæµé‡å¤„ç†å™¨ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Ingress Controlleræ˜¯ä»€ä¹ˆï¼Ÿ

Ingress Controlleræ˜¯ä¸€ä¸ªå®é™…è¿è¡Œçš„Podï¼Œå®ƒï¼š
1. ç›‘å¬Kubernetes APIï¼Œè¯»å–Ingressèµ„æº
2. æ ¹æ®Ingressè§„åˆ™é…ç½®åå‘ä»£ç†ï¼ˆå¦‚Nginxï¼‰
3. æ¥æ”¶å¤–éƒ¨æµé‡ï¼ŒæŒ‰è§„åˆ™è½¬å‘åˆ°å¯¹åº”Service

å¸¸è§çš„Ingress Controllerï¼š
  - Nginx Ingress Controllerï¼ˆæœ€æµè¡Œï¼‰
  - Traefik
  - HAProxy
  - Kong
  - Istio Gateway
  - äº‘å¹³å°çš„Ingressï¼ˆå¦‚AWS ALBã€Azure Application Gatewayï¼‰

ç±»æ¯”ï¼š
  Ingressèµ„æº = äº¤é€šè§„åˆ™ï¼ˆè§„åˆ™å®šä¹‰ï¼‰
  Ingress Controller = äº¤è­¦ï¼ˆæ‰§è¡Œè§„åˆ™ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.4 Ingresså·¥ä½œåŸç†&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®Œæ•´çš„æµé‡è½¬å‘æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨ç”¨æˆ·è®¿é—®ï¼šhttp://www.example.com/api/users

æ­¥éª¤1ï¼šDNSè§£æ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æµè§ˆå™¨                              â”‚
â”‚  è¾“å…¥ï¼šwww.example.com                  â”‚
â”‚    â†“                                    â”‚
â”‚  DNSè§£æï¼šwww.example.com â†’ 1.2.3.4    â”‚
â”‚  ï¼ˆIngress Controllerçš„å¤–éƒ¨IPï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
æ­¥éª¤2ï¼šåˆ°è¾¾Ingress Controller
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress Controller Pod                 â”‚
â”‚  ï¼ˆè¿è¡ŒNginx/Traefikç­‰åå‘ä»£ç†ï¼‰         â”‚
â”‚                                         â”‚
â”‚  æ¥æ”¶è¯·æ±‚ï¼š                              â”‚
â”‚    Host: www.example.com               â”‚
â”‚    Path: /api/users                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
æ­¥éª¤3ï¼šåŒ¹é…Ingressè§„åˆ™
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress ControlleræŸ¥æ‰¾è§„åˆ™ï¼š            â”‚
â”‚                                         â”‚
â”‚  âœ“ æ‰¾åˆ°åŒ¹é…çš„Ingressï¼š                  â”‚
â”‚    - host: www.example.com             â”‚
â”‚    - path: /api                        â”‚
â”‚    - backend: api-service:80           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
æ­¥éª¤4ï¼šè½¬å‘åˆ°Service
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress Controllerè½¬å‘è¯·æ±‚åˆ°ï¼š          â”‚
â”‚  http://api-service:80/api/users       â”‚
â”‚  ï¼ˆServiceçš„ClusterIPï¼‰                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
æ­¥éª¤5ï¼šServiceè´Ÿè½½å‡è¡¡åˆ°Pod
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service (ClusterIP)                    â”‚
â”‚  é€šè¿‡kube-proxy/IPVSè´Ÿè½½å‡è¡¡ï¼š          â”‚
â”‚    â†’ Pod1: 10.244.1.10:8080            â”‚
â”‚    â†’ Pod2: 10.244.2.20:8080            â”‚
â”‚    â†’ Pod3: 10.244.3.30:8080            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“
æ­¥éª¤6ï¼šPodå¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Podå“åº” â†’ Service â†’ Ingress Controller â”‚
â”‚          â†’ ç”¨æˆ·æµè§ˆå™¨                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç”¨æµç¨‹å›¾è¡¨ç¤ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨ç”¨æˆ·
   â†“ (1) HTTPè¯·æ±‚ï¼šwww.example.com/api
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress Controller Pod      â”‚
â”‚  (Nginx/Traefikç­‰)           â”‚
â”‚  å¤–éƒ¨IP: 1.2.3.4             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ (2) æ ¹æ®Ingressè§„åˆ™è·¯ç”±
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Service (ClusterIP)         â”‚
â”‚  api-service: 10.96.100.50   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ (3) è´Ÿè½½å‡è¡¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Pod1   â”‚  â”‚  Pod2   â”‚  â”‚  Pod3   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.5 Ingressä¸Serviceçš„å…³ç³»&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Ingresså’ŒServiceæ˜¯é…åˆä½¿ç”¨çš„ï¼Œä¸æ˜¯æ›¿ä»£å…³ç³»ï¼&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ¶æ„å±‚æ¬¡ï¼š

å¤–éƒ¨ç”¨æˆ·
   â†“
Ingressï¼ˆ7å±‚è·¯ç”±ï¼‰
   â†“
Serviceï¼ˆ4å±‚è´Ÿè½½å‡è¡¡ï¼‰
   â†“
Podï¼ˆåº”ç”¨å®¹å™¨ï¼‰

èŒè´£åˆ†å·¥ï¼š

Ingressçš„èŒè´£ï¼š
  âœ“ æ¥æ”¶å¤–éƒ¨HTTP/HTTPSæµé‡
  âœ“ åŸºäºåŸŸåã€è·¯å¾„ã€Headerè·¯ç”±
  âœ“ SSL/TLSç»ˆæ­¢
  âœ“ é‡å†™ã€é‡å®šå‘
  âœ“ ç»Ÿä¸€è®¿é—®å…¥å£

Serviceçš„èŒè´£ï¼š
  âœ“ ä¸ºPodæä¾›ç¨³å®šçš„ClusterIP
  âœ“ åœ¨Podä¹‹é—´è¿›è¡Œè´Ÿè½½å‡è¡¡
  âœ“ æœåŠ¡å‘ç°ï¼ˆDNSï¼‰
  âœ“ å¥åº·æ£€æŸ¥
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸ºä»€ä¹ˆä¸èƒ½è·³è¿‡Serviceï¼ŒIngressç›´æ¥è½¬å‘åˆ°Podï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æŠ€æœ¯ä¸Šå¯ä»¥ï¼Œä½†ä¸æ¨èï¼š

é—®é¢˜1ï¼šPod IPä¸ç¨³å®š
  - Podé‡å¯/æ‰©ç¼©å®¹æ—¶IPä¼šå˜åŒ–
  - Ingresséœ€è¦é¢‘ç¹æ›´æ–°é…ç½®

é—®é¢˜2ï¼šå¤±å»Serviceçš„è´Ÿè½½å‡è¡¡èƒ½åŠ›
  - Serviceçš„å¥åº·æ£€æŸ¥
  - Serviceçš„ä¼šè¯ä¿æŒ
  - Serviceçš„æ•…éšœè½¬ç§»

é—®é¢˜3ï¼šè¿èƒŒKubernetesè®¾è®¡ç†å¿µ
  - Serviceæ˜¯Podçš„æŠ½è±¡å±‚
  - æ‰€æœ‰è®¿é—®Podçš„æµé‡éƒ½åº”è¯¥ç»è¿‡Service

æœ€ä½³å®è·µï¼š
  Ingress â†’ Service â†’ Pod
  è¿™æ˜¯æ ‡å‡†çš„ä¸‰å±‚æ¶æ„
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.6 Ingress vs Serviceå¯¹æ¯”&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;Service (NodePort/LB)&lt;/th&gt;
&lt;th&gt;Ingress&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;OSIå±‚&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;4å±‚ï¼ˆTCP/UDPï¼‰&lt;/td&gt;
&lt;td&gt;7å±‚ï¼ˆHTTP/HTTPSï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;è·¯ç”±èƒ½åŠ›&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;IP + ç«¯å£&lt;/td&gt;
&lt;td&gt;åŸŸå + è·¯å¾„ + Header&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æˆæœ¬&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ¯ä¸ªæœåŠ¡1ä¸ªLBï¼ˆè´µï¼‰&lt;/td&gt;
&lt;td&gt;å¤šä¸ªæœåŠ¡å…±äº«1ä¸ªå…¥å£ï¼ˆçœé’±ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ç«¯å£&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;éœ€è¦ä¸åŒç«¯å£&lt;/td&gt;
&lt;td&gt;ç»Ÿä¸€80/443ç«¯å£&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;SSL&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ¯ä¸ªServiceå•ç‹¬é…ç½®&lt;/td&gt;
&lt;td&gt;ç»Ÿä¸€ç®¡ç†è¯ä¹¦&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;åŸŸå&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ä¸æ”¯æŒ&lt;/td&gt;
&lt;td&gt;åŸç”Ÿæ”¯æŒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;é«˜çº§åŠŸèƒ½&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ— &lt;/td&gt;
&lt;td&gt;é‡å†™ã€é‡å®šå‘ã€é‡‘ä¸é›€ç­‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å†…éƒ¨æœåŠ¡ã€ç®€å•æš´éœ²&lt;/td&gt;
&lt;td&gt;ç”Ÿäº§ç¯å¢ƒå¤–éƒ¨è®¿é—®&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;å…¸å‹æ¶æ„å¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼ ç»Ÿæ–¹å¼ï¼ˆService LoadBalancerï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·æœåŠ¡ï¼šLB1 (1.2.3.4:80) â†’ Service1  â”‚
â”‚  è®¢å•æœåŠ¡ï¼šLB2 (1.2.3.5:80) â†’ Service2  â”‚
â”‚  å•†å“æœåŠ¡ï¼šLB3 (1.2.3.6:80) â†’ Service3  â”‚
â”‚                                         â”‚
â”‚  æˆæœ¬ï¼š3ä¸ªLoadBalancer                  â”‚
â”‚  IPï¼š3ä¸ªå…¬ç½‘IP                          â”‚
â”‚  ç®¡ç†ï¼šåˆ†æ•£é…ç½®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ingressæ–¹å¼ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress (1.2.3.4:80/443)               â”‚
â”‚    â”œâ”€ user.example.com â†’ Service1       â”‚
â”‚    â”œâ”€ order.example.com â†’ Service2      â”‚
â”‚    â””â”€ api.example.com/products â†’ Svc3  â”‚
â”‚                                         â”‚
â”‚  æˆæœ¬ï¼š1ä¸ªLoadBalancerï¼ˆæˆ–å…è´¹æ–¹æ¡ˆï¼‰     â”‚
â”‚  IPï¼š1ä¸ªå…¬ç½‘IP                          â”‚
â”‚  ç®¡ç†ï¼šç»Ÿä¸€é…ç½®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;1.7 Ingressçš„æœ¬è´¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Ingress Controllerçš„æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Ingress Controller = Nginx/Traefik + è‡ªåŠ¨é…ç½®å™¨

ä»¥Nginx Ingress Controllerä¸ºä¾‹ï¼š

ä¼ ç»ŸNginxé…ç½®ï¼ˆæ‰‹åŠ¨ç¼–å†™ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  server {                            â”‚
â”‚    listen 80;                        â”‚
â”‚    server_name www.example.com;      â”‚
â”‚    location /api {                   â”‚
â”‚      proxy_pass http://backend:8080; â”‚
â”‚    }                                 â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ingress Controllerçš„é­”æ³•ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. ç›‘å¬Kubernetes API                â”‚
â”‚  2. è¯»å–Ingressèµ„æº                   â”‚
â”‚  3. è‡ªåŠ¨ç”ŸæˆNginxé…ç½®æ–‡ä»¶              â”‚
â”‚  4. é‡è½½Nginxï¼ˆæ— éœ€æ‰‹åŠ¨æ“ä½œï¼‰          â”‚
â”‚  5. æŒç»­ç›‘å¬ï¼Œé…ç½®å˜åŒ–è‡ªåŠ¨æ›´æ–°          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½ åªéœ€è¦ï¼š
  - åˆ›å»ºIngress YAML
  - kubectl apply -f ingress.yaml
  - å‰©ä¸‹çš„äº¤ç»™Ingress Controllerï¼
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Ingress Controlleråšäº†ä»€ä¹ˆï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Ingress Controllerçš„å·¥ä½œæµç¨‹ï¼š              â”‚
â”‚                                             â”‚
â”‚  1. å¯åŠ¨æ—¶ï¼š                                â”‚
â”‚     - åˆ›å»ºNginx/Traefikå®¹å™¨                â”‚
â”‚     - ç›‘å¬Kubernetes API                   â”‚
â”‚                                             â”‚
â”‚  2. å‘ç°Ingressèµ„æºæ—¶ï¼š                     â”‚
â”‚     - è¯»å–Ingressè§„åˆ™                      â”‚
â”‚     - è½¬æ¢ä¸ºNginxé…ç½®                      â”‚
â”‚     - æ›´æ–°Nginxé…ç½®æ–‡ä»¶                    â”‚
â”‚     - æ‰§è¡Œnginx -s reload                  â”‚
â”‚                                             â”‚
â”‚  3. Ingresså˜åŒ–æ—¶ï¼š                         â”‚
â”‚     - æ£€æµ‹åˆ°å˜åŒ–ï¼ˆå¢/åˆ /æ”¹ï¼‰                â”‚
â”‚     - é‡æ–°ç”Ÿæˆé…ç½®                         â”‚
â”‚     - çƒ­æ›´æ–°ï¼ˆä¸ä¸­æ–­ç°æœ‰è¿æ¥ï¼‰              â”‚
â”‚                                             â”‚
â”‚  4. å¤„ç†æµé‡æ—¶ï¼š                            â”‚
â”‚     - æ¥æ”¶HTTP/HTTPSè¯·æ±‚                   â”‚
â”‚     - åŒ¹é…Ingressè§„åˆ™                      â”‚
â”‚     - è½¬å‘åˆ°å¯¹åº”Service                    â”‚
â”‚     - è¿”å›å“åº”ç»™å®¢æˆ·ç«¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;å°ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Ingressè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. ç»Ÿä¸€å¤–éƒ¨è®¿é—®å…¥å£
   - ä¸€ä¸ªå…¬ç½‘IPæœåŠ¡æ‰€æœ‰åº”ç”¨
   - èŠ‚çœæˆæœ¬ï¼ˆäº‘å¹³å°LoadBalancerï¼‰

2. åŸºäº7å±‚çš„æ™ºèƒ½è·¯ç”±
   - åŸŸåè·¯ç”±ï¼šuser.example.com â†’ ç”¨æˆ·æœåŠ¡
   - è·¯å¾„è·¯ç”±ï¼š/api/orders â†’ è®¢å•æœåŠ¡
   - Headerè·¯ç”±ï¼šç§»åŠ¨ç«¯ â†’ ç§»åŠ¨æœåŠ¡

3. ç®€åŒ–ç®¡ç†
   - ç»Ÿä¸€ç®¡ç†SSLè¯ä¹¦
   - ç»Ÿä¸€é…ç½®è®¿é—®ç­–ç•¥
   - å£°æ˜å¼é…ç½®ï¼ˆYAMLï¼‰

4. ä¼ä¸šçº§åŠŸèƒ½
   - é‡‘ä¸é›€å‘å¸ƒ
   - ç°åº¦å‘å¸ƒ
   - A/Bæµ‹è¯•
   - æµé‡åˆ†å‰²
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸‹ä¸€æ­¥ï¼š&lt;/strong&gt; æˆ‘ä»¬å°†è¯¦ç»†å­¦ä¹ Ingressèƒ½å®ç°å“ªäº›åŠŸèƒ½ï¼Œä»¥åŠä¸åŒçš„éƒ¨ç½²æ–¹å¼ã€‚&lt;/p&gt;
&lt;hr /&gt;
&lt;h3&gt;2. IngressåŠŸèƒ½è¯¦è§£&lt;/h3&gt;
&lt;h4&gt;2.1 åŸºç¡€åŠŸèƒ½ï¼šåŸºäºåŸŸåçš„è·¯ç”±&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŠŸèƒ½è¯´æ˜ï¼š&lt;/strong&gt; æ ¹æ®ä¸åŒçš„åŸŸåï¼Œå°†æµé‡è½¬å‘åˆ°ä¸åŒçš„Serviceã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šä¸€ä¸ªå…¬å¸æœ‰å¤šä¸ªå­ç³»ç»Ÿ
- ç”¨æˆ·ç³»ç»Ÿï¼šuser.example.com
- è®¢å•ç³»ç»Ÿï¼šorder.example.com
- å•†å“ç³»ç»Ÿï¼šproduct.example.com

ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦3ä¸ªLoadBalancerï¼ˆè´µï¼ï¼‰
Ingressæ–¹å¼ï¼š1ä¸ªIngressæå®šï¼ˆçœé’±ï¼ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: multi-domain-ingress
spec:
  rules:
  # è§„åˆ™1ï¼šç”¨æˆ·ç³»ç»Ÿ
  - host: user.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 80
  
  # è§„åˆ™2ï¼šè®¢å•ç³»ç»Ÿ
  - host: order.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: order-service
            port:
              number: 80
  
  # è§„åˆ™3ï¼šå•†å“ç³»ç»Ÿ
  - host: product.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: product-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è·¯ç”±æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç”¨æˆ·è®¿é—®ï¼šuser.example.com
  â†“
Ingressæ£€æµ‹Hostå¤´ï¼šuser.example.com
  â†“
åŒ¹é…è§„åˆ™1 â†’ è½¬å‘åˆ°user-service
  â†“
user-service â†’ user-pod

ç”¨æˆ·è®¿é—®ï¼šorder.example.com
  â†“
Ingressæ£€æµ‹Hostå¤´ï¼šorder.example.com
  â†“
åŒ¹é…è§„åˆ™2 â†’ è½¬å‘åˆ°order-service
  â†“
order-service â†’ order-pod
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.2 åŸºäºè·¯å¾„çš„è·¯ç”±&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŠŸèƒ½è¯´æ˜ï¼š&lt;/strong&gt; æ ¹æ®URLè·¯å¾„ï¼Œå°†æµé‡è½¬å‘åˆ°ä¸åŒçš„Serviceã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šä¸€ä¸ªç»Ÿä¸€çš„APIç½‘å…³
- /api/users â†’ ç”¨æˆ·æœåŠ¡
- /api/orders â†’ è®¢å•æœåŠ¡
- /api/products â†’ å•†å“æœåŠ¡
- /static â†’ é™æ€æ–‡ä»¶æœåŠ¡

ä¼˜åŠ¿ï¼š
  âœ“ ç»Ÿä¸€åŸŸåï¼ˆå¦‚api.example.comï¼‰
  âœ“ è·¯å¾„æ¸…æ™°ï¼Œç¬¦åˆRESTfulè§„èŒƒ
  âœ“ ä¾¿äºAPIç®¡ç†å’Œç‰ˆæœ¬æ§åˆ¶
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: path-based-ingress
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      # ç”¨æˆ·API
      - path: /api/users
        pathType: Prefix
        backend:
          service:
            name: user-service
            port:
              number: 8080
      
      # è®¢å•API
      - path: /api/orders
        pathType: Prefix
        backend:
          service:
            name: order-service
            port:
              number: 8080
      
      # å•†å“API
      - path: /api/products
        pathType: Prefix
        backend:
          service:
            name: product-service
            port:
              number: 8080
      
      # é™æ€æ–‡ä»¶
      - path: /static
        pathType: Prefix
        backend:
          service:
            name: static-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;pathTypeè¯¦è§£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;pathType&lt;/th&gt;
&lt;th&gt;åŒ¹é…è§„åˆ™&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Prefix&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å‰ç¼€åŒ¹é…&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/api&lt;/code&gt; åŒ¹é… &lt;code&gt;/api/users&lt;/code&gt;ã€&lt;code&gt;/api/orders&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Exact&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç²¾ç¡®åŒ¹é…&lt;/td&gt;
&lt;td&gt;&lt;code&gt;/api&lt;/code&gt; åªåŒ¹é… &lt;code&gt;/api&lt;/code&gt;ï¼Œä¸åŒ¹é… &lt;code&gt;/api/users&lt;/code&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ImplementationSpecific&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç”±Ingress Controllerå†³å®š&lt;/td&gt;
&lt;td&gt;å–å†³äºå…·ä½“å®ç°&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;åŒ¹é…ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;é…ç½®ï¼špath: /api, pathType: Prefix

âœ“ åŒ¹é…ï¼š
  - /api
  - /api/
  - /api/users
  - /api/users/123

âœ— ä¸åŒ¹é…ï¼š
  - /apis
  - /v1/api

é…ç½®ï¼špath: /api, pathType: Exact

âœ“ åŒ¹é…ï¼š
  - /api

âœ— ä¸åŒ¹é…ï¼š
  - /api/
  - /api/users
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.3 HTTPSå’ŒSSL/TLSç»ˆæ­¢&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŠŸèƒ½è¯´æ˜ï¼š&lt;/strong&gt; Ingresså¯ä»¥åœ¨è¾¹ç¼˜ç»ˆæ­¢SSL/TLSï¼Œåç«¯Serviceä½¿ç”¨HTTPé€šä¿¡ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šéœ€è¦HTTPSåŠ å¯†è®¿é—®

ä¼ ç»Ÿæ–¹å¼ï¼š
  - æ¯ä¸ªServiceé…ç½®SSLè¯ä¹¦
  - è¯ä¹¦ç®¡ç†åˆ†æ•£
  - è¯ä¹¦æ›´æ–°å¤æ‚

Ingressæ–¹å¼ï¼š
  - è¯ä¹¦ç»Ÿä¸€é…ç½®åœ¨Ingress
  - è¯ä¹¦é›†ä¸­ç®¡ç†
  - åç«¯Serviceæ— éœ€å…³å¿ƒSSL
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œåŸç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨ç”¨æˆ·
  â†“ HTTPS (443ç«¯å£ï¼ŒåŠ å¯†)
Ingress Controller
  â†“ HTTP (80ç«¯å£ï¼Œæ˜æ–‡)
Service
  â†“
Pod

SSLç»ˆæ­¢å‘ç”Ÿåœ¨Ingress Controllerå±‚
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Secret
metadata:
  name: example-tls
type: kubernetes.io/tls
data:
  tls.crt: LS0tLS1CRUdJTi... # Base64ç¼–ç çš„è¯ä¹¦
  tls.key: LS0tLS1CRUdJTi... # Base64ç¼–ç çš„ç§é’¥

---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: https-ingress
spec:
  tls:
  - hosts:
    - www.example.com
    - api.example.com
    secretName: example-tls    # å¼•ç”¨è¯ä¹¦Secret
  rules:
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºTLS Secretï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ–¹å¼1ï¼šä»è¯ä¹¦æ–‡ä»¶åˆ›å»º
kubectl create secret tls example-tls \
  --cert=path/to/tls.crt \
  --key=path/to/tls.key

# æ–¹å¼2ï¼šä½¿ç”¨Let&apos;s Encryptè‡ªåŠ¨ç”Ÿæˆï¼ˆéœ€è¦cert-managerï¼‰
# åé¢å®æ“ç¯èŠ‚ä¼šæ¼”ç¤º
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;HTTPSé‡å®šå‘ï¼ˆHTTPè‡ªåŠ¨è·³è½¬HTTPSï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: https-redirect-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: &quot;true&quot;    # è‡ªåŠ¨é‡å®šå‘
    nginx.ingress.kubernetes.io/force-ssl-redirect: &quot;true&quot;
spec:
  tls:
  - hosts:
    - www.example.com
    secretName: example-tls
  rules:
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: web-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.4 URLé‡å†™å’Œé‡å®šå‘&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŠŸèƒ½è¯´æ˜ï¼š&lt;/strong&gt; ä¿®æ”¹è¯·æ±‚è·¯å¾„æˆ–é‡å®šå‘åˆ°å…¶ä»–URLã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯1ï¼šè·¯å¾„é‡å†™&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šå‰ç«¯è·¯å¾„å’Œåç«¯è·¯å¾„ä¸ä¸€è‡´

ç”¨æˆ·è®¿é—®ï¼šhttp://api.example.com/v1/users
åç«¯æœŸæœ›ï¼šhttp://api.example.com/users

éœ€è¦å»æ‰ /v1 å‰ç¼€
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è·¯å¾„é‡å†™é…ç½®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rewrite-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /v1(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: api-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;è·¯å¾„é‡å†™ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç”¨æˆ·è¯·æ±‚ï¼š/v1/users/123
  â†“ åŒ¹é…æ­£åˆ™ï¼š/v1(/|$)(.*)
  â†“ $2 = users/123
  â†“ rewrite-target: /$2
è½¬å‘åˆ°åç«¯ï¼š/users/123

ç”¨æˆ·è¯·æ±‚ï¼š/v1/orders
  â†“
è½¬å‘åˆ°åç«¯ï¼š/orders
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯2ï¼šæ°¸ä¹…é‡å®šå‘&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šåŸŸåè¿ç§»æˆ–ç»Ÿä¸€å…¥å£

æ—§åŸŸåï¼šold.example.com
æ–°åŸŸåï¼šnew.example.com

éœ€è¦å°†æ—§åŸŸåè®¿é—®è‡ªåŠ¨è·³è½¬åˆ°æ–°åŸŸå
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é‡å®šå‘é…ç½®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: redirect-ingress
  annotations:
    nginx.ingress.kubernetes.io/permanent-redirect: https://new.example.com
spec:
  rules:
  - host: old.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: dummy-service   # å®é™…ä¸ä¼šè®¿é—®
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.5 é‡‘ä¸é›€å‘å¸ƒï¼ˆCanary Deploymentï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŠŸèƒ½è¯´æ˜ï¼š&lt;/strong&gt; å°†ä¸€å°éƒ¨åˆ†æµé‡å¯¼å‘æ–°ç‰ˆæœ¬ï¼ŒéªŒè¯ç¨³å®šåå†å…¨é‡å‘å¸ƒã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šå‘å¸ƒæ–°ç‰ˆæœ¬åº”ç”¨v2ï¼Œä½†ä¸ç¡®å®šæ˜¯å¦ç¨³å®š

ä¼ ç»Ÿæ–¹å¼ï¼šç›´æ¥å…¨é‡å‘å¸ƒ â†’ å‡ºé—®é¢˜å½±å“æ‰€æœ‰ç”¨æˆ·
é‡‘ä¸é›€æ–¹å¼ï¼šå…ˆå¯¼5%æµé‡åˆ°v2 â†’ ç¨³å®šåé€æ­¥å¢åŠ  â†’ æœ€ç»ˆ100%

ç±»æ¯”ï¼šç…¤çŸ¿å·¥äººå¸¦é‡‘ä¸é›€ä¸‹äº•ï¼Œé‡‘ä¸é›€å¯¹æœ‰æ¯’æ°”ä½“æ•æ„Ÿ
     å¦‚æœé‡‘ä¸é›€æ­»äº†ï¼Œè¯´æ˜ç¯å¢ƒæœ‰é—®é¢˜
     
é‡‘ä¸é›€å‘å¸ƒï¼šæ–°ç‰ˆæœ¬å°±æ˜¯&quot;é‡‘ä¸é›€&quot;
     å…ˆè®©å°‘é‡ç”¨æˆ·ä½“éªŒæ–°ç‰ˆæœ¬
     å¦‚æœå‡ºé—®é¢˜ï¼Œå½±å“èŒƒå›´å°
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é‡‘ä¸é›€å‘å¸ƒç­–ç•¥ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. åŸºäºæµé‡æ¯”ä¾‹
   - 10%æµé‡ â†’ v2ç‰ˆæœ¬
   - 90%æµé‡ â†’ v1ç‰ˆæœ¬

2. åŸºäºHeader
   - å¦‚æœHeaderåŒ…å« canary=true â†’ v2ç‰ˆæœ¬
   - å¦åˆ™ â†’ v1ç‰ˆæœ¬
   ï¼ˆå†…éƒ¨æµ‹è¯•äººå‘˜ä½¿ç”¨ï¼‰

3. åŸºäºCookie
   - å¦‚æœCookieåŒ…å« user_type=vip â†’ v2ç‰ˆæœ¬
   - å¦åˆ™ â†’ v1ç‰ˆæœ¬
   ï¼ˆVIPç”¨æˆ·å…ˆä½“éªŒï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹1ï¼šåŸºäºæƒé‡çš„é‡‘ä¸é›€&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸»Ingressï¼ˆç¨³å®šç‰ˆæœ¬v1ï¼‰
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
spec:
  rules:
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v1        # ç¨³å®šç‰ˆæœ¬
            port:
              number: 80

---
# é‡‘ä¸é›€Ingressï¼ˆæ–°ç‰ˆæœ¬v2ï¼‰
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-canary
  annotations:
    nginx.ingress.kubernetes.io/canary: &quot;true&quot;
    nginx.ingress.kubernetes.io/canary-weight: &quot;10&quot;    # 10%æµé‡
spec:
  rules:
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v2        # æ–°ç‰ˆæœ¬
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµé‡åˆ†é…ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;100ä¸ªè¯·æ±‚ï¼š
  â†’ 90ä¸ªè¯·æ±‚åˆ°app-v1ï¼ˆç¨³å®šç‰ˆæœ¬ï¼‰
  â†’ 10ä¸ªè¯·æ±‚åˆ°app-v2ï¼ˆé‡‘ä¸é›€ç‰ˆæœ¬ï¼‰

è§‚å¯Ÿv2ç¨³å®šåï¼Œé€æ­¥è°ƒæ•´æƒé‡ï¼š
  canary-weight: 10 â†’ 30 â†’ 50 â†’ 80 â†’ 100

æœ€ç»ˆv2å®Œå…¨æ›¿ä»£v1ï¼š
  åˆ é™¤ä¸»Ingressï¼Œé‡‘ä¸é›€Ingressæ”¹ä¸ºä¸»Ingress
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹2ï¼šåŸºäºHeaderçš„é‡‘ä¸é›€&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-canary-header
  annotations:
    nginx.ingress.kubernetes.io/canary: &quot;true&quot;
    nginx.ingress.kubernetes.io/canary-by-header: &quot;canary&quot;
    nginx.ingress.kubernetes.io/canary-by-header-value: &quot;true&quot;
spec:
  rules:
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v2
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ™®é€šç”¨æˆ·è®¿é—®ï¼ˆåˆ°v1ï¼‰
curl http://www.example.com

# æµ‹è¯•äººå‘˜è®¿é—®ï¼ˆåˆ°v2ï¼‰
curl -H &quot;canary: true&quot; http://www.example.com
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.6 A/Bæµ‹è¯•&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åŠŸèƒ½è¯´æ˜ï¼š&lt;/strong&gt; æ ¹æ®ç”¨æˆ·ç‰¹å¾ï¼Œå°†æµé‡å¯¼å‘ä¸åŒç‰ˆæœ¬ï¼Œæ¯”è¾ƒæ•ˆæœã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åœºæ™¯ï¼šæµ‹è¯•æ–°UIè®¾è®¡æ˜¯å¦æå‡è½¬åŒ–ç‡

Aç‰ˆæœ¬ï¼šåŸæœ‰UI
Bç‰ˆæœ¬ï¼šæ–°UIè®¾è®¡

ç­–ç•¥ï¼š
  - 50%ç”¨æˆ·çœ‹Aç‰ˆæœ¬
  - 50%ç”¨æˆ·çœ‹Bç‰ˆæœ¬
  
æ”¶é›†æ•°æ®ï¼š
  - Aç‰ˆæœ¬è½¬åŒ–ç‡ï¼š5%
  - Bç‰ˆæœ¬è½¬åŒ–ç‡ï¼š8%
  
ç»“è®ºï¼šBç‰ˆæœ¬æ›´å¥½ï¼Œå…¨é‡ä¸Šçº¿Bç‰ˆæœ¬
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;A/Bæµ‹è¯• vs é‡‘ä¸é›€å‘å¸ƒï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;é‡‘ä¸é›€å‘å¸ƒï¼š
  - ç›®æ ‡ï¼šéªŒè¯ç¨³å®šæ€§
  - é€æ­¥å¢åŠ æµé‡
  - å‡ºé—®é¢˜ç«‹å³å›æ»š

A/Bæµ‹è¯•ï¼š
  - ç›®æ ‡ï¼šæ¯”è¾ƒæ•ˆæœ
  - æµé‡æ¯”ä¾‹å›ºå®š
  - æ”¶é›†æ•°æ®åˆ†æ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®ç¤ºä¾‹ï¼šåŸºäºCookieçš„A/Bæµ‹è¯•&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ab-test
  annotations:
    nginx.ingress.kubernetes.io/canary: &quot;true&quot;
    nginx.ingress.kubernetes.io/canary-by-cookie: &quot;ab_test&quot;
    nginx.ingress.kubernetes.io/canary-by-cookie-value: &quot;version_b&quot;
spec:
  rules:
  - host: www.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-version-b
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç”¨æˆ·Aï¼ˆçœ‹åˆ°Aç‰ˆæœ¬ï¼‰
curl http://www.example.com

# ç”¨æˆ·Bï¼ˆçœ‹åˆ°Bç‰ˆæœ¬ï¼‰
curl --cookie &quot;ab_test=version_b&quot; http://www.example.com
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;2.7 å…¶ä»–é«˜çº§åŠŸèƒ½&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;1. é€Ÿç‡é™åˆ¶ï¼ˆRate Limitingï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: rate-limit-ingress
  annotations:
    nginx.ingress.kubernetes.io/limit-rps: &quot;10&quot;         # æ¯ç§’10ä¸ªè¯·æ±‚
    nginx.ingress.kubernetes.io/limit-connections: &quot;5&quot;  # æœ€å¤š5ä¸ªå¹¶å‘è¿æ¥
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;2. IPç™½åå•/é»‘åå•&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: whitelist-ingress
  annotations:
    nginx.ingress.kubernetes.io/whitelist-source-range: &quot;10.0.0.0/8,192.168.1.0/24&quot;
spec:
  rules:
  - host: admin.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: admin-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;3. åŸºæœ¬è®¤è¯ï¼ˆBasic Authï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºå¯†ç æ–‡ä»¶
htpasswd -c auth admin
# è¾“å…¥å¯†ç 

# åˆ›å»ºSecret
kubectl create secret generic basic-auth --from-file=auth
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auth-ingress
  annotations:
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
    nginx.ingress.kubernetes.io/auth-realm: &quot;Authentication Required&quot;
spec:
  rules:
  - host: admin.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: admin-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;4. è·¨åŸŸé…ç½®ï¼ˆCORSï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cors-ingress
  annotations:
    nginx.ingress.kubernetes.io/enable-cors: &quot;true&quot;
    nginx.ingress.kubernetes.io/cors-allow-origin: &quot;https://frontend.example.com&quot;
    nginx.ingress.kubernetes.io/cors-allow-methods: &quot;GET, POST, PUT, DELETE&quot;
spec:
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-service
            port:
              number: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;2.8 Ingress Controlleréƒ¨ç½²æ–¹å¼&lt;/h3&gt;
&lt;p&gt;Ingress Controlleræœ‰å¤šç§éƒ¨ç½²æ–¹å¼ï¼Œé€‚ç”¨äºä¸åŒçš„ç¯å¢ƒå’Œéœ€æ±‚ã€‚&lt;/p&gt;
&lt;h4&gt;éƒ¨ç½²æ–¹å¼1ï¼šLoadBalancer + Deployment&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯ï¼š&lt;/strong&gt; äº‘å¹³å°ç¯å¢ƒï¼ˆAWSã€é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¶æ„å›¾ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨ç”¨æˆ·
   â†“
äº‘å¹³å°LoadBalancer (å…¬ç½‘IP: 1.2.3.4)
   â†“
Ingress Controller Service (LoadBalancerç±»å‹)
   â†“
Ingress Controller Pods (Deployment, 2-3å‰¯æœ¬)
   â†“
åº”ç”¨Service
   â†“
åº”ç”¨Pods
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
  âœ“ é«˜å¯ç”¨ï¼ˆå¤šå‰¯æœ¬ + LBè‡ªåŠ¨åˆ†å‘æµé‡ï¼‰
  âœ“ è‡ªåŠ¨æ•…éšœè½¬ç§»
  âœ“ äº‘å¹³å°ç®¡ç†LoadBalancer
  âœ“ ç®€å•æ˜“ç”¨

ç¼ºç‚¹ï¼š
  âœ— äº‘å¹³å°LoadBalanceræ”¶è´¹
  âœ— ä¾èµ–äº‘å¹³å°
  âœ— ä¸é€‚ç”¨äºè£¸é‡‘å±ç¯å¢ƒ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;éƒ¨ç½²ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Ingress Controller Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
spec:
  replicas: 2                    # å¤šå‰¯æœ¬é«˜å¯ç”¨
  selector:
    matchLabels:
      app: nginx-ingress
  template:
    metadata:
      labels:
        app: nginx-ingress
    spec:
      containers:
      - name: nginx-ingress-controller
        image: k8s.gcr.io/ingress-nginx/controller:v1.0.0
        args:
        - /nginx-ingress-controller
        - --configmap=$(POD_NAMESPACE)/nginx-configuration

---
# LoadBalancer Service
apiVersion: v1
kind: Service
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
spec:
  type: LoadBalancer              # äº‘å¹³å°è‡ªåŠ¨åˆ›å»ºLB
  ports:
  - name: http
    port: 80
    targetPort: 80
  - name: https
    port: 443
    targetPort: 443
  selector:
    app: nginx-ingress
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;éƒ¨ç½²æ–¹å¼2ï¼šDaemonSet + hostNetwork&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯ï¼š&lt;/strong&gt; è£¸é‡‘å±ç¯å¢ƒï¼ˆæœ¬åœ°æœºæˆ¿ã€ç§æœ‰äº‘ï¼‰&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¶æ„å›¾ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨ç”¨æˆ·
   â†“
ç‰©ç†æœº/è™šæ‹Ÿæœº (ç›´æ¥è®¿é—®Node IP)
   â†“
Ingress Controller Pod (æ¯ä¸ªNodeè¿è¡Œä¸€ä¸ª)
   â†“ hostNetworkæ¨¡å¼ï¼ˆä½¿ç”¨Nodeçš„ç½‘ç»œæ ˆï¼‰
Nodeçš„80/443ç«¯å£
   â†“
åº”ç”¨Service
   â†“
åº”ç”¨Pods
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
  âœ“ æ— éœ€LoadBalancerï¼ˆçœé’±ï¼‰
  âœ“ ç›´æ¥ä½¿ç”¨Nodeçš„80/443ç«¯å£
  âœ“ æ€§èƒ½å¥½ï¼ˆæ— é¢å¤–ç½‘ç»œå±‚ï¼‰
  âœ“ é€‚ç”¨äºè£¸é‡‘å±ç¯å¢ƒ

ç¼ºç‚¹ï¼š
  âœ— æ¯ä¸ªNodeåªèƒ½è¿è¡Œä¸€ä¸ªIngress Pod
  âœ— Nodeçš„80/443ç«¯å£è¢«å ç”¨
  âœ— éœ€è¦å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚Nginx/HAProxyï¼‰åˆ†å‘åˆ°å„Node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;éƒ¨ç½²ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nginx-ingress-controller
  namespace: ingress-nginx
spec:
  selector:
    matchLabels:
      app: nginx-ingress
  template:
    metadata:
      labels:
        app: nginx-ingress
    spec:
      hostNetwork: true           # å…³é”®ï¼šä½¿ç”¨Nodeç½‘ç»œ
      dnsPolicy: ClusterFirstWithHostNet
      containers:
      - name: nginx-ingress-controller
        image: k8s.gcr.io/ingress-nginx/controller:v1.0.0
        args:
        - /nginx-ingress-controller
        ports:
        - name: http
          containerPort: 80
          hostPort: 80            # ç»‘å®šNodeçš„80ç«¯å£
        - name: https
          containerPort: 443
          hostPort: 443           # ç»‘å®šNodeçš„443ç«¯å£
      nodeSelector:
        ingress: &quot;true&quot;           # åªåœ¨ç‰¹å®šNodeè¿è¡Œ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ ‡è®°Nodeè¿è¡ŒIngressï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç»™Nodeæ‰“æ ‡ç­¾
kubectl label node node1 ingress=true
kubectl label node node2 ingress=true

# éªŒè¯
kubectl get nodes --show-labels | grep ingress
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å¤–éƒ¨è´Ÿè½½å‡è¡¡é…ç½®ï¼ˆNginxç¤ºä¾‹ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨å¤–éƒ¨Nginxä¸Šé…ç½®
upstream k8s_ingress {
    server 192.168.100.21:80;    # node1
    server 192.168.100.22:80;    # node2
}

server {
    listen 80;
    server_name *.example.com;
    
    location / {
        proxy_pass http://k8s_ingress;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;éƒ¨ç½²æ–¹å¼3ï¼šNodePort + Deployment&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é€‚ç”¨åœºæ™¯ï¼š&lt;/strong&gt; æµ‹è¯•ç¯å¢ƒã€å°è§„æ¨¡é›†ç¾¤&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ¶æ„å›¾ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;å¤–éƒ¨ç”¨æˆ·
   â†“
ä»»æ„Node IP:NodePort (å¦‚192.168.100.21:30080)
   â†“
Ingress Controller Service (NodePortç±»å‹)
   â†“
Ingress Controller Pods
   â†“
åº”ç”¨Service
   â†“
åº”ç”¨Pods
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ä¼˜ç‚¹ï¼š
  âœ“ æ— éœ€LoadBalancer
  âœ“ ç®€å•æ˜“ç”¨
  âœ“ é€‚åˆæµ‹è¯•ç¯å¢ƒ

ç¼ºç‚¹ï¼š
  âœ— ç«¯å£ä¸æ˜¯æ ‡å‡†80/443
  âœ— éœ€è¦è®°ä½NodePort
  âœ— ä¸é€‚åˆç”Ÿäº§ç¯å¢ƒ
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;éƒ¨ç½²ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Service
metadata:
  name: ingress-nginx
  namespace: ingress-nginx
spec:
  type: NodePort
  ports:
  - name: http
    port: 80
    targetPort: 80
    nodePort: 30080         # å¤–éƒ¨è®¿é—®Node:30080
  - name: https
    port: 443
    targetPort: 443
    nodePort: 30443
  selector:
    app: nginx-ingress
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;ä¸‰ç§éƒ¨ç½²æ–¹å¼å¯¹æ¯”&lt;/h4&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;LoadBalancer+Deployment&lt;/th&gt;
&lt;th&gt;DaemonSet+hostNetwork&lt;/th&gt;
&lt;th&gt;NodePort+Deployment&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;é€‚ç”¨ç¯å¢ƒ&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;äº‘å¹³å°&lt;/td&gt;
&lt;td&gt;è£¸é‡‘å±/ç§æœ‰äº‘&lt;/td&gt;
&lt;td&gt;æµ‹è¯•ç¯å¢ƒ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;å¤–éƒ¨è®¿é—®&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;LBå…¬ç½‘IP:80/443&lt;/td&gt;
&lt;td&gt;Node IP:80/443&lt;/td&gt;
&lt;td&gt;Node IP:30080&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;æˆæœ¬&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;éœ€è¦ä»˜è´¹LB&lt;/td&gt;
&lt;td&gt;å…è´¹ï¼ˆéœ€å¤–éƒ¨LBï¼‰&lt;/td&gt;
&lt;td&gt;å…è´¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;é«˜å¯ç”¨&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;äº‘å¹³å°LBè‡ªåŠ¨å®ç°&lt;/td&gt;
&lt;td&gt;éœ€å¤–éƒ¨LB&lt;/td&gt;
&lt;td&gt;æ— ï¼ˆå•ç‚¹ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ç«¯å£&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ ‡å‡†80/443&lt;/td&gt;
&lt;td&gt;æ ‡å‡†80/443&lt;/td&gt;
&lt;td&gt;éæ ‡å‡†ç«¯å£&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;ç”Ÿäº§æ¨è&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;td&gt;âœ—&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§ç¯å¢ƒæ¨èï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;äº‘å¹³å°ï¼šLoadBalancer + Deployment
  - AWS EKSã€é˜¿é‡Œäº‘ACKã€è…¾è®¯äº‘TKEç­‰
  - è‡ªåŠ¨åˆ›å»ºELB/SLB/CLB
  - é«˜å¯ç”¨ã€æ˜“ç®¡ç†

è£¸é‡‘å±/ç§æœ‰äº‘ï¼šDaemonSet + hostNetwork
  - è‡ªå»ºæœºæˆ¿ã€ç§æœ‰äº‘
  - é…åˆå¤–éƒ¨Nginx/HAProxy/Keepalived
  - æˆæœ¬ä½ã€æ€§èƒ½å¥½

æ··åˆæ–¹æ¡ˆï¼šDaemonSet + hostNetwork + MetalLB
  - è£¸é‡‘å±ç¯å¢ƒ
  - ä½¿ç”¨MetalLBæä¾›LoadBalancerèƒ½åŠ›
  - ç»“åˆä¸¤ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;å°ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;IngressåŠŸèƒ½æ€»ç»“ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;åŸºç¡€åŠŸèƒ½ï¼š
  âœ“ åŸºäºåŸŸåè·¯ç”±
  âœ“ åŸºäºè·¯å¾„è·¯ç”±
  âœ“ HTTPS/SSLç»ˆæ­¢

é«˜çº§åŠŸèƒ½ï¼š
  âœ“ URLé‡å†™/é‡å®šå‘
  âœ“ é‡‘ä¸é›€å‘å¸ƒ
  âœ“ A/Bæµ‹è¯•
  âœ“ é€Ÿç‡é™åˆ¶
  âœ“ IPç™½åå•
  âœ“ è®¤è¯æˆæƒ
  âœ“ CORSè·¨åŸŸ

éƒ¨ç½²æ–¹å¼ï¼š
  âœ“ LoadBalancer + Deploymentï¼ˆäº‘å¹³å°ï¼‰
  âœ“ DaemonSet + hostNetworkï¼ˆè£¸é‡‘å±ï¼‰
  âœ“ NodePort + Deploymentï¼ˆæµ‹è¯•ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;ä¸‹ä¸€æ­¥ï¼š&lt;/strong&gt; æˆ‘ä»¬å°†é€šè¿‡å®é™…æ“ä½œï¼Œéƒ¨ç½²Ingress Controllerå¹¶æ¼”ç¤ºå„ç§åŠŸèƒ½ã€‚&lt;/p&gt;
&lt;hr /&gt;
&lt;h3&gt;3. Ingresså®æˆ˜æ“ä½œ&lt;/h3&gt;
&lt;h4&gt;3.1 éƒ¨ç½²Nginx Ingress Controllerï¼ˆDaemonSetæ¨¡å¼ï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šæ ‡è®°è¿è¡ŒIngressçš„Node&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl label node node1 ingress=true
kubectl label node node2 ingress=true
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šä¸‹è½½å¹¶ä¿®æ”¹éƒ¨ç½²æ–‡ä»¶&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸‹è½½å®˜æ–¹éƒ¨ç½²æ–‡ä»¶
wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/baremetal/deploy.yaml

# å…³é”®ä¿®æ”¹ï¼š
# 1. Deploymentæ”¹ä¸ºDaemonSet
# 2. æ·»åŠ  hostNetwork: true
# 3. æ·»åŠ  dnsPolicy: ClusterFirstWithHostNet
# 4. æ·»åŠ  nodeSelector: ingress: &quot;true&quot;
# 5. é•œåƒæ”¹ä¸ºå›½å†…æºï¼ˆå¯é€‰ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤3ï¼šéƒ¨ç½²&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl apply -f deploy.yaml
kubectl get pods -n ingress-nginx -o wide
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.2 å®éªŒ1ï¼šåŸºäºåŸŸåè·¯ç”±&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ç»™containerdé…ç½®ä»£ç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;åœ¨æ­¤ä¹‹å‰ï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬ä¸‹é¢ä½¿ç”¨dockerå®˜æ–¹çš„é•œåƒï¼Œç”±äºå›½å†…æ— æ³•ç›´æ¥æ‹‰å–å®˜æ–¹é•œåƒï¼Œæˆ‘ä»¬éœ€è¦ç»™èŠ‚ç‚¹çš„containerdé…ç½®ä»£ç†ï¼Œè®¾ç½®æˆ‘ä»¬çš„ç§æœ‰ä»“åº“reg.westos.orgä¸èµ°ä»£ç†ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#åœ¨æ¯ä¸ªk8sèŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œæ¢æˆä½ çš„ä»£ç†åœ°å€
mkdir -p /etc/systemd/system/containerd.service.d
cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/systemd/system/containerd.service.d/proxy.conf
[Service]
Environment=&quot;HTTP_PROXY=http://192.168.10.141:7897&quot;
Environment=&quot;HTTPS_PROXY=http://192.168.10.141:7897&quot;
Environment=&quot;NO_PROXY=localhost,127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,.svc,.cluster.local,reg.westos.org&quot;
EOF
sudo systemctl daemon-reload
sudo systemctl restart containerd
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šåˆ›å»ºä¸¤ä¸ªåº”ç”¨Podï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºnginxåº”ç”¨Podï¼ˆ2ä¸ªå‰¯æœ¬ï¼‰
cat &amp;gt; nginx-app-pods.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: nginx-app-1
  labels:
    app: nginx-app
spec:
  containers:
  - name: nginx
    image: nginx:1.20
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: nginx-app-2
  labels:
    app: nginx-app
spec:
  containers:
  - name: nginx
    image: nginx:1.20
    ports:
    - containerPort: 80
EOF

kubectl apply -f nginx-app-pods.yaml

# åˆ›å»ºhttpdåº”ç”¨Podï¼ˆ2ä¸ªå‰¯æœ¬ï¼‰
cat &amp;gt; httpd-app-pods.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: httpd-app-1
  labels:
    app: httpd-app
spec:
  containers:
  - name: httpd
    image: httpd:2.4
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: httpd-app-2
  labels:
    app: httpd-app
spec:
  containers:
  - name: httpd
    image: httpd:2.4
    ports:
    - containerPort: 80
EOF

kubectl apply -f httpd-app-pods.yaml

# ç­‰å¾…Podå°±ç»ª
kubectl get pods -l app=nginx-app
kubectl get pods -l app=httpd-app
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåˆ›å»ºServiceï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºnginx-service
cat &amp;gt; nginx-service.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx-app
  ports:
  - port: 80
    targetPort: 80
EOF

kubectl apply -f nginx-service.yaml

# åˆ›å»ºhttpd-service
cat &amp;gt; httpd-service.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: httpd-service
spec:
  selector:
    app: httpd-app
  ports:
  - port: 80
    targetPort: 80
EOF

kubectl apply -f httpd-service.yaml

# æŸ¥çœ‹Serviceå’ŒEndpoints
kubectl get svc
kubectl get endpoints

# åˆ›å»ºåŸºäºåŸŸåçš„Ingress
cat &amp;gt; domain-ingress.yaml &amp;lt;&amp;lt;EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: domain-ingress
spec:
  ingressClassName: nginx
  rules:
  - host: nginx.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
  - host: httpd.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: httpd-service
            port:
              number: 80
EOF

kubectl apply -f domain-ingress.yaml

# é…ç½®hostsï¼ˆæµ‹è¯•æœºå™¨ï¼‰
echo &quot;192.168.100.21 nginx.example.com httpd.example.com&quot; &amp;gt;&amp;gt; /etc/hosts

# æµ‹è¯•
curl http://nginx.example.com
curl http://httpd.example.com

# æ¸…ç†
kubectl delete ingress domain-ingress
kubectl delete svc nginx-service httpd-service
kubectl delete pod nginx-app-1 nginx-app-2 httpd-app-1 httpd-app-2
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.3 å®éªŒ2ï¼šåŸºäºè·¯å¾„è·¯ç”± + URLé‡å†™&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å‰æï¼šä½¿ç”¨å®éªŒ1åˆ›å»ºçš„Podå’ŒServiceï¼Œå¦‚æœå·²æ¸…ç†åˆ™éœ€è¦é‡æ–°åˆ›å»º&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºåŸºäºè·¯å¾„çš„Ingress
cat &amp;gt; path-rewrite-ingress.yaml &amp;lt;&amp;lt;EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: path-rewrite
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /\$2
spec:
  ingressClassName: nginx
  rules:
  - host: api.example.com
    http:
      paths:
      - path: /nginx(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: nginx-service
            port:
              number: 80
      - path: /httpd(/|$)(.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: httpd-service
            port:
              number: 80
EOF

kubectl apply -f path-rewrite-ingress.yaml

# é…ç½®hostsï¼ˆæµ‹è¯•æœºå™¨ï¼‰
echo &quot;192.168.100.21 api.example.com&quot; &amp;gt;&amp;gt; /etc/hosts

# æµ‹è¯•
curl http://api.example.com/nginx   # è½¬å‘åˆ°nginx-service/
curl http://api.example.com/httpd   # è½¬å‘åˆ°httpd-service/

# æ¸…ç†
kubectl delete ingress path-rewrite
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.4 å®éªŒ3ï¼šHTTPSé…ç½®&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å‰æï¼šä½¿ç”¨å®éªŒ1åˆ›å»ºçš„nginx-serviceï¼Œå¦‚æœå·²æ¸…ç†åˆ™éœ€è¦é‡æ–°åˆ›å»º&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
  -keyout tls.key -out tls.crt \
  -subj &quot;/CN=secure.example.com&quot;

# åˆ›å»ºTLS Secret
kubectl create secret tls example-tls --cert=tls.crt --key=tls.key

# åˆ›å»ºHTTPS Ingress
cat &amp;gt; https-ingress.yaml &amp;lt;&amp;lt;EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: https-ingress
  annotations:
    nginx.ingress.kubernetes.io/ssl-redirect: &quot;true&quot;
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - secure.example.com
    secretName: example-tls
  rules:
  - host: secure.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              number: 80
EOF

kubectl apply -f https-ingress.yaml

# é…ç½®hostsï¼ˆæµ‹è¯•æœºå™¨ï¼‰
echo &quot;192.168.100.21 secure.example.com&quot; &amp;gt;&amp;gt; /etc/hosts

# æµ‹è¯•
curl -k https://secure.example.com        # HTTPSè®¿é—®
curl -I http://secure.example.com         # HTTPè‡ªåŠ¨è·³è½¬

# æ¸…ç†
kubectl delete ingress https-ingress
kubectl delete secret example-tls
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.5 å®éªŒ4ï¼šé‡‘ä¸é›€å‘å¸ƒ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤1ï¼šåˆ›å»ºv1ç‰ˆæœ¬Podï¼ˆ3ä¸ªå‰¯æœ¬ï¼Œçº¢è‰²é¡µé¢ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; app-v1-pods.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: app-v1-1
  labels:
    app: myapp
    version: v1
spec:
  containers:
  - name: app
    image: nginx:1.20
    command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
    args:
    - echo &apos;&amp;lt;h1 style=&quot;color:red&quot;&amp;gt;Version 1&amp;lt;/h1&amp;gt;&apos; &amp;gt; /usr/share/nginx/html/index.html &amp;amp;&amp;amp; nginx -g &apos;daemon off;&apos;
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: app-v1-2
  labels:
    app: myapp
    version: v1
spec:
  containers:
  - name: app
    image: nginx:1.20
    command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
    args:
    - echo &apos;&amp;lt;h1 style=&quot;color:red&quot;&amp;gt;Version 1&amp;lt;/h1&amp;gt;&apos; &amp;gt; /usr/share/nginx/html/index.html &amp;amp;&amp;amp; nginx -g &apos;daemon off;&apos;
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: app-v1-3
  labels:
    app: myapp
    version: v1
spec:
  containers:
  - name: app
    image: nginx:1.20
    command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
    args:
    - echo &apos;&amp;lt;h1 style=&quot;color:red&quot;&amp;gt;Version 1&amp;lt;/h1&amp;gt;&apos; &amp;gt; /usr/share/nginx/html/index.html &amp;amp;&amp;amp; nginx -g &apos;daemon off;&apos;
    ports:
    - containerPort: 80
EOF

kubectl apply -f app-v1-pods.yaml

# åˆ›å»ºv1 Service
cat &amp;gt; app-v1-service.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: app-v1-service
spec:
  selector:
    app: myapp
    version: v1
  ports:
  - port: 80
EOF

kubectl apply -f app-v1-service.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤2ï¼šåˆ›å»ºv2ç‰ˆæœ¬Podï¼ˆ3ä¸ªå‰¯æœ¬ï¼Œç»¿è‰²é¡µé¢ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; app-v2-pods.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Pod
metadata:
  name: app-v2-1
  labels:
    app: myapp
    version: v2
spec:
  containers:
  - name: app
    image: nginx:1.20
    command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
    args:
    - echo &apos;&amp;lt;h1 style=&quot;color:green&quot;&amp;gt;Version 2 - Canary&amp;lt;/h1&amp;gt;&apos; &amp;gt; /usr/share/nginx/html/index.html &amp;amp;&amp;amp; nginx -g &apos;daemon off;&apos;
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: app-v2-2
  labels:
    app: myapp
    version: v2
spec:
  containers:
  - name: app
    image: nginx:1.20
    command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
    args:
    - echo &apos;&amp;lt;h1 style=&quot;color:green&quot;&amp;gt;Version 2 - Canary&amp;lt;/h1&amp;gt;&apos; &amp;gt; /usr/share/nginx/html/index.html &amp;amp;&amp;amp; nginx -g &apos;daemon off;&apos;
    ports:
    - containerPort: 80
---
apiVersion: v1
kind: Pod
metadata:
  name: app-v2-3
  labels:
    app: myapp
    version: v2
spec:
  containers:
  - name: app
    image: nginx:1.20
    command: [&quot;/bin/sh&quot;, &quot;-c&quot;]
    args:
    - echo &apos;&amp;lt;h1 style=&quot;color:green&quot;&amp;gt;Version 2 - Canary&amp;lt;/h1&amp;gt;&apos; &amp;gt; /usr/share/nginx/html/index.html &amp;amp;&amp;amp; nginx -g &apos;daemon off;&apos;
    ports:
    - containerPort: 80
EOF

kubectl apply -f app-v2-pods.yaml

# åˆ›å»ºv2 Service
cat &amp;gt; app-v2-service.yaml &amp;lt;&amp;lt;EOF
apiVersion: v1
kind: Service
metadata:
  name: app-v2-service
spec:
  selector:
    app: myapp
    version: v2
  ports:
  - port: 80
EOF

kubectl apply -f app-v2-service.yaml

# ç­‰å¾…æ‰€æœ‰Podå°±ç»ª
kubectl get pods -l app=myapp
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºä¸»Ingresså’Œé‡‘ä¸é›€Ingressï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸»Ingressï¼ˆv1ï¼‰
cat &amp;gt; canary-main.yaml &amp;lt;&amp;lt;EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-main
spec:
  ingressClassName: nginx
  rules:
  - host: app.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v1-service
            port:
              number: 80
EOF

# é‡‘ä¸é›€Ingressï¼ˆv2ï¼Œ10%æµé‡ï¼‰
cat &amp;gt; canary-test.yaml &amp;lt;&amp;lt;EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-canary
  annotations:
    nginx.ingress.kubernetes.io/canary: &quot;true&quot;
    nginx.ingress.kubernetes.io/canary-weight: &quot;10&quot;
spec:
  ingressClassName: nginx
  rules:
  - host: app.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v2-service
            port:
              number: 80
EOF

kubectl apply -f canary-main.yaml
kubectl apply -f canary-test.yaml

# é…ç½®hostsï¼ˆæµ‹è¯•æœºå™¨ï¼‰
echo &quot;192.168.100.21 app.example.com&quot; &amp;gt;&amp;gt; /etc/hosts

# æµ‹è¯•æµé‡åˆ†é…ï¼ˆ10%æµå‘v2ï¼‰
for i in {1..100}; do curl -s http://app.example.com | grep -o &quot;Version [0-9]&quot;; done | sort | uniq -c
# è¾“å‡ºï¼šçº¦90ä¸ªVersion 1ï¼Œçº¦10ä¸ªVersion 2

# é€æ­¥å¢åŠ æƒé‡ï¼ˆå¯é€‰ï¼‰
kubectl patch ingress app-canary -p &apos;{&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;nginx.ingress.kubernetes.io/canary-weight&quot;:&quot;30&quot;}}}&apos;
kubectl patch ingress app-canary -p &apos;{&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;nginx.ingress.kubernetes.io/canary-weight&quot;:&quot;50&quot;}}}&apos;

# æ¸…ç†
kubectl delete ingress app-main app-canary
kubectl delete svc app-v1-service app-v2-service
kubectl delete pod app-v1-1 app-v1-2 app-v1-3 app-v2-1 app-v2-2 app-v2-3
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.6 å®éªŒ5ï¼šåŸºäºHeaderçš„é‡‘ä¸é›€ï¼ˆå†…éƒ¨æµ‹è¯•ï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å‰æï¼šä½¿ç”¨å®éªŒ4åˆ›å»ºçš„Podå’ŒServiceï¼Œå¦‚æœå·²æ¸…ç†åˆ™éœ€è¦é‡æ–°åˆ›å»º&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºåŸºäºHeaderçš„é‡‘ä¸é›€Ingress
cat &amp;gt; canary-header.yaml &amp;lt;&amp;lt;EOF
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-canary-header
  annotations:
    nginx.ingress.kubernetes.io/canary: &quot;true&quot;
    nginx.ingress.kubernetes.io/canary-by-header: &quot;X-Canary&quot;
    nginx.ingress.kubernetes.io/canary-by-header-value: &quot;true&quot;
spec:
  ingressClassName: nginx
  rules:
  - host: app.example.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: app-v2-service
            port:
              number: 80
EOF

kubectl apply -f canary-header.yaml

# æµ‹è¯•
curl http://app.example.com                       # æ™®é€šç”¨æˆ· -&amp;gt; v1ï¼ˆçº¢è‰²ï¼‰
curl -H &quot;X-Canary: true&quot; http://app.example.com   # æµ‹è¯•äººå‘˜ -&amp;gt; v2ï¼ˆç»¿è‰²ï¼‰

# æ¸…ç†
kubectl delete ingress app-canary-header
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.7 å…¶ä»–é«˜çº§åŠŸèƒ½ç¤ºä¾‹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;é€Ÿç‡é™åˆ¶ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;metadata:
  annotations:
    nginx.ingress.kubernetes.io/limit-rps: &quot;5&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;IPç™½åå•ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;metadata:
  annotations:
    nginx.ingress.kubernetes.io/whitelist-source-range: &quot;192.168.100.0/24&quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;åŸºæœ¬è®¤è¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;htpasswd -c auth admin
kubectl create secret generic basic-auth --from-file=auth
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code&gt;metadata:
  annotations:
    nginx.ingress.kubernetes.io/auth-type: basic
    nginx.ingress.kubernetes.io/auth-secret: basic-auth
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h4&gt;3.8 å¸¸ç”¨ç®¡ç†å‘½ä»¤&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹Ingress
kubectl get ingress
kubectl describe ingress &amp;lt;name&amp;gt;

# æŸ¥çœ‹Ingress Controlleræ—¥å¿—
kubectl logs -n ingress-nginx &amp;lt;pod-name&amp;gt; -f

# æŸ¥çœ‹ç”Ÿæˆçš„Nginxé…ç½®
kubectl exec -n ingress-nginx &amp;lt;pod-name&amp;gt; -- cat /etc/nginx/nginx.conf

# è°ƒè¯•
curl -v -H &quot;Host: example.com&quot; http://192.168.100.21
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;4. æ€»ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;Ingressæ ¸å¿ƒä»·å€¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;ç»Ÿä¸€å…¥å£&lt;/strong&gt; - ä¸€ä¸ªIPæœåŠ¡å¤šä¸ªåº”ç”¨ï¼ŒèŠ‚çœæˆæœ¬&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;7å±‚è·¯ç”±&lt;/strong&gt; - åŸºäºåŸŸåã€è·¯å¾„ã€Headeræ™ºèƒ½è·¯ç”±&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SSLé›†ä¸­ç®¡ç†&lt;/strong&gt; - ç»Ÿä¸€è¯ä¹¦é…ç½®ï¼Œç®€åŒ–ç®¡ç†&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä¼ä¸šçº§åŠŸèƒ½&lt;/strong&gt; - é‡‘ä¸é›€ã€A/Bæµ‹è¯•ã€é™æµã€è®¤è¯&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿäº§ç¯å¢ƒå»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;âœ“ è£¸é‡‘å±ï¼šDaemonSet + hostNetwork + å¤–éƒ¨LB
âœ“ äº‘å¹³å°ï¼šLoadBalancer + Deployment
âœ“ é…ç½®èµ„æºé™åˆ¶å’Œç›‘æ§
âœ“ ä½¿ç”¨cert-managerè‡ªåŠ¨ç®¡ç†è¯ä¹¦
âœ“ é…ç½®å¤‡ä»½å’Œç¾éš¾æ¢å¤è®¡åˆ’
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Ingress vs Serviceå¯¹æ¯”ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç‰¹æ€§&lt;/th&gt;
&lt;th&gt;Service&lt;/th&gt;
&lt;th&gt;Ingress&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;OSIå±‚&lt;/td&gt;
&lt;td&gt;4å±‚&lt;/td&gt;
&lt;td&gt;7å±‚&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;è·¯ç”±&lt;/td&gt;
&lt;td&gt;IP+ç«¯å£&lt;/td&gt;
&lt;td&gt;åŸŸå+è·¯å¾„&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;æˆæœ¬&lt;/td&gt;
&lt;td&gt;æ¯æœåŠ¡1ä¸ªLB&lt;/td&gt;
&lt;td&gt;å¤šæœåŠ¡å…±äº«1ä¸ªå…¥å£&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;åŠŸèƒ½&lt;/td&gt;
&lt;td&gt;è´Ÿè½½å‡è¡¡&lt;/td&gt;
&lt;td&gt;è·¯ç”±+SSL+é‡‘ä¸é›€ç­‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;åœºæ™¯&lt;/td&gt;
&lt;td&gt;å†…éƒ¨é€šä¿¡&lt;/td&gt;
&lt;td&gt;å¤–éƒ¨è®¿é—®&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
</content:encoded></item><item><title>01.Kubernetes å­¦ä¹ ç¬”è®°ï¼šåŸºç¡€æ¦‚å¿µä¸ Pod è¯¦è§£</title><link>https://dev-null-sec.github.io/posts/01-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8Epod%E8%AF%A6%E8%A7%A3/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/01-k8s%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5%E4%B8%8Epod%E8%AF%A6%E8%A7%A3/</guid><description>K8s åŸºç¡€å…¥é—¨ï¼Œä»‹ç»æ¶æ„ã€ç»„ä»¶ã€å·¥ä½œåŸç†ï¼Œä»¥åŠ Pod çš„ç”Ÿå‘½å‘¨æœŸå’Œå®æˆ˜</description><pubDate>Fri, 09 May 2025 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;æœ¬ç¯‡ç¬”è®°è®°å½• k8s çš„æ ¸å¿ƒæ¦‚å¿µã€æ¶æ„ç»„ä»¶ï¼Œä»¥åŠ Pod çš„è¯¦ç»†ä½¿ç”¨ã€‚ç¯å¢ƒæ˜¯ä¸€ä¸»ä¸¤ä»çš„é›†ç¾¤ï¼Œé•œåƒä»ç§æœ‰ Harbor ä»“åº“æ‹‰å–ã€‚&lt;/p&gt;
&lt;h2&gt;ç¯å¢ƒè¯´æ˜&lt;/h2&gt;
&lt;p&gt;é›†ç¾¤å·²æå‰æ­å»ºå®Œæˆï¼Œå‚è€ƒ&lt;a href=&quot;../%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/&quot;&gt;è¿™ç¯‡æ–‡ç« &lt;/a&gt;ã€‚&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ä¸»æœº&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;k8s-master&lt;/td&gt;
&lt;td&gt;192.168.100.20&lt;/td&gt;
&lt;td&gt;æ§åˆ¶å¹³é¢èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node1&lt;/td&gt;
&lt;td&gt;192.168.100.21&lt;/td&gt;
&lt;td&gt;worker èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node2&lt;/td&gt;
&lt;td&gt;192.168.100.22&lt;/td&gt;
&lt;td&gt;worker èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;harbor&lt;/td&gt;
&lt;td&gt;192.168.100.14&lt;/td&gt;
&lt;td&gt;ç§æœ‰é•œåƒä»“åº“&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;Harbor ä»“åº“ä¿¡æ¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åŸŸåï¼š&lt;code&gt;reg.westos.org&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;é•œåƒåœ°å€ï¼š&lt;code&gt;reg.westos.org/library/&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å·²ç»æå‰æ­å»ºk8sé›†ç¾¤ç¯å¢ƒï¼Œè‹¥æ²¡æœ‰è¯·å‚è€ƒ ../æ­å»ºk8sé›†ç¾¤&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ä¸»æœº&lt;/th&gt;
&lt;th&gt;ip&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;k8s-master&lt;/td&gt;
&lt;td&gt;192.168.100.20&lt;/td&gt;
&lt;td&gt;k8sä¸»èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node1&lt;/td&gt;
&lt;td&gt;192.168.100.21&lt;/td&gt;
&lt;td&gt;workèŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node2&lt;/td&gt;
&lt;td&gt;192.168.100.22&lt;/td&gt;
&lt;td&gt;workèŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;harbor&lt;/td&gt;
&lt;td&gt;192.168.100.14&lt;/td&gt;
&lt;td&gt;ç§æœ‰é•œåƒä»“åº“&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;harborä»“åº“åŸŸåä¸ºreg.westos.org
é•œåƒåœ°å€ä¸ºreg.westos.org/library/&lt;/p&gt;
&lt;hr /&gt;
&lt;h2&gt;ä¸€ã€k8sä»‹ç»&lt;/h2&gt;
&lt;h3&gt;ç¬¬ä¸€éƒ¨åˆ†ï¼šK8sæ˜¯ä»€ä¹ˆï¼Œè§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œè®¾è®¡ç†å¿µå’Œæ€æƒ³&lt;/h3&gt;
&lt;h4&gt;1.1 K8sæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Kubernetesï¼ˆK8sï¼‰&lt;/strong&gt; æ˜¯ä¸€ä¸ªå¼€æºçš„å®¹å™¨ç¼–æ’å¹³å°ï¼Œç”¨äºè‡ªåŠ¨åŒ–éƒ¨ç½²ã€æ‰©å±•å’Œç®¡ç†å®¹å™¨åŒ–åº”ç”¨ç¨‹åºã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;åç§°ç”±æ¥&lt;/strong&gt;ï¼šKubernetes æºäºå¸Œè…Šè¯­ï¼Œæ„ä¸º&quot;èˆµæ‰‹&quot;æˆ–&quot;é¢†èˆªå‘˜&quot;ï¼Œç¼©å†™K8sæ˜¯å› ä¸ºKå’Œsä¹‹é—´æœ‰8ä¸ªå­—æ¯&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;èµ·æº&lt;/strong&gt;ï¼šGoogleåŸºäºå…¶å†…éƒ¨å®¹å™¨ç¼–æ’ç³»ç»ŸBorgçš„ç»éªŒï¼Œäº2014å¹´å¼€æº&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å½“å‰çŠ¶æ€&lt;/strong&gt;ï¼šå·²æˆä¸ºäº‘åŸç”Ÿåº”ç”¨ç¼–æ’çš„äº‹å®æ ‡å‡†ï¼Œç”±CNCFï¼ˆCloud Native Computing Foundationï¼‰ç»´æŠ¤&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;1.2 è§£å†³äº†ä»€ä¹ˆé—®é¢˜&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;ä¼ ç»Ÿéƒ¨ç½²æ–¹å¼çš„ç—›ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;èµ„æºåˆ©ç”¨ç‡ä½&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç‰©ç†æœºéƒ¨ç½²ï¼šä¸€å°æœåŠ¡å™¨åªè¿è¡Œä¸€ä¸ªåº”ç”¨ï¼Œèµ„æºæµªè´¹ä¸¥é‡&lt;/li&gt;
&lt;li&gt;ç¯å¢ƒéš”ç¦»å·®ï¼šå¤šä¸ªåº”ç”¨å…±äº«ä¸€å°æœåŠ¡å™¨ï¼Œç›¸äº’å½±å“&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ‰©å±•å›°éš¾&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ‰‹åŠ¨æ‰©å®¹ï¼šéœ€è¦äººå·¥ä»‹å…¥ï¼Œå“åº”æ…¢&lt;/li&gt;
&lt;li&gt;å¼¹æ€§ä¼¸ç¼©éš¾ï¼šæ— æ³•æ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è¿ç»´å¤æ‚&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æœåŠ¡å‘ç°å›°éš¾ï¼šéœ€è¦æ‰‹åŠ¨é…ç½®IPå’Œç«¯å£&lt;/li&gt;
&lt;li&gt;è´Ÿè½½å‡è¡¡é…ç½®ç¹ç&lt;/li&gt;
&lt;li&gt;åº”ç”¨æ›´æ–°é£é™©é«˜ï¼šåœæœºæ—¶é—´é•¿ï¼Œå›æ»šå›°éš¾&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;K8sçš„è§£å†³æ–¹æ¡ˆï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è‡ªåŠ¨åŒ–å®¹å™¨ç¼–æ’&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨éƒ¨ç½²å’Œè°ƒåº¦å®¹å™¨åˆ°åˆé€‚çš„èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨é‡å¯å¤±è´¥çš„å®¹å™¨&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨æ›¿æ¢å’Œé‡æ–°è°ƒåº¦æ•…éšœèŠ‚ç‚¹ä¸Šçš„å®¹å™¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨åˆ†é…DNSåç§°å’ŒIPåœ°å€&lt;/li&gt;
&lt;li&gt;å†…ç½®è´Ÿè½½å‡è¡¡ï¼Œè‡ªåŠ¨åˆ†å‘æµé‡&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è‡ªåŠ¨æ‰©ç¼©å®¹&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ°´å¹³æ‰©å±•ï¼šæ ¹æ®CPUä½¿ç”¨ç‡æˆ–è‡ªå®šä¹‰æŒ‡æ ‡è‡ªåŠ¨å¢å‡Podæ•°é‡&lt;/li&gt;
&lt;li&gt;å‚ç›´æ‰©å±•ï¼šè°ƒæ•´å®¹å™¨èµ„æºé™åˆ¶&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è‡ªåŠ¨åŒ–å‘å¸ƒå’Œå›æ»š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ»šåŠ¨æ›´æ–°ï¼šé€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬ï¼Œé›¶åœæœº&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨å›æ»šï¼šæ£€æµ‹åˆ°é—®é¢˜è‡ªåŠ¨æ¢å¤åˆ°ä¸Šä¸€ç‰ˆæœ¬&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å­˜å‚¨ç¼–æ’&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨æŒ‚è½½å­˜å‚¨ç³»ç»Ÿï¼ˆæœ¬åœ°å­˜å‚¨ã€äº‘å­˜å‚¨ç­‰ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è‡ªæˆ‘ä¿®å¤&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¥åº·æ£€æŸ¥ï¼šå®šæœŸæ£€æµ‹å®¹å™¨å¥åº·çŠ¶æ€&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨é‡å¯ä¸å¥åº·çš„å®¹å™¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;1.3 è®¾è®¡ç†å¿µå’Œæ€æƒ³&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒè®¾è®¡ç†å¿µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å£°æ˜å¼API&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç”¨æˆ·åªéœ€è¦å£°æ˜&quot;æœŸæœ›çŠ¶æ€&quot;ï¼ˆDesired Stateï¼‰ï¼Œæ— éœ€å…³å¿ƒå¦‚ä½•å®ç°&lt;/li&gt;
&lt;li&gt;K8sä¼šæŒç»­å·¥ä½œï¼Œä½¿&quot;å½“å‰çŠ¶æ€&quot;ï¼ˆCurrent Stateï¼‰è¶‹å‘äº&quot;æœŸæœ›çŠ¶æ€&quot;&lt;/li&gt;
&lt;li&gt;ä¾‹å¦‚ï¼šå£°æ˜éœ€è¦3ä¸ªå‰¯æœ¬ï¼ŒK8sä¼šè‡ªåŠ¨åˆ›å»ºã€ç»´æŠ¤è¿™3ä¸ªå‰¯æœ¬&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ§åˆ¶å™¨æ¨¡å¼ï¼ˆController Patternï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;for {
  å®é™…çŠ¶æ€ := è·å–é›†ç¾¤å®é™…çŠ¶æ€()
  æœŸæœ›çŠ¶æ€ := è·å–ç”¨æˆ·å®šä¹‰çš„æœŸæœ›çŠ¶æ€()
  if å®é™…çŠ¶æ€ == æœŸæœ›çŠ¶æ€ {
    ä»€ä¹ˆéƒ½ä¸åš
  } else {
    æ‰§è¡Œç¼–æ’åŠ¨ä½œï¼Œå°†å®é™…çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çŠ¶æ€
  }
}
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ¾è€¦åˆæ¶æ„&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å„ä¸ªç»„ä»¶ç‹¬ç«‹è¿è¡Œï¼Œé€šè¿‡API Serveré€šä¿¡&lt;/li&gt;
&lt;li&gt;ç»„ä»¶å¯ä»¥ç‹¬ç«‹å‡çº§å’Œæ›¿æ¢&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;èµ„æºå¯¹è±¡åŒ–&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€åˆ‡çš†å¯¹è±¡ï¼šPodã€Serviceã€Deploymentç­‰éƒ½æ˜¯èµ„æºå¯¹è±¡&lt;/li&gt;
&lt;li&gt;é€šè¿‡YAML/JSONæ–‡ä»¶æè¿°èµ„æº&lt;/li&gt;
&lt;li&gt;ç»Ÿä¸€çš„APIæ¥å£ç®¡ç†æ‰€æœ‰èµ„æº&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Labelå’ŒSelectoræœºåˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Labelï¼šé”®å€¼å¯¹æ ‡ç­¾ï¼Œé™„åŠ åˆ°èµ„æºå¯¹è±¡ä¸Š&lt;/li&gt;
&lt;li&gt;Selectorï¼šé€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨æŸ¥è¯¢å’Œå…³è”èµ„æº&lt;/li&gt;
&lt;li&gt;å®ç°æ¾è€¦åˆçš„èµ„æºå…³è”&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åˆ†å±‚æ¶æ„&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åº”ç”¨å±‚ï¼šç”¨æˆ·åº”ç”¨&lt;/li&gt;
&lt;li&gt;ç¼–æ’å±‚ï¼šK8sæ ¸å¿ƒåŠŸèƒ½&lt;/li&gt;
&lt;li&gt;èµ„æºå±‚ï¼šè®¡ç®—ã€å­˜å‚¨ã€ç½‘ç»œ&lt;/li&gt;
&lt;li&gt;åŸºç¡€è®¾æ–½å±‚ï¼šç‰©ç†æœºã€è™šæ‹Ÿæœºã€äº‘æœåŠ¡&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;è®¾è®¡æ€æƒ³ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;å¯ç§»æ¤æ€§&lt;/strong&gt;ï¼šè·¨äº‘å¹³å°ã€è·¨æ•°æ®ä¸­å¿ƒè¿è¡Œ&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¯æ‰©å±•æ€§&lt;/strong&gt;ï¼šæ”¯æŒæ’ä»¶æœºåˆ¶ï¼Œå¯è‡ªå®šä¹‰èµ„æºå’Œæ§åˆ¶å™¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;è‡ªåŠ¨åŒ–&lt;/strong&gt;ï¼šæœ€å°åŒ–äººå·¥å¹²é¢„&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é«˜å¯ç”¨&lt;/strong&gt;ï¼šç»„ä»¶å†—ä½™ï¼Œæ•…éšœè‡ªåŠ¨æ¢å¤&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;ç¬¬äºŒéƒ¨åˆ†ï¼šK8sæ¶æ„ã€ç»„ä»¶åŠå…¶å…³ç³»&lt;/h3&gt;
&lt;h4&gt;2.1 K8sæ•´ä½“æ¶æ„&lt;/h4&gt;
&lt;p&gt;K8sé‡‡ç”¨&lt;strong&gt;ä¸»ä»æ¶æ„&lt;/strong&gt;ï¼ˆMaster-Workerï¼‰ï¼Œåˆ†ä¸º&lt;strong&gt;æ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰&lt;strong&gt;å’Œ&lt;/strong&gt;å·¥ä½œèŠ‚ç‚¹ï¼ˆWorker Nodeï¼‰&lt;/strong&gt;ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;graph TB
    subgraph Master[&quot;Control Plane (Master)&quot;]
        API[&quot;API Server&quot;]
        Scheduler[&quot;Scheduler&quot;]
        Controller[&quot;Controller Manager&quot;]
        etcd[&quot;etcd&quot;]
    end
    
    subgraph Node1[&quot;Worker Node1&quot;]
        K1[&quot;Kubelet&quot;]
        P1[&quot;Kube-proxy&quot;]
        R1[&quot;Container Runtime&quot;]
        Pods1[&quot;Pods&quot;]
    end
    
    subgraph Node2[&quot;Worker Node2&quot;]
        K2[&quot;Kubelet&quot;]
        P2[&quot;Kube-proxy&quot;]
        R2[&quot;Container Runtime&quot;]
        Pods2[&quot;Pods&quot;]
    end
    
    subgraph Node3[&quot;Worker Node3&quot;]
        K3[&quot;Kubelet&quot;]
        P3[&quot;Kube-proxy&quot;]
        R3[&quot;Container Runtime&quot;]
        Pods3[&quot;Pods&quot;]
    end
    
    Master --&amp;gt; Node1
    Master --&amp;gt; Node2
    Master --&amp;gt; Node3
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2.2 æ ¸å¿ƒç»„ä»¶æ¦‚è§ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;MasterèŠ‚ç‚¹ç»„ä»¶ï¼ˆæ§åˆ¶å¹³é¢ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç»„ä»¶&lt;/th&gt;
&lt;th&gt;ä½œç”¨&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;API Server&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;é›†ç¾¤çš„ç»Ÿä¸€å…¥å£ï¼Œæä¾›RESTful API&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;etcd&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨ï¼Œä¿å­˜é›†ç¾¤æ‰€æœ‰æ•°æ®&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Scheduler&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è´Ÿè´£Podè°ƒåº¦åˆ°åˆé€‚çš„NodeèŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Controller Manager&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è¿è¡Œå„ç§æ§åˆ¶å™¨ï¼Œç»´æŠ¤é›†ç¾¤çŠ¶æ€&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Cloud Controller&lt;/strong&gt; (å¯é€‰)&lt;/td&gt;
&lt;td&gt;ä¸äº‘å¹³å°äº¤äº’&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;WorkerèŠ‚ç‚¹ç»„ä»¶ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç»„ä»¶&lt;/th&gt;
&lt;th&gt;ä½œç”¨&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Kubelet&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç®¡ç†Podå’Œå®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Kube-proxy&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®ç°Serviceçš„ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Container Runtime&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚Dockerã€containerdï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;é™„åŠ ç»„ä»¶ï¼ˆAdd-onsï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç»„ä»¶&lt;/th&gt;
&lt;th&gt;ä½œç”¨&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;CoreDNS&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;é›†ç¾¤å†…éƒ¨DNSæœåŠ¡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Dashboard&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Web UIç®¡ç†ç•Œé¢&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;CNIæ’ä»¶&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;ç½‘ç»œæ’ä»¶ï¼ˆå¦‚Calicoã€Flannelï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Metrics Server&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;èµ„æºç›‘æ§&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;2.3 ç»„ä»¶ä¹‹é—´çš„å…³ç³»å’Œå·¥ä½œæµç¨‹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å…¸å‹çš„Podåˆ›å»ºæµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ç”¨æˆ·æäº¤&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl create -f pod.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;
&lt;li&gt;kubectlå°†è¯·æ±‚å‘é€åˆ°API Server&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;API Serverå¤„ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;éªŒè¯è¯·æ±‚åˆæ³•æ€§&lt;/li&gt;
&lt;li&gt;å°†Podä¿¡æ¯å†™å…¥etcd&lt;/li&gt;
&lt;li&gt;è¿”å›ç¡®è®¤ç»™ç”¨æˆ·&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Schedulerç›‘å¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šè¿‡Watchæœºåˆ¶ç›‘å¬åˆ°æ–°Podï¼ˆçŠ¶æ€ä¸ºPendingï¼Œæœªåˆ†é…èŠ‚ç‚¹ï¼‰&lt;/li&gt;
&lt;li&gt;æ‰§è¡Œè°ƒåº¦ç®—æ³•ï¼Œé€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;å°†ç»‘å®šä¿¡æ¯ï¼ˆPod â†’ Nodeï¼‰å†™å›API Server&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;API Serveræ›´æ–°&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ›´æ–°Podä¿¡æ¯ï¼ŒæŒ‡å®šè¿è¡ŒèŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;å°†æ•°æ®æŒä¹…åŒ–åˆ°etcd&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Kubeletç›‘å¬&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¯¹åº”èŠ‚ç‚¹çš„Kubeletç›‘å¬åˆ°åˆ†é…ç»™è‡ªå·±çš„Pod&lt;/li&gt;
&lt;li&gt;è°ƒç”¨Container Runtimeåˆ›å»ºå®¹å™¨&lt;/li&gt;
&lt;li&gt;å®šæœŸä¸ŠæŠ¥PodçŠ¶æ€ç»™API Server&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Controller Managerç›‘æ§&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒç»­ç›‘æ§PodçŠ¶æ€&lt;/li&gt;
&lt;li&gt;å¦‚æœPodå¼‚å¸¸ï¼Œè§¦å‘é‡å»ºæµç¨‹&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Kube-proxyé…ç½®&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å¦‚æœPodå±äºæŸä¸ªServiceï¼ŒKube-proxyæ›´æ–°iptables/ipvsè§„åˆ™&lt;/li&gt;
&lt;li&gt;å®ç°æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç»„ä»¶é€šä¿¡åŸåˆ™ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;æ‰€æœ‰ç»„ä»¶åªä¸API Serveré€šä¿¡&lt;/strong&gt;ï¼Œä¸ç›´æ¥äº’ç›¸é€šä¿¡&lt;/li&gt;
&lt;li&gt;API Serveræ˜¯å”¯ä¸€ç›´æ¥æ“ä½œetcdçš„ç»„ä»¶&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨&lt;strong&gt;List-Watchæœºåˆ¶&lt;/strong&gt;å®ç°äº‹ä»¶é©±åŠ¨ï¼š
&lt;ul&gt;
&lt;li&gt;Listï¼šè·å–èµ„æºåˆ—è¡¨&lt;/li&gt;
&lt;li&gt;Watchï¼šç›‘å¬èµ„æºå˜åŒ–&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;ç¬¬ä¸‰éƒ¨åˆ†ï¼šå„ä¸ªç»„ä»¶çš„è¯¦ç»†åŠŸèƒ½å’Œä½œç”¨&lt;/h3&gt;
&lt;h4&gt;3.1 API Serverï¼ˆkube-apiserverï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é›†ç¾¤ç®¡ç†çš„ç»Ÿä¸€å…¥å£&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æä¾›RESTful APIæ¥å£&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰æ“ä½œéƒ½è¦é€šè¿‡API Server&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è®¤è¯ã€æˆæƒã€å‡†å…¥æ§åˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;è®¤è¯ï¼ˆAuthenticationï¼‰&lt;/strong&gt;ï¼šéªŒè¯ç”¨æˆ·èº«ä»½ï¼ˆè¯ä¹¦ã€Tokenã€ServiceAccountï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æˆæƒï¼ˆAuthorizationï¼‰&lt;/strong&gt;ï¼šéªŒè¯æ“ä½œæƒé™ï¼ˆRBACã€ABACï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å‡†å…¥æ§åˆ¶ï¼ˆAdmission Controlï¼‰&lt;/strong&gt;ï¼šä¿®æ”¹æˆ–æ‹’ç»è¯·æ±‚ï¼ˆå¦‚èµ„æºé…é¢æ£€æŸ¥ï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;èµ„æºæ“ä½œæ¥å£&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;CRUDæ“ä½œï¼šåˆ›å»ºã€è¯»å–ã€æ›´æ–°ã€åˆ é™¤èµ„æº&lt;/li&gt;
&lt;li&gt;Watchæ¥å£ï¼šå®æ—¶ç›‘å¬èµ„æºå˜åŒ–&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æ•°æ®æŒä¹…åŒ–&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å°†èµ„æºçŠ¶æ€å†™å…¥etcd&lt;/li&gt;
&lt;li&gt;ç¼“å­˜æœºåˆ¶æé«˜æ€§èƒ½&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é›†ç¾¤çŠ¶æ€æŸ¥è¯¢&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æä¾›é›†ç¾¤å½“å‰çŠ¶æ€çš„è§†å›¾&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ— çŠ¶æ€ï¼šå¯ä»¥æ°´å¹³æ‰©å±•å¤šä¸ªå®ä¾‹&lt;/li&gt;
&lt;li&gt;é«˜å¯ç”¨ï¼šé€šè¿‡è´Ÿè½½å‡è¡¡å™¨å¯¹å¤–æä¾›æœåŠ¡&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;3.2 etcd&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åˆ†å¸ƒå¼é”®å€¼å­˜å‚¨&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å­˜å‚¨K8sæ‰€æœ‰é›†ç¾¤æ•°æ®&lt;/li&gt;
&lt;li&gt;ä¿å­˜èµ„æºå¯¹è±¡çš„å®šä¹‰å’ŒçŠ¶æ€&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ä¸€è‡´æ€§ä¿è¯&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨Raftåè®®ä¿è¯æ•°æ®ä¸€è‡´æ€§&lt;/li&gt;
&lt;li&gt;æ”¯æŒåˆ†å¸ƒå¼é”&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Watchæœºåˆ¶&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ”¯æŒé«˜æ•ˆçš„äº‹ä»¶ç›‘å¬&lt;/li&gt;
&lt;li&gt;å®ç°K8sçš„å“åº”å¼æ¶æ„&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å­˜å‚¨çš„æ•°æ®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Podã€Serviceã€Deploymentç­‰èµ„æºå¯¹è±¡&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ä¿¡æ¯&lt;/li&gt;
&lt;li&gt;é…ç½®ä¿¡æ¯ï¼ˆConfigMapã€Secretï¼‰&lt;/li&gt;
&lt;li&gt;é›†ç¾¤çŠ¶æ€&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;éƒ¨ç½²å»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç”Ÿäº§ç¯å¢ƒå»ºè®®3-5ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤&lt;/li&gt;
&lt;li&gt;å®šæœŸå¤‡ä»½æ•°æ®&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨SSDæé«˜æ€§èƒ½&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;3.3 Schedulerï¼ˆkube-schedulerï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Podè°ƒåº¦&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸ºæ–°åˆ›å»ºçš„Podé€‰æ‹©åˆé€‚çš„èŠ‚ç‚¹&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è°ƒåº¦ç®—æ³•&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;é¢„é€‰ï¼ˆPredicateï¼‰ï¼š&lt;/strong&gt; è¿‡æ»¤ä¸ç¬¦åˆæ¡ä»¶çš„èŠ‚ç‚¹&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;PodFitsResourcesï¼šèŠ‚ç‚¹èµ„æºæ˜¯å¦å……è¶³&lt;/li&gt;
&lt;li&gt;PodFitsHostPortsï¼šç«¯å£æ˜¯å¦å†²çª&lt;/li&gt;
&lt;li&gt;NodeSelectorï¼šèŠ‚ç‚¹æ ‡ç­¾åŒ¹é…&lt;/li&gt;
&lt;li&gt;NodeAffinityï¼šèŠ‚ç‚¹äº²å’Œæ€§&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä¼˜é€‰ï¼ˆPriorityï¼‰ï¼š&lt;/strong&gt; å¯¹é¢„é€‰èŠ‚ç‚¹æ‰“åˆ†ï¼Œé€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;LeastRequestedPriorityï¼šé€‰æ‹©èµ„æºä½¿ç”¨ç‡æœ€ä½çš„èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;BalancedResourceAllocationï¼šCPUå’Œå†…å­˜ä½¿ç”¨ç‡å‡è¡¡&lt;/li&gt;
&lt;li&gt;NodeAffinityPriorityï¼šèŠ‚ç‚¹äº²å’Œæ€§å¾—åˆ†&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é«˜çº§è°ƒåº¦ç­–ç•¥&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;NodeSelector&lt;/strong&gt;ï¼šæŒ‡å®šèŠ‚ç‚¹æ ‡ç­¾&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;NodeAffinity&lt;/strong&gt;ï¼šèŠ‚ç‚¹äº²å’Œæ€§ï¼ˆç¡¬æ€§/è½¯æ€§è¦æ±‚ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;PodAffinity&lt;/strong&gt;ï¼šPodäº²å’Œæ€§ï¼ˆå°†ç›¸å…³Podè°ƒåº¦åˆ°ä¸€èµ·ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;PodAntiAffinity&lt;/strong&gt;ï¼šPodåäº²å’Œæ€§ï¼ˆå°†Podåˆ†æ•£åˆ°ä¸åŒèŠ‚ç‚¹ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Taintså’ŒTolerations&lt;/strong&gt;ï¼šæ±¡ç‚¹å’Œå®¹å¿åº¦ï¼ˆæ’æ–¥ç‰¹å®šPodï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;è°ƒåº¦æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç›‘å¬æœªè°ƒåº¦çš„Pod â†’ é¢„é€‰è¿‡æ»¤èŠ‚ç‚¹ â†’ ä¼˜é€‰æ‰“åˆ†æ’åº â†’ é€‰æ‹©æœ€ä¼˜èŠ‚ç‚¹ â†’ ç»‘å®šPodåˆ°èŠ‚ç‚¹
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.4 Controller Managerï¼ˆkube-controller-managerï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;è¿è¡Œå¤šä¸ªæ§åˆ¶å™¨ï¼Œæ¯ä¸ªæ§åˆ¶å™¨è´Ÿè´£ç»´æŠ¤ç‰¹å®šèµ„æºçš„æœŸæœ›çŠ¶æ€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸»è¦æ§åˆ¶å™¨ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Replication Controller / ReplicaSet Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¡®ä¿æŒ‡å®šæ•°é‡çš„Podå‰¯æœ¬è¿è¡Œ&lt;/li&gt;
&lt;li&gt;Podæ•°é‡ä¸è¶³æ—¶åˆ›å»ºï¼Œè¿‡å¤šæ—¶åˆ é™¤&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Deployment Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®¡ç†ReplicaSetï¼Œå®ç°å£°æ˜å¼æ›´æ–°&lt;/li&gt;
&lt;li&gt;æ”¯æŒæ»šåŠ¨æ›´æ–°å’Œå›æ»š&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;StatefulSet Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨&lt;/li&gt;
&lt;li&gt;æä¾›ç¨³å®šçš„ç½‘ç»œæ ‡è¯†å’ŒæŒä¹…åŒ–å­˜å‚¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;DaemonSet Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œä¸€ä¸ªPodå‰¯æœ¬&lt;/li&gt;
&lt;li&gt;å¸¸ç”¨äºæ—¥å¿—æ”¶é›†ã€ç›‘æ§ä»£ç†&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Job Controller / CronJob Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Jobï¼šè¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡&lt;/li&gt;
&lt;li&gt;CronJobï¼šå®šæ—¶ä»»åŠ¡&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Service Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç›‘å¬Serviceå¯¹è±¡ï¼Œåˆ›å»ºEndpoint&lt;/li&gt;
&lt;li&gt;ä¸äº‘å¹³å°äº¤äº’åˆ›å»ºLoadBalancer&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Namespace Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åˆ é™¤namespaceæ—¶æ¸…ç†ç›¸å…³èµ„æº&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Node Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç›‘æ§èŠ‚ç‚¹çŠ¶æ€&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹å¼‚å¸¸æ—¶é©±é€Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Endpoint Controller&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç»´æŠ¤Serviceå’ŒPodä¹‹é—´çš„æ˜ å°„å…³ç³»&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œåŸç†ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;æ§åˆ¶å¾ªç¯ï¼š
  ç›‘å¬èµ„æºå˜åŒ– â†’ æ¯”è¾ƒæœŸæœ›çŠ¶æ€å’Œå®é™…çŠ¶æ€ â†’ æ‰§è¡Œè°ƒè°åŠ¨ä½œ â†’ æ›´æ–°èµ„æºçŠ¶æ€
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.5 Kubelet&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Podç”Ÿå‘½å‘¨æœŸç®¡ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¥æ”¶API Serveråˆ†é…çš„Pod&lt;/li&gt;
&lt;li&gt;è°ƒç”¨Container Runtimeåˆ›å»ºå®¹å™¨&lt;/li&gt;
&lt;li&gt;ç®¡ç†å®¹å™¨çš„å¯åŠ¨ã€åœæ­¢ã€é‡å¯&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å®¹å™¨å¥åº·æ£€æŸ¥&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Liveness Probe&lt;/strong&gt;ï¼šå­˜æ´»æ¢é’ˆï¼Œæ£€æµ‹å®¹å™¨æ˜¯å¦è¿è¡Œï¼Œå¤±è´¥åˆ™é‡å¯&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Readiness Probe&lt;/strong&gt;ï¼šå°±ç»ªæ¢é’ˆï¼Œæ£€æµ‹å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Startup Probe&lt;/strong&gt;ï¼šå¯åŠ¨æ¢é’ˆï¼Œæ£€æµ‹å®¹å™¨åº”ç”¨æ˜¯å¦å¯åŠ¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;èµ„æºç›‘æ§&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ç›‘æ§Podå’Œå®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼ˆCPUã€å†…å­˜ï¼‰&lt;/li&gt;
&lt;li&gt;é€šè¿‡cAdvisoræ”¶é›†æ•°æ®&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Volumeç®¡ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŒ‚è½½Volumeåˆ°å®¹å™¨&lt;/li&gt;
&lt;li&gt;æ”¯æŒå¤šç§å­˜å‚¨ç±»å‹&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;çŠ¶æ€ä¸ŠæŠ¥&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®šæœŸå‘API Serverä¸ŠæŠ¥èŠ‚ç‚¹å’ŒPodçŠ¶æ€&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é•œåƒç®¡ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ‹‰å–é•œåƒ&lt;/li&gt;
&lt;li&gt;é•œåƒåƒåœ¾å›æ”¶&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Static Podï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Kubeletå¯ä»¥ç›´æ¥ç®¡ç†æœ¬åœ°çš„YAMLæ–‡ä»¶ï¼ˆé€šå¸¸åœ¨/etc/kubernetes/manifests/ï¼‰&lt;/li&gt;
&lt;li&gt;ä¸å—API Serveræ§åˆ¶ï¼Œå¸¸ç”¨äºéƒ¨ç½²æ§åˆ¶å¹³é¢ç»„ä»¶&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;3.6 Kube-proxy&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Serviceç½‘ç»œä»£ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®ç°Serviceçš„è™šæ‹ŸIPï¼ˆClusterIPï¼‰&lt;/li&gt;
&lt;li&gt;å°†æµé‡è½¬å‘åˆ°åç«¯Pod&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;è´Ÿè½½å‡è¡¡&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨å¤šä¸ªPodå‰¯æœ¬ä¹‹é—´åˆ†å‘æµé‡&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œæ¨¡å¼&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;iptablesæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;é€šè¿‡iptablesè§„åˆ™å®ç°&lt;/li&gt;
&lt;li&gt;æ€§èƒ½å¥½ï¼Œä½†è§„åˆ™å¤šæ—¶æ€§èƒ½ä¸‹é™&lt;/li&gt;
&lt;li&gt;éšæœºè´Ÿè½½å‡è¡¡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ipvsæ¨¡å¼ï¼ˆæ¨èï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä½¿ç”¨IPVSå†…æ ¸æ¨¡å—&lt;/li&gt;
&lt;li&gt;æ”¯æŒæ›´å¤šè´Ÿè½½å‡è¡¡ç®—æ³•ï¼ˆrrã€lcã€dhç­‰ï¼‰&lt;/li&gt;
&lt;li&gt;æ€§èƒ½æ›´å¥½ï¼Œé€‚åˆå¤§è§„æ¨¡é›†ç¾¤&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;userspaceæ¨¡å¼ï¼ˆå·²åºŸå¼ƒï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åœ¨ç”¨æˆ·ç©ºé—´ä»£ç†ï¼Œæ€§èƒ½å·®&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Serviceç±»å‹æ”¯æŒ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ClusterIPï¼šé›†ç¾¤å†…éƒ¨è®¿é—®&lt;/li&gt;
&lt;li&gt;NodePortï¼šé€šè¿‡èŠ‚ç‚¹ç«¯å£æš´éœ²æœåŠ¡&lt;/li&gt;
&lt;li&gt;LoadBalancerï¼šäº‘å¹³å°è´Ÿè½½å‡è¡¡å™¨&lt;/li&gt;
&lt;li&gt;ExternalNameï¼šDNS CNAMEæ˜ å°„&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å·¥ä½œæµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç›‘å¬Serviceå’ŒEndpointå˜åŒ– â†’ ç”Ÿæˆä»£ç†è§„åˆ™ï¼ˆiptables/ipvsï¼‰ â†’ æµé‡è½¬å‘åˆ°åç«¯Pod
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.7 Container Runtimeï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ã€åˆ é™¤å®¹å™¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é•œåƒç®¡ç†&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ‹‰å–ã€å­˜å‚¨ã€åˆ é™¤é•œåƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å¸¸è§è¿è¡Œæ—¶ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Docker&lt;/strong&gt;ï¼šæœ€æ—©æ”¯æŒï¼ŒåŠŸèƒ½å®Œå–„&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;containerd&lt;/strong&gt;ï¼šDockerçš„æ ¸å¿ƒç»„ä»¶ï¼Œè½»é‡çº§ï¼ˆæ¨èï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;CRI-O&lt;/strong&gt;ï¼šä¸“ä¸ºK8sè®¾è®¡çš„è½»é‡çº§è¿è¡Œæ—¶&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;CRIæ¥å£ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;K8sé€šè¿‡CRIï¼ˆContainer Runtime Interfaceï¼‰ä¸è¿è¡Œæ—¶é€šä¿¡&lt;/li&gt;
&lt;li&gt;è§£è€¦K8så’Œå…·ä½“çš„å®¹å™¨å®ç°&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;3.8 CoreDNS&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é›†ç¾¤å†…éƒ¨DNS&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸ºServiceæä¾›DNSè§£æ&lt;/li&gt;
&lt;li&gt;æ ¼å¼ï¼š&lt;code&gt;&amp;lt;service-name&amp;gt;.&amp;lt;namespace&amp;gt;.svc.cluster.local&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æœåŠ¡å‘ç°&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Podé€šè¿‡Serviceåç§°è®¿é—®æœåŠ¡&lt;/li&gt;
&lt;li&gt;æ— éœ€çŸ¥é“å…·ä½“IPåœ°å€&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# Service: nginx-service åœ¨ default namespace
# å…¶ä»–Podå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è®¿é—®ï¼š
nginx-service
nginx-service.default
nginx-service.default.svc.cluster.local
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3.9 CNIç½‘ç»œæ’ä»¶&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒåŠŸèƒ½ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Podç½‘ç»œé€šä¿¡&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸ºæ¯ä¸ªPodåˆ†é…IPåœ°å€&lt;/li&gt;
&lt;li&gt;å®ç°Podä¹‹é—´çš„ç½‘ç»œäº’é€š&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ç½‘ç»œç­–ç•¥&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®ç°ç½‘ç»œéš”ç¦»å’Œè®¿é—®æ§åˆ¶&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å¸¸è§ç½‘ç»œæ’ä»¶ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Flannel&lt;/strong&gt;ï¼šç®€å•æ˜“ç”¨ï¼Œé€‚åˆå°è§„æ¨¡é›†ç¾¤&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Calico&lt;/strong&gt;ï¼šåŠŸèƒ½å¼ºå¤§ï¼Œæ”¯æŒç½‘ç»œç­–ç•¥ï¼Œæ€§èƒ½å¥½&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Weave&lt;/strong&gt;ï¼šæ˜“äºéƒ¨ç½²ï¼Œæ”¯æŒåŠ å¯†&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Cilium&lt;/strong&gt;ï¼šåŸºäºeBPFï¼Œé«˜æ€§èƒ½&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ç½‘ç»œæ¨¡å‹è¦æ±‚ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ‰€æœ‰Podå¯ä»¥äº’ç›¸é€šä¿¡ï¼ˆæ— éœ€NATï¼‰&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰Nodeå¯ä»¥ä¸æ‰€æœ‰Podé€šä¿¡&lt;/li&gt;
&lt;li&gt;Podçœ‹åˆ°çš„è‡ªå·±çš„IPå’Œå…¶ä»–Podçœ‹åˆ°çš„ä¸€è‡´&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;æ€»ç»“&lt;/h3&gt;
&lt;p&gt;&lt;strong&gt;K8sæ ¸å¿ƒä»·å€¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨åŒ–å®¹å™¨ç¼–æ’å’Œç®¡ç†&lt;/li&gt;
&lt;li&gt;å£°æ˜å¼é…ç½®ï¼Œç”¨æˆ·åªéœ€å…³å¿ƒ&quot;è¦ä»€ä¹ˆ&quot;&lt;/li&gt;
&lt;li&gt;è‡ªæˆ‘ä¿®å¤ï¼Œé«˜å¯ç”¨&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;æ¶æ„ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸»ä»æ¶æ„ï¼ŒèŒè´£æ¸…æ™°&lt;/li&gt;
&lt;li&gt;æ§åˆ¶å™¨æ¨¡å¼ï¼ŒæŒç»­è°ƒè°&lt;/li&gt;
&lt;li&gt;æ‰€æœ‰ç»„ä»¶é€šè¿‡API Serveré€šä¿¡&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;å…³é”®ç»„ä»¶åä½œï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ç”¨æˆ· â†’ kubectl â†’ API Server â† â†’ etcd
                     â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â†“              â†“              â†“
  Scheduler   Controller Manager  Kubelet
                                    â†“
                            Container Runtime
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;é€šè¿‡è¿™äº›ç»„ä»¶çš„ååŒå·¥ä½œï¼ŒK8så®ç°äº†å¼ºå¤§çš„å®¹å™¨ç¼–æ’èƒ½åŠ›ï¼Œæˆä¸ºäº‘åŸç”Ÿæ—¶ä»£çš„åŸºçŸ³ã€‚&lt;/p&gt;
&lt;h2&gt;äºŒã€Podè¯¦è§£&lt;/h2&gt;
&lt;h3&gt;1. Podè®¾è®¡ç†å¿µä¸åŸºæœ¬æ¦‚å¿µ&lt;/h3&gt;
&lt;h4&gt;1.1 Podæ˜¯ä»€ä¹ˆ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Pod&lt;/strong&gt;æ˜¯Kubernetesä¸­æœ€å°çš„å¯éƒ¨ç½²å•å…ƒï¼Œæ˜¯ä¸€ç»„ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰å®¹å™¨çš„é›†åˆã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ ¸å¿ƒç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å…±äº«ç½‘ç»œ&lt;/strong&gt;ï¼šPodå†…çš„æ‰€æœ‰å®¹å™¨å…±äº«åŒä¸€ä¸ªç½‘ç»œå‘½åç©ºé—´&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å…±äº«åŒä¸€ä¸ªIPåœ°å€å’Œç«¯å£ç©ºé—´&lt;/li&gt;
&lt;li&gt;å®¹å™¨ä¹‹é—´å¯ä»¥é€šè¿‡localhosté€šä¿¡&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å…±äº«å­˜å‚¨&lt;/strong&gt;ï¼šPodå†…çš„å®¹å™¨å¯ä»¥å…±äº«Volume&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®ç°å®¹å™¨é—´æ•°æ®å…±äº«&lt;/li&gt;
&lt;li&gt;æŒä¹…åŒ–æ•°æ®å­˜å‚¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ç”Ÿå‘½å‘¨æœŸä¸€è‡´&lt;/strong&gt;ï¼šPodå†…çš„å®¹å™¨åŒç”Ÿå…±æ­»&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€èµ·è°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹&lt;/li&gt;
&lt;li&gt;ä¸€èµ·å¯åŠ¨å’Œåœæ­¢&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;1.2 ä¸ºä»€ä¹ˆéœ€è¦Pod&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;è®¾è®¡åŸå› ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å®¹å™¨é—´ç´§å¯†åä½œ&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æŸäº›åº”ç”¨éœ€è¦å¤šä¸ªå®¹å™¨ååŒå·¥ä½œ&lt;/li&gt;
&lt;li&gt;ä¾‹å¦‚ï¼šä¸»åº”ç”¨å®¹å™¨ + æ—¥å¿—æ”¶é›†å®¹å™¨ + é…ç½®ä»£ç†å®¹å™¨&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;ç®€åŒ–ç½‘ç»œé€šä¿¡&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Podå†…å®¹å™¨é€šè¿‡localhosté€šä¿¡ï¼Œæ— éœ€å¤æ‚çš„ç½‘ç»œé…ç½®&lt;/li&gt;
&lt;li&gt;å¯¹å¤–å‘ˆç°ä¸ºä¸€ä¸ªæ•´ä½“ï¼Œåªæœ‰ä¸€ä¸ªIPåœ°å€&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;èµ„æºå…±äº«&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®¹å™¨é—´å¯ä»¥å…±äº«æ–‡ä»¶ã€IPCã€ç½‘ç»œç­‰èµ„æº&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;Podçš„ä¸¤ç§ä½¿ç”¨æ¨¡å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å•å®¹å™¨Podï¼ˆæœ€å¸¸è§ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Pod
â”œâ”€â”€ Container (åº”ç”¨å®¹å™¨)
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¤šå®¹å™¨Podï¼ˆSidecaræ¨¡å¼ï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Pod
â”œâ”€â”€ Container 1 (ä¸»åº”ç”¨å®¹å™¨)
â”œâ”€â”€ Container 2 (Sidecarå®¹å™¨ - æ—¥å¿—æ”¶é›†)
â””â”€â”€ Container 3 (Sidecarå®¹å™¨ - é…ç½®åŒæ­¥)
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;1.3 Podçš„ç»„æˆ&lt;/h4&gt;
&lt;p&gt;ä¸€ä¸ªPodåŒ…å«ä»¥ä¸‹éƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Pod
â”œâ”€â”€ Pauseå®¹å™¨ï¼ˆåŸºç¡€å®¹å™¨/æ ¹å®¹å™¨ï¼‰
â”‚   â””â”€â”€ è´Ÿè´£åˆ›å»ºç½‘ç»œå‘½åç©ºé—´ï¼Œç»´æŠ¤Podçš„ç½‘ç»œ
â”œâ”€â”€ Initå®¹å™¨ï¼ˆå¯é€‰ï¼‰
â”‚   â””â”€â”€ åˆå§‹åŒ–å®¹å™¨ï¼Œåœ¨ä¸»å®¹å™¨å¯åŠ¨å‰è¿è¡Œï¼Œç”¨äºåˆå§‹åŒ–å·¥ä½œ
â””â”€â”€ åº”ç”¨å®¹å™¨ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰
    â”œâ”€â”€ ä¸»å®¹å™¨
    â””â”€â”€ Sidecarå®¹å™¨ï¼ˆå¯é€‰ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Pauseå®¹å™¨ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ¯ä¸ªPodéƒ½æœ‰ä¸€ä¸ªéšè—çš„Pauseå®¹å™¨ï¼ˆä¹Ÿå«Infraå®¹å™¨ï¼‰&lt;/li&gt;
&lt;li&gt;å ç”¨æå°‘èµ„æºï¼Œé•œåƒå¾ˆå°ï¼ˆå‡ ç™¾KBï¼‰&lt;/li&gt;
&lt;li&gt;ä½œç”¨ï¼š
&lt;ul&gt;
&lt;li&gt;åˆ›å»ºå¹¶æŒæœ‰ç½‘ç»œå‘½åç©ºé—´&lt;/li&gt;
&lt;li&gt;å…¶ä»–å®¹å™¨åŠ å…¥åˆ°è¿™ä¸ªç½‘ç»œå‘½åç©ºé—´&lt;/li&gt;
&lt;li&gt;å³ä½¿åº”ç”¨å®¹å™¨é‡å¯ï¼ŒPodçš„IPä¹Ÿä¸ä¼šå˜&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;hr /&gt;
&lt;h3&gt;2. Podçš„åˆ›å»ºè¿‡ç¨‹ã€çŠ¶æ€ã€ç”Ÿå‘½å‘¨æœŸå’Œæ¢é’ˆ&lt;/h3&gt;
&lt;h4&gt;2.1 Podçš„åˆ›å»ºè¿‡ç¨‹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å®Œæ•´æµç¨‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;1. ç”¨æˆ·æäº¤Podå®šä¹‰
   kubectl apply -f pod.yaml
   â†“
2. API Serveræ¥æ”¶è¯·æ±‚
   - éªŒè¯YAMLæ ¼å¼å’Œæƒé™
   - å†™å…¥etcdï¼ˆçŠ¶æ€ï¼šPendingï¼‰
   â†“
3. Schedulerè°ƒåº¦
   - é€‰æ‹©åˆé€‚çš„NodeèŠ‚ç‚¹
   - æ›´æ–°Podä¿¡æ¯ï¼ˆç»‘å®šNodeï¼‰
   â†“
4. Kubeletåˆ›å»ºPod
   - æ‹‰å–é•œåƒ
   - åˆ›å»ºPauseå®¹å™¨
   - è¿è¡ŒInitå®¹å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
   - è¿è¡Œä¸»å®¹å™¨
   â†“
5. å®¹å™¨è¿è¡Œï¼ˆçŠ¶æ€ï¼šRunningï¼‰
   - æ‰§è¡Œå¥åº·æ£€æŸ¥
   - ä¸ŠæŠ¥çŠ¶æ€åˆ°API Server
   â†“
6. Podå®Œæˆæˆ–å¤±è´¥ï¼ˆçŠ¶æ€ï¼šSucceeded/Failedï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2.2 Podçš„ç”Ÿå‘½å‘¨æœŸ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Pod Phaseï¼ˆé˜¶æ®µï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;é˜¶æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Pending&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Podå·²åˆ›å»ºï¼Œä½†å®¹å™¨è¿˜æœªè¿è¡Œï¼ˆå¯èƒ½åœ¨æ‹‰å–é•œåƒæˆ–è°ƒåº¦ä¸­ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Running&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Podå·²ç»‘å®šåˆ°èŠ‚ç‚¹ï¼Œæ‰€æœ‰å®¹å™¨å·²åˆ›å»ºï¼Œè‡³å°‘ä¸€ä¸ªå®¹å™¨åœ¨è¿è¡Œ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Succeeded&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Podä¸­æ‰€æœ‰å®¹å™¨æˆåŠŸç»ˆæ­¢ï¼Œä¸”ä¸ä¼šé‡å¯&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Failed&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Podä¸­æ‰€æœ‰å®¹å™¨ç»ˆæ­¢ï¼Œè‡³å°‘ä¸€ä¸ªå®¹å™¨å¼‚å¸¸é€€å‡º&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Unknown&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;æ— æ³•è·å–PodçŠ¶æ€ï¼ˆé€šå¸¸æ˜¯èŠ‚ç‚¹é€šä¿¡é—®é¢˜ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;å®¹å™¨çŠ¶æ€ï¼ˆContainer Stateï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;çŠ¶æ€&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Waiting&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®¹å™¨ç­‰å¾…ä¸­ï¼ˆæ‹‰å–é•œåƒã€ç­‰å¾…Initå®¹å™¨ç­‰ï¼‰&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Running&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®¹å™¨æ­£åœ¨è¿è¡Œ&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Terminated&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®¹å™¨å·²ç»ˆæ­¢&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;é‡å¯ç­–ç•¥ï¼ˆRestartPolicyï¼‰ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ç­–ç•¥&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;é€‚ç”¨åœºæ™¯&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Always&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®¹å™¨ç»ˆæ­¢åæ€»æ˜¯é‡å¯ï¼ˆé»˜è®¤ç­–ç•¥ï¼‰&lt;/td&gt;
&lt;td&gt;é•¿æœŸè¿è¡Œçš„æœåŠ¡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;OnFailure&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®¹å™¨å¼‚å¸¸ç»ˆæ­¢æ—¶æ‰é‡å¯ï¼ˆé€€å‡ºç é0ï¼‰&lt;/td&gt;
&lt;td&gt;æ‰¹å¤„ç†ä»»åŠ¡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;Never&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å®¹å™¨ç»ˆæ­¢åä¸é‡å¯&lt;/td&gt;
&lt;td&gt;ä¸€æ¬¡æ€§ä»»åŠ¡&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;2.3 å®¹å™¨æ¢é’ˆï¼ˆProbeï¼‰&lt;/h4&gt;
&lt;p&gt;æ¢é’ˆæ˜¯Kubeletå¯¹å®¹å™¨æ‰§è¡Œçš„å®šæœŸè¯Šæ–­ï¼Œç”¨äºæ£€æµ‹å®¹å™¨çš„å¥åº·çŠ¶å†µã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ä¸‰ç§æ¢é’ˆç±»å‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Liveness Probeï¼ˆå­˜æ´»æ¢é’ˆï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä½œç”¨&lt;/strong&gt;ï¼šæ£€æµ‹å®¹å™¨æ˜¯å¦å­˜æ´»&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¤±è´¥å¤„ç†&lt;/strong&gt;ï¼šé‡å¯å®¹å™¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯&lt;/strong&gt;ï¼šæ£€æµ‹åº”ç”¨æ˜¯å¦æ­»é”ã€æ— å“åº”&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç¤ºä¾‹&lt;/strong&gt;ï¼šåº”ç”¨è¿›ç¨‹å­˜åœ¨ä½†å¡æ­»ï¼Œéœ€è¦é‡å¯æ¢å¤&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Readiness Probeï¼ˆå°±ç»ªæ¢é’ˆï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä½œç”¨&lt;/strong&gt;ï¼šæ£€æµ‹å®¹å™¨æ˜¯å¦å‡†å¤‡å¥½æ¥æ”¶æµé‡&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¤±è´¥å¤„ç†&lt;/strong&gt;ï¼šä»Serviceçš„Endpointåˆ—è¡¨ä¸­ç§»é™¤è¯¥Pod&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯&lt;/strong&gt;ï¼šåº”ç”¨å¯åŠ¨æ…¢ï¼Œéœ€è¦é¢„çƒ­ï¼›ä¸´æ—¶è¿‡è½½ï¼Œæš‚æ—¶æ— æ³•å¤„ç†è¯·æ±‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç¤ºä¾‹&lt;/strong&gt;ï¼šæ•°æ®åº“è¿æ¥åˆå§‹åŒ–ä¸­ã€ç¼“å­˜åŠ è½½ä¸­&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Startup Probeï¼ˆå¯åŠ¨æ¢é’ˆï¼‰&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;ä½œç”¨&lt;/strong&gt;ï¼šæ£€æµ‹å®¹å™¨åº”ç”¨æ˜¯å¦å·²å¯åŠ¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¤±è´¥å¤„ç†&lt;/strong&gt;ï¼šé‡å¯å®¹å™¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯&lt;/strong&gt;ï¼šå¯åŠ¨æ…¢çš„åº”ç”¨ï¼ˆé¿å…Livenessæ¢é’ˆè¿‡æ—©æ€æ­»å®¹å™¨ï¼‰&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç¤ºä¾‹&lt;/strong&gt;ï¼šJavaåº”ç”¨å¯åŠ¨éœ€è¦å‡ åˆ†é’Ÿ&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;æ¢æµ‹æ–¹å¼ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;æ–¹å¼&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;ç¤ºä¾‹&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;exec&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;åœ¨å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤ï¼Œé€€å‡ºç ä¸º0è¡¨ç¤ºæˆåŠŸ&lt;/td&gt;
&lt;td&gt;æ‰§è¡Œcatæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;httpGet&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å‘é€HTTP GETè¯·æ±‚ï¼ŒçŠ¶æ€ç 200-399è¡¨ç¤ºæˆåŠŸ&lt;/td&gt;
&lt;td&gt;è®¿é—®/healthç«¯ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;tcpSocket&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;TCPè¿æ¥æµ‹è¯•ï¼Œèƒ½è¿æ¥è¡¨ç¤ºæˆåŠŸ&lt;/td&gt;
&lt;td&gt;æ£€æµ‹MySQL 3306ç«¯å£æ˜¯å¦å¯è¿æ¥&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;grpc&lt;/strong&gt; (æ–°å¢)&lt;/td&gt;
&lt;td&gt;è°ƒç”¨gRPCå¥åº·æ£€æŸ¥æœåŠ¡&lt;/td&gt;
&lt;td&gt;gRPCåº”ç”¨çš„å¥åº·æ£€æŸ¥&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;æ¢é’ˆå‚æ•°é…ç½®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;livenessProbe:
  httpGet:
    path: /health       # æ£€æŸ¥è·¯å¾„
    port: 8080          # ç«¯å£
  initialDelaySeconds: 30   # å®¹å™¨å¯åŠ¨åå¤šä¹…å¼€å§‹æ¢æµ‹
  periodSeconds: 10         # æ¢æµ‹é—´éš”
  timeoutSeconds: 5         # æ¢æµ‹è¶…æ—¶æ—¶é—´
  successThreshold: 1       # æˆåŠŸé˜ˆå€¼ï¼ˆè¿ç»­æˆåŠŸå¤šå°‘æ¬¡æ‰ç®—æˆåŠŸï¼‰
  failureThreshold: 3       # å¤±è´¥é˜ˆå€¼ï¼ˆè¿ç»­å¤±è´¥å¤šå°‘æ¬¡æ‰ç®—å¤±è´¥ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ¢é’ˆä½¿ç”¨å»ºè®®ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Liveness&lt;/strong&gt;ï¼šè°¨æ…ä½¿ç”¨ï¼Œé¿å…é¢‘ç¹é‡å¯&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Readiness&lt;/strong&gt;ï¼šæ¨èä½¿ç”¨ï¼Œä¼˜é›…åœ°å¤„ç†æµé‡&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Startup&lt;/strong&gt;ï¼šå¯¹å¯åŠ¨æ…¢çš„åº”ç”¨å¿…é¡»é…ç½®&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;2.4 Initå®¹å™¨&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Initå®¹å™¨&lt;/strong&gt;åœ¨ä¸»å®¹å™¨å¯åŠ¨å‰è¿è¡Œï¼Œç”¨äºåˆå§‹åŒ–å·¥ä½œã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;ç‰¹ç‚¹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;é¡ºåºæ‰§è¡Œ&lt;/strong&gt;ï¼šå¤šä¸ªInitå®¹å™¨æŒ‰é¡ºåºä¾æ¬¡è¿è¡Œ&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;å¿…é¡»æˆåŠŸ&lt;/strong&gt;ï¼šæ‰€æœ‰Initå®¹å™¨æˆåŠŸåï¼Œä¸»å®¹å™¨æ‰ä¼šå¯åŠ¨&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç‹¬ç«‹é•œåƒ&lt;/strong&gt;ï¼šå¯ä»¥ä½¿ç”¨ä¸åŒçš„é•œåƒ&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;ä½¿ç”¨åœºæ™¯ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;ç­‰å¾…ä¾èµ–æœåŠ¡å¯åŠ¨ï¼ˆå¦‚ç­‰å¾…æ•°æ®åº“å°±ç»ªï¼‰&lt;/li&gt;
&lt;li&gt;åˆå§‹åŒ–é…ç½®æ–‡ä»¶&lt;/li&gt;
&lt;li&gt;ä¸‹è½½ä¾èµ–æˆ–æ•°æ®&lt;/li&gt;
&lt;li&gt;è®¾ç½®æƒé™&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;ç¤ºä¾‹ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;initContainers:
- name: init-mysql
  image: busybox
  command: [&apos;sh&apos;, &apos;-c&apos;, &apos;until nslookup mysql; do echo waiting for mysql; sleep 2; done&apos;]
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;3. YAMLèµ„æºæ¸…å•ä¸Podåˆ›å»º&lt;/h3&gt;
&lt;h4&gt;3.1 YAMLèµ„æºæ¸…å•åŸºç¡€&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;YAMLæ–‡ä»¶ç»“æ„ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1           # APIç‰ˆæœ¬
kind: Pod                # èµ„æºç±»å‹
metadata:                # å…ƒæ•°æ®
  name: my-pod           # Podåç§°
  labels:                # æ ‡ç­¾
    app: nginx
spec:                    # è§„æ ¼/æœŸæœ›çŠ¶æ€
  containers:            # å®¹å™¨åˆ—è¡¨
  - name: nginx          # å®¹å™¨åç§°
    image: nginx:1.20    # é•œåƒ
    ports:               # ç«¯å£
    - containerPort: 80
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å››ä¸ªæ ¸å¿ƒå­—æ®µï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;å­—æ®µ&lt;/th&gt;
&lt;th&gt;è¯´æ˜&lt;/th&gt;
&lt;th&gt;å¿…éœ€&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;apiVersion&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;APIç‰ˆæœ¬ï¼ˆå¦‚v1ã€apps/v1ï¼‰&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;kind&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;èµ„æºç±»å‹ï¼ˆå¦‚Podã€Deploymentï¼‰&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;metadata&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;å…ƒæ•°æ®ï¼ˆnameã€labelsã€namespaceç­‰ï¼‰&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;&lt;strong&gt;spec&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;è§„æ ¼è¯´æ˜ï¼ˆæœŸæœ›çŠ¶æ€ï¼‰&lt;/td&gt;
&lt;td&gt;âœ“&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;h4&gt;3.2 ç®€å•Podç¤ºä¾‹&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æœ€ç®€å•çš„Podï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
spec:
  containers:
  - name: nginx
    image: nginx:1.20
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å¸¦æ¢é’ˆçš„Podï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod-with-probe
  labels:
    app: nginx
spec:
  containers:
  - name: nginx
    image: nginx:1.20
    ports:
    - containerPort: 80
    livenessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 5
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 3
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;å¤šå®¹å™¨Podï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: multi-container-pod
spec:
  containers:
  - name: app
    image: myapp:1.0
    ports:
    - containerPort: 8080
  - name: sidecar-log
    image: busybox
    command: [&apos;sh&apos;, &apos;-c&apos;, &apos;tail -f /var/log/app.log&apos;]
    volumeMounts:
    - name: log-volume
      mountPath: /var/log
  volumes:
  - name: log-volume
    emptyDir: {}
&lt;/code&gt;&lt;/pre&gt;
&lt;hr /&gt;
&lt;h3&gt;4. å®æ“ï¼šæ„å»ºé•œåƒå¹¶éƒ¨ç½²Pod&lt;/h3&gt;
&lt;h4&gt;4.1 å‡†å¤‡æµ‹è¯•ç¯å¢ƒ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åœ¨harboræœºå™¨ä¸Šé…ç½®kubectlè¿œç¨‹ç®¡ç†K8sé›†ç¾¤&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;æˆ‘ä»¬ä½¿ç”¨harboræœºå™¨ï¼ˆ192.168.100.14ï¼‰ä½œä¸ºè¿œç¨‹ç®¡ç†èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨masterä¸Šæ“ä½œï¼Œè¿™æ˜¯ç”Ÿäº§ç¯å¢ƒçš„æœ€ä½³å®è·µã€‚&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;æ­¥éª¤ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åœ¨masterèŠ‚ç‚¹ä¸Šè·å–kubeconfig&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨k8s-masterä¸Šæ‰§è¡Œ
cat ~/.kube/config
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;åœ¨harboræœºå™¨ä¸Šå®‰è£…kubectl&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä¸‹è½½kubectl
curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;

# å®‰è£…
chmod +x kubectl
mv kubectl /usr/local/bin/

# éªŒè¯
kubectl version --client

&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;é…ç½®kubeconfig&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»º.kubeç›®å½•
mkdir -p ~/.kube

# å°†masterçš„configå†…å®¹å¤åˆ¶åˆ°harboræœºå™¨
vi ~/.kube/config
# ç²˜è´´masterèŠ‚ç‚¹çš„configå†…å®¹ï¼Œä¿®æ”¹serveråœ°å€ä¸ºmasterçš„IP
# server: https://192.168.100.20:6443

# è®¾ç½®æƒé™
chmod 600 ~/.kube/config

#è®¾ç½®k8så‘½ä»¤è¡¥é½
 echo &quot;source &amp;lt;(kubectl completion bash)&quot; &amp;gt;&amp;gt; ~/.bashrc
 source ~/.bashrc
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•è¿æ¥&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get nodes
kubectl cluster-info
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;h4&gt;4.2 å‡†å¤‡åº”ç”¨é•œåƒ&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;å‡†å¤‡ä¸¤ä¸ªé•œåƒï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;nginxå‰ç«¯&lt;/strong&gt;ï¼šè¿æ¥æ•°æ®åº“æµ‹è¯•&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;mysqlæ•°æ®åº“&lt;/strong&gt;ï¼šMySQL 8.0&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;é¡¹ç›®ç›®å½•ç»“æ„ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;/root/k8s-demo/
â”œâ”€â”€ nginx/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ index.php
â””â”€â”€ mysql/
    â””â”€â”€ Dockerfile
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;1. åˆ›å»ºMySQLé•œåƒ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p /root/k8s-demo/mysql
cd /root/k8s-demo/mysql
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Dockerfileï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM mysql:8.0

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV MYSQL_ROOT_PASSWORD=Westos123
ENV MYSQL_DATABASE=testdb

# æš´éœ²ç«¯å£
EXPOSE 3306
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ„å»ºå¹¶æ¨é€ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ„å»ºé•œåƒ
docker build -t reg.westos.org/library/mysql:8.0 .

# æ¨é€åˆ°ç§æœ‰ä»“åº“
docker push reg.westos.org/library/mysql:8.0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;2. åˆ›å»ºNginx+PHPé•œåƒ&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p /root/k8s-demo/nginx
cd /root/k8s-demo/nginx
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;Dockerfileï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;FROM php:7.4-apache

# å®‰è£…mysqliæ‰©å±•
RUN docker-php-ext-install mysqli

# å¤åˆ¶æµ‹è¯•é¡µé¢
COPY index.php /var/www/html/

# æš´éœ²ç«¯å£
EXPOSE 80

# å¯åŠ¨Apache
CMD [&quot;apache2-foreground&quot;]
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;index.phpï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;lt;?php
header(&apos;Content-Type: text/plain; charset=utf-8&apos;);  

echo &quot;Nginx-PHP Container\n&quot;;
echo &quot;Hostname: &quot; . gethostname() . &quot;\n&quot;;
echo &quot;Server IP: &quot; . $_SERVER[&apos;SERVER_ADDR&apos;] . &quot;\n&quot;;
echo &quot;\n&quot;;

// æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼ˆç¨åæ‰‹åŠ¨ä¿®æ”¹ï¼‰
$db_host = &quot;DB_HOST_HERE&quot;;  // ç¨åæ›¿æ¢ä¸ºMySQL Podçš„IP
$db_user = &quot;root&quot;;
$db_pass = &quot;Westos123&quot;;
$db_name = &quot;testdb&quot;;

// å°è¯•è¿æ¥æ•°æ®åº“
$conn = new mysqli($db_host, $db_user, $db_pass, $db_name);

if ($conn-&amp;gt;connect_error) {
    echo &quot;Database connection failed: &quot; . $conn-&amp;gt;connect_error . &quot;\n&quot;;
} else {
    echo &quot;Database connected successfully!\n&quot;;
    echo &quot;MySQL Version: &quot; . $conn-&amp;gt;server_info . &quot;\n&quot;;
}

$conn-&amp;gt;close();
?&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;æ„å»ºå¹¶æ¨é€ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ„å»ºé•œåƒ
docker build -t reg.westos.org/library/nginx-php:v1 .

# æ¨é€åˆ°ç§æœ‰ä»“åº“
docker push reg.westos.org/library/nginx-php:v1
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.3 åˆ›å»ºPodèµ„æºæ¸…å•&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;åˆ›å»ºYAMLæ–‡ä»¶ç›®å½•ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p /root/k8s-yaml
cd /root/k8s-yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;1. mysql-pod.yaml&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: mysql-pod
  labels:
    app: mysql
spec:
  containers:
  - name: mysql
    image: reg.westos.org/library/mysql:8.0
    ports:
    - containerPort: 3306
    env:
    - name: MYSQL_ROOT_PASSWORD
      value: &quot;Westos123&quot;
    - name: MYSQL_DATABASE
      value: &quot;testdb&quot;
    livenessProbe:
      tcpSocket:
        port: 3306
      initialDelaySeconds: 30
      periodSeconds: 10
    readinessProbe:
      exec:
        command:
        - sh
        - -c
        - &quot;mysqladmin ping -h localhost -pWestos123&quot;
      initialDelaySeconds: 10
      periodSeconds: 5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;2. nginx-pod.yaml&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;apiVersion: v1
kind: Pod
metadata:
  name: nginx-pod
  labels:
    app: nginx
spec:
  containers:
  - name: nginx-php
    image: reg.westos.org/library/nginx-php:v1
    ports:
    - containerPort: 80
    livenessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 5
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 3
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.4 éƒ¨ç½²å’Œæµ‹è¯•&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;1. åˆ›å»ºMySQL Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºHarborè®¤è¯Secretï¼ˆå¦‚æœlibraryä»“åº“æ˜¯ç§æœ‰çš„ï¼Œä¸é…ç½®æ‹‰å–é•œåƒä¼šå‡ºç°ImagePullBackOffé”™è¯¯ã€‚ï¼‰
kubectl create secret docker-registry harbor-auth \
  --docker-server=reg.westos.org \
  --docker-username=admin \
  --docker-password=12345 \
  --docker-email=admin@westos.org
  
#è®¤è¯ç»‘å®šå‘½åç©ºé—´ï¼Œè‡ªåŠ¨æˆæƒ
kubectl patch serviceaccount default -p &apos;{&quot;imagePullSecrets&quot;: [{&quot;name&quot;: &quot;harbor-auth&quot;}]}&apos;

# åˆ›å»ºPod
kubectl apply -f mysql-pod.yaml

# æŸ¥çœ‹PodçŠ¶æ€
kubectl get pods -o wide

# æŸ¥çœ‹Podè¯¦ç»†ä¿¡æ¯
kubectl describe pod mysql-pod

# æŸ¥çœ‹æ—¥å¿—
kubectl logs mysql-pod
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;2. è·å–MySQL Podçš„IPåœ°å€&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# è·å–IP
kubectl get pod mysql-pod -o wide

# å‡è®¾è¾“å‡ºï¼š
# NAME        READY   STATUS    RESTARTS   AGE   IP            NODE
# mysql-pod   1/1     Running   0          1m    10.244.1.10   k8s-node1
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;3. åˆ›å»ºNginx Pod&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# åˆ›å»ºPod
kubectl apply -f nginx-pod.yaml

# æŸ¥çœ‹çŠ¶æ€
kubectl get pods -o wide

# è·å–nginx-podçš„IPï¼ˆå‡è®¾æ˜¯10.244.2.15ï¼‰
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;4. è¿›å…¥Nginxå®¹å™¨ä¿®æ”¹æ•°æ®åº“è¿æ¥&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# è¿›å…¥nginxå®¹å™¨
kubectl exec -it nginx-pod -- bash

# ä¿®æ”¹index.phpæ–‡ä»¶ï¼Œæ›¿æ¢æ•°æ®åº“IP
sed -i &apos;s/DB_HOST_HERE/10.244.169.133/&apos; /var/www/html/index.php

# éªŒè¯ä¿®æ”¹
cat /var/www/html/index.php | grep db_host

# é€€å‡ºå®¹å™¨
exit
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;5. åœ¨é›†ç¾¤å†…æµ‹è¯•è¿æ¥&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#å‡†å¤‡busyboxé•œåƒ
docker pull busybox:1.30.1
docker tag busybox:1.30.1 reg.westos.org/library/busybox:1.30.1
docker push reg.westos.org/library/busybox:1.30.1

# ä»ä»»æ„èŠ‚ç‚¹æˆ–Podå†…æµ‹è¯•
kubectl run test-pod --image=reg.westos.org/library/busybox:1.30.1 --rm -it -- sh

# åœ¨test-podä¸­æµ‹è¯•
wget -q -O- http://10.244.2.15
# åº”è¯¥çœ‹åˆ°è¿æ¥æˆåŠŸçš„æ¶ˆæ¯

# æˆ–è€…åœ¨masterèŠ‚ç‚¹ç›´æ¥curl
curl http://10.244.2.15
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;é¢„æœŸè¾“å‡ºï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Nginx-PHP Container
Hostname: nginx-pod
Server IP: 10.244.2.15

Database connected successfully!
MySQL Version: 8.0.44
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.5 å¸¸ç”¨Podç®¡ç†å‘½ä»¤&lt;/h4&gt;
&lt;pre&gt;&lt;code&gt;# æŸ¥çœ‹æ‰€æœ‰Pod
kubectl get pods
kubectl get pods -o wide    # æ˜¾ç¤ºæ›´å¤šä¿¡æ¯ï¼ˆIPã€èŠ‚ç‚¹ç­‰ï¼‰
kubectl get pods -A         # æŸ¥çœ‹æ‰€æœ‰å‘½åç©ºé—´çš„Pod

# æŸ¥çœ‹Podè¯¦æƒ…
kubectl describe pod &amp;lt;pod-name&amp;gt;

# æŸ¥çœ‹æ—¥å¿—
kubectl logs &amp;lt;pod-name&amp;gt;
kubectl logs &amp;lt;pod-name&amp;gt; -f              # å®æ—¶æŸ¥çœ‹
kubectl logs &amp;lt;pod-name&amp;gt; -c &amp;lt;container&amp;gt;  # å¤šå®¹å™¨PodæŒ‡å®šå®¹å™¨

# è¿›å…¥å®¹å™¨
kubectl exec -it &amp;lt;pod-name&amp;gt; -- bash
kubectl exec -it &amp;lt;pod-name&amp;gt; -c &amp;lt;container&amp;gt; -- sh  # å¤šå®¹å™¨æŒ‡å®šå®¹å™¨

# åˆ é™¤Pod
kubectl delete pod &amp;lt;pod-name&amp;gt;
kubectl delete -f pod.yaml

# ç¼–è¾‘Podï¼ˆéƒ¨åˆ†å­—æ®µä¸å¯ä¿®æ”¹ï¼‰
kubectl edit pod &amp;lt;pod-name&amp;gt;

# æŸ¥çœ‹Podçš„YAML
kubectl get pod &amp;lt;pod-name&amp;gt; -o yaml

# æŸ¥çœ‹Podäº‹ä»¶
kubectl get events --field-selector involvedObject.name=&amp;lt;pod-name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;4.6 éªŒè¯å’Œæ’é”™&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;æ£€æŸ¥æ¸…å•ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;PodçŠ¶æ€æ£€æŸ¥&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get pods
# æ­£å¸¸åº”æ˜¾ç¤ºï¼šRunningï¼ŒREADY 1/1
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¦‚æœPodçŠ¶æ€ä¸ºPending&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ£€æŸ¥èŠ‚ç‚¹èµ„æºæ˜¯å¦å……è¶³&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥é•œåƒæ˜¯å¦èƒ½æ­£å¸¸æ‹‰å–&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;kubectl describe pod &amp;lt;pod-name&amp;gt;
# æŸ¥çœ‹Eventséƒ¨åˆ†çš„é”™è¯¯ä¿¡æ¯
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¦‚æœPodçŠ¶æ€ä¸ºImagePullBackOff&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ£€æŸ¥é•œåƒåç§°æ˜¯å¦æ­£ç¡®&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥ç§æœ‰ä»“åº“è®¤è¯ï¼ˆåç»­ä¼šè®²Secretï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;kubectl logs &amp;lt;pod-name&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;å¦‚æœPodçŠ¶æ€ä¸ºCrashLoopBackOff&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;å®¹å™¨å¯åŠ¨åç«‹å³å´©æºƒ&lt;/li&gt;
&lt;li&gt;æŸ¥çœ‹æ—¥å¿—å®šä½é—®é¢˜&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code&gt;kubectl logs &amp;lt;pod-name&amp;gt; --previous  # æŸ¥çœ‹ä¸Šä¸€æ¬¡è¿è¡Œçš„æ—¥å¿—
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;æµ‹è¯•ç½‘ç»œè¿é€šæ€§&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä»ä»»æ„èŠ‚ç‚¹æˆ–Podå†…æµ‹è¯•
kubectl run test-pod --image=reg.westos.org/library/busybox:1.30.1 --rm -it --restart=Never -- sh

# åœ¨test-podä¸­æµ‹è¯•
wget -q -O- http://&amp;lt;pod-ip&amp;gt;
# åº”è¯¥çœ‹åˆ°è¿æ¥æˆåŠŸçš„æ¶ˆæ¯

# æˆ–è€…åœ¨masterèŠ‚ç‚¹ç›´æ¥curl
curl http://&amp;lt;pod-ip&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;å¸¸è§é—®é¢˜ï¼š&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;é—®é¢˜&lt;/th&gt;
&lt;th&gt;åŸå› &lt;/th&gt;
&lt;th&gt;è§£å†³æ–¹æ³•&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;ImagePullBackOff&lt;/td&gt;
&lt;td&gt;é•œåƒæ‹‰å–å¤±è´¥&lt;/td&gt;
&lt;td&gt;æ£€æŸ¥é•œåƒåç§°ã€ä»“åº“åœ°å€ã€ç½‘ç»œè¿æ¥&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;CrashLoopBackOff&lt;/td&gt;
&lt;td&gt;å®¹å™¨å¯åŠ¨åå´©æºƒ&lt;/td&gt;
&lt;td&gt;æ£€æŸ¥æ—¥å¿—ã€æ£€æŸ¥å¯åŠ¨å‘½ä»¤ã€æ£€æŸ¥ä¾èµ–æœåŠ¡&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Pending&lt;/td&gt;
&lt;td&gt;æ— æ³•è°ƒåº¦ï¼ˆèµ„æºä¸è¶³ã€èŠ‚ç‚¹å¼‚å¸¸ç­‰ï¼‰&lt;/td&gt;
&lt;td&gt;æ£€æŸ¥èŠ‚ç‚¹çŠ¶æ€ã€èµ„æºé…é¢&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;Error&lt;/td&gt;
&lt;td&gt;Podå¯åŠ¨å¤±è´¥&lt;/td&gt;
&lt;td&gt;æŸ¥çœ‹describeå’Œlogs&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;0/1 Ready&lt;/td&gt;
&lt;td&gt;å®¹å™¨æœªé€šè¿‡å°±ç»ªæ¢é’ˆ&lt;/td&gt;
&lt;td&gt;æ£€æŸ¥æ¢é’ˆé…ç½®ã€åº”ç”¨å¯åŠ¨çŠ¶æ€&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;hr /&gt;
</content:encoded></item><item><title>æ­å»º Kubernetes é›†ç¾¤</title><link>https://dev-null-sec.github.io/posts/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/%E6%90%AD%E5%BB%BAk8s%E9%9B%86%E7%BE%A4/</guid><description>è®°å½•ç”¨ kubeadm æ­å»º k8s é›†ç¾¤çš„è¿‡ç¨‹ï¼Œä½¿ç”¨ containerd è¿è¡Œæ—¶å’Œ Calico ç½‘ç»œ</description><pubDate>Sat, 08 Mar 2025 00:00:00 GMT</pubDate><content:encoded>&lt;p&gt;æœ€è¿‘éœ€è¦æ­ä¸ª k8s é›†ç¾¤åšæµ‹è¯•ï¼Œç”¨çš„æ˜¯ kubeadm éƒ¨ç½²æ–¹å¼ã€‚é›†ç¾¤é•œåƒä»ç§æœ‰ Harbor ä»“åº“æ‹‰å–ï¼ŒHarbor çš„æ­å»ºå¯ä»¥å‚è€ƒ&lt;a href=&quot;../%E6%90%AD%E5%BB%BAharbor%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93/&quot;&gt;ä¸Šä¸€ç¯‡æ–‡ç« &lt;/a&gt;ã€‚&lt;/p&gt;
&lt;h2&gt;ç¯å¢ƒè§„åˆ’&lt;/h2&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;ä¸»æœº&lt;/th&gt;
&lt;th&gt;IP&lt;/th&gt;
&lt;th&gt;ç”¨é€”&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;k8s-master&lt;/td&gt;
&lt;td&gt;192.168.100.20&lt;/td&gt;
&lt;td&gt;æ§åˆ¶å¹³é¢èŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node1&lt;/td&gt;
&lt;td&gt;192.168.100.21&lt;/td&gt;
&lt;td&gt;å·¥ä½œèŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;k8s-node2&lt;/td&gt;
&lt;td&gt;192.168.100.22&lt;/td&gt;
&lt;td&gt;å·¥ä½œèŠ‚ç‚¹&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;harbor&lt;/td&gt;
&lt;td&gt;192.168.100.14&lt;/td&gt;
&lt;td&gt;ç§æœ‰é•œåƒä»“åº“&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;k8s ç‰ˆæœ¬ï¼šv1.33.5&lt;br /&gt;
ç½‘ç»œæ’ä»¶ï¼šCalico v3.31.0&lt;br /&gt;
å®¹å™¨è¿è¡Œæ—¶ï¼šcontainerd&lt;/p&gt;
&lt;h2&gt;ç³»ç»Ÿåˆå§‹åŒ–&lt;/h2&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹éƒ½éœ€è¦æ‰§è¡Œä»¥ä¸‹æ“ä½œã€‚&lt;/p&gt;
&lt;h3&gt;å…³é—­ swap&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;swapoff -a
sed -i &apos;/swap/s/^/#/&apos; /etc/fstab
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;è°ƒæ•´å†…æ ¸å‚æ•°&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

sysctl --system
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½®ä¸»æœºåå’Œè§£æ&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# åœ¨ master èŠ‚ç‚¹
hostnamectl set-hostname k8s-master

# åœ¨ node1 èŠ‚ç‚¹
hostnamectl set-hostname k8s-node1

# åœ¨ node2 èŠ‚ç‚¹
hostnamectl set-hostname k8s-node2

# æ‰€æœ‰èŠ‚ç‚¹æ·»åŠ  hosts è§£æ
cat &amp;gt;&amp;gt; /etc/hosts &amp;lt;&amp;lt;EOF
192.168.100.20 k8s-master
192.168.100.21 k8s-node1
192.168.100.22 k8s-node2
192.168.100.14 reg.westos.org
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½® k8s yum æº&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.33/rpm/
enabled=1
gpgcheck=0
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½® SSH å…å¯†ï¼ˆå¯é€‰ï¼‰&lt;/h3&gt;
&lt;p&gt;æ–¹ä¾¿åç»­æ“ä½œï¼Œå†™ä¸ªè„šæœ¬æ‰¹é‡é…ç½®ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;#!/bin/bash
USER=&quot;root&quot;
PASSWORD=&quot;123&quot;
PORT=22
HOSTS=(
  192.168.100.20
  192.168.100.21
  192.168.100.22
)

[ ! -f ~/.ssh/id_rsa.pub ] &amp;amp;&amp;amp; ssh-keygen -t rsa -N &quot;&quot; -f ~/.ssh/id_rsa

for entry in &quot;${HOSTS[@]}&quot;; do
  host=&quot;$entry&quot;
  port=&quot;$PORT&quot;
  [[ &quot;$entry&quot; == *:* ]] &amp;amp;&amp;amp; host=&quot;${entry%%:*}&quot; &amp;amp;&amp;amp; port=&quot;${entry##*:}&quot;
  sshpass -p &quot;$PASSWORD&quot; ssh-copy-id -o StrictHostKeyChecking=no -p &quot;$port&quot; &quot;$USER@$host&quot;
done
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½® IPVS&lt;/h3&gt;
&lt;p&gt;k8s ç”¨ IPVS åšè´Ÿè½½å‡è¡¡ï¼Œéœ€è¦åŠ è½½ç›¸å…³å†…æ ¸æ¨¡å—ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cat &amp;gt; /etc/modules-load.d/ipvs.conf &amp;lt;&amp;lt;EOF
ip_vs
ip_vs_rr
ip_vs_wrr
ip_vs_sh
nf_conntrack
overlay
br_netfilter
EOF

# ç«‹å³åŠ è½½
modprobe ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh nf_conntrack overlay br_netfilter

# å®‰è£…ç®¡ç†å·¥å…·
dnf install -y ipvsadm ipset
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;å®‰è£… containerd&lt;/h2&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹å®‰è£…ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;yum install -y containerd.io cri-tools
containerd config default &amp;gt; /etc/containerd/config.toml

# å¯ç”¨ systemd cgroup é©±åŠ¨
sed -i &apos;s#SystemdCgroup = false#SystemdCgroup = true#g&apos; /etc/containerd/config.toml

systemctl enable --now containerd

# é…ç½® crictl
cat &amp;lt;&amp;lt;EOF &amp;gt; /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
image-endpoint: unix:///run/containerd/containerd.sock
EOF
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½® Harbor è¯ä¹¦&lt;/h3&gt;
&lt;p&gt;è®© containerd ä¿¡ä»» Harbor çš„è¯ä¹¦ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# æ‰€æœ‰èŠ‚ç‚¹åˆ›å»ºç›®å½•
mkdir -p /etc/containerd/certs.d/reg.westos.org

# åœ¨ harbor èŠ‚ç‚¹ä¸Šï¼Œå°†è¯ä¹¦å¤åˆ¶åˆ°å„èŠ‚ç‚¹
scp /etc/docker/certs.d/reg.westos.org/ca.crt 192.168.100.20:/etc/containerd/certs.d/reg.westos.org/
scp /etc/docker/certs.d/reg.westos.org/ca.crt 192.168.100.21:/etc/containerd/certs.d/reg.westos.org/
scp /etc/docker/certs.d/reg.westos.org/ca.crt 192.168.100.22:/etc/containerd/certs.d/reg.westos.org/

# åœ¨æ‰€æœ‰ k8s èŠ‚ç‚¹ä¸Šï¼Œä¿®æ”¹ containerd é…ç½®
sed -i &apos;s#config_path = &quot;&quot;#config_path = &quot;/etc/containerd/certs.d&quot;#g&apos; /etc/containerd/config.toml
sed -i &apos;s#registry.k8s.io/pause:3.8#reg.westos.org/k8s/pause:3.10#g&apos; /etc/containerd/config.toml

systemctl restart containerd
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;å‡†å¤‡é•œåƒ&lt;/h2&gt;
&lt;h3&gt;å®‰è£… k8s ç»„ä»¶&lt;/h3&gt;
&lt;p&gt;æ‰€æœ‰èŠ‚ç‚¹å®‰è£…ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;yum install -y kubelet kubeadm kubectl
systemctl enable --now kubelet
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;æŸ¥çœ‹éœ€è¦çš„é•œåƒ&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;kubeadm config images list --image-repository registry.aliyuncs.com/google_containers --kubernetes-version v1.33.5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¼šåˆ—å‡ºè¿™äº›é•œåƒï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;kube-apiserver:v1.33.5&lt;/li&gt;
&lt;li&gt;kube-controller-manager:v1.33.5&lt;/li&gt;
&lt;li&gt;kube-scheduler:v1.33.5&lt;/li&gt;
&lt;li&gt;kube-proxy:v1.33.5&lt;/li&gt;
&lt;li&gt;coredns:v1.12.0&lt;/li&gt;
&lt;li&gt;pause:3.10&lt;/li&gt;
&lt;li&gt;etcd:3.5.21-0&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;æ¨é€é•œåƒåˆ° Harbor&lt;/h3&gt;
&lt;p&gt;åœ¨ harbor èŠ‚ç‚¹ä¸Šæ‹‰å–é•œåƒå¹¶æ¨é€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;# ä»é˜¿é‡Œäº‘æ‹‰å–
docker pull registry.aliyuncs.com/google_containers/pause:3.10
docker pull registry.aliyuncs.com/google_containers/kube-apiserver:v1.33.5
docker pull registry.aliyuncs.com/google_containers/kube-controller-manager:v1.33.5
docker pull registry.aliyuncs.com/google_containers/kube-scheduler:v1.33.5
docker pull registry.aliyuncs.com/google_containers/kube-proxy:v1.33.5
docker pull registry.aliyuncs.com/google_containers/coredns:v1.12.0
docker pull registry.aliyuncs.com/google_containers/etcd:3.5.21-0

# åœ¨ Harbor Web ç•Œé¢åˆ›å»º k8s é¡¹ç›®ï¼ˆè®¾ä¸ºå…¬å¼€ï¼‰

# æ‰¹é‡æ‰“æ ‡ç­¾
docker images |grep google_containers | awk &apos;{print $1&quot;:&quot;$2}&apos; | awk -F/ &apos;{system(&quot;docker tag &quot;$0&quot; reg.westos.org/k8s/&quot;$3&quot;&quot;)}&apos;

# æ‰¹é‡æ¨é€
docker images |grep reg.westos.org/k8s | awk &apos;{system(&quot;docker push &quot;$1&quot;:&quot;$2&quot;&quot;)}&apos;
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;åˆå§‹åŒ– Master èŠ‚ç‚¹&lt;/h2&gt;
&lt;p&gt;åœ¨ k8s-master ä¸Šæ‰§è¡Œï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubeadm init \
  --pod-network-cidr=10.244.0.0/16 \
  --image-repository reg.westos.org/k8s \
  --kubernetes-version v1.33.5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åˆå§‹åŒ–æˆåŠŸåä¼šè¾“å‡º join å‘½ä»¤ï¼Œè®°ä¸‹æ¥ç»™ node èŠ‚ç‚¹ç”¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubeadm join 192.168.100.20:6443 --token afmhpb.r5vcfet4ro49kg5i \
  --discovery-token-ca-cert-hash sha256:69a36f40befb0f36e29c1afae2291be7ff652672ec730728aebb90b73f436192
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;é…ç½® kubectl&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p $HOME/.kube
cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
chown $(id -u):$(id -g) $HOME/.kube/config

# å‘½ä»¤è¡¥å…¨
echo &quot;source &amp;lt;(kubectl completion bash)&quot; &amp;gt;&amp;gt; ~/.bashrc
source ~/.bashrc
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;éªŒè¯ä¸€ä¸‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get nodes
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ­¤æ—¶ master èŠ‚ç‚¹çŠ¶æ€æ˜¯ &lt;code&gt;NotReady&lt;/code&gt;ï¼Œå› ä¸ºè¿˜æ²¡è£…ç½‘ç»œæ’ä»¶ã€‚&lt;/p&gt;
&lt;h2&gt;å®‰è£… Calico ç½‘ç»œæ’ä»¶&lt;/h2&gt;
&lt;h3&gt;å‡†å¤‡ Calico é•œåƒ&lt;/h3&gt;
&lt;p&gt;åœ¨ harbor èŠ‚ç‚¹ä¸Šï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull quay.io/calico/cni:v3.31.0
docker pull quay.io/calico/node:v3.31.0
docker pull quay.io/calico/kube-controllers:v3.31.0

# åœ¨ Harbor Web ç•Œé¢åˆ›å»º calico é¡¹ç›®

# æ‰“æ ‡ç­¾å¹¶æ¨é€
docker images |grep calico | awk &apos;{print $1&quot;:&quot;$2}&apos; | awk -F/ &apos;{system(&quot;docker tag &quot;$0&quot; reg.westos.org/calico/&quot;$3&quot;&quot;)}&apos;
docker images |grep reg.westos.org/calico | awk &apos;{system(&quot;docker push &quot;$1&quot;:&quot;$2&quot;&quot;)}&apos;
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;éƒ¨ç½² Calico&lt;/h3&gt;
&lt;p&gt;åœ¨ master èŠ‚ç‚¹ä¸Šï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;wget https://raw.githubusercontent.com/projectcalico/calico/v3.31.0/manifests/calico.yaml
sed -i &apos;s#quay.io/#reg.westos.org/#g&apos; calico.yaml
kubectl apply -f calico.yaml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç­‰å¾… calico pods å¯åŠ¨ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get pod -A |grep calico
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å…¨éƒ¨ Running åï¼Œå†æŸ¥çœ‹èŠ‚ç‚¹çŠ¶æ€ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;master èŠ‚ç‚¹åº”è¯¥å˜æˆ &lt;code&gt;Ready&lt;/code&gt; çŠ¶æ€äº†ã€‚&lt;/p&gt;
&lt;h2&gt;åŠ å…¥ Worker èŠ‚ç‚¹&lt;/h2&gt;
&lt;p&gt;åœ¨ node1 å’Œ node2 ä¸Šæ‰§è¡Œä¹‹å‰ä¿å­˜çš„ join å‘½ä»¤ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubeadm join 192.168.100.20:6443 --token afmhpb.r5vcfet4ro49kg5i \
  --discovery-token-ca-cert-hash sha256:69a36f40befb0f36e29c1afae2291be7ff652672ec730728aebb90b73f436192
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å›åˆ° master èŠ‚ç‚¹æŸ¥çœ‹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubectl get node
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;è¾“å‡ºï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;NAME         STATUS   ROLES           AGE     VERSION
k8s-master   Ready    control-plane   35m     v1.33.5
k8s-node1    Ready    &amp;lt;none&amp;gt;          2m      v1.33.5
k8s-node2    Ready    &amp;lt;none&amp;gt;          6m22s   v1.33.5
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å…¨éƒ¨ Readyï¼Œé›†ç¾¤å°±æ­å¥½äº†ã€‚&lt;/p&gt;
&lt;h2&gt;å¸¸è§é—®é¢˜&lt;/h2&gt;
&lt;p&gt;é‡åˆ°è¿‡å‡ æ¬¡é•œåƒæ‹‰å–å¤±è´¥çš„é—®é¢˜ï¼Œæ’æŸ¥ä¸‹æ¥æ˜¯è¿™å‡ ä¸ªåŸå› ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;containerd æ²¡é…ç½® Harbor è¯ä¹¦è·¯å¾„&lt;/li&gt;
&lt;li&gt;Harbor é¡¹ç›®æƒé™è®¾ä¸ºç§æœ‰äº†ï¼ˆæ”¹æˆå…¬å¼€æˆ–é…ç½® imagePullSecretsï¼‰&lt;/li&gt;
&lt;li&gt;èŠ‚ç‚¹ &lt;code&gt;/etc/hosts&lt;/code&gt; æ²¡æœ‰ Harbor åŸŸåè§£æ&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å¦å¤–å¦‚æœ token è¿‡æœŸäº†ï¼Œå¯ä»¥åœ¨ master ä¸Šé‡æ–°ç”Ÿæˆï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;kubeadm token create --print-join-command
&lt;/code&gt;&lt;/pre&gt;
</content:encoded></item><item><title>æ­å»º Harbor ç§æœ‰é•œåƒä»“åº“</title><link>https://dev-null-sec.github.io/posts/%E6%90%AD%E5%BB%BAharbor%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/%E6%90%AD%E5%BB%BAharbor%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E4%BB%93%E5%BA%93/</guid><description>è®°å½•ä¸€ä¸‹åœ¨å†…ç½‘ç¯å¢ƒæ­å»º Harbor ç§æœ‰é•œåƒä»“åº“çš„è¿‡ç¨‹ï¼ŒåŒ…æ‹¬ HTTPS é…ç½®å’Œ Trivy æ‰«æ</description><pubDate>Thu, 07 Nov 2024 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;ç¯å¢ƒ&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;æœåŠ¡å™¨ï¼š&lt;code&gt;192.168.100.14&lt;/code&gt;ï¼Œå·²è£…å¥½ Docker&lt;/li&gt;
&lt;li&gt;åŸŸåï¼š&lt;code&gt;reg.westos.org&lt;/code&gt;ï¼ˆå†…ç½‘åŸŸåï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;ç”Ÿæˆè¯ä¹¦&lt;/h2&gt;
&lt;p&gt;Harbor éœ€è¦ HTTPSï¼Œå…ˆç”Ÿæˆè‡ªç­¾åè¯ä¹¦ã€‚&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir certs
openssl req -newkey rsa:4096 -nodes -sha256 \
  -keyout certs/westos.org.key \
  -addext &quot;subjectAltName = DNS:reg.westos.org&quot; \
  -x509 -days 365 \
  -out certs/westos.org.crt
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç„¶åæŠŠè¯ä¹¦å¤åˆ¶åˆ° &lt;code&gt;/data&lt;/code&gt; ç›®å½•ï¼ŒHarbor ä¼šä»è¿™é‡Œè¯»å–ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir /data
cp -r certs /data
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;å®‰è£… Harbor&lt;/h2&gt;
&lt;p&gt;å» &lt;a href=&quot;https://github.com/goharbor/harbor/releases&quot;&gt;Harbor Release&lt;/a&gt; ä¸‹è½½ç¦»çº¿å®‰è£…åŒ…ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;wget https://github.com/goharbor/harbor/releases/download/v2.14.0/harbor-offline-installer-v2.14.0.tgz
tar zxf harbor-offline-installer-v2.14.0.tgz
cd harbor/
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;å¤åˆ¶é…ç½®æ¨¡æ¿å¹¶ä¿®æ”¹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cp harbor.yml.tmpl harbor.yml
vim harbor.yml
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ä¸»è¦æ”¹è¿™å‡ ä¸ªåœ°æ–¹ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;hostname: reg.westos.org

http:
  port: 80

https:
  port: 443
  certificate: /data/certs/westos.org.crt
  private_key: /data/certs/westos.org.key

harbor_admin_password: 12345  # æ”¹æˆä½ çš„å¯†ç 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;æ‰§è¡Œå®‰è£…ï¼Œå¸¦ä¸Š &lt;code&gt;--with-trivy&lt;/code&gt; å‚æ•°ä¼šä¸€èµ·å®‰è£…æ¼æ´æ‰«æå·¥å…·ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;./install.sh --with-trivy
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç­‰ä¸€ä¼šå„¿ï¼Œçœ‹åˆ° &lt;code&gt;Harbor has been installed and started successfully&lt;/code&gt; å°±å¥½äº†ã€‚&lt;/p&gt;
&lt;h2&gt;Docker å®¢æˆ·ç«¯é…ç½®&lt;/h2&gt;
&lt;p&gt;ç›´æ¥ &lt;code&gt;docker login&lt;/code&gt; ä¼šæŠ¥è¯ä¹¦é”™è¯¯ï¼Œå› ä¸ºæ˜¯è‡ªç­¾åçš„ã€‚éœ€è¦è®© Docker ä¿¡ä»»è¿™ä¸ªè¯ä¹¦ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir -p /etc/docker/certs.d/reg.westos.org
cp /data/certs/westos.org.crt /etc/docker/certs.d/reg.westos.org/ca.crt
systemctl restart docker

# é‡å¯å Harbor ä¹Ÿè¦é‡æ–°å¯åŠ¨
cd ~/harbor
docker compose up -d
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç°åœ¨å¯ä»¥ç™»å½•äº†ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker login reg.westos.org
# Username: admin
# Password: 12345
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;ä½¿ç”¨&lt;/h2&gt;
&lt;p&gt;æµè§ˆå™¨è®¿é—® &lt;code&gt;https://reg.westos.org&lt;/code&gt;ï¼Œç”¨ admin è´¦æˆ·ç™»å½•ã€‚&lt;/p&gt;
&lt;p&gt;å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œæ¯”å¦‚å« &lt;code&gt;myproject&lt;/code&gt;ï¼Œé€‰ç§æœ‰ã€‚&lt;/p&gt;
&lt;p&gt;ç„¶åè¯•ç€æ¨é€ä¸€ä¸ªé•œåƒï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull nginx:latest
docker tag nginx:latest reg.westos.org/myproject/nginx:v1.0
docker push reg.westos.org/myproject/nginx:v1.0
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åœ¨ Web ç•Œé¢é‡Œå°±èƒ½çœ‹åˆ°æ¨é€çš„é•œåƒäº†ã€‚&lt;/p&gt;
&lt;p&gt;æ‹‰å–ä¹Ÿå¾ˆç®€å•ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker pull reg.westos.org/myproject/nginx:v1.0
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;Trivy æ‰«æé—®é¢˜&lt;/h2&gt;
&lt;p&gt;åœ¨ Web ç•Œé¢ç‚¹&quot;æ‰«æ&quot;æŒ‰é’®çš„æ—¶å€™ï¼ŒTrivy ä¼šæŠ¥é”™è¯´ä¸‹è½½ä¸äº†æ¼æ´åº“ã€‚å› ä¸ºå®ƒè¦ä» GitHub æ‹‰æ•°æ®ï¼Œå›½å†…ç½‘ç»œä¸å¤ªè¡Œã€‚&lt;/p&gt;
&lt;p&gt;è§£å†³åŠæ³•æ˜¯ç»™å®ƒé…ä¸ªä»£ç†ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;cd ~/harbor
vim ./common/config/trivy-adapter/env
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;åŠ ä¸Šä»£ç†é…ç½®ï¼ˆæ¢æˆä½ è‡ªå·±çš„ä»£ç†åœ°å€ï¼‰ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;HTTP_PROXY=http://192.168.10.141:7897
HTTPS_PROXY=http://192.168.10.141:7897
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç„¶åé‡å¯ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;docker compose down
docker compose up -d
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;ç°åœ¨æ‰«æåº”è¯¥èƒ½æ­£å¸¸å·¥ä½œäº†ã€‚æ‰«æç»“æœä¼šæ˜¾ç¤ºé•œåƒé‡Œæœ‰å“ªäº›æ¼æ´ï¼Œæ–¹ä¾¿è¯„ä¼°é£é™©ã€‚&lt;/p&gt;
&lt;h2&gt;å…¶ä»–æœºå™¨ä½¿ç”¨&lt;/h2&gt;
&lt;p&gt;å¦‚æœå…¶ä»–æœºå™¨è¦ç”¨è¿™ä¸ªä»“åº“ï¼Œéœ€è¦ï¼š&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;é…ç½®åŸŸåè§£æï¼ˆ&lt;code&gt;/etc/hosts&lt;/code&gt; æˆ– DNSï¼‰&lt;/li&gt;
&lt;li&gt;å¤åˆ¶è¯ä¹¦åˆ°å®¢æˆ·ç«¯ï¼š&lt;pre&gt;&lt;code&gt;scp root@192.168.100.14:/data/certs/westos.org.crt /etc/docker/certs.d/reg.westos.org/ca.crt
&lt;/code&gt;&lt;/pre&gt;
&lt;/li&gt;
&lt;li&gt;ç™»å½•å³å¯&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;å°±è¿™æ ·ï¼ŒåŸºæœ¬çš„ Harbor ä»“åº“å°±æ­å¥½äº†ã€‚&lt;/p&gt;
</content:encoded></item><item><title>Linuxè¿ç»´å·¥å…·ç®±(Python)</title><link>https://dev-null-sec.github.io/posts/python%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7%E7%AE%B1/</link><guid isPermaLink="true">https://dev-null-sec.github.io/posts/python%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7%E7%AE%B1/</guid><description>ä¸€ä¸ªç”¨Pythonå†™çš„Linuxè¿ç»´è‡ªåŠ¨åŒ–å·¥å…·ç®±ï¼Œæ”¯æŒç³»ç»Ÿç®¡ç†ã€ç½‘ç»œé…ç½®ã€æœåŠ¡éƒ¨ç½²ç­‰åŠŸèƒ½</description><pubDate>Wed, 11 Sep 2024 00:00:00 GMT</pubDate><content:encoded>&lt;h2&gt;é¡¹ç›®èƒŒæ™¯&lt;/h2&gt;
&lt;p&gt;åœ¨å­¦ä¹ Linuxè¿ç»´ç›¸å…³çŸ¥è¯†æ—¶ï¼Œå‘ç°æ—¥å¸¸ç®¡ç†æœåŠ¡å™¨æ—¶æ€»æ˜¯è¦é‡å¤æ‰§è¡Œå¾ˆå¤šå‘½ä»¤ï¼Œæ¯”å¦‚é…ç½®ç½‘ç»œã€å®‰è£…è½¯ä»¶ã€æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ç­‰ã€‚äºæ˜¯å°±æƒ³ç€èƒ½ä¸èƒ½å†™ä¸ªå·¥å…·æŠŠè¿™äº›æ“ä½œè‡ªåŠ¨åŒ–ï¼Œè¿™æ ·ä»¥åé…ç½®æ–°æœåŠ¡å™¨å°±æ–¹ä¾¿å¤šäº†ã€‚&lt;/p&gt;
&lt;p&gt;æœ€å¼€å§‹æ˜¯ç”¨Shellå†™çš„ï¼Œä½†æ˜¯Shellå¤„ç†å¤æ‚é€»è¾‘ä¸å¤ªæ–¹ä¾¿ï¼Œåæ¥å­¦äº†Pythonå°±æƒ³ç€ç”¨Pythoné‡å†™ã€‚èŠ±äº†å¤§æ¦‚ä¸¤å‘¨æ—¶é—´ï¼Œè¾¹å­¦è¾¹å†™ï¼Œå†™å‡ºäº†è¿™ä¸ªè¿ç»´å·¥å…·ç®±ã€‚&lt;/p&gt;
&lt;h2&gt;ä¸»è¦åŠŸèƒ½&lt;/h2&gt;
&lt;p&gt;è¿™ä¸ªå·¥å…·ç®±ä¸»è¦å®ç°äº†ä»¥ä¸‹åŠŸèƒ½ï¼š&lt;/p&gt;
&lt;h3&gt;1. ç³»ç»Ÿä¿¡æ¯ç®¡ç†&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨è¯†åˆ«Linuxå‘è¡Œç‰ˆï¼ˆæ”¯æŒUbuntuã€CentOSã€Rocky Linuxç­‰ï¼‰&lt;/li&gt;
&lt;li&gt;æ£€æŸ¥ç³»ç»Ÿç‰ˆæœ¬å’Œé…ç½®ä¿¡æ¯&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;2. ç½‘ç»œé…ç½®&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨é…ç½®é™æ€IPåœ°å€&lt;/li&gt;
&lt;li&gt;ç®¡ç†DNSæœåŠ¡å™¨è®¾ç½®&lt;/li&gt;
&lt;li&gt;æ”¯æŒä¸åŒå‘è¡Œç‰ˆçš„ç½‘ç»œé…ç½®æ–¹å¼ï¼ˆDebianç³»ç”¨çš„æ˜¯netplanï¼ŒRedHatç³»ç”¨çš„æ˜¯network-scriptsï¼‰&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;3. è½¯ä»¶æºç®¡ç†&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;ä¸€é”®æ›´æ¢å›½å†…é•œåƒæºï¼ˆæ¸…åæºã€é˜¿é‡Œæºç­‰ï¼‰&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨å¤‡ä»½åŸæœ‰é…ç½®&lt;/li&gt;
&lt;li&gt;æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬é€‰æ‹©åˆé€‚çš„æºåœ°å€&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;4. æœåŠ¡å®‰è£…ä¸éƒ¨ç½²&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;è‡ªåŠ¨å®‰è£…å¸¸ç”¨è½¯ä»¶ï¼ˆNginxã€Dockerç­‰ï¼‰&lt;/li&gt;
&lt;li&gt;ä¸€é”®éƒ¨ç½²å¼€å‘ç¯å¢ƒ&lt;/li&gt;
&lt;li&gt;é…ç½®ç³»ç»ŸæœåŠ¡è‡ªå¯åŠ¨&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;5. äº¤äº’å¼èœå•&lt;/h3&gt;
&lt;p&gt;ä½¿ç”¨äº†ç®€å•çš„èœå•ç³»ç»Ÿï¼Œæ“ä½œèµ·æ¥æ¯”è¾ƒç›´è§‚ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Linux è¿ç»´å·¥å…·ç®± - ä¸»èœå•         

  1. ç³»ç»Ÿåˆå§‹åŒ–                         
  2. å®‰è£…å¸¸ç”¨æœåŠ¡                       
  3. ç³»ç»Ÿå·¡æ£€                           
  0. é€€å‡ºç¨‹åº                           
&lt;/code&gt;&lt;/pre&gt;
&lt;h2&gt;æŠ€æœ¯å®ç°&lt;/h2&gt;
&lt;h3&gt;ä»£ç ç»“æ„&lt;/h3&gt;
&lt;p&gt;æ•´ä¸ªå·¥å…·åˆ†æˆäº†å‡ ä¸ªæ¨¡å—ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;åŸºç¡€å·¥å…·å‡½æ•°&lt;/strong&gt;ï¼šè´Ÿè´£æ‰§è¡Œå‘½ä»¤ã€æ£€æŸ¥ç³»ç»Ÿç­‰åº•å±‚æ“ä½œ&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç³»ç»Ÿä¿¡æ¯æ¨¡å—&lt;/strong&gt;ï¼šè¯»å–å’Œè§£æç³»ç»Ÿé…ç½®&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç³»ç»Ÿå·¡æ£€æ¨¡å—&lt;/strong&gt;ï¼šè¿›è¡Œç³»ç»Ÿå·¡æ£€ç”ŸæˆæŠ¥å‘Šå¹¶æ¨é€å¾®ä¿¡å‘Šè­¦&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;æœåŠ¡ç®¡ç†æ¨¡å—&lt;/strong&gt;ï¼šå®‰è£…å’Œé…ç½®å„ç±»æœåŠ¡&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;äº¤äº’ç•Œé¢æ¨¡å—&lt;/strong&gt;ï¼šæä¾›ç”¨æˆ·äº¤äº’èœå•&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;å…³é”®æŠ€æœ¯ç‚¹&lt;/h3&gt;
&lt;h4&gt;1. ç³»ç»Ÿè¯†åˆ«&lt;/h4&gt;
&lt;p&gt;é€šè¿‡è¯»å–&lt;code&gt;/etc/os-release&lt;/code&gt;æ–‡ä»¶æ¥è¯†åˆ«ç³»ç»Ÿä¿¡æ¯ï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;def read_system_info():
    os_release_data = {}
    with open(&apos;/etc/os-release&apos;) as file:
        for line in file:
            if &apos;=&apos; in line:
                key, value = line.strip().split(&apos;=&apos;, 1)
                os_release_data[key] = value.strip().strip(&apos;&quot;&apos;)
    return os_release_data
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;2. å‘½ä»¤æ‰§è¡Œ&lt;/h4&gt;
&lt;p&gt;ä½¿ç”¨&lt;code&gt;subprocess&lt;/code&gt;æ¨¡å—æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¹¶å¤„ç†å„ç§å¼‚å¸¸æƒ…å†µï¼š&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;def run_system_command(command_list):
    try:
        subprocess.run(command_list, check=True)
        return True
    except FileNotFoundError:
        print(f&quot;æ‰¾ä¸åˆ°å‘½ä»¤ï¼š{command_list[0]}&quot;)
        return False
    except subprocess.CalledProcessError:
        print(&quot;å‘½ä»¤æ‰§è¡Œå¤±è´¥&quot;)
        return False
&lt;/code&gt;&lt;/pre&gt;
&lt;h4&gt;3. è·¨å‘è¡Œç‰ˆå…¼å®¹&lt;/h4&gt;
&lt;p&gt;ä¸åŒLinuxå‘è¡Œç‰ˆä½¿ç”¨çš„åŒ…ç®¡ç†å™¨ä¸åŒï¼Œéœ€è¦åšé€‚é…ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Debianç³»ï¼ˆUbuntuï¼‰ï¼šä½¿ç”¨&lt;code&gt;apt&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;RedHatç³»ï¼ˆCentOSã€Rockyï¼‰ï¼šä½¿ç”¨&lt;code&gt;yum&lt;/code&gt;æˆ–&lt;code&gt;dnf&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä»£ç é‡Œå†™äº†è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿç±»å‹ï¼Œç„¶åè°ƒç”¨å¯¹åº”çš„åŒ…ç®¡ç†å™¨ã€‚&lt;/p&gt;
&lt;h2&gt;ä½¿ç”¨æ–¹å¼&lt;/h2&gt;
&lt;h3&gt;å¿«é€Ÿå¼€å§‹&lt;/h3&gt;
&lt;pre&gt;&lt;code&gt;# ä¸‹è½½å·¥å…·åŒ…
wget https://devnu11.pages.dev/file/tools.tar

# è§£å‹
tar xf tools.tar

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x check_system.sh ops_toolbox.py wechat.py

# è¿è¡Œï¼ˆéœ€è¦rootæƒé™ï¼‰
python3 ops_toolbox.py
&lt;/code&gt;&lt;/pre&gt;
&lt;h3&gt;ä½¿ç”¨å»ºè®®&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;å»ºè®®åœ¨è™šæ‹Ÿæœºæˆ–æµ‹è¯•ç¯å¢ƒå…ˆè¯•ç”¨ä¸€ä¸‹&lt;/li&gt;
&lt;li&gt;æŸäº›æ“ä½œä¼šä¿®æ”¹ç³»ç»Ÿé…ç½®ï¼Œä½¿ç”¨å‰æœ€å¥½å¤‡ä»½é‡è¦æ•°æ®&lt;/li&gt;
&lt;li&gt;ç›®å‰ä¸»è¦æµ‹è¯•äº†CentOS 7/Rocky 9å’ŒUbuntu 22.04&lt;/li&gt;
&lt;/ul&gt;
&lt;h2&gt;å¼€å‘è¿‡ç¨‹ä¸­çš„æ”¶è·&lt;/h2&gt;
&lt;h3&gt;é‡åˆ°çš„é—®é¢˜&lt;/h3&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;ä¸åŒå‘è¡Œç‰ˆå·®å¼‚å¤§&lt;/strong&gt;ï¼šåˆšå¼€å§‹æ²¡æƒ³åˆ°ä¸åŒLinuxå‘è¡Œç‰ˆçš„é…ç½®æ–‡ä»¶ä½ç½®ã€å‘½ä»¤éƒ½ä¸ä¸€æ ·ï¼ŒèŠ±äº†ä¸å°‘æ—¶é—´å»é€‚é…ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ç½‘ç»œé…ç½®å¤æ‚&lt;/strong&gt;ï¼šç‰¹åˆ«æ˜¯Ubuntu ç”¨netplanï¼Œé…ç½®æ–¹å¼å®Œå…¨ä¸åŒï¼Œç ”ç©¶äº†å¥½ä¹…ã€‚&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;é”™è¯¯å¤„ç†&lt;/strong&gt;ï¼šä¸€å¼€å§‹é”™è¯¯å¤„ç†åšå¾—ä¸å¥½ï¼Œè¿è¡Œä¸­å‡ºé”™å°±ç›´æ¥å´©æºƒï¼Œåæ¥åŠ äº†å¾ˆå¤šå¼‚å¸¸æ•è·å’Œæç¤ºã€‚&lt;/li&gt;
&lt;/ol&gt;
&lt;h3&gt;å­¦åˆ°çš„ä¸œè¥¿&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;ç†Ÿæ‚‰äº†Pythonçš„&lt;code&gt;subprocess&lt;/code&gt;æ¨¡å—ï¼Œå­¦ä¼šäº†ç”¨Pythonè°ƒç”¨ç³»ç»Ÿå‘½ä»¤&lt;/li&gt;
&lt;li&gt;æ·±å…¥äº†è§£äº†Linuxç³»ç»Ÿçš„é…ç½®æ–‡ä»¶ç»“æ„å’ŒæœåŠ¡ç®¡ç†&lt;/li&gt;
&lt;li&gt;å­¦ä¼šäº†å¦‚ä½•å†™å¯ç»´æŠ¤æ€§æ›´å¥½çš„ä»£ç ï¼Œæ¯”å¦‚æ¨¡å—åŒ–ã€åŠ æ³¨é‡Š&lt;/li&gt;
&lt;li&gt;æ˜ç™½äº†åšè·¨å¹³å°å…¼å®¹çš„é‡è¦æ€§&lt;/li&gt;
&lt;/ul&gt;
</content:encoded></item></channel></rss>